{"version":3,"sources":["../../../widgets/Chart/Widget.js"],"names":["define","declare","lang","query","html","array","fx","on","focusUtil","_WidgetsInTemplateMixin","BaseWidget","Message","DrawBox","CheckBox","jimuUtils","FilterUtils","FeatureLayer","SimpleRenderer","symbolJsonUtils","StatisticsChart","Query","LayerInfos","ServiceDefinitionManager","Popup","a11y","clazz","name","baseClass","isValidConfig","currentAttrs","tempResultLayer","previewArgs","previewPopup","layerInfosObj","constructor","cachePopUpInfos","_resetCurrentAttrs","chartTr","config","layerInfo","postMixInProperties","inherited","arguments","isRenderIdForAttrs","nls","colorful","monochromatic","clearResults","window","jimuNls","drawBox","clear","getInstanceSync","serviceDefinitionManager","getInstance","_setUrlForConfig","_updateConfig","charts","length","forEach","hitch","singleConfig","_rebuildFilter","url","filter","webMapLayerId","layerInfoOrTableInfo","getLayerOrTableInfoById","getUrl","expr","filterUtils","isHosted","isHostedService","getExprByFilterObj","e","console","log","postCreate","cbxUseSpatial","label","useSpatialFilter","placeAt","cbxUseSpatialDiv","own","_onCbxUseSpatialClicked","bind","_initDrawBox","_initPreview","_initSelf","onOpen","show","onDeActive","deactivate","onClose","hide","_hideInfoWindow","resize","time","appConfig","theme","setTimeout","_updatePreviewHeight","preview","destroy","_clickClearButton","_isConfigValid","types","map","showClear","keepOneGraphic","drawBoxDiv","startup","_createBigPreview","windowWidth","document","body","clientWidth","windowHeight","clientHeight","margin","width","height","fontColor","_getDefaultFontColor","initialChartIndex","currentChartIndex","bigPreview","isBigPreview","showSettingIcon","showZoomIcon","zoomToFeaturesWhenClick","style","titleLabel","_widgetLabel","content","popupFieldInfosObj","_getPopupFieldInfo","createClientCharts","featureLayer","features","layerId","getLayerInfoById","getPopupInfo","resultsContainer","color","styles","uniqueId","getRandomString","cbxName","cbxUseMapExtent","set","cbxDrawGraphic","setStyle","chartsNode","invalidConfigNode","display","left","noChartTipSection","index","strTr","tr","toDom","chartNameDiv","innerHTML","stripHTML","place","chartsTbody","addClass","dontSlide","_removeTempResultLayer","_clearResultPage","_fromCurrentPageToChartList","focus","_slide","dom","startLeft","endLeft","animateProperty","node","properties","start","end","units","duration","onEnd","play","_onChartListClicked","event","target","srcElement","getAncestorDom","hasClass","_enterIntoChartTr","clone","removeClass","callback","_fromChartListToChartParams","shelter","getServiceDefinition","then","response","domNode","err","error","errMsg","httpCode","noPermissionsMsg","_showQueryErrorMsg","layerUrl","chartList","getStyle","chartParams","chartResults","checked","selectSpatialDiv","_onCbxUseMapExtentClicked","_onCbxDrawGraphicClicked","_resetDrawBox","_onBtnClearAllClicked","childElementCount","isChartListVisible","_resetChartParamsPage","setValue","showDom","hideDom","_onBtnParamsBackClicked","_onBtnApplyClicked","where","geometry","extent","gs","drawLayer","graphics","g","message","specifySpatialFilterMsg","removeLayer","_createChartResultLayer","outFields","mode","valueFields","indexOf","labelField","push","categoryField","baseExpr","_getBaseExpression","_query","status","args","feature","type","isVaildPointGeometry","add","_zoomToLayer","info","getTableInfoById","getFilter","box","getContentBox","h","Math","max","drawingInfo","transparency","minScale","maxScale","effectiveMinScale","effectiveMaxScale","defaultVisibility","featureCollection","layerDefinition","featureSet","addLayer","symbol","fromJson","renderer","setRenderer","options","limit","spatialReference","getFeatures","close","gl","toFeatureSet","zoomToFeatureSet","msg","queryError","_onBtnResultsBackClicked","paramsContainer","extend"],"mappings":";;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEAA,OAAO,CACH,oBADG,EAEH,iBAFG,EAGH,kBAHG,EAIH,iBAJG,EAKH,kBALG,EAMH,eANG,EAOH,SAPG,EAQH,aARG,EASH,+BATG,EAUH,iBAVG,EAWH,oBAXG,EAYH,oBAZG,EAaH,qBAbG,EAcH,YAdG,EAeH,kBAfG,EAgBH,0BAhBG,EAiBH,+BAjBG,EAkBH,wBAlBG,EAmBH,4BAnBG,EAoBH,SApBG,EAqBH,4BArBG,EAsBH,+BAtBG,EAuBH,kBAvBG,EAwBH,eAxBG,EAyBH,6BAzBG,EA0BH,wBA1BG,CAAP,EA4BE,UAASC,OAAT,EAAkBC,IAAlB,EAAwBC,KAAxB,EAA+BC,IAA/B,EAAqCC,KAArC,EAA4CC,EAA5C,EAAgDC,EAAhD,EAAoDC,SAApD,EAA+DC,uBAA/D,EACEC,UADF,EACcC,OADd,EACuBC,OADvB,EACgCC,QADhC,EAC0CC,SAD1C,EACqDC,WADrD,EACkEC,YADlE,EACgFC,cADhF,EAEEC,eAFF,EAEmBC,eAFnB,EAEoCC,KAFpC,EAE2CC,UAF3C,EAEuDC,wBAFvD,EAEiFC,KAFjF,EAEwFC,IAFxF,EAE8F;;AAE5F,MAAIC,QAAQxB,QAAQ,CAACS,UAAD,EAAaD,uBAAb,CAAR,EAA+C;AACzDiB,UAAM,OADmD;AAEzDC,eAAW,mBAF8C;AAGzDC,mBAAe,KAH0C;AAIzDC,kBAAc,IAJ2C;AAKzDC,qBAAiB,IALwC;AAMzDC,iBAAa,IAN4C;AAOzDC,kBAAc,IAP2C;AAQzDC,mBAAe,IAR0C;;AAUzD;AACA;AACA;AACA;AACA;;AAEAC,iBAAa,uBAAW;AACtB,WAAKC,eAAL,GAAuB,EAAvB;AACD,KAlBwD;;AAoBzDC,wBAAoB,8BAAW;AAC7B,WAAKP,YAAL,GAAoB;AAClBQ,iBAAS,IADS;AAElBC,gBAAQ,IAFU;AAGlBC,mBAAW;AAHO,OAApB;AAKD,KA1BwD;;AA4BzDC,yBAAqB,+BAAW;AAC9B,WAAKC,SAAL,CAAeC,SAAf;AACA,WAAKC,kBAAL,GAA0B,IAA1B;AACA,WAAKC,GAAL,CAASC,QAAT,GAAoB,KAAKD,GAAL,CAASC,QAAT,IAAqB,UAAzC;AACA,WAAKD,GAAL,CAASE,aAAT,GAAyB,KAAKF,GAAL,CAASE,aAAT,IAA0B,eAAnD;AACA,WAAKF,GAAL,CAASG,YAAT,GAAwBC,OAAOC,OAAP,CAAeC,OAAf,CAAuBC,KAA/C;AACA,WAAKlB,aAAL,GAAqBZ,WAAW+B,eAAX,EAArB;AACA,WAAKC,wBAAL,GAAgC/B,yBAAyBgC,WAAzB,EAAhC;AACA,UAAI,KAAKhB,MAAT,EAAiB;AACf,aAAKiB,gBAAL;AACA,aAAKC,aAAL;AACD;AACF,KAxCwD;;AA0CzDA,mBAAe,yBAAW;AACxB,UAAI,KAAKlB,MAAL,IAAe,KAAKA,MAAL,CAAYmB,MAA3B,IAAqC,KAAKnB,MAAL,CAAYmB,MAAZ,CAAmBC,MAAnB,GAA4B,CAArE,EAAwE;AACtErD,cAAMsD,OAAN,CAAc,KAAKrB,MAAL,CAAYmB,MAA1B,EAAkCvD,KAAK0D,KAAL,CAAW,IAAX,EAAiB,UAASC,YAAT,EAAuB;AACxE,eAAKC,cAAL,CAAoBD,aAAaE,GAAjC,EAAsCF,aAAaG,MAAnD;AACD,SAFiC,CAAlC;AAGD;AACF,KAhDwD;;AAkDzDT,sBAAkB,4BAAW;AAC3B;AACA,UAAI,KAAKjB,MAAL,IAAe,KAAKA,MAAL,CAAYmB,MAA3B,IAAqC,KAAKnB,MAAL,CAAYmB,MAAZ,CAAmBC,MAAnB,GAA4B,CAArE,EAAwE;AACtErD,cAAMsD,OAAN,CAAc,KAAKrB,MAAL,CAAYmB,MAA1B,EAAkCvD,KAAK0D,KAAL,CAAW,IAAX,EAAiB,UAASC,YAAT,EAAuB;AACxE,cAAIA,aAAaI,aAAjB,EAAgC;AAC9B,gBAAIC,uBAAuB,KAAKjC,aAAL,CAAmBkC,uBAAnB,CAA2CN,aAAaI,aAAxD,CAA3B;AACA,gBAAIC,oBAAJ,EAA0B;AACxBL,2BAAaE,GAAb,GAAmBG,qBAAqBE,MAArB,EAAnB;AACD;AACF;AACF,SAPiC,CAAlC;AAQD;AACF,KA9DwD;;AAgEzDN,oBAAgB,wBAASC,GAAT,EAAcC,MAAd,EAAsB;AACpC,UAAI;AACF,YAAIA,MAAJ,EAAY;AACV,iBAAOA,OAAOK,IAAd;AACA,cAAIC,cAAc,IAAIvD,WAAJ,EAAlB;AACAuD,sBAAYC,QAAZ,GAAuBzD,UAAU0D,eAAV,CAA0BT,GAA1B,CAAvB;AACA;AACAO,sBAAYG,kBAAZ,CAA+BT,MAA/B;AACD;AACF,OARD,CAQE,OAAOU,CAAP,EAAU;AACVC,gBAAQC,GAAR,CAAYF,CAAZ;AACD;AACF,KA5EwD;;AA8EzDG,gBAAY,sBAAW;AACrB,WAAKpC,SAAL,CAAeC,SAAf;;AAEA,WAAKoC,aAAL,GAAqB,IAAIjE,QAAJ,CAAa;AAChCkE,eAAO,KAAKnC,GAAL,CAASoC;AADgB,OAAb,CAArB;;AAIA,WAAKF,aAAL,CAAmBG,OAAnB,CAA2B,KAAKC,gBAAhC;AACA,WAAKC,GAAL,CAAS5E,GAAG,KAAKuE,aAAR,EAAuB,QAAvB,EAAiC,YAAW;AACnD,aAAKM,uBAAL;AACD,OAFyC,CAExCC,IAFwC,CAEnC,IAFmC,CAAjC,CAAT;;AAIA,WAAKC,YAAL;AACA,WAAKC,YAAL;AACA;AACA,WAAKC,SAAL;AACD,KA9FwD;;AAgGzDC,YAAQ,kBAAW;AACjB,UAAI,KAAK3D,eAAT,EAA0B;AACxB,aAAKA,eAAL,CAAqB4D,IAArB;AACD;AACF,KApGwD;;AAsGzD;AACA;AACA;;AAEAC,gBAAY,sBAAW;AACrB;AACA,WAAKzC,OAAL,CAAa0C,UAAb;AACD,KA7GwD;;AA+GzDC,aAAS,mBAAW;AAClB,UAAI,KAAK/D,eAAT,EAA0B;AACxB,aAAKA,eAAL,CAAqBgE,IAArB;AACD;AACD,WAAKC,eAAL;AACA,WAAK7C,OAAL,CAAaC,KAAb;AACA;AACA,WAAKV,SAAL,CAAeC,SAAf;AACD,KAvHwD;;AAyHzDsD,YAAQ,kBAAW;AACjB;AACA,UAAIC,OAAO,KAAKC,SAAL,CAAeC,KAAf,CAAqBzE,IAArB,KAA8B,UAA9B,GAA2C,IAA3C,GAAkD,GAA7D;AACA0E,iBAAWlG,KAAK0D,KAAL,CAAW,IAAX,EAAiB,YAAW;AACrC,aAAKyC,oBAAL;AACA,aAAKC,OAAL,CAAaN,MAAb;AACD,OAHU,CAAX,EAGIC,IAHJ;AAID,KAhIwD;;AAkIzDM,aAAS,mBAAW;AAClB,WAAKC,iBAAL,CAAuB,IAAvB;AACA,WAAK/D,SAAL,CAAeC,SAAf;AACD,KArIwD;;AAuIzD+D,oBAAgB,0BAAW;AACzB,aAAO,KAAKnE,MAAL,IAAe,QAAO,KAAKA,MAAZ,MAAuB,QAA7C;AACD,KAzIwD;;AA2IzDgD,kBAAc,wBAAW;AACvB,WAAKpC,OAAL,GAAe,IAAItC,OAAJ,CAAY;AACzB8F,eAAO,CAAC,OAAD,EAAU,UAAV,EAAsB,SAAtB,CADkB;AAEzBC,aAAK,KAAKA,GAFe;AAGzBC,mBAAW,IAHc;AAIzBC,wBAAgB;AAJS,OAAZ,CAAf;AAMA,WAAK3D,OAAL,CAAa+B,OAAb,CAAqB,KAAK6B,UAA1B;AACA,WAAK5D,OAAL,CAAa6D,OAAb;AACD,KApJwD;;AAsJzDC,uBAAmB,6BAAW;AAC5B,UAAI,CAAC,KAAKjF,WAAV,EAAuB;AACrB;AACD;AACD;AACA,UAAIkF,cAAcC,SAASC,IAAT,CAAcC,WAAhC;AACA,UAAIC,eAAeH,SAASC,IAAT,CAAcG,YAAjC;AACA,UAAIC,SAAS,EAAb;AACA,UAAIC,QAAQP,cAAc,IAAIM,MAA9B;AACA,UAAIE,SAASJ,eAAe,IAAIE,MAAhC;AACA,UAAIC,QAAQ,GAAR,IAAeC,SAAS,GAA5B,EAAiC;AAC/B;AACD;AACD,UAAIC,YAAY,KAAKC,oBAAL,EAAhB;AACA,UAAIC,oBAAoB,CAAxB;AACA,UAAI,KAAKtB,OAAL,IAAgB,KAAKA,OAAL,CAAauB,iBAAb,IAAkC,CAAtD,EAAyD;AACvDD,4BAAoB,KAAKtB,OAAL,CAAauB,iBAAjC;AACD;AACD,UAAIC,aAAa,IAAI3G,eAAJ,CAAoB;AACnCwF,aAAK,KAAKA,GADyB;AAEnCe,mBAAWA,SAFwB;AAGnCK,sBAAc,IAHqB;AAInCC,yBAAiB,IAJkB;AAKnCC,sBAAc,KALqB;AAMnCC,iCAAyB,IANU;AAOnCN,2BAAmBA,iBAPgB;AAQnCO,eAAO;AAR4B,OAApB,CAAjB;AAUA,WAAKnG,YAAL,GAAoB,IAAIT,KAAJ,CAAU;AAC5BiG,eAAOA,KADqB;AAE5BC,gBAAQA,MAFoB;AAG5BW,oBAAY,KAAKxF,GAAL,CAASyF,YAHO;AAI5BC,iBAASR,UAJmB;AAK5BjC,iBAAS3F,KAAK0D,KAAL,CAAW,IAAX,EAAiB,YAAW;AACnCkE,qBAAWvB,OAAX;AACAuB,uBAAa,IAAb;AACA,eAAK9F,YAAL,GAAoB,IAApB;AACD,SAJQ;AALmB,OAAV,CAApB;AAWA;AACA,UAAIuG,qBAAqB,KAAKC,kBAAL,MAA6B,EAAtD;AACApC,iBAAWlG,KAAK0D,KAAL,CAAW,IAAX,EAAiB,YAAW;AACrCkE,mBAAWW,kBAAX,CAA8B,KAAKnC,OAAL,CAAaoC,YAA3C,EAAyD,KAAKpC,OAAL,CAAaqC,QAAtE,EAAgF,KAAKrC,OAAL,CAAahE,MAA7F,EACEiG,kBADF;AAED,OAHU,CAAX,EAGI,GAHJ;AAID,KAnMwD;;AAqMzDC,wBAAoB,8BAAW;AAC7B,UAAID,qBAAqB,IAAzB;AACA,UAAI,KAAK1G,YAAL,CAAkBS,MAAlB,IAA4B,OAAO,KAAKT,YAAL,CAAkBS,MAAlB,CAAyB2B,aAAhC,KAAkD,WAAlF,EAA+F;AAC7F,YAAI2E,UAAU,KAAK/G,YAAL,CAAkBS,MAAlB,CAAyB2B,aAAvC;AACA,YAAI,OAAO,KAAK9B,eAAL,CAAqByG,OAArB,CAAP,KAAyC,WAA7C,EAA0D;AACxDL,+BAAqB,KAAKpG,eAAL,CAAqByG,OAArB,CAArB;AACD,SAFD,MAEO;AACL,cAAIrG,YAAY,KAAKN,aAAL,CAAmB4G,gBAAnB,CAAoCD,OAApC,CAAhB;AACA,cAAIrG,SAAJ,EAAe;AACbgG,iCAAqBhG,UAAUuG,YAAV,EAArB;AACA,gBAAIP,kBAAJ,EAAwB;AACtB,mBAAKpG,eAAL,CAAqByG,OAArB,IAAgCL,kBAAhC;AACD;AACF;AACF;AACF;AACD,aAAOA,kBAAP;AACD,KAtNwD;;AAwNzDhD,kBAAc,wBAAW;AACvB,UAAImC,YAAY,KAAKC,oBAAL,EAAhB;AACA,WAAKrB,OAAL,GAAe,IAAInF,eAAJ,CAAoB;AACjCwF,aAAK,KAAKA,GADuB;AAEjCe,mBAAWA,SAFsB;AAGjCK,sBAAc,KAHmB;AAIjCC,yBAAiB,IAJgB;AAKjCC,sBAAc,IALmB;AAMjCC,iCAAyB;AANQ,OAApB,CAAf;AAQA,WAAK5B,OAAL,CAAarB,OAAb,CAAqB,KAAK8D,gBAA1B;AACA,WAAKzC,OAAL,CAAaS,OAAb;AACA,WAAK5B,GAAL,CAAS5E,GAAG,KAAK+F,OAAR,EAAiB,QAAjB,EAA2BpG,KAAK0D,KAAL,CAAW,IAAX,EAAiB,KAAKoD,iBAAtB,CAA3B,CAAT;AACD,KArOwD;;AAuOzDW,0BAAsB,gCAAW;AAC/B,UAAIqB,QAAQ,SAAZ;AACA,UAAI,KAAK9C,SAAL,CAAeC,KAAf,CAAqBzE,IAArB,KAA8B,gBAA9B,KACD,KAAKwE,SAAL,CAAeC,KAAf,CAAqB8C,MAArB,CAA4B,CAA5B,MAAmC,SAAnC,IAAgD,KAAK/C,SAAL,CAAeC,KAAf,CAAqB8C,MAArB,CAA4B,CAA5B,MAAmC,QADlF,CAAJ,EACiG;AAC/F;AACAD,gBAAQ,MAAR;AACD,OAJD,MAIO,IAAI,KAAK9C,SAAL,CAAeC,KAAf,CAAqBzE,IAArB,KAA8B,WAAlC,EAA+C;AACpD;AACAsH,gBAAQ,MAAR;AACD;AACD,aAAOA,KAAP;AACD,KAlPwD;;AAoPzDxD,eAAW,qBAAW;AACpB,UAAI0D,WAAWpI,UAAUqI,eAAV,EAAf;AACA,UAAIC,UAAU,WAAWF,QAAzB;AACA,WAAKG,eAAL,CAAqBC,GAArB,CAAyB,MAAzB,EAAiCF,OAAjC;AACA,WAAKG,cAAL,CAAoBD,GAApB,CAAwB,MAAxB,EAAgCF,OAAhC;;AAEA,WAAKxH,aAAL,GAAqB,KAAK6E,cAAL,EAArB;AACA,UAAI,CAAC,KAAK7E,aAAV,EAAyB;AACvBxB,aAAKoJ,QAAL,CAAc,KAAKC,UAAnB,EAA+B,SAA/B,EAA0C,MAA1C;AACArJ,aAAKoJ,QAAL,CAAc,KAAKE,iBAAnB,EAAsC;AACpCC,mBAAS,OAD2B;AAEpCC,gBAAM;AAF8B,SAAtC;AAIA;AACD;;AAED,UAAInG,SAAS,KAAKnB,MAAL,CAAYmB,MAAzB;;AAEA,UAAIA,OAAOC,MAAP,KAAkB,CAAtB,EAAyB;AACvBtD,aAAKoJ,QAAL,CAAc,KAAKC,UAAnB,EAA+B,SAA/B,EAA0C,MAA1C;AACArJ,aAAKoJ,QAAL,CAAc,KAAKK,iBAAnB,EAAsC,SAAtC,EAAiD,OAAjD;AACA;AACD;;AAEDxJ,YAAMsD,OAAN,CAAcF,MAAd,EAAsBvD,KAAK0D,KAAL,CAAW,IAAX,EAAiB,UAASC,YAAT,EAAuBiG,KAAvB,EAA8B;AACnE,YAAIpI,OAAOmC,aAAanC,IAAxB;AACA,YAAIqI,QAAQ,0DACV,4BADU,GAEV,wBAFU,GAGV,oCAHU,GAIV,OAJU,GAKV,uBALU,GAMV,2BANU,GAOV,OAPU,GAQV,OARF;AASA,YAAIC,KAAK5J,KAAK6J,KAAL,CAAWF,KAAX,CAAT;AACA,YAAIG,eAAe/J,MAAM,iBAAN,EAAyB6J,EAAzB,EAA6B,CAA7B,CAAnB;AACAE,qBAAaC,SAAb,GAAyBrJ,UAAUsJ,SAAV,CAAoB1I,IAApB,CAAzB;AACAtB,aAAKiK,KAAL,CAAWL,EAAX,EAAe,KAAKM,WAApB;AACAN,WAAGnG,YAAH,GAAkBA,YAAlB;AACA,YAAIiG,QAAQ,CAAR,KAAc,CAAlB,EAAqB;AACnB1J,eAAKmK,QAAL,CAAcP,EAAd,EAAkB,MAAlB;AACD,SAFD,MAEO;AACL5J,eAAKmK,QAAL,CAAcP,EAAd,EAAkB,KAAlB;AACD;AACF,OArBqB,CAAtB;AAsBD,KAlSwD;;AAoSzDxD,uBAAmB,4BAAU,YAAagE,SAAvB,EAAkC;AACnD,WAAKzE,eAAL;AACA,WAAK7C,OAAL,CAAaC,KAAb;AACA,WAAKsH,sBAAL;AACA,WAAKC,gBAAL;AACA;AACA;AACA,UAAI,CAACF,SAAL,EAAgB;AACd,aAAKG,2BAAL;AACD;AACDnK,gBAAUoK,KAAV,CAAgB,KAAKnB,UAArB;AACD,KA/SwD;;AAiTzDoB,YAAQ,gBAASC,GAAT,EAAcC,SAAd,EAAyBC,OAAzB,EAAkC;AACxC5K,WAAKoJ,QAAL,CAAcsB,GAAd,EAAmB,SAAnB,EAA8B,OAA9B;AACA1K,WAAKoJ,QAAL,CAAcsB,GAAd,EAAmB,MAAnB,EAA2BC,YAAY,GAAvC;AACAzK,SAAG2K,eAAH,CAAmB;AACjBC,cAAMJ,GADW;AAEjBK,oBAAY;AACVvB,gBAAM;AACJwB,mBAAOL,SADH;AAEJM,iBAAKL,OAFD;AAGJM,mBAAO;AAHH;AADI,SAFK;AASjBC,kBAAU,GATO;AAUjBC,eAAOtL,KAAK0D,KAAL,CAAW,IAAX,EAAiB,YAAW;AACjCxD,eAAKoJ,QAAL,CAAcsB,GAAd,EAAmB,MAAnB,EAA2BE,OAA3B;AACA,cAAIA,YAAY,CAAhB,EAAmB;AACjB5K,iBAAKoJ,QAAL,CAAcsB,GAAd,EAAmB,SAAnB,EAA8B,OAA9B;AACD,WAFD,MAEO;AACL1K,iBAAKoJ,QAAL,CAAcsB,GAAd,EAAmB,SAAnB,EAA8B,MAA9B;AACD;AACF,SAPM;AAVU,OAAnB,EAkBGW,IAlBH;AAmBD,KAvUwD;;AAyUzDC,yBAAqB,6BAASC,KAAT,EAAgB;AACnC,UAAIC,SAASD,MAAMC,MAAN,IAAgBD,MAAME,UAAnC;AACA,UAAI7B,KAAKlJ,UAAUgL,cAAV,CAAyBF,MAAzB,EAAiC1L,KAAK0D,KAAL,CAAW,IAAX,EAAiB,UAASkH,GAAT,EAAc;AACvE,eAAO1K,KAAK2L,QAAL,CAAcjB,GAAd,EAAmB,cAAnB,CAAP;AACD,OAFyC,CAAjC,EAEL,EAFK,CAAT;AAGA,WAAKkB,iBAAL,CAAuBhC,EAAvB;AACD,KA/UwD;;AAiVzDgC,uBAAmB,2BAAShC,EAAT,EAAa;AAC9B,UAAI,CAACA,EAAL,EAAS;AACP;AACD;;AAED,UAAInG,eAAemG,GAAGnG,YAAtB;AACA,WAAKzB,kBAAL;AACA,WAAKP,YAAL,CAAkBQ,OAAlB,GAA4B2H,EAA5B;AACA,WAAKnI,YAAL,CAAkBS,MAAlB,GAA2BpC,KAAK+L,KAAL,CAAWpI,YAAX,CAA3B;AACA,WAAKhC,YAAL,CAAkBU,SAAlB,GAA8B,KAAKV,YAAL,CAAkBQ,OAAlB,CAA0BE,SAAxD,CAT8B,CASqC;;AAEnEpC,YAAM,iBAAN,EAAyB,KAAKmK,WAA9B,EAA2C4B,WAA3C,CAAuD,mBAAvD;AACA9L,WAAKmK,QAAL,CAAc,KAAK1I,YAAL,CAAkBQ,OAAhC,EAAyC,mBAAzC;;AAEA,UAAI8J,WAAWjM,KAAK0D,KAAL,CAAW,IAAX,EAAiB,YAAW;AACzC,aAAK/B,YAAL,CAAkBU,SAAlB,GAA8B,KAAKV,YAAL,CAAkBQ,OAAlB,CAA0BE,SAAxD;AACA,aAAK6J,2BAAL;AACD,OAHc,CAAf;;AAKA,UAAI,KAAKvK,YAAL,CAAkBQ,OAAlB,CAA0BE,SAA9B,EAAyC;AACvC4J;AACD,OAFD,MAEO;AACL,aAAKE,OAAL,CAAa3G,IAAb;;AAEA,YAAInD,YAAY,IAAhB;AACA,YAAI,KAAKV,YAAL,CAAkBS,MAAlB,IAA4B,OAAO,KAAKT,YAAL,CAAkBS,MAAlB,CAAyB2B,aAAhC,KAAkD,WAAlF,EAA+F;AAC7F,cAAI2E,UAAU,KAAK/G,YAAL,CAAkBS,MAAlB,CAAyB2B,aAAvC;AACA1B,sBAAY,KAAKN,aAAL,CAAmB4G,gBAAnB,CAAoCD,OAApC,CAAZ;AACD;;AAED,YAAIrG,SAAJ,EAAe;AACbA,oBAAU+J,oBAAV,GAAiCC,IAAjC,CAAsCrM,KAAK0D,KAAL,CAAW,IAAX,EAAiB,UAAS4I,QAAT,EAAmB;AACxE,gBAAI,CAAC,KAAKC,OAAV,EAAmB;AACjB;AACD;AACD,iBAAKJ,OAAL,CAAavG,IAAb;AACA,iBAAKjE,YAAL,CAAkBQ,OAAlB,CAA0BE,SAA1B,GAAsCiK,QAAtC;AACA,iBAAK3K,YAAL,CAAkBU,SAAlB,GAA8B,KAAKV,YAAL,CAAkBQ,OAAlB,CAA0BE,SAAxD;AACA4J;AACD,WARqC,CAAtC,EAQIjM,KAAK0D,KAAL,CAAW,IAAX,EAAiB,UAAS8I,GAAT,EAAc;AACjC/H,oBAAQgI,KAAR,CAAcD,GAAd;AACA,gBAAI,CAAC,KAAKD,OAAV,EAAmB;AACjB;AACD;AACD,iBAAKJ,OAAL,CAAavG,IAAb;AACA,gBAAI8G,SAAS,EAAb;AACA,gBAAIF,OAAOA,IAAIG,QAAJ,KAAiB,GAA5B,EAAiC;AAC/BD,uBAAS,KAAKhK,GAAL,CAASkK,gBAAlB;AACD;AACD,iBAAKC,kBAAL,CAAwBH,MAAxB;AACD,WAXG,CARJ;AAoBD,SArBD,MAqBO;AACL,cAAII,WAAW,KAAKnL,YAAL,CAAkBS,MAAlB,CAAyByB,GAAxC;AACA,eAAKV,wBAAL,CAA8BiJ,oBAA9B,CAAmDU,QAAnD,EACGT,IADH,CACQrM,KAAK0D,KAAL,CAAW,IAAX,EAAiB,UAAS4I,QAAT,EAAmB;AACxC,gBAAI,CAAC,KAAKC,OAAV,EAAmB;AACjB;AACD;AACD,iBAAKJ,OAAL,CAAavG,IAAb;AACA,iBAAKjE,YAAL,CAAkBQ,OAAlB,CAA0BE,SAA1B,GAAsCiK,QAAtC;AACA,iBAAK3K,YAAL,CAAkBU,SAAlB,GAA8B,KAAKV,YAAL,CAAkBQ,OAAlB,CAA0BE,SAAxD;AACA4J;AACD,WARK,CADR,EASMjM,KAAK0D,KAAL,CAAW,IAAX,EAAiB,UAAS8I,GAAT,EAAc;AACjC/H,oBAAQgI,KAAR,CAAcD,GAAd;AACA,gBAAI,CAAC,KAAKD,OAAV,EAAmB;AACjB;AACD;AACD,iBAAKJ,OAAL,CAAavG,IAAb;AACA,gBAAI8G,SAAS,EAAb;AACA,gBAAIF,OAAOA,IAAIG,QAAJ,KAAiB,GAA5B,EAAiC;AAC/BD,uBAAS,KAAKhK,GAAL,CAASkK,gBAAlB;AACD;AACD,iBAAKC,kBAAL,CAAwBH,MAAxB;AACD,WAXG,CATN;AAqBD;AACF;AACF,KA7ZwD;;AA+ZzDjC,iCAA6B,uCAAW;AACtCvK,WAAKoJ,QAAL,CAAc,KAAKyD,SAAnB,EAA8B,SAA9B,EAAyC,OAAzC;;AAEA,UAAI7M,KAAK8M,QAAL,CAAc,KAAKC,WAAnB,EAAgC,SAAhC,MAA+C,OAAnD,EAA4D;AAC1D,aAAKtC,MAAL,CAAY,KAAKoC,SAAjB,EAA4B,CAAC,GAA7B,EAAkC,CAAlC;AACA,aAAKpC,MAAL,CAAY,KAAKsC,WAAjB,EAA8B,CAA9B,EAAiC,GAAjC;AACD,OAHD,MAGO,IAAI/M,KAAK8M,QAAL,CAAc,KAAKE,YAAnB,EAAiC,SAAjC,MAAgD,OAApD,EAA6D;AAClE,aAAKvC,MAAL,CAAY,KAAKoC,SAAjB,EAA4B,CAAC,GAA7B,EAAkC,CAAlC;AACA,aAAKpC,MAAL,CAAY,KAAKuC,YAAjB,EAA+B,CAA/B,EAAkC,GAAlC;AACD;AACF,KAzawD;;AA2azDhI,6BAAyB,mCAAW;AAClC,UAAI,KAAKN,aAAL,CAAmBuI,OAAvB,EAAgC;AAC9BjN,aAAKoJ,QAAL,CAAc,KAAK8D,gBAAnB,EAAqC,SAArC,EAAgD,OAAhD;AACD,OAFD,MAEO;AACLlN,aAAKoJ,QAAL,CAAc,KAAK8D,gBAAnB,EAAqC,SAArC,EAAgD,MAAhD;AACD;;AAED,UAAI,KAAKjE,eAAL,CAAqBgE,OAAzB,EAAkC;AAChC,aAAKE,yBAAL;AACD,OAFD,MAEO;AACL,aAAKC,wBAAL;AACD;;AAED,WAAKC,aAAL;AACD,KAzbwD;;AA2bzDF,+BAA2B,qCAAW;AACpC,UAAI,KAAKlE,eAAL,CAAqBgE,OAAzB,EAAkC;AAChC,aAAKI,aAAL;AACArN,aAAKoJ,QAAL,CAAc,KAAK1C,UAAnB,EAA+B,SAA/B,EAA0C,MAA1C;AACD;AACF,KAhcwD;;AAkczD0G,8BAA0B,oCAAW;AACnC,UAAI,KAAKjE,cAAL,CAAoB8D,OAAxB,EAAiC;AAC/BjN,aAAKoJ,QAAL,CAAc,KAAK1C,UAAnB,EAA+B,SAA/B,EAA0C,OAA1C;AACD;AACF,KAtcwD;;AAwczD4G,2BAAuB,iCAAW;AAChC,UAAI,KAAKpD,WAAL,CAAiBqD,iBAAjB,KAAuC,CAA3C,EAA8C;AAC5C;AACD;;AAED,UAAIC,qBAAqB,KAAKX,SAAL,CAAe9E,KAAf,CAAqBwB,OAArB,KAAiC,MAA1D;AACA,UAAIa,YAAYoD,kBAAhB;AACA,WAAKpH,iBAAL,CAAuBgE,SAAvB;AACD,KAhdwD;;AAkdzDiD,mBAAe,yBAAW;AACxB,WAAKvK,OAAL,CAAa0C,UAAb;AACA,WAAK1C,OAAL,CAAaC,KAAb;AACD,KArdwD;;AAudzD0K,2BAAuB,iCAAW;AAChC,WAAK/I,aAAL,CAAmBgJ,QAAnB,CAA4B,KAA5B;AACA,WAAK1I,uBAAL;AACA,WAAKqI,aAAL;AACD,KA3dwD;;AA6dzDrB,iCAA6B,uCAAW;AACtC;AACA,WAAKyB,qBAAL;AACA;AACA;AACA,UAAIE,UAAU,KAAKZ,WAAnB;AACA,UAAIa,UAAU,KAAKZ,YAAnB;;AAEAhN,WAAKoJ,QAAL,CAAc,KAAKyD,SAAnB,EAA8B;AAC5BrD,cAAM,CADsB;AAE5BD,iBAAS;AAFmB,OAA9B;;AAKAvJ,WAAKoJ,QAAL,CAAcuE,OAAd,EAAuB;AACrBnE,cAAM,MADe;AAErBD,iBAAS;AAFY,OAAvB;;AAKAvJ,WAAKoJ,QAAL,CAAcwE,OAAd,EAAuB,SAAvB,EAAkC,MAAlC;AACA,WAAKnD,MAAL,CAAY,KAAKoC,SAAjB,EAA4B,CAA5B,EAA+B,CAAC,GAAhC;AACA,WAAKpC,MAAL,CAAYkD,OAAZ,EAAqB,GAArB,EAA0B,CAA1B;AACA;AACAvN,gBAAUoK,KAAV,CAAgB,KAAK9F,aAAL,CAAmB2H,OAAnC;AACD,KApfwD;;AAsfzDwB,6BAAyB,mCAAW;AAClC,WAAKR,aAAL;AACArN,WAAKoJ,QAAL,CAAc,KAAKyD,SAAnB,EAA8B,SAA9B,EAAyC,OAAzC;AACA7M,WAAKoJ,QAAL,CAAc,KAAK2D,WAAnB,EAAgC,SAAhC,EAA2C,OAA3C;AACA/M,WAAKoJ,QAAL,CAAc,KAAK4D,YAAnB,EAAiC,SAAjC,EAA4C,MAA5C;AACA,WAAKvC,MAAL,CAAY,KAAKoC,SAAjB,EAA4B,CAAC,GAA7B,EAAkC,CAAlC;AACA,WAAKpC,MAAL,CAAY,KAAKsC,WAAjB,EAA8B,CAA9B,EAAiC,GAAjC;AACA;AACA3M,gBAAUoK,KAAV,CAAgB,KAAKnB,UAArB;AACD,KA/fwD;;AAigBzD;AACAyE,wBAAoB,8BAAW;AAC7B;AACA,WAAKxD,gBAAL;AACA;;AAEA,UAAIyD,QAAQ,KAAKtM,YAAL,CAAkBS,MAAlB,CAAyB0B,MAAzB,CAAgCK,IAA5C;AACA,UAAI+J,WAAW,IAAf;;AAEA,UAAI,KAAKtJ,aAAL,CAAmBuI,OAAvB,EAAgC;AAC9B,YAAI,KAAKhE,eAAL,CAAqBgE,OAAzB,EAAkC;AAChCe,qBAAW,KAAKzH,GAAL,CAAS0H,MAApB;AACD,SAFD,MAEO;AACL,cAAIC,KAAK,KAAKpL,OAAL,CAAaqL,SAAb,CAAuBC,QAAhC;AACA,cAAIF,GAAG5K,MAAH,GAAY,CAAhB,EAAmB;AACjB,gBAAI+K,IAAIH,GAAG,CAAH,CAAR;AACAF,uBAAWK,EAAEL,QAAb;AACD;AACF;AACD,YAAI,CAACA,QAAL,EAAe;AACb,cAAIzN,OAAJ,CAAY;AACV+N,qBAAS,KAAK9L,GAAL,CAAS+L;AADR,WAAZ;AAGA;AACD;AACF;;AAED,UAAI,KAAK7M,eAAT,EAA0B;AACxB,aAAK6E,GAAL,CAASiI,WAAT,CAAqB,KAAK9M,eAA1B;AACD;AACD,WAAKA,eAAL,GAAuB,IAAvB;;AAEA;AACA,WAAK+M,uBAAL;;AAEA,WAAKpB,aAAL;;AAEArN,WAAKoJ,QAAL,CAAc,KAAKyD,SAAnB,EAA8B,SAA9B,EAAyC,MAAzC;AACA7M,WAAKoJ,QAAL,CAAc,KAAK2D,WAAnB,EAAgC,SAAhC,EAA2C,OAA3C;AACA/M,WAAKoJ,QAAL,CAAc,KAAK4D,YAAnB,EAAiC,SAAjC,EAA4C,OAA5C;AACA,WAAKvC,MAAL,CAAY,KAAKsC,WAAjB,EAA8B,CAA9B,EAAiC,CAAC,GAAlC;AACA,WAAKtC,MAAL,CAAY,KAAKuC,YAAjB,EAA+B,GAA/B,EAAoC,CAApC;;AAEA;AACA5M,gBAAUoK,KAAV,CAAgB,KAAK7B,gBAArB;;AAEA,UAAIlF,eAAe,KAAKhC,YAAL,CAAkBS,MAArC;AACA,UAAIwM,YAAY,EAAhB;AACA,UAAIC,OAAOlL,aAAakL,IAAxB;AACA,UAAIA,SAAS,SAAb,EAAwB;AACtBD,oBAAY5O,KAAK+L,KAAL,CAAWpI,aAAamL,WAAxB,CAAZ;AACA,YAAIF,UAAUG,OAAV,CAAkBpL,aAAaqL,UAA/B,IAA6C,CAAjD,EAAoD;AAClDJ,oBAAUK,IAAV,CAAetL,aAAaqL,UAA5B;AACD;AACF,OALD,MAKO,IAAIH,SAAS,UAAb,EAAyB;AAC9BD,oBAAY5O,KAAK+L,KAAL,CAAWpI,aAAamL,WAAxB,CAAZ;AACA,YAAIF,UAAUG,OAAV,CAAkBpL,aAAauL,aAA/B,IAAgD,CAApD,EAAuD;AACrDN,oBAAUK,IAAV,CAAetL,aAAauL,aAA5B;AACD;AACF,OALM,MAKA,IAAIL,SAAS,OAAb,EAAsB;AAC3BD,oBAAY,CAACjL,aAAauL,aAAd,CAAZ;AACD,OAFM,MAEA,IAAIL,SAAS,OAAb,EAAsB;AAC3BD,oBAAY5O,KAAK+L,KAAL,CAAWpI,aAAamL,WAAxB,CAAZ;AACD;;AAED,WAAK3C,OAAL,CAAa3G,IAAb;AACA;AACA,UAAI6C,qBAAqB,KAAKC,kBAAL,MAA6B,EAAtD;AACA,UAAI6G,WAAW,KAAKC,kBAAL,CAAwB,KAAKzN,YAAL,CAAkBS,MAAlB,CAAyB2B,aAAjD,CAAf;AACA,UAAIoL,QAAJ,EAAc;AACZlB,gBAAQ,MAAMkB,QAAN,GAAiB,QAAjB,GAA4B,GAA5B,GAAkClB,KAAlC,GAA0C,GAAlD;AACD;AACD,WAAKoB,MAAL,CAAYpB,KAAZ,EAAmBW,SAAnB,EAA8BV,QAA9B,EAAwC7B,IAAxC,CAA6CrM,KAAK0D,KAAL,CAAW,IAAX,EAAiB,UAAS4I,QAAT,EAAmB;AAC/E;AACA,YAAI,CAAC,KAAKC,OAAV,EAAmB;AACjB;AACD;AACD,aAAKJ,OAAL,CAAavG,IAAb;AACA,YAAI0G,SAASgD,MAAT,GAAkB,CAAtB,EAAyB;AACvB;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,cAAIC,OAAO;AACT/G,0BAAc,KAAK5G,eADV;AAET6G,sBAAU6D,SAAS7D,QAFV;AAGTrG,oBAAQuB;AAHC,WAAX;;AAMA,eAAK9B,WAAL,GAAmB0N,IAAnB;;AAEA;AACA,eAAKpJ,oBAAL;;AAEA;AACA;AACA,eAAKC,OAAL,CAAamC,kBAAb,CAAgCgH,KAAK/G,YAArC,EAAmD+G,KAAK9G,QAAxD,EAAkE8G,KAAKnN,MAAvE,EAA+EiG,kBAA/E;;AAEA;AACAlI,gBAAMsD,OAAN,CAAc6I,SAAS7D,QAAvB,EAAiCzI,KAAK0D,KAAL,CAAW,IAAX,EAAiB,UAAS8L,OAAT,EAAkB;AAClE,gBAAItB,WAAWsB,QAAQtB,QAAvB;AACA,gBAAI,CAACA,QAAL,EAAe;AACb;AACD;AACD;AACA,gBAAIA,SAASuB,IAAT,KAAkB,OAAtB,EAA+B;AAC7B;AACA,kBAAI7O,UAAU8O,oBAAV,CAA+BxB,QAA/B,CAAJ,EAA8C;AAC5C,qBAAKtM,eAAL,CAAqB+N,GAArB,CAAyBH,OAAzB;AACD;AACF,aALD,MAKO;AACL,mBAAK5N,eAAL,CAAqB+N,GAArB,CAAyBH,OAAzB;AACD;AACF,WAdgC,CAAjC;;AAgBA,eAAKI,YAAL,CAAkB,KAAKhO,eAAvB;AACD;AACF,OAjD4C,CAA7C,EAiDI5B,KAAK0D,KAAL,CAAW,IAAX,EAAiB,UAAS8I,GAAT,EAAc;AACjC/H,gBAAQgI,KAAR,CAAcD,GAAd;AACA,YAAI,CAAC,KAAKD,OAAV,EAAmB;AACjB;AACD;AACD,aAAKJ,OAAL,CAAavG,IAAb;AACA,aAAK2E,sBAAL;AACD,OAPG,CAjDJ;AAyDD,KAloBwD;;AAooBzD6E,wBAAoB,4BAASrL,aAAT,EAAwB;AAC1C,UAAIoL,WAAW,EAAf;AACA;AACA,UAAIpL,aAAJ,EAAmB;AACjB,YAAI8L,OAAO,IAAX;AACA,YAAI,KAAKlO,YAAL,CAAkBU,SAAlB,CAA4BoN,IAA5B,KAAqC,OAAzC,EAAkD;AAChDI,iBAAO,KAAK9N,aAAL,CAAmB+N,gBAAnB,CAAoC/L,aAApC,CAAP;AACD,SAFD,MAEO;AACL8L,iBAAO,KAAK9N,aAAL,CAAmB4G,gBAAnB,CAAoC5E,aAApC,CAAP;AACD;AACD,YAAI8L,IAAJ,EAAU;AACRV,qBAAWU,KAAKE,SAAL,EAAX;AACD;AACF;AACD,aAAOZ,QAAP;AACD,KAnpBwD;;AAqpBzDhJ,0BAAsB,gCAAW;AAC/B,UAAI6J,MAAM9P,KAAK+P,aAAL,CAAmB,KAAK1D,OAAxB,CAAV;AACA,UAAI2D,IAAIC,KAAKC,GAAL,CAASJ,IAAIE,CAAJ,GAAQ,GAAjB,EAAsB,GAAtB,CAAR;;AAEA;AACAhQ,WAAKoJ,QAAL,CAAc,KAAKlD,OAAL,CAAamG,OAA3B,EAAoC,QAApC,EAA8C2D,IAAI,IAAlD;AACD,KA3pBwD;;AA6pBzDvB,6BAAyB,mCAAW;AAClC,WAAKpE,sBAAL;AACA,UAAIlI,YAAYrC,KAAK+L,KAAL,CAAW,KAAKpK,YAAL,CAAkBU,SAA7B,CAAhB;;AAEA;AACA;AACA;AACA,UAAI,CAACA,UAAUgO,WAAf,EAA4B;AAC1BhO,kBAAUgO,WAAV,GAAwB,EAAxB;AACD;;AAEDhO,gBAAUgO,WAAV,CAAsBC,YAAtB,GAAqC,CAArC;AACAjO,gBAAUkO,QAAV,GAAqB,CAArB;AACAlO,gBAAUmO,QAAV,GAAqB,CAArB;AACAnO,gBAAUoO,iBAAV,GAA8B,CAA9B;AACApO,gBAAUqO,iBAAV,GAA8B,CAA9B;AACArO,gBAAUsO,iBAAV,GAA8B,IAA9B;AACA,aAAOtO,UAAU8L,MAAjB;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,UAAIyC,oBAAoB;AACtBC,yBAAiBxO,SADK;AAEtByO,oBAAY;AAFU,OAAxB;;AAKA;AACA,WAAKlP,eAAL,GAAuB,IAAId,YAAJ,CAAiB8P,iBAAjB,CAAvB;AACA,WAAKnK,GAAL,CAASsK,QAAT,CAAkB,KAAKnP,eAAvB;;AAEA,UAAIoP,SAAShQ,gBAAgBiQ,QAAhB,CAAyB,KAAKtP,YAAL,CAAkBS,MAAlB,CAAyB4O,MAAlD,CAAb;AACA,UAAIE,WAAW,IAAInQ,cAAJ,CAAmBiQ,MAAnB,CAAf;;AAEA;AACA,WAAKpP,eAAL,CAAqBuP,WAArB,CAAiCD,QAAjC;AACD,KApsBwD;;AAssBzD3G,4BAAwB,kCAAW;AACjC,UAAI,KAAK3I,eAAT,EAA0B;AACxB,aAAK6E,GAAL,CAASiI,WAAT,CAAqB,KAAK9M,eAA1B;AACD;AACD,WAAKA,eAAL,GAAuB,IAAvB;AACD,KA3sBwD;;AA6sBzD;AACAyN,YAAQ,gBAASpB,KAAT,EAAgBW,SAAhB,EAA2B,YAAaV,QAAxC,EAAkD;AACxD,UAAI,CAACD,KAAL,EAAY;AACVA,gBAAQ,KAAR;AACD;;AAED,UAAImD,UAAU,EAAd;AACAA,cAAQvN,GAAR,GAAc,KAAKlC,YAAL,CAAkBS,MAAlB,CAAyByB,GAAvC;AACAuN,cAAQ/O,SAAR,GAAoB,KAAKV,YAAL,CAAkBU,SAAtC;AACA+O,cAAQC,KAAR,GAAgB,KAAK,IAArB;AACAD,cAAQE,gBAAR,GAA2B,KAAK7K,GAAL,CAAS6K,gBAApC;AACAF,cAAQnD,KAAR,GAAgBA,KAAhB;AACAmD,cAAQlD,QAAR,GAAmBA,QAAnB;AACAkD,cAAQxC,SAAR,GAAoBA,SAApB;;AAEA,UAAI3O,QAAQ,IAAIiB,KAAJ,CAAUkQ,OAAV,CAAZ;AACA,aAAOnR,MAAMsR,WAAN,EAAP;AACD,KA9tBwD;;AAguBzD/G,sBAAkB,4BAAW;AAC3B,UAAI,KAAK1I,YAAT,EAAuB;AACrB,aAAKA,YAAL,CAAkB0P,KAAlB;AACA,aAAK1P,YAAL,GAAoB,IAApB;AACD;AACD,WAAKD,WAAL,GAAmB,IAAnB;AACA,WAAKuE,OAAL,CAAanD,KAAb;AACA,WAAK4C,eAAL;AACD,KAxuBwD;;AA0uBzD+J,kBAAc,sBAAS6B,EAAT,EAAa;AACzB,UAAInD,QAAJ;AACA,UAAImD,GAAGnD,QAAH,IAAemD,GAAGnD,QAAH,CAAY9K,MAAZ,GAAqB,CAAxC,EAA2C;AACzC;AACA;AACA8K,mBAAWmD,GAAGnD,QAAH,CAAYxK,MAAZ,CAAmB,UAASyK,CAAT,EAAY;AACxC,cAAIL,WAAWK,EAAEL,QAAjB;AACA;AACA,cAAIA,SAASuB,IAAT,KAAkB,OAAtB,EAA+B;AAC7B,mBAAO,IAAP;AACD,WAFD,MAEO;AACL,mBAAO7O,UAAU8O,oBAAV,CAA+BxB,QAA/B,CAAP;AACD;AACF,SAR6B,CAQ5B/I,IAR4B,CAQvB,IARuB,CAAnB,CAAX;AASD;AACD,UAAImJ,YAAYA,SAAS9K,MAAT,GAAkB,CAAlC,EAAqC;AACnC,YAAIsN,aAAalQ,UAAU8Q,YAAV,CAAuBpD,QAAvB,CAAjB;AACA,YAAI;AACF1N,oBAAU+Q,gBAAV,CAA2B,KAAKlL,GAAhC,EAAqCqK,UAArC;AACD,SAFD,CAEE,OAAOtM,CAAP,EAAU;AACVC,kBAAQgI,KAAR,CAAcjI,CAAd;AACD;AACF;AACF,KAjwBwD;;AAmwBzDqI,wBAAoB,6BAAU,cAAe+E,GAAzB,EAA8B;AAChD,UAAInR,OAAJ,CAAY;AACV+N,iBAASoD,OAAO,KAAKlP,GAAL,CAASmP;AADf,OAAZ;AAGD,KAvwBwD;;AAywBzDhM,qBAAiB,2BAAW,CAAE,CAzwB2B;;AA2wBzDiM,8BAA0B,oCAAW;AACnC,UAAIjE,OAAJ,EAAaC,OAAb;;AAEAD,gBAAU,KAAKZ,WAAf;AACAa,gBAAU,KAAKf,SAAf;;AAEA7M,WAAKoJ,QAAL,CAAcwE,OAAd,EAAuB,SAAvB,EAAkC,MAAlC;AACA5N,WAAKoJ,QAAL,CAAcuE,OAAd,EAAuB;AACrBpE,iBAAS,OADY;AAErBC,cAAM;AAFe,OAAvB;AAIA,WAAKiB,MAAL,CAAYkD,OAAZ,EAAqB,CAAC,GAAtB,EAA2B,CAA3B;AACA,WAAKlD,MAAL,CAAY,KAAKuC,YAAjB,EAA+B,CAA/B,EAAkC,GAAlC;AACA;AACA5M,gBAAUoK,KAAV,CAAgB,KAAKqH,eAArB;AACD;AA1xBwD,GAA/C,CAAZ;;AA6xBAxQ,QAAMyQ,MAAN,CAAa1Q,IAAb,EA/xB4F,CA+xBxE;AACpB,SAAOC,KAAP;AACD,CA/zBH","file":"Widget.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n    'dojo/_base/declare',\r\n    'dojo/_base/lang',\r\n    'dojo/_base/query',\r\n    'dojo/_base/html',\r\n    'dojo/_base/array',\r\n    'dojo/_base/fx',\r\n    'dojo/on',\r\n    'dijit/focus',\r\n    'dijit/_WidgetsInTemplateMixin',\r\n    'jimu/BaseWidget',\r\n    'jimu/dijit/Message',\r\n    'jimu/dijit/DrawBox',\r\n    \"jimu/dijit/CheckBox\",\r\n    'jimu/utils',\r\n    'jimu/filterUtils',\r\n    'esri/layers/FeatureLayer',\r\n    'esri/renderers/SimpleRenderer',\r\n    'esri/symbols/jsonUtils',\r\n    'jimu/dijit/StatisticsChart',\r\n    './Query',\r\n    'jimu/LayerInfos/LayerInfos',\r\n    'jimu/ServiceDefinitionManager',\r\n    'jimu/dijit/Popup',\r\n    './a11y/Widget',\r\n    'jimu/dijit/LoadingIndicator',\r\n    'dijit/form/RadioButton'\r\n  ],\r\n  function(declare, lang, query, html, array, fx, on, focusUtil, _WidgetsInTemplateMixin,\r\n    BaseWidget, Message, DrawBox, CheckBox, jimuUtils, FilterUtils, FeatureLayer, SimpleRenderer,\r\n    symbolJsonUtils, StatisticsChart, Query, LayerInfos, ServiceDefinitionManager, Popup, a11y) {\r\n\r\n    var clazz = declare([BaseWidget, _WidgetsInTemplateMixin], {\r\n      name: 'Chart',\r\n      baseClass: 'jimu-widget-chart',\r\n      isValidConfig: false,\r\n      currentAttrs: null,\r\n      tempResultLayer: null,\r\n      previewArgs: null,\r\n      previewPopup: null,\r\n      layerInfosObj: null,\r\n\r\n      //test:\r\n      //http://sampleserver6.arcgisonline.com/arcgis/rest/services/USA/MapServer\r\n      //http://map.floridadisaster.org/GIS/rest/services/Events/FL511_Feeds/MapServer/4\r\n      //http://maps.usu.edu/ArcGIS/rest/services/MudLake/MudLakeMonitoringSites/MapServer/0\r\n      //http://sampleserver6.arcgisonline.com/arcgis/rest/services/SampleWorldCities/MapServer/1\r\n\r\n      constructor: function() {\r\n        this.cachePopUpInfos = {};\r\n      },\r\n\r\n      _resetCurrentAttrs: function() {\r\n        this.currentAttrs = {\r\n          chartTr: null,\r\n          config: null,\r\n          layerInfo: null\r\n        };\r\n      },\r\n\r\n      postMixInProperties: function() {\r\n        this.inherited(arguments);\r\n        this.isRenderIdForAttrs = true;\r\n        this.nls.colorful = this.nls.colorful || \"Colorful\";\r\n        this.nls.monochromatic = this.nls.monochromatic || \"Monochromatic\";\r\n        this.nls.clearResults = window.jimuNls.drawBox.clear;\r\n        this.layerInfosObj = LayerInfos.getInstanceSync();\r\n        this.serviceDefinitionManager = ServiceDefinitionManager.getInstance();\r\n        if (this.config) {\r\n          this._setUrlForConfig();\r\n          this._updateConfig();\r\n        }\r\n      },\r\n\r\n      _updateConfig: function() {\r\n        if (this.config && this.config.charts && this.config.charts.length > 0) {\r\n          array.forEach(this.config.charts, lang.hitch(this, function(singleConfig) {\r\n            this._rebuildFilter(singleConfig.url, singleConfig.filter);\r\n          }));\r\n        }\r\n      },\r\n\r\n      _setUrlForConfig: function() {\r\n        //set url attribute of config if webMapLayerId is set\r\n        if (this.config && this.config.charts && this.config.charts.length > 0) {\r\n          array.forEach(this.config.charts, lang.hitch(this, function(singleConfig) {\r\n            if (singleConfig.webMapLayerId) {\r\n              var layerInfoOrTableInfo = this.layerInfosObj.getLayerOrTableInfoById(singleConfig.webMapLayerId);\r\n              if (layerInfoOrTableInfo) {\r\n                singleConfig.url = layerInfoOrTableInfo.getUrl();\r\n              }\r\n            }\r\n          }));\r\n        }\r\n      },\r\n\r\n      _rebuildFilter: function(url, filter) {\r\n        try {\r\n          if (filter) {\r\n            delete filter.expr;\r\n            var filterUtils = new FilterUtils();\r\n            filterUtils.isHosted = jimuUtils.isHostedService(url);\r\n            //make sure filter.expr is correct\r\n            filterUtils.getExprByFilterObj(filter);\r\n          }\r\n        } catch (e) {\r\n          console.log(e);\r\n        }\r\n      },\r\n\r\n      postCreate: function() {\r\n        this.inherited(arguments);\r\n\r\n        this.cbxUseSpatial = new CheckBox({\r\n          label: this.nls.useSpatialFilter\r\n        });\r\n\r\n        this.cbxUseSpatial.placeAt(this.cbxUseSpatialDiv);\r\n        this.own(on(this.cbxUseSpatial, 'change', function() {\r\n          this._onCbxUseSpatialClicked();\r\n        }.bind(this)));\r\n\r\n        this._initDrawBox();\r\n        this._initPreview();\r\n        // this._resetAndAddTempResultLayer();\r\n        this._initSelf();\r\n      },\r\n\r\n      onOpen: function() {\r\n        if (this.tempResultLayer) {\r\n          this.tempResultLayer.show();\r\n        }\r\n      },\r\n\r\n      // onActive: function(){\r\n      //   this.map.setInfoWindowOnClick(false);\r\n      // },\r\n\r\n      onDeActive: function() {\r\n        //deactivate method of DrawBox dijit will call this.map.setInfoWindowOnClick(true) inside\r\n        this.drawBox.deactivate();\r\n      },\r\n\r\n      onClose: function() {\r\n        if (this.tempResultLayer) {\r\n          this.tempResultLayer.hide();\r\n        }\r\n        this._hideInfoWindow();\r\n        this.drawBox.clear();\r\n        // this.preview.onClose();\r\n        this.inherited(arguments);\r\n      },\r\n\r\n      resize: function() {\r\n        //.box-frame in BoxTheme uses 1s to do transition.\r\n        var time = this.appConfig.theme.name === \"BoxTheme\" ? 1100 : 100;\r\n        setTimeout(lang.hitch(this, function() {\r\n          this._updatePreviewHeight();\r\n          this.preview.resize();\r\n        }), time);\r\n      },\r\n\r\n      destroy: function() {\r\n        this._clickClearButton(true);\r\n        this.inherited(arguments);\r\n      },\r\n\r\n      _isConfigValid: function() {\r\n        return this.config && typeof this.config === 'object';\r\n      },\r\n\r\n      _initDrawBox: function() {\r\n        this.drawBox = new DrawBox({\r\n          types: ['point', 'polyline', 'polygon'],\r\n          map: this.map,\r\n          showClear: true,\r\n          keepOneGraphic: true\r\n        });\r\n        this.drawBox.placeAt(this.drawBoxDiv);\r\n        this.drawBox.startup();\r\n      },\r\n\r\n      _createBigPreview: function() {\r\n        if (!this.previewArgs) {\r\n          return;\r\n        }\r\n        //60 75\r\n        var windowWidth = document.body.clientWidth;\r\n        var windowHeight = document.body.clientHeight;\r\n        var margin = 20;\r\n        var width = windowWidth - 2 * margin;\r\n        var height = windowHeight - 2 * margin;\r\n        if (width < 100 || height < 100) {\r\n          return;\r\n        }\r\n        var fontColor = this._getDefaultFontColor();\r\n        var initialChartIndex = 0;\r\n        if (this.preview && this.preview.currentChartIndex >= 0) {\r\n          initialChartIndex = this.preview.currentChartIndex;\r\n        }\r\n        var bigPreview = new StatisticsChart({\r\n          map: this.map,\r\n          fontColor: fontColor,\r\n          isBigPreview: true,\r\n          showSettingIcon: true,\r\n          showZoomIcon: false,\r\n          zoomToFeaturesWhenClick: true,\r\n          initialChartIndex: initialChartIndex,\r\n          style: \"width:100%;height:100%;\"\r\n        });\r\n        this.previewPopup = new Popup({\r\n          width: width,\r\n          height: height,\r\n          titleLabel: this.nls._widgetLabel,\r\n          content: bigPreview,\r\n          onClose: lang.hitch(this, function() {\r\n            bigPreview.destroy();\r\n            bigPreview = null;\r\n            this.previewPopup = null;\r\n          })\r\n        });\r\n        //popupInfos\r\n        var popupFieldInfosObj = this._getPopupFieldInfo() || {};\r\n        setTimeout(lang.hitch(this, function() {\r\n          bigPreview.createClientCharts(this.preview.featureLayer, this.preview.features, this.preview.config,\r\n            popupFieldInfosObj);\r\n        }), 100);\r\n      },\r\n\r\n      _getPopupFieldInfo: function() {\r\n        var popupFieldInfosObj = null;\r\n        if (this.currentAttrs.config && typeof this.currentAttrs.config.webMapLayerId !== 'undefined') {\r\n          var layerId = this.currentAttrs.config.webMapLayerId;\r\n          if (typeof this.cachePopUpInfos[layerId] !== 'undefined') {\r\n            popupFieldInfosObj = this.cachePopUpInfos[layerId];\r\n          } else {\r\n            var layerInfo = this.layerInfosObj.getLayerInfoById(layerId);\r\n            if (layerInfo) {\r\n              popupFieldInfosObj = layerInfo.getPopupInfo();\r\n              if (popupFieldInfosObj) {\r\n                this.cachePopUpInfos[layerId] = popupFieldInfosObj;\r\n              }\r\n            }\r\n          }\r\n        }\r\n        return popupFieldInfosObj;\r\n      },\r\n\r\n      _initPreview: function() {\r\n        var fontColor = this._getDefaultFontColor();\r\n        this.preview = new StatisticsChart({\r\n          map: this.map,\r\n          fontColor: fontColor,\r\n          isBigPreview: false,\r\n          showSettingIcon: true,\r\n          showZoomIcon: true,\r\n          zoomToFeaturesWhenClick: true\r\n        });\r\n        this.preview.placeAt(this.resultsContainer);\r\n        this.preview.startup();\r\n        this.own(on(this.preview, 'zoomin', lang.hitch(this, this._createBigPreview)));\r\n      },\r\n\r\n      _getDefaultFontColor: function() {\r\n        var color = \"#333333\";\r\n        if (this.appConfig.theme.name === 'DashboardTheme' &&\r\n          (this.appConfig.theme.styles[0] === 'default' || this.appConfig.theme.styles[0] === 'style3')) {\r\n          // bgColor = '#222222';\r\n          color = '#fff';\r\n        } else if (this.appConfig.theme.name === 'DartTheme') {\r\n          // bgColor = '#4c4c4c';\r\n          color = '#fff';\r\n        }\r\n        return color;\r\n      },\r\n\r\n      _initSelf: function() {\r\n        var uniqueId = jimuUtils.getRandomString();\r\n        var cbxName = \"Chart_\" + uniqueId;\r\n        this.cbxUseMapExtent.set('name', cbxName);\r\n        this.cbxDrawGraphic.set('name', cbxName);\r\n\r\n        this.isValidConfig = this._isConfigValid();\r\n        if (!this.isValidConfig) {\r\n          html.setStyle(this.chartsNode, 'display', 'none');\r\n          html.setStyle(this.invalidConfigNode, {\r\n            display: 'block',\r\n            left: 0\r\n          });\r\n          return;\r\n        }\r\n\r\n        var charts = this.config.charts;\r\n\r\n        if (charts.length === 0) {\r\n          html.setStyle(this.chartsNode, 'display', 'none');\r\n          html.setStyle(this.noChartTipSection, 'display', 'block');\r\n          return;\r\n        }\r\n\r\n        array.forEach(charts, lang.hitch(this, function(singleConfig, index) {\r\n          var name = singleConfig.name;\r\n          var strTr = '<tr tabindex=\"0\" class=\"single-chart jimu-table-row\">' +\r\n            '<td class=\"first-td\"></td>' +\r\n            '<td class=\"second-td\">' +\r\n            '<div class=\"chart-name-div\"></div>' +\r\n            '</td>' +\r\n            '<td class=\"third-td\">' +\r\n            '<div class=\"arrow\"></div>' +\r\n            '</td>' +\r\n            '</tr>';\r\n          var tr = html.toDom(strTr);\r\n          var chartNameDiv = query(\".chart-name-div\", tr)[0];\r\n          chartNameDiv.innerHTML = jimuUtils.stripHTML(name);\r\n          html.place(tr, this.chartsTbody);\r\n          tr.singleConfig = singleConfig;\r\n          if (index % 2 === 0) {\r\n            html.addClass(tr, 'even');\r\n          } else {\r\n            html.addClass(tr, 'odd');\r\n          }\r\n        }));\r\n      },\r\n\r\n      _clickClearButton: function( /*optional*/ dontSlide) {\r\n        this._hideInfoWindow();\r\n        this.drawBox.clear();\r\n        this._removeTempResultLayer();\r\n        this._clearResultPage();\r\n        //the default value of dontSlide is false.\r\n        //if true, it means the widgte will destroy and it needn't slide.\r\n        if (!dontSlide) {\r\n          this._fromCurrentPageToChartList();\r\n        }\r\n        focusUtil.focus(this.chartsNode);\r\n      },\r\n\r\n      _slide: function(dom, startLeft, endLeft) {\r\n        html.setStyle(dom, 'display', 'block');\r\n        html.setStyle(dom, 'left', startLeft + \"%\");\r\n        fx.animateProperty({\r\n          node: dom,\r\n          properties: {\r\n            left: {\r\n              start: startLeft,\r\n              end: endLeft,\r\n              units: '%'\r\n            }\r\n          },\r\n          duration: 500,\r\n          onEnd: lang.hitch(this, function() {\r\n            html.setStyle(dom, 'left', endLeft);\r\n            if (endLeft === 0) {\r\n              html.setStyle(dom, 'display', 'block');\r\n            } else {\r\n              html.setStyle(dom, 'display', 'none');\r\n            }\r\n          })\r\n        }).play();\r\n      },\r\n\r\n      _onChartListClicked: function(event) {\r\n        var target = event.target || event.srcElement;\r\n        var tr = jimuUtils.getAncestorDom(target, lang.hitch(this, function(dom) {\r\n          return html.hasClass(dom, 'single-chart');\r\n        }), 10);\r\n        this._enterIntoChartTr(tr);\r\n      },\r\n\r\n      _enterIntoChartTr: function(tr) {\r\n        if (!tr) {\r\n          return;\r\n        }\r\n\r\n        var singleConfig = tr.singleConfig;\r\n        this._resetCurrentAttrs();\r\n        this.currentAttrs.chartTr = tr;\r\n        this.currentAttrs.config = lang.clone(singleConfig);\r\n        this.currentAttrs.layerInfo = this.currentAttrs.chartTr.layerInfo; //may be null\r\n\r\n        query('tr.single-chart', this.chartsTbody).removeClass('jimu-state-active');\r\n        html.addClass(this.currentAttrs.chartTr, 'jimu-state-active');\r\n\r\n        var callback = lang.hitch(this, function() {\r\n          this.currentAttrs.layerInfo = this.currentAttrs.chartTr.layerInfo;\r\n          this._fromChartListToChartParams();\r\n        });\r\n\r\n        if (this.currentAttrs.chartTr.layerInfo) {\r\n          callback();\r\n        } else {\r\n          this.shelter.show();\r\n\r\n          var layerInfo = null;\r\n          if (this.currentAttrs.config && typeof this.currentAttrs.config.webMapLayerId !== 'undefined') {\r\n            var layerId = this.currentAttrs.config.webMapLayerId;\r\n            layerInfo = this.layerInfosObj.getLayerInfoById(layerId);\r\n          }\r\n\r\n          if (layerInfo) {\r\n            layerInfo.getServiceDefinition().then(lang.hitch(this, function(response) {\r\n              if (!this.domNode) {\r\n                return;\r\n              }\r\n              this.shelter.hide();\r\n              this.currentAttrs.chartTr.layerInfo = response;\r\n              this.currentAttrs.layerInfo = this.currentAttrs.chartTr.layerInfo;\r\n              callback();\r\n            }), lang.hitch(this, function(err) {\r\n              console.error(err);\r\n              if (!this.domNode) {\r\n                return;\r\n              }\r\n              this.shelter.hide();\r\n              var errMsg = \"\";\r\n              if (err && err.httpCode === 403) {\r\n                errMsg = this.nls.noPermissionsMsg;\r\n              }\r\n              this._showQueryErrorMsg(errMsg);\r\n            }));\r\n          } else {\r\n            var layerUrl = this.currentAttrs.config.url;\r\n            this.serviceDefinitionManager.getServiceDefinition(layerUrl)\r\n              .then(lang.hitch(this, function(response) {\r\n                if (!this.domNode) {\r\n                  return;\r\n                }\r\n                this.shelter.hide();\r\n                this.currentAttrs.chartTr.layerInfo = response;\r\n                this.currentAttrs.layerInfo = this.currentAttrs.chartTr.layerInfo;\r\n                callback();\r\n              }), lang.hitch(this, function(err) {\r\n                console.error(err);\r\n                if (!this.domNode) {\r\n                  return;\r\n                }\r\n                this.shelter.hide();\r\n                var errMsg = \"\";\r\n                if (err && err.httpCode === 403) {\r\n                  errMsg = this.nls.noPermissionsMsg;\r\n                }\r\n                this._showQueryErrorMsg(errMsg);\r\n              }));\r\n          }\r\n        }\r\n      },\r\n\r\n      _fromCurrentPageToChartList: function() {\r\n        html.setStyle(this.chartList, 'display', 'block');\r\n\r\n        if (html.getStyle(this.chartParams, 'display') === 'block') {\r\n          this._slide(this.chartList, -100, 0);\r\n          this._slide(this.chartParams, 0, 100);\r\n        } else if (html.getStyle(this.chartResults, 'display') === 'block') {\r\n          this._slide(this.chartList, -100, 0);\r\n          this._slide(this.chartResults, 0, 100);\r\n        }\r\n      },\r\n\r\n      _onCbxUseSpatialClicked: function() {\r\n        if (this.cbxUseSpatial.checked) {\r\n          html.setStyle(this.selectSpatialDiv, 'display', 'block');\r\n        } else {\r\n          html.setStyle(this.selectSpatialDiv, 'display', 'none');\r\n        }\r\n\r\n        if (this.cbxUseMapExtent.checked) {\r\n          this._onCbxUseMapExtentClicked();\r\n        } else {\r\n          this._onCbxDrawGraphicClicked();\r\n        }\r\n\r\n        this._resetDrawBox();\r\n      },\r\n\r\n      _onCbxUseMapExtentClicked: function() {\r\n        if (this.cbxUseMapExtent.checked) {\r\n          this._resetDrawBox();\r\n          html.setStyle(this.drawBoxDiv, 'display', 'none');\r\n        }\r\n      },\r\n\r\n      _onCbxDrawGraphicClicked: function() {\r\n        if (this.cbxDrawGraphic.checked) {\r\n          html.setStyle(this.drawBoxDiv, 'display', 'block');\r\n        }\r\n      },\r\n\r\n      _onBtnClearAllClicked: function() {\r\n        if (this.chartsTbody.childElementCount === 0) {\r\n          return;\r\n        }\r\n\r\n        var isChartListVisible = this.chartList.style.display !== 'none';\r\n        var dontSlide = isChartListVisible;\r\n        this._clickClearButton(dontSlide);\r\n      },\r\n\r\n      _resetDrawBox: function() {\r\n        this.drawBox.deactivate();\r\n        this.drawBox.clear();\r\n      },\r\n\r\n      _resetChartParamsPage: function() {\r\n        this.cbxUseSpatial.setValue(false);\r\n        this._onCbxUseSpatialClicked();\r\n        this._resetDrawBox();\r\n      },\r\n\r\n      _fromChartListToChartParams: function() {\r\n        //reset UI of params page\r\n        this._resetChartParamsPage();\r\n        //var layerUrl = this.currentAttrs.config.url;\r\n        //slide\r\n        var showDom = this.chartParams;\r\n        var hideDom = this.chartResults;\r\n\r\n        html.setStyle(this.chartList, {\r\n          left: 0,\r\n          display: 'block'\r\n        });\r\n\r\n        html.setStyle(showDom, {\r\n          left: '100%',\r\n          display: 'block'\r\n        });\r\n\r\n        html.setStyle(hideDom, 'display', 'none');\r\n        this._slide(this.chartList, 0, -100);\r\n        this._slide(showDom, 100, 0);\r\n        //a11y\r\n        focusUtil.focus(this.cbxUseSpatial.domNode);\r\n      },\r\n\r\n      _onBtnParamsBackClicked: function() {\r\n        this._resetDrawBox();\r\n        html.setStyle(this.chartList, 'display', 'block');\r\n        html.setStyle(this.chartParams, 'display', 'block');\r\n        html.setStyle(this.chartResults, 'display', 'none');\r\n        this._slide(this.chartList, -100, 0);\r\n        this._slide(this.chartParams, 0, 100);\r\n        //a11y\r\n        focusUtil.focus(this.chartsNode);\r\n      },\r\n\r\n      //start to query\r\n      _onBtnApplyClicked: function() {\r\n        //reset result page\r\n        this._clearResultPage();\r\n        //var layerInfo = this.currentAttrs.layerInfo;\r\n\r\n        var where = this.currentAttrs.config.filter.expr;\r\n        var geometry = null;\r\n\r\n        if (this.cbxUseSpatial.checked) {\r\n          if (this.cbxUseMapExtent.checked) {\r\n            geometry = this.map.extent;\r\n          } else {\r\n            var gs = this.drawBox.drawLayer.graphics;\r\n            if (gs.length > 0) {\r\n              var g = gs[0];\r\n              geometry = g.geometry;\r\n            }\r\n          }\r\n          if (!geometry) {\r\n            new Message({\r\n              message: this.nls.specifySpatialFilterMsg\r\n            });\r\n            return;\r\n          }\r\n        }\r\n\r\n        if (this.tempResultLayer) {\r\n          this.map.removeLayer(this.tempResultLayer);\r\n        }\r\n        this.tempResultLayer = null;\r\n\r\n        //set query.resultLayer\r\n        this._createChartResultLayer();\r\n\r\n        this._resetDrawBox();\r\n\r\n        html.setStyle(this.chartList, 'display', 'none');\r\n        html.setStyle(this.chartParams, 'display', 'block');\r\n        html.setStyle(this.chartResults, 'display', 'block');\r\n        this._slide(this.chartParams, 0, -100);\r\n        this._slide(this.chartResults, 100, 0);\r\n\r\n        //a11y\r\n        focusUtil.focus(this.resultsContainer);\r\n\r\n        var singleConfig = this.currentAttrs.config;\r\n        var outFields = [];\r\n        var mode = singleConfig.mode;\r\n        if (mode === 'feature') {\r\n          outFields = lang.clone(singleConfig.valueFields);\r\n          if (outFields.indexOf(singleConfig.labelField) < 0) {\r\n            outFields.push(singleConfig.labelField);\r\n          }\r\n        } else if (mode === 'category') {\r\n          outFields = lang.clone(singleConfig.valueFields);\r\n          if (outFields.indexOf(singleConfig.categoryField) < 0) {\r\n            outFields.push(singleConfig.categoryField);\r\n          }\r\n        } else if (mode === 'count') {\r\n          outFields = [singleConfig.categoryField];\r\n        } else if (mode === 'field') {\r\n          outFields = lang.clone(singleConfig.valueFields);\r\n        }\r\n\r\n        this.shelter.show();\r\n        //popupInfos\r\n        var popupFieldInfosObj = this._getPopupFieldInfo() || {};\r\n        var baseExpr = this._getBaseExpression(this.currentAttrs.config.webMapLayerId);\r\n        if (baseExpr) {\r\n          where = \"(\" + baseExpr + \") AND \" + \"(\" + where + \")\";\r\n        }\r\n        this._query(where, outFields, geometry).then(lang.hitch(this, function(response) {\r\n          //response: {status,count,features}\r\n          if (!this.domNode) {\r\n            return;\r\n          }\r\n          this.shelter.hide();\r\n          if (response.status > 0) {\r\n            // var url = this.currentAttrs.config.url;\r\n            // var args = {\r\n            //   config: singleConfig,\r\n            //   features: response.features,\r\n            //   layerDefinition: this.currentAttrs.layerInfo,\r\n            //   resultLayer: this.tempResultLayer\r\n            // };\r\n\r\n            var args = {\r\n              featureLayer: this.tempResultLayer,\r\n              features: response.features,\r\n              config: singleConfig\r\n            };\r\n\r\n            this.previewArgs = args;\r\n\r\n            //update preview height\r\n            this._updatePreviewHeight();\r\n\r\n            //preview will filter features\r\n            // this.preview.createClientCharts(args);\r\n            this.preview.createClientCharts(args.featureLayer, args.features, args.config, popupFieldInfosObj);\r\n\r\n            //add the filtered features to layer\r\n            array.forEach(response.features, lang.hitch(this, function(feature) {\r\n              var geometry = feature.geometry;\r\n              if (!geometry) {\r\n                return;\r\n              }\r\n              //if geometry.type is not point, return true\r\n              if (geometry.type === 'point') {\r\n                //if geometry.type is point, check its geometry is vaild or not\r\n                if (jimuUtils.isVaildPointGeometry(geometry)) {\r\n                  this.tempResultLayer.add(feature);\r\n                }\r\n              } else {\r\n                this.tempResultLayer.add(feature);\r\n              }\r\n            }));\r\n\r\n            this._zoomToLayer(this.tempResultLayer);\r\n          }\r\n        }), lang.hitch(this, function(err) {\r\n          console.error(err);\r\n          if (!this.domNode) {\r\n            return;\r\n          }\r\n          this.shelter.hide();\r\n          this._removeTempResultLayer();\r\n        }));\r\n      },\r\n\r\n      _getBaseExpression: function(webMapLayerId) {\r\n        var baseExpr = \"\";\r\n        //var webMapLayerId = this.currentAttrs.config.webMapLayerId;\r\n        if (webMapLayerId) {\r\n          var info = null;\r\n          if (this.currentAttrs.layerInfo.type === 'Table') {\r\n            info = this.layerInfosObj.getTableInfoById(webMapLayerId);\r\n          } else {\r\n            info = this.layerInfosObj.getLayerInfoById(webMapLayerId);\r\n          }\r\n          if (info) {\r\n            baseExpr = info.getFilter();\r\n          }\r\n        }\r\n        return baseExpr;\r\n      },\r\n\r\n      _updatePreviewHeight: function() {\r\n        var box = html.getContentBox(this.domNode);\r\n        var h = Math.max(box.h - 120, 150);\r\n\r\n        //update preview height\r\n        html.setStyle(this.preview.domNode, 'height', h + 'px');\r\n      },\r\n\r\n      _createChartResultLayer: function() {\r\n        this._removeTempResultLayer();\r\n        var layerInfo = lang.clone(this.currentAttrs.layerInfo);\r\n\r\n        //override layerInfo\r\n        // layerInfo.name = queryName;\r\n        //ImageServiceLayer doesn't have drawingInfo\r\n        if (!layerInfo.drawingInfo) {\r\n          layerInfo.drawingInfo = {};\r\n        }\r\n\r\n        layerInfo.drawingInfo.transparency = 0;\r\n        layerInfo.minScale = 0;\r\n        layerInfo.maxScale = 0;\r\n        layerInfo.effectiveMinScale = 0;\r\n        layerInfo.effectiveMaxScale = 0;\r\n        layerInfo.defaultVisibility = true;\r\n        delete layerInfo.extent;\r\n\r\n        //only keep necessary fields\r\n        // var singleQueryLoader = new SingleQueryLoader(this.map, currentAttrs);\r\n        // var necessaryFieldNames = singleQueryLoader.getOutputFields();\r\n        // layerInfo.fields = array.filter(layerInfo.fields, lang.hitch(this, function(fieldInfo) {\r\n        //   return necessaryFieldNames.indexOf(fieldInfo.name) >= 0;\r\n        // }));\r\n        var featureCollection = {\r\n          layerDefinition: layerInfo,\r\n          featureSet: null\r\n        };\r\n\r\n        //For now, we should not add the FeatureLayer into map.\r\n        this.tempResultLayer = new FeatureLayer(featureCollection);\r\n        this.map.addLayer(this.tempResultLayer);\r\n\r\n        var symbol = symbolJsonUtils.fromJson(this.currentAttrs.config.symbol);\r\n        var renderer = new SimpleRenderer(symbol);\r\n\r\n        //set renderer\r\n        this.tempResultLayer.setRenderer(renderer);\r\n      },\r\n\r\n      _removeTempResultLayer: function() {\r\n        if (this.tempResultLayer) {\r\n          this.map.removeLayer(this.tempResultLayer);\r\n        }\r\n        this.tempResultLayer = null;\r\n      },\r\n\r\n      //resovle {status,count,features}\r\n      _query: function(where, outFields, /*optional*/ geometry) {\r\n        if (!where) {\r\n          where = \"1=1\";\r\n        }\r\n\r\n        var options = {};\r\n        options.url = this.currentAttrs.config.url;\r\n        options.layerInfo = this.currentAttrs.layerInfo;\r\n        options.limit = 10 * 1000;\r\n        options.spatialReference = this.map.spatialReference;\r\n        options.where = where;\r\n        options.geometry = geometry;\r\n        options.outFields = outFields;\r\n\r\n        var query = new Query(options);\r\n        return query.getFeatures();\r\n      },\r\n\r\n      _clearResultPage: function() {\r\n        if (this.previewPopup) {\r\n          this.previewPopup.close();\r\n          this.previewPopup = null;\r\n        }\r\n        this.previewArgs = null;\r\n        this.preview.clear();\r\n        this._hideInfoWindow();\r\n      },\r\n\r\n      _zoomToLayer: function(gl) {\r\n        var graphics;\r\n        if (gl.graphics && gl.graphics.length > 0) {\r\n          //some graphics maybe don't have geometry or have invaild geometry,\r\n          //so need to filter graphics here by geometry\r\n          graphics = gl.graphics.filter(function(g) {\r\n            var geometry = g.geometry;\r\n            //if geometry.type is not point, return true\r\n            if (geometry.type !== 'point') {\r\n              return true;\r\n            } else {\r\n              return jimuUtils.isVaildPointGeometry(geometry);\r\n            }\r\n          }.bind(this));\r\n        }\r\n        if (graphics && graphics.length > 0) {\r\n          var featureSet = jimuUtils.toFeatureSet(graphics);\r\n          try {\r\n            jimuUtils.zoomToFeatureSet(this.map, featureSet);\r\n          } catch (e) {\r\n            console.error(e);\r\n          }\r\n        }\r\n      },\r\n\r\n      _showQueryErrorMsg: function( /* optional */ msg) {\r\n        new Message({\r\n          message: msg || this.nls.queryError\r\n        });\r\n      },\r\n\r\n      _hideInfoWindow: function() {},\r\n\r\n      _onBtnResultsBackClicked: function() {\r\n        var showDom, hideDom;\r\n\r\n        showDom = this.chartParams;\r\n        hideDom = this.chartList;\r\n\r\n        html.setStyle(hideDom, 'display', 'none');\r\n        html.setStyle(showDom, {\r\n          display: 'block',\r\n          left: '-100%'\r\n        });\r\n        this._slide(showDom, -100, 0);\r\n        this._slide(this.chartResults, 0, 100);\r\n        //a11y\r\n        focusUtil.focus(this.paramsContainer);\r\n      }\r\n    });\r\n\r\n    clazz.extend(a11y); //for a11y\r\n    return clazz;\r\n  });"]}