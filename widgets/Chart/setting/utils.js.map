{"version":3,"sources":["../../../../widgets/Chart/setting/utils.js"],"names":["define","Deferred","lang","esriRequest","jimuUtils","_cacheDefinition","getLayerDefinitionByLayerIdOrUrl","layerId","url","deferred","catchDefinition","resolve","hanleAs","content","f","callbackParamName","then","response","bind","error","reject","layerInfo","layerInfosObj","getLayerInfoById","popupInfo","getPopupInfo","_getServiceDefinitionByLayerInfo","definition","_addAliasForLayerDefinition","getServiceDefinition","hitch","getLayerObject","layerObject","getFeatureLayerDefinition","fields","length","forEach","fieldInfo","alias","getFieldAliasByFieldInfo","name","getAliasFromPopupInfo","fieldName","fieldInfos","item","label","getAliasByFieldName","field","filter","updateOptions","select","options","value","showTitle","clone","removeOption","getOptions","addOption","set","option"],"mappings":"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","file":"utils.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\ndefine([\r\n    'dojo/Deferred',\r\n    'dojo/_base/lang',\r\n    'esri/request',\r\n    'jimu/utils'\r\n  ],\r\n  function(Deferred, lang, esriRequest, jimuUtils) {\r\n    return {\r\n\r\n      _cacheDefinition: {},\r\n\r\n      getLayerDefinitionByLayerIdOrUrl: function(layerId, url) {\r\n        var deferred = new Deferred();\r\n        var catchDefinition = this._cacheDefinition[layerId] || this._cacheDefinition[url];\r\n        if (catchDefinition) {\r\n          deferred.resolve(catchDefinition);\r\n          return deferred;\r\n        }\r\n        if (!layerId) {\r\n          esriRequest({\r\n            url: url,\r\n            hanleAs: 'json',\r\n            content: {\r\n              f: 'json'\r\n            },\r\n            callbackParamName: 'callback'\r\n          }).then(function(response) {\r\n            this._cacheDefinition[url] = response;\r\n            deferred.resolve(response);\r\n          }.bind(this), function(error) {\r\n            deferred.reject(error);\r\n          });\r\n          return deferred;\r\n        }\r\n\r\n        var layerInfo = this.layerInfosObj.getLayerInfoById(layerId);\r\n        if (layerInfo) {\r\n          var popupInfo = layerInfo.getPopupInfo();\r\n          this._getServiceDefinitionByLayerInfo(layerInfo).then(function(definition) {\r\n            this._addAliasForLayerDefinition(definition, popupInfo);\r\n            this._cacheDefinition[layerId] = definition;\r\n            deferred.resolve(definition);\r\n          }.bind(this));\r\n        } else {\r\n          deferred.reject('Invaild layerInfo for layer id: ' + layerId);\r\n        }\r\n        return deferred;\r\n      },\r\n\r\n      _getServiceDefinitionByLayerInfo: function(layerInfo) {\r\n        return layerInfo.getServiceDefinition().then(lang.hitch(this, function(definition) {\r\n          if (definition) {\r\n            return definition;\r\n          } else {\r\n            return layerInfo.getLayerObject().then(lang.hitch(this, function(layerObject) {\r\n              if (layerObject) {\r\n                return jimuUtils.getFeatureLayerDefinition(layerObject);\r\n              } else {\r\n                return null;\r\n              }\r\n            }));\r\n          }\r\n        }));\r\n      },\r\n\r\n      _addAliasForLayerDefinition: function(definition, popupInfo) {\r\n        if (definition && definition.fields && definition.fields.length > 0) {\r\n          definition.fields.forEach(lang.hitch(this, function(fieldInfo) {\r\n            var alias = this.getFieldAliasByFieldInfo(fieldInfo, popupInfo);\r\n            if (alias) {\r\n              fieldInfo.alias = alias;\r\n            }\r\n          }));\r\n        }\r\n      },\r\n\r\n      getFieldAliasByFieldInfo: function(fieldInfo, popupInfo) {\r\n        var alias = '';\r\n        if (!fieldInfo) {\r\n          return alias;\r\n        }\r\n        var name = fieldInfo.name;\r\n        alias = fieldInfo.alias || name;\r\n        if (popupInfo) {\r\n          alias = this.getAliasFromPopupInfo(name, popupInfo);\r\n        }\r\n        return alias;\r\n      },\r\n\r\n      getAliasFromPopupInfo: function(fieldName, popupInfo) {\r\n        var alias = fieldName;\r\n        if (!popupInfo) {\r\n          return alias;\r\n        }\r\n        var fieldInfos = popupInfo.fieldInfos;\r\n        if (fieldInfos && fieldInfos.length > 0) {\r\n          fieldInfos.forEach(function(item) {\r\n            if (item.fieldName === fieldName) {\r\n              alias = item.label;\r\n            }\r\n          });\r\n        }\r\n        return alias;\r\n      },\r\n\r\n      getAliasByFieldName:function(fieldName, definition){\r\n        if(!fieldName){\r\n          return;\r\n        }\r\n        if(!definition || !definition.fields || !definition.fields.length){\r\n          return;\r\n        }\r\n        var field = definition.fields.filter(function(item){\r\n          return item.name === fieldName;\r\n        })[0];\r\n        return field && field.alias;\r\n      },\r\n\r\n      updateOptions: function(select, options, value, showTitle) {\r\n        if (options) {\r\n          options = lang.clone(options);\r\n          select.removeOption(select.getOptions());\r\n          select.addOption(options);\r\n        } else {\r\n          options = [];\r\n        }\r\n        if (!value && options.length > 0) {\r\n          value = options[0].value;\r\n        }\r\n        if (value) {\r\n          select.set('value', value);\r\n          if (showTitle) {\r\n            var option = select.getOptions(value);\r\n            if (option && typeof option.label !== 'undefined') {\r\n              select.set('title', option.label);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    };\r\n  });"]}