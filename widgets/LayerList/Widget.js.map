{"version":3,"sources":["../../../widgets/LayerList/Widget.js"],"names":["define","BaseWidget","declare","lang","array","html","dom","on","query","registry","LayerListView","LayerFilter","NlsStrings","LayerInfos","clazz","baseClass","name","layerFilter","_denyLayerInfosOpacityResponseOneTime","_denyLayerInfosIsVisibleChangedResponseOneTime","layerListView","operLayerInfos","postCreate","config","showTitle","layerListTitle","innerHTML","addClass","startup","inherited","arguments","_createLayerFilter","value","nls","map","itemId","getInstance","itemInfo","then","hitch","showLayers","bindEvents","setSelectable","layerListBody","_obtainMapLayers","layerListWidget","placeAt","layerFilterNode","setAttr","searchButton","layers","window","jimuNls","common","search","destroy","_clearLayers","basemapLayers","operLayers","retObj","itemData","baseMap","baseMapLayers","operationalLayers","forEach","graphicsLayerIds","layerId","layer","getLayer","isOperationalLayer","push","layerObject","title","label","id","layerIds","expandAllLayersByDefault","foldOrUnfoldAllLayers","destroyRecursive","_refresh","own","_onLayerInfosChanged","showBasemap","_onTableInfosChanged","_onLayerInfosIsVisibleChanged","_onLayerInfosReorder","_onZoomEnd","_onLayerInfosRendererChanged","_onLayerInfosOpacityChanged","_onLayerInfosScaleRangeChanged","cancelFilter","refresh","changedLayerInfos","layerInfo","domNode","visibleCheckBoxDomNode","visibleCheckBox","byNode","isVisible","check","uncheck","layerInfoArray","traversal","that","setTimeout","shift","layerTitleDivIdDomNode","isInScale","removeClass","err","console","warn","message","length","callee","redrawLegends","opacity","undefined","contentDomNode","style","_hideCurrentPopupMenu","subLayerInfo","currentIndex","steps","batchLayerInfos","slice","onAppConfigChanged","appConfig","reason","changedData"],"mappings":"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","file":"Widget.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright © Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n    'jimu/BaseWidget',\r\n    'dojo/_base/declare',\r\n    'dojo/_base/lang',\r\n    'dojo/_base/array',\r\n    'dojo/_base/html',\r\n    'dojo/dom',\r\n    'dojo/on',\r\n    'dojo/query',\r\n    'dijit/registry',\r\n    './LayerListView',\r\n    './LayerFilter',\r\n    './NlsStrings',\r\n    'jimu/LayerInfos/LayerInfos'\r\n  ],\r\n  function(BaseWidget, declare, lang, array, html, dom, on,\r\n  query, registry, LayerListView, LayerFilter, NlsStrings, LayerInfos) {\r\n\r\n    var clazz = declare([BaseWidget], {\r\n      //these two properties is defined in the BaseWiget\r\n      baseClass: 'jimu-widget-layerList',\r\n      name: 'layerList',\r\n      layerFilter: null,\r\n      _denyLayerInfosOpacityResponseOneTime: null,\r\n      _denyLayerInfosIsVisibleChangedResponseOneTime: null,\r\n      //layerListView: Object{}\r\n      //  A module is responsible for show layers list\r\n      layerListView: null,\r\n\r\n      //operLayerInfos: Object{}\r\n      //  operational layer infos\r\n      operLayerInfos: null,\r\n\r\n      postCreate: function() {\r\n        // compitible with old verion, undefined means 'show title'\r\n        if(this.config.showTitle === false) {\r\n          this.layerListTitle.innerHTML = \"\";\r\n          html.addClass(this.layerListTitle, 'disable');\r\n        }\r\n      },\r\n\r\n      startup: function() {\r\n        this.inherited(arguments);\r\n\r\n        this._createLayerFilter();\r\n\r\n        NlsStrings.value = this.nls;\r\n        this._denyLayerInfosOpacityResponseOneTime = false;\r\n        this._denyLayerInfosIsVisibleChangedResponseOneTime = false;\r\n        // summary:\r\n        //    this function will be called when widget is started.\r\n        // description:\r\n        //    according to webmap or basemap to create LayerInfos instance\r\n        //    and initialize operLayerInfos;\r\n        //    show layers list;\r\n        //    bind events for layerLis;\r\n\r\n        if (this.map.itemId) {\r\n          LayerInfos.getInstance(this.map, this.map.itemInfo)\r\n            .then(lang.hitch(this, function(operLayerInfos) {\r\n              this.operLayerInfos = operLayerInfos;\r\n              this.showLayers();\r\n              this.bindEvents();\r\n              dom.setSelectable(this.layerListBody, false);\r\n              dom.setSelectable(this.layerListTitle, false);\r\n            }));\r\n        } else {\r\n          var itemInfo = this._obtainMapLayers();\r\n          LayerInfos.getInstance(this.map, itemInfo)\r\n            .then(lang.hitch(this, function(operLayerInfos) {\r\n              this.operLayerInfos = operLayerInfos;\r\n              this.showLayers();\r\n              this.bindEvents();\r\n              dom.setSelectable(this.layerListBody, false);\r\n              dom.setSelectable(this.layerListTitle, false);\r\n            }));\r\n        }\r\n      },\r\n\r\n      _createLayerFilter: function() {\r\n        this.layerFilter = new LayerFilter({layerListWidget: this}).placeAt(this.layerFilterNode);\r\n        html.setAttr(this.layerFilter.searchButton, 'tabindex', 0);\r\n        html.setAttr(this.layerFilter.searchButton, 'aria-label', this.nls.layers + ' ' + window.jimuNls.common.search);\r\n        html.addClass(this.layerFilter.searchButton, 'firstFocusNode');\r\n      },\r\n\r\n      destroy: function() {\r\n        this._clearLayers();\r\n        this.inherited(arguments);\r\n      },\r\n\r\n      _obtainMapLayers: function() {\r\n        // summary:\r\n        //    obtain basemap layers and operational layers if the map is not webmap.\r\n        var basemapLayers = [],\r\n          operLayers = [];\r\n        // emulate a webmapItemInfo.\r\n        var retObj = {\r\n          itemData: {\r\n            baseMap: {\r\n              baseMapLayers: []\r\n            },\r\n            operationalLayers: []\r\n          }\r\n        };\r\n        array.forEach(this.map.graphicsLayerIds, function(layerId) {\r\n          var layer = this.map.getLayer(layerId);\r\n          if (layer.isOperationalLayer) {\r\n            operLayers.push({\r\n              layerObject: layer,\r\n              title: layer.label || layer.title || layer.name || layer.id || \" \",\r\n              id: layer.id || \" \"\r\n            });\r\n          }\r\n        }, this);\r\n        array.forEach(this.map.layerIds, function(layerId) {\r\n          var layer = this.map.getLayer(layerId);\r\n          if (layer.isOperationalLayer) {\r\n            operLayers.push({\r\n              layerObject: layer,\r\n              title: layer.label || layer.title || layer.name || layer.id || \" \",\r\n              id: layer.id || \" \"\r\n            });\r\n          } else {\r\n            basemapLayers.push({\r\n              layerObject: layer,\r\n              id: layer.id || \" \"\r\n            });\r\n          }\r\n        }, this);\r\n\r\n        retObj.itemData.baseMap.baseMapLayers = basemapLayers;\r\n        retObj.itemData.operationalLayers = operLayers;\r\n        return retObj;\r\n      },\r\n\r\n      showLayers: function() {\r\n        // summary:\r\n        //    create a LayerListView module used to draw layers list in browser.\r\n        this.layerListView = new LayerListView({\r\n          operLayerInfos: this.operLayerInfos,\r\n          layerListWidget: this,\r\n          layerFilter: this.layerFilter,\r\n          config: this.config\r\n        }).placeAt(this.layerListBody);\r\n\r\n        if(this.config.expandAllLayersByDefault) {\r\n          this.layerListView.foldOrUnfoldAllLayers(false);\r\n        }\r\n      },\r\n\r\n      _clearLayers: function() {\r\n        // summary:\r\n        //   clear layer list\r\n        //domConstruct.empty(this.layerListTable);\r\n        if (this.layerListView && this.layerListView.destroyRecursive) {\r\n          this.layerListView.destroyRecursive();\r\n        }\r\n      },\r\n\r\n      _refresh: function() {\r\n        this._clearLayers();\r\n        this.showLayers();\r\n      },\r\n\r\n      /****************\r\n       * Event\r\n       ***************/\r\n      bindEvents: function() {\r\n        // summary:\r\n        //    bind events are listened by this module\r\n        this.own(on(this.operLayerInfos,\r\n          'layerInfosChanged',\r\n          lang.hitch(this, this._onLayerInfosChanged)));\r\n\r\n        if(this.config.showBasemap) {\r\n          this.own(on(this.operLayerInfos,\r\n            'basemapLayerInfosChanged',\r\n            lang.hitch(this, this._onLayerInfosChanged)));\r\n        }\r\n\r\n        this.own(on(this.operLayerInfos,\r\n          'tableInfosChanged',\r\n          lang.hitch(this, this._onTableInfosChanged)));\r\n\r\n        this.own(this.operLayerInfos.on('layerInfosIsVisibleChanged',\r\n          lang.hitch(this, this._onLayerInfosIsVisibleChanged)));\r\n\r\n        this.own(on(this.operLayerInfos,\r\n          'layerInfosReorder',\r\n          lang.hitch(this, this._onLayerInfosReorder)));\r\n\r\n        this.own(on(this.map,\r\n          'zoom-end',\r\n          lang.hitch(this, this._onZoomEnd)));\r\n\r\n        this.own(on(this.operLayerInfos,\r\n          'layerInfosRendererChanged',\r\n          lang.hitch(this, this._onLayerInfosRendererChanged)));\r\n\r\n        this.own(on(this.operLayerInfos,\r\n          'layerInfosOpacityChanged',\r\n          lang.hitch(this, this._onLayerInfosOpacityChanged)));\r\n\r\n        this.own(on(this.operLayerInfos,\r\n          'layerInfosScaleRangeChanged',\r\n          lang.hitch(this, this._onLayerInfosScaleRangeChanged)));\r\n      },\r\n\r\n      _onLayerInfosChanged: function(/*layerInfo, changedType*/) {\r\n        //udpates layerFilter.isValid to false first\r\n        this.layerFilter.cancelFilter();\r\n        this.layerListView.refresh();\r\n      },\r\n\r\n      _onTableInfosChanged: function(/*tableInfoArray, changedType*/) {\r\n        //udpates layerFilter.isValid to false first\r\n        this.layerFilter.cancelFilter();\r\n        this.layerListView.refresh();\r\n      },\r\n\r\n      _onLayerInfosIsVisibleChanged: function(changedLayerInfos) {\r\n        if(this._denyLayerInfosIsVisibleChangedResponseOneTime) {\r\n          this._denyLayerInfosIsVisibleChangedResponseOneTime = false;\r\n        } else {\r\n          array.forEach(changedLayerInfos, function(layerInfo) {\r\n            query(\"[class~='visible-checkbox-\" + layerInfo.id + \"']\", this.domNode)\r\n            .forEach(function(visibleCheckBoxDomNode) {\r\n              var visibleCheckBox = registry.byNode(visibleCheckBoxDomNode);\r\n              if(layerInfo.isVisible()) {\r\n                visibleCheckBox.check();\r\n              } else {\r\n                visibleCheckBox.uncheck();\r\n              }\r\n            }, this);\r\n\r\n          }, this);\r\n        }\r\n      },\r\n\r\n      _onZoomEnd: function() {\r\n        var layerInfoArray = [];\r\n        this.operLayerInfos.traversal(lang.hitch(this, function(layerInfo) {\r\n          layerInfoArray.push(layerInfo);\r\n        }));\r\n\r\n        var that = this;\r\n        setTimeout(function() {\r\n          var layerInfo = layerInfoArray.shift();\r\n          query(\"[class~='layer-title-div-\" + layerInfo.id + \"']\", this.domNode)\r\n          .forEach(function(layerTitleDivIdDomNode) {\r\n            try {\r\n              if (layerInfo.isInScale()) {\r\n                html.removeClass(layerTitleDivIdDomNode, 'grayed-title');\r\n              } else {\r\n                html.addClass(layerTitleDivIdDomNode, 'grayed-title');\r\n              }\r\n            } catch (err) {\r\n              console.warn(err.message);\r\n            }\r\n          }, that);\r\n\r\n          if(layerInfoArray.length > 0) {\r\n            setTimeout(arguments.callee, 30); // jshint ignore:line\r\n          }\r\n        }, 30);\r\n\r\n\r\n      },\r\n\r\n      _onLayerInfosReorder: function() {\r\n        //if(this._denyLayerInfosReorderResponseOneTime) {\r\n        //  // denies one time\r\n        //  this._denyLayerInfosReorderResponseOneTime = false;\r\n        //} else {\r\n        //  this._refresh();\r\n        //}\r\n        this.layerFilter.cancelFilter();\r\n        this.layerListView.refresh();\r\n      },\r\n\r\n      _onLayerInfosRendererChanged: function(changedLayerInfos) {\r\n        try {\r\n          array.forEach(changedLayerInfos, function(layerInfo) {\r\n            this.layerListView.redrawLegends(layerInfo);\r\n          }, this);\r\n        } catch (err) {\r\n          this._refresh();\r\n        }\r\n      },\r\n\r\n      _onLayerInfosOpacityChanged: function(changedLayerInfos) {\r\n        array.forEach(changedLayerInfos, function(layerInfo) {\r\n          var opacity = layerInfo.layerObject.opacity === undefined ? 1 : layerInfo.layerObject.opacity;\r\n          var contentDomNode = query(\"[layercontenttrnodeid='\" + layerInfo.id + \"']\", this.domNode)[0];\r\n          query(\".legends-div.jimu-legends-div-flag img\", contentDomNode).style(\"opacity\", opacity);\r\n        }, this);\r\n\r\n        if(this._denyLayerInfosOpacityResponseOneTime) {\r\n          // denies one time\r\n          this._denyLayerInfosOpacityResponseOneTime = false;\r\n        } else {\r\n          this.layerListView._hideCurrentPopupMenu();\r\n        }\r\n      },\r\n\r\n      _onLayerInfosScaleRangeChanged: function(changedLayerInfos) {\r\n        array.forEach(changedLayerInfos, function(layerInfo) {\r\n          var layerInfoArray = [];\r\n          layerInfo.traversal(lang.hitch(this, function(subLayerInfo) {\r\n            layerInfoArray.push(subLayerInfo);\r\n          }));\r\n\r\n          var that = this;\r\n          var currentIndex = 0;\r\n          var steps = 10;\r\n          setTimeout(function() {\r\n            var batchLayerInfos = layerInfoArray.slice(currentIndex, currentIndex + steps);\r\n            currentIndex += steps;\r\n            array.forEach(batchLayerInfos, function(layerInfo) {\r\n              query(\"[class~='layer-title-div-\" + layerInfo.id + \"']\", this.domNode)\r\n              .forEach(function(layerTitleDivIdDomNode) {\r\n                try {\r\n                  if (layerInfo.isInScale()) {\r\n                    html.removeClass(layerTitleDivIdDomNode, 'grayed-title');\r\n                  } else {\r\n                    html.addClass(layerTitleDivIdDomNode, 'grayed-title');\r\n                  }\r\n                } catch (err) {\r\n                  console.warn(err.message);\r\n                }\r\n              }, that);\r\n            });\r\n\r\n            if(layerInfoArray.length > currentIndex) {\r\n              setTimeout(arguments.callee, 30); // jshint ignore:line\r\n            }\r\n          }, 30);\r\n        }, this);\r\n      },\r\n\r\n      onAppConfigChanged: function(appConfig, reason, changedData){\r\n        /*jshint unused: false*/\r\n        this.appConfig = appConfig;\r\n      }\r\n\r\n    });\r\n\r\n    return clazz;\r\n  });\r\n"]}