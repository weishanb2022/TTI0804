{"version":3,"sources":["../../../widgets/OverviewMap/utils.js"],"names":["define","lang","array","string","Deferred","esriLang","esriRequest","Url","TileInfo","portalUtils","ArcGISTiledMapServiceLayer","ArcGISDynamicMapServiceLayer","ArcGISImageServiceLayer","VETiledLayer","OpenStreetMapLayer","ImageParameters","mo","TYPE","createBaseLayer","baseLayer","map","that","def","layer","url","type","veLayer","veLayerInfo","BASE_MAP","resolve","ARCGIS_TILED_MAP","valid","isArcGISLayersValid","then","isValid","res","err","ARCGIS_DYNAMIC_MAP_SERVICE","info","mslOptions","supportedImageFormatTypes","indexOf","imageParameters","format","ARCGIS_IMAGE_SERVICE","OSM","BING_ROAD","BING_AERIAL","BING_HYBRID","key","layers","getBingMapKey","isKeyInPortal","console","error","bingMapsKey","mapStyle","_getVEStyle","_getLayerInfoSR","infoSR","spatialReference","extent","_getTileServers","tileLayer","_tileServers","subDomains","length","authority","split","subDomainTileServer","forEach","subDomain","scheme","substitute","replace","push","VEStyle","MAP_STYLE_AERIAL","MAP_STYLE_AERIAL_WITH_LABELS","MAP_STYLE_ROAD","fetchLayerInfo","handleAs","callbackParamName","timeout","content","f","hitch","layerObject","reject","portal","window","portalSelf","getPortal","appConfig","portalUrl","bingKey","baseLayerVerification","baseLayerObj","mapSR","layerSr","isSameSR","sameSpatialReference","ArcGISLayersTypeVerification","lc","toLowerCase","tileInfo","tileInfoStr","str","JSON","parse","isHaveBingKey","sp1","sp2","mercator","isDefined","wkid","latestWkid","wkt"],"mappings":"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D,OAVM,MAUA,IAAIL,OAAOC,GAAP,IAAc3G,SAAS6G,SAAT,CAAmBH,IAAIM,GAAvB,CAAd,IAA6ChH,SAAS6G,SAAT,CAAmBF,IAAIK,GAAvB,CAA7C,IAA4EN,IAAIM,GAAJ,KAAYL,IAAIK,GAAhG,EAAqG;AAC1G,eAAO,IAAP;AACD;;AAED,aAAO,KAAP;AACD;AA5HQ,GAAX;;AA+HA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA,SAAOrG,EAAP;AACD,CAraH","file":"utils.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright © Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine(['dojo/_base/lang', 'dojo/_base/array',// 'dojo/_base/html',\r\n  \"dojo/string\",\r\n  'dojo/Deferred',\r\n  \"esri/lang\",\r\n  'esri/request',\r\n  //\"esri/geometry/Extent\",\r\n  \"dojo/_base/url\",\r\n  \"esri/layers/TileInfo\",\r\n  \"jimu/portalUtils\",\r\n  // \"esri/layers/layer\",\r\n  // \"esri/layers/TiledMapServiceLayer\",\r\n  // \"esri/SpatialReference\",\r\n  \"esri/layers/ArcGISTiledMapServiceLayer\",\r\n  \"esri/layers/ArcGISDynamicMapServiceLayer\",\r\n  \"esri/layers/ArcGISImageServiceLayer\",\r\n  //\"esri/layers/WebTiledLayer\",\r\n  \"esri/virtualearth/VETiledLayer\",\r\n  \"esri/layers/OpenStreetMapLayer\",\r\n  \"esri/layers/ImageParameters\"\r\n],\r\n  function (lang, array,/* html,*/ string, Deferred, esriLang, esriRequest,/* Extent,*/ Url, TileInfo, portalUtils,/* Layer, TiledMapServiceLayer, SpatialReference,*/\r\n    ArcGISTiledMapServiceLayer, ArcGISDynamicMapServiceLayer, ArcGISImageServiceLayer,\r\n    /*WebTiledLayer, */VETiledLayer, OpenStreetMapLayer, ImageParameters) {\r\n    var mo = {};\r\n\r\n    mo.TYPE = {\r\n      \"BASE_MAP\": \"baseMap\",\r\n      \"ARCGIS_TILED_MAP\": \"tiledMapService\",\r\n      \"ARCGIS_DYNAMIC_MAP_SERVICE\": \"dynamicMapService\",\r\n      \"ARCGIS_IMAGE_SERVICE\": \"imageService\",\r\n      \"OSM\": \"openStreetMap\",\r\n      \"BING_ROAD\": \"bingMapsRoad\",\r\n      \"BING_AERIAL\": \"bingMapsAerial\",\r\n      \"BING_HYBRID\": \"bingMapsHybrid\"\r\n    };\r\n\r\n    mo.createBaseLayer = function (baseLayer, map, that) {\r\n      var def = new Deferred();\r\n      var layer = null;\r\n      var url = baseLayer.url,\r\n        type = baseLayer.type,\r\n        //tileLayer = baseLayer.tileLayerInfo,\r\n        veLayer = baseLayer.veLayerInfo;\r\n\r\n      if (type === mo.TYPE.BASE_MAP) {\r\n        def.resolve({ layer: \"BaseMap\" });//use raw BaseMap\r\n      } else if (type === mo.TYPE.ARCGIS_TILED_MAP) {\r\n        mo.valid.isArcGISLayersValid(url, map, type).then(function (isValid) {\r\n          if (isValid && true === isValid.res) {\r\n            layer = new ArcGISTiledMapServiceLayer(url/*, param*/);\r\n            def.resolve({ layer: layer });\r\n          } else {\r\n            //console.error(isValid.err);\r\n            def.resolve({ layer: null, err: isValid.err });\r\n          }\r\n\r\n        }, function (err) {\r\n          def.resolve({ res: false, err: err });\r\n        });\r\n      } else if (type === mo.TYPE.ARCGIS_DYNAMIC_MAP_SERVICE) {\r\n        mo.valid.isArcGISLayersValid(url, map, type).then(function (isValid) {\r\n          if (isValid && true === isValid.res) {\r\n            var info = isValid.info;\r\n            var mslOptions = {};\r\n            if (info && info.supportedImageFormatTypes &&\r\n              info.supportedImageFormatTypes.indexOf(\"PNG24\") !== -1) {\r\n              mslOptions.imageParameters = new ImageParameters();\r\n              mslOptions.imageParameters.format = \"png24\";\r\n            }\r\n            layer = new ArcGISDynamicMapServiceLayer(url, mslOptions);//2.2\r\n            def.resolve({ layer: layer });\r\n          } else {\r\n            def.resolve({ layer: null, err: isValid.err });\r\n          }\r\n\r\n        }, function (err) {\r\n          def.resolve({ res: false, err: err });\r\n        });\r\n      } else if (type === mo.TYPE.ARCGIS_IMAGE_SERVICE) {\r\n        mo.valid.isArcGISLayersValid(url, map, type).then(function (isValid) {\r\n          if (isValid && true === isValid.res) {\r\n            layer = new ArcGISImageServiceLayer(url, {});//2.3\r\n            def.resolve({ layer: layer });\r\n          } else {\r\n            def.resolve({ layer: null, err: isValid.err });\r\n          }\r\n\r\n        }, function (err) {\r\n          def.resolve({ res: false, err: err });\r\n        });\r\n      } else if (type === mo.TYPE.OSM) {\r\n        //OpenStreetMapLayer\r\n        layer = new OpenStreetMapLayer(url, {/*id: id*/ });\r\n        def.resolve({ layer: layer });\r\n      } else if ((type === mo.TYPE.BING_ROAD || type === mo.TYPE.BING_AERIAL || type === mo.TYPE.BING_HYBRID) &&\r\n        veLayer) {\r\n\r\n        var key = mo.layers.getBingMapKey(that);\r\n        if (!key || !veLayer.isKeyInPortal) {\r\n          key = \"__invalidKey\";//set \"__invalidKey\" to show widget panel, when no key in portal\r\n          console.error(\"OverviewMap Error: BingMapsKey must be provided\");\r\n        }\r\n        layer = new VETiledLayer({\r\n          bingMapsKey: key,\r\n          mapStyle: mo.layers._getVEStyle(type)\r\n        });\r\n        def.resolve({ layer: layer });\r\n      } else {\r\n        def.resolve({ layer: null });//DO NOT SUPPORT\r\n      } /* TODO WebTiledLayer\r\n      else if (type === \"WebTiled\" && tileLayer) {\r\n        //if (!canAdd) {}\r\n      } */\r\n\r\n      return def;\r\n    };\r\n\r\n    //layers\r\n    mo.layers = {\r\n      _getLayerInfoSR: function (info) {\r\n        var infoSR = info.spatialReference || (info.extent && info.extent.spatialReference);\r\n        return infoSR;\r\n      },\r\n      _getTileServers: function (tileLayer) {\r\n        var _tileServers = [];\r\n        var url = new Url(tileLayer.url);\r\n        if (tileLayer.subDomains && tileLayer.subDomains.length > 0 && url.authority.split(\".\").length > 1) {\r\n          var subDomainTileServer;\r\n          array.forEach(tileLayer.subDomains, function (subDomain) {\r\n            if (url.authority.indexOf(\"${subDomain}\") > -1) {\r\n              subDomainTileServer = url.scheme + \"://\" +\r\n                string.substitute(url.authority, { subDomain: subDomain }) + \"/\";\r\n            }\r\n            else if (url.authority.indexOf(\"{subDomain}\") > -1) {\r\n              subDomainTileServer = url.scheme + \"://\" + url.authority.replace(/\\{subDomain\\}/gi, subDomain) + \"/\";\r\n            }\r\n            _tileServers.push(subDomainTileServer);\r\n          }, this);\r\n        }\r\n\r\n        if (_tileServers && _tileServers.length > 0) {\r\n          return _tileServers;\r\n        } else {\r\n          return null;\r\n        }\r\n      },\r\n      _getVEStyle: function (VEStyle) {\r\n        switch (VEStyle) {\r\n          case mo.TYPE.BING_AERIAL: {\r\n            return VETiledLayer.MAP_STYLE_AERIAL;\r\n          } case mo.TYPE.BING_HYBRID: {\r\n            return VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS;\r\n          } case mo.TYPE.BING_ROAD: {\r\n            return VETiledLayer.MAP_STYLE_ROAD;\r\n          } default: {\r\n            return VETiledLayer.MAP_STYLE_AERIAL;\r\n          }\r\n        }\r\n      },\r\n      fetchLayerInfo: function (url) {\r\n        var def = new Deferred();\r\n        esriRequest({\r\n          url: url,\r\n          handleAs: 'json',\r\n          callbackParamName: 'callback',\r\n          timeout: 15000,\r\n          content: { f: 'json' }\r\n        }).then(lang.hitch(this, function (res) {\r\n          var layerObject = res;\r\n          def.resolve(layerObject);\r\n        }), function (err) {\r\n          def.reject(err);\r\n        });\r\n        return def;\r\n      },\r\n      getBingMapKey: function (that) {\r\n        //setting || runtime\r\n        var portal = window.portalSelf || (that && portalUtils.getPortal(that.appConfig.portalUrl));\r\n\r\n        if (portal && portal.bingKey) {\r\n          return portal.bingKey;\r\n        } else {\r\n          return \"\";\r\n        }\r\n      }\r\n    };\r\n\r\n    //validations\r\n    mo.valid = {\r\n      baseLayerVerification: function (baseLayerObj, map) {\r\n        var def = new Deferred();\r\n        var mapSR = map.spatialReference;\r\n        mo.createBaseLayer(baseLayerObj, map).then(function (res) {\r\n          if (res.layer) {\r\n            var layerSr = mo.layers._getLayerInfoSR(res.layer);\r\n            var isSameSR = mo.valid.sameSpatialReference(mapSR, layerSr);\r\n            if (isSameSR || res.layer === \"BaseMap\") {\r\n              def.resolve({ res: true });\r\n            } else {\r\n              def.resolve({ res: false });\r\n            }\r\n          } else {\r\n            def.resolve({ res: false, err: res.err });\r\n          }\r\n        }, function (err) {\r\n          def.resolve({ res: false, err: err });\r\n        });\r\n        return def;\r\n      },\r\n\r\n      ArcGISLayersTypeVerification: function (url, info, type) {\r\n        var lc = url.toLowerCase();\r\n        if (lc.indexOf(\"/featureserver\") > 0 || lc.indexOf(\"/mapserver\") > 0) {\r\n          if (info && typeof info.type === \"string\" &&\r\n            (info.type === \"Feature Layer\" || info.type === \"Table\")) {\r\n            return false;//DO NOT SUPPORT\r\n          } else {\r\n            if (lc.indexOf(\"/featureserver\") > 0) {\r\n              return false;//DO NOT SUPPORT\r\n            } else if (lc.indexOf(\"/mapserver\") > 0) {\r\n              if (info.tileInfo) {\r\n                if (type === mo.TYPE.ARCGIS_TILED_MAP || type === mo.TYPE.ARCGIS_DYNAMIC_MAP_SERVICE) {\r\n                  return true;\r\n                } else {\r\n                  return false;\r\n                }\r\n              } else {\r\n                if (type === mo.TYPE.ARCGIS_DYNAMIC_MAP_SERVICE) {\r\n                  return true;\r\n                } else {\r\n                  return false;\r\n                }\r\n              }\r\n            }\r\n          }\r\n        } else if (lc.indexOf(\"/imageserver\") > 0) {\r\n          if (type === mo.TYPE.ARCGIS_IMAGE_SERVICE) {\r\n            return true;\r\n          } else {\r\n            return false;\r\n          }\r\n        }\r\n      },\r\n      isArcGISLayersValid: function (url, map, type) {\r\n        var def = new Deferred();\r\n\r\n        mo.layers.fetchLayerInfo(url).then(function (info) {\r\n          var infoSR = null,\r\n            mapSR = null;\r\n          infoSR = mo.layers._getLayerInfoSR(info);\r\n          mapSR = (map && map.spatialReference);\r\n\r\n          if (infoSR && mapSR && mo.valid.sameSpatialReference(mapSR, infoSR)) {\r\n            if (true === mo.valid.ArcGISLayersTypeVerification(url, info, type)) {\r\n              def.resolve({ res: true, info: info });\r\n            } else {\r\n              def.resolve({ res: false, err: \"layerType\"});//TODO layer type err\r\n            }\r\n          } else if (infoSR && mapSR && !mo.valid.sameSpatialReference(mapSR, infoSR)) {\r\n            def.resolve({ res: false, err: \"wkid\" });\r\n          } else {\r\n            def.resolve({ res: false });\r\n          }\r\n        }, function (err) {\r\n          def.resolve({ res: false, err: err });\r\n        }/*).otherwise(function (error) {\r\n          def.reject({ layer: null, err: error });\r\n        }*/);\r\n        return def;\r\n      },\r\n\r\n      tileInfoStr: function (str) {\r\n        try {\r\n          new TileInfo(JSON.parse(str));\r\n          return true;\r\n        } catch (error) {\r\n          return error;\r\n        }\r\n      },\r\n\r\n      isHaveBingKey: function () {\r\n        if (mo.layers.getBingMapKey()) {\r\n          return true;\r\n        } else {\r\n          return false;\r\n        }\r\n      },\r\n\r\n      sameSpatialReference: function (sp1, sp2) {\r\n        var mercator = [102113, 102100, 3857, 4326];//add 4326 for WAB-Widget\r\n        if (sp1 && sp2 && esriLang.isDefined(sp1.wkid) && esriLang.isDefined(sp2.wkid) &&\r\n          //arcgisonline.map.main.contains(mercator, sp1.wkid) &&\r\n          //arcgisonline.map.main.contains(mercator, sp2.wkid)\r\n          -1 !== mercator.indexOf(sp1.wkid) &&\r\n          -1 !== mercator.indexOf(sp2.wkid)\r\n        ) {\r\n          return true;\r\n        } else if (sp1 && sp2 &&\r\n          (\r\n            esriLang.isDefined(sp1.wkid) && esriLang.isDefined(sp2.wkid) && sp1.wkid === sp2.wkid ||\r\n            (esriLang.isDefined(sp1.latestWkid) && esriLang.isDefined(sp2.wkid) && sp1.latestWkid === sp2.wkid) ||\r\n            (esriLang.isDefined(sp1.wkid) && esriLang.isDefined(sp2.latestWkid) && sp1.wkid === sp2.latestWkid) ||\r\n            (esriLang.isDefined(sp1.latestWkid) && esriLang.isDefined(sp2.latestWkid) &&\r\n              sp1.latestWkid === sp2.latestWkid)\r\n          )\r\n        ) {\r\n          return true;\r\n        } else if (sp1 && sp2 && esriLang.isDefined(sp1.wkt) && esriLang.isDefined(sp2.wkt) && sp1.wkt === sp2.wkt) {\r\n          return true;\r\n        }\r\n\r\n        return false;\r\n      }\r\n    };\r\n\r\n    /********/\r\n    // mo.createBaseLayer_autoType = function (baseLayer, map) {\r\n    //   var def = new Deferred();\r\n    //   var layer = null;\r\n    //   var url = baseLayer.url,\r\n    //     type = baseLayer.type,\r\n    //     tileLayer = baseLayer.tileLayerInfo,\r\n    //     veLayer = baseLayer.veLayerInfo;\r\n    //   var lc = url.toLowerCase();\r\n\r\n    //   if (type === \"BaseMap\") {\r\n    //     def.resolve({ layer: \"BaseMap\" });//use raw BaseMap\r\n    //   } else if (type === \"ArcGIS\") {\r\n    //     mo.layers.fetchLayerInfo(url).then(function (info) {\r\n    //       var infoSR = null, mapSR = null;\r\n    //       infoSR = mo.layers._getLayerInfoSR(info);\r\n    //       mapSR = (map && map.spatialReference);\r\n    //       if (infoSR && mapSR && !mo.valid.sameSpatialReference(mapSR, infoSR)) {\r\n    //         def.resolve({ layer: null, err: \"wkid\" });\r\n    //       } else {\r\n    //         //2 same wkid\r\n    //         if (lc.indexOf(\"/featureserver\") > 0 || lc.indexOf(\"/mapserver\") > 0) {\r\n    //           if (info && typeof info.type === \"string\" &&\r\n    //             (info.type === \"Feature Layer\" || info.type === \"Table\")) {\r\n    //             def.resolve({ layer: null });//DO NOT SUPPORT\r\n    //           } else {\r\n    //             if (lc.indexOf(\"/featureserver\") > 0) {\r\n    //               def.resolve({ layer: null });//DO NOT SUPPORT\r\n    //             } else if (lc.indexOf(\"/mapserver\") > 0) {\r\n    //               if (info.tileInfo) {\r\n    //                 layer = new ArcGISTiledMapServiceLayer(url/*, param*/);//2.1\r\n    //                 def.resolve({ layer: layer });\r\n    //               } else {\r\n    //                 var mslOptions = {/* id: id*/ };\r\n    //                 if (info && info.supportedImageFormatTypes &&\r\n    //                   info.supportedImageFormatTypes.indexOf(\"PNG24\") !== -1) {\r\n    //                   mslOptions.imageParameters = new ImageParameters();\r\n    //                   mslOptions.imageParameters.format = \"png24\";\r\n    //                 }\r\n    //                 layer = new ArcGISDynamicMapServiceLayer(url, mslOptions);//2.2\r\n    //                 def.resolve({ layer: layer });\r\n    //               }\r\n    //             }\r\n    //           }\r\n    //         } else if (lc.indexOf(\"/imageserver\") > 0) {\r\n    //           layer = new ArcGISImageServiceLayer(url, {/*id: id*/ });//2.3\r\n    //           def.resolve({ layer: layer });\r\n    //         }\r\n    //       }\r\n    //     }).otherwise(function (error) {\r\n    //       def.reject({ layer: null, err: error });\r\n    //     });\r\n    //   } else if (type === \"OSM\") {\r\n    //     //OpenStreetMapLayer\r\n    //     layer = new OpenStreetMapLayer(url, {/*id: id*/ });\r\n    //     def.resolve({ layer: layer });\r\n    //   } else if (type === \"WebTiled\" && tileLayer) {\r\n    //     //WebTiledLayer TODO if (!canAdd) {}\r\n    //     tileLayer.url = tileLayer.url.replace(/{subdomain}/i, '{subDomain}');// fix URL\r\n    //     tileLayer.url = tileLayer.url.replace(/{level}/i, '{level}');\r\n    //     tileLayer.url = tileLayer.url.replace(/{col}/i, '{col}');\r\n    //     tileLayer.url = tileLayer.url.replace(/{row}/i, '{row}');\r\n    //     var _fullExtent = new Extent(tileLayer.extent);\r\n    //     //fullExtent = (tileLayer.fullExtent instanceof Extent) ? tileLayer.fullExtent : (tileLayer.fullExtent ? esri.geometry.Extent(tileLayer.fullExtent) : null);\r\n    //     var param = {\r\n    //       id: \"WebTiled_\" + Math.floor(Math.random() * 10001),\r\n    //       visible: true,\r\n    //       visibility: true,\r\n    //       opacity: 1,\r\n    //       identify: false,\r\n    //       title: tileLayer.tile,\r\n    //       copyright: tileLayer.credits,\r\n    //       fullExtent: _fullExtent,//TODO\r\n    //       initialExtent: _fullExtent,//TODO\r\n    //       //subDomains: tileLayer.subDomains, //API DO NOT pass this\r\n    //       tileServers: mo.layers._getTileServers(tileLayer)\r\n    //       //_addedVia: \"url\",\r\n    //       //snippet: \"\",\r\n    //       //wmtsInfo: tileLayer.wmtsInfo,\r\n    //       //refreshInterval: tileLayer.refreshInterval,\r\n    //     };\r\n    //     if (tileLayer.tileInfo && true === mo.valid.tileInfoStr(tileLayer.tileInfo)) {\r\n    //       param.tileInfo = new TileInfo(JSON.parse(tileLayer.tileInfo));\r\n    //     }\r\n\r\n    //     layer = new WebTiledLayer(tileLayer.url, param);\r\n    //     def.resolve({ layer: layer });\r\n    //   } else if (type === \"VETiled\" && veLayer) {\r\n    //     var key = mo.layers.getBingMapKey();\r\n    //     if (!key || !veLayer.isKeyInPortal) {\r\n    //       key = \"__invalidKey\";//set \"__invalidKey\" to show widget panel, when no key in portal\r\n    //       console.error(\"OverviewMap Error: BingMapsKey must be provided\");\r\n    //     }\r\n    //     layer = new VETiledLayer({\r\n    //       bingMapsKey: key,\r\n    //       mapStyle: mo.layers._getVEStyle(veLayer.style)\r\n    //     });\r\n    //     def.resolve({ layer: layer });\r\n    //   } else {\r\n    //     def.resolve({ layer: null });//DO NOT SUPPORT\r\n    //   }\r\n\r\n    //   return def;\r\n    // };\r\n\r\n    return mo;\r\n  });"]}