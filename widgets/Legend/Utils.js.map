{"version":3,"sources":["../../../widgets/Legend/Utils.js"],"names":["define","array","LayerInfos","mo","getLayerInfosParam","config","layerInfosParamFromCurrentMap","getLayerInfosParamFromCurrentMap","layerInfosParam","jimuLayerInfos","getInstanceSync","jimuLayerInfoArray","getLayerInfoArray","forEach","topLayerInfo","hideLayers","isShowLegend","layerObject","declaredClass","baseLayerInfos","dynamicLayerInfos","layerInfos","jsapiLayerInfo","subLayerInfo","traversal","layerInfo","subId","id","isLeaf","push","originOperLayer","mapService","isMapNotesLayerInfo","getSubLayers","mapNotesSubLayerInfo","layerInfoParam","layer","title","reverse","isSupportedLayerType","version","isShowLegendResult","layerState","selected","getShowLegendOfWebmap"],"mappings":"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","file":"Utils.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\n\r\ndefine([\r\n  'dojo/_base/array',\r\n  'jimu/LayerInfos/LayerInfos'\r\n], function(array, LayerInfos) {\r\n\r\n  var mo = {};\r\n\r\n  mo.getLayerInfosParam = function(config) {\r\n    // summary:\r\n    //   get layerInfos parameter for create/refresh/settingPage in legend dijit.\r\n    // description:\r\n    var layerInfosParamFromCurrentMap = getLayerInfosParamFromCurrentMap(config);\r\n    return layerInfosParamFromCurrentMap;\r\n  };\r\n\r\n  var getLayerInfosParamFromCurrentMap = function(config) {\r\n    var layerInfosParam     = [];\r\n    var jimuLayerInfos      = LayerInfos.getInstanceSync();\r\n    var jimuLayerInfoArray  = jimuLayerInfos.getLayerInfoArray();\r\n    array.forEach(jimuLayerInfoArray, function(topLayerInfo) {\r\n      var hideLayers = [];\r\n      if(isShowLegend(topLayerInfo, config)) {\r\n        // temporary code.\r\n        if(topLayerInfo.layerObject &&\r\n           (topLayerInfo.layerObject.declaredClass === 'esri.layers.ArcGISDynamicMapServiceLayer' ||\r\n            topLayerInfo.layerObject.declaredClass === 'esri.layers.ArcGISTiledMapServiceLayer')) {\r\n          // topLayerInfo.traversal(function(layerInfo) {\r\n          //   if(layerInfo.isLeaf() && !layerInfo.getShowLegendOfWebmap()) {\r\n          //     hideLayers.push(layerInfo.originOperLayer.mapService.subId);\r\n          //   }\r\n          // });\r\n          var baseLayerInfos = topLayerInfo.layerObject.dynamicLayerInfos || topLayerInfo.layerObject.layerInfos;\r\n          array.forEach(baseLayerInfos, function(jsapiLayerInfo) {\r\n            var subLayerInfo = null;\r\n            topLayerInfo.traversal(function(layerInfo) {\r\n              if(layerInfo.subId === jsapiLayerInfo.id) {\r\n                if(layerInfo.isLeaf() && !isShowLegend(layerInfo, config)) {\r\n                  hideLayers.push(layerInfo.originOperLayer.mapService.subId);\r\n                }\r\n                subLayerInfo = layerInfo;\r\n                return true;\r\n              }\r\n            });\r\n            if(!subLayerInfo) {\r\n              hideLayers.push(jsapiLayerInfo.id);\r\n            }\r\n          });\r\n        }\r\n        // add to layerInfosparam\r\n        if(topLayerInfo.isMapNotesLayerInfo()) {\r\n          array.forEach(topLayerInfo.getSubLayers(), function(mapNotesSubLayerInfo) {\r\n            if(isShowLegend(mapNotesSubLayerInfo, config)) {\r\n              var layerInfoParam = {\r\n                layer: mapNotesSubLayerInfo.layerObject,\r\n                title: \"Map Notes - \" + mapNotesSubLayerInfo.title\r\n              };\r\n              layerInfosParam.push(layerInfoParam);\r\n            }\r\n          });\r\n        } else {\r\n          var layerInfoParam = {\r\n            hideLayers: hideLayers,\r\n            layer: topLayerInfo.layerObject,\r\n            title: topLayerInfo.title\r\n          };\r\n          layerInfosParam.push(layerInfoParam);\r\n        }\r\n      }\r\n    });\r\n    return layerInfosParam.reverse();\r\n  };\r\n\r\n  mo.isSupportedLayerType = function(layer) {\r\n    if (layer &&\r\n        (layer.declaredClass === \"esri.layers.ArcGISDynamicMapServiceLayer\" ||\r\n        (layer.declaredClass === \"esri.layers.ArcGISImageServiceLayer\" && layer.version >= 10.2) ||\r\n        layer.declaredClass === \"esri.layers.ArcGISImageServiceVectorLayer\" ||\r\n        layer.declaredClass === \"esri.layers.ArcGISTiledMapServiceLayer\" ||\r\n        layer.declaredClass === \"esri.layers.FeatureLayer\" ||\r\n        layer.declaredClass === \"esri.layers.StreamLayer\" ||\r\n        layer.declaredClass === \"esri.layers.KMLLayer\" ||\r\n        layer.declaredClass === \"esri.layers.GeoRSSLayer\" ||\r\n        layer.declaredClass === \"esri.layers.WMSLayer\" ||\r\n        layer.declaredClass === \"esri.layers.WFSLayer\" ||\r\n        layer.declaredClass === \"esri.layers.CSVLayer\")) {\r\n      return true;\r\n    }\r\n    return false;\r\n  };\r\n  /*\r\n  function isShowLegend(layerInfo, config) {\r\n    var isToggledOnLegend;\r\n    var isShowLegendResult = true;\r\n    var currentLayerInfo = layerInfo;\r\n    while(currentLayerInfo) {\r\n      isToggledOnLegend = config.layerState[currentLayerInfo.id] ?\r\n                                config.layerState[currentLayerInfo.id].selected :\r\n                                layerInfo._getShowLegendOfWebmap();\r\n      isShowLegendResult = isShowLegendResult && isToggledOnLegend;\r\n      currentLayerInfo = currentLayerInfo.parentLayerInfo;\r\n    }\r\n\r\n    return isShowLegendResult;\r\n  }\r\n  */\r\n\r\n  function isShowLegend(layerInfo, config) {\r\n    /*jshint unused: false*/\r\n    var isShowLegendResult;\r\n    if(layerInfo.isLeaf()) {\r\n      isShowLegendResult = config.layerState[layerInfo.id] ?\r\n                         config.layerState[layerInfo.id].selected :\r\n                         layerInfo.getShowLegendOfWebmap();\r\n    } else {\r\n      isShowLegendResult = true;\r\n    }\r\n    return isShowLegendResult;\r\n  }\r\n\r\n\r\n  return mo;\r\n});\r\n"]}