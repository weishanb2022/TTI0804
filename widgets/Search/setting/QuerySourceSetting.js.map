{"version":3,"sources":["../../../../widgets/Search/setting/QuerySourceSetting.js"],"names":["define","declare","html","_WidgetBase","_TemplatedMixin","_WidgetsInTemplateMixin","template","lang","array","on","query","Deferred","Evented","_FeaturelayerSourcePopup","portalUrlUtils","esriRequest","esriLang","jimuUtils","Popup","CheckBox","baseClass","templateString","nls","appConfig","map","tr","config","fieldsPopup","_layerDefinition","_fieldsCheckBox","_layerId","_suggestible","_clickSet","_defaultZoomScale","postCreate","inherited","arguments","zoomScale","set","window","jimuNls","common","defaults","exactMatch","checked","label","searchInCurrentMapExtent","_setMessageNodeContent","own","panToRadio","hitch","_onRadioClicke","zoomToRadio","setDefinition","definition","getDefinition","setRelatedTr","getRelatedTr","setConfig","Object","prototype","toString","call","url","shelter","show","_getDefinitionFromRemote","then","response","type","_setSourceItems","_disableSourceItems","substitute","clone","invalidUrlTip","hide","isValidConfig","getConfig","name","displayField","showValidationTip","_showValidationErrorTip","sourceUrl","sourceName","json","layerId","get","stripHTML","placeholder","searchFields","_getSearchFields","getValue","panToScale","maxSuggestions","maxResults","destroy","close","_onSourceNameBlur","_onPlaceholderBlur","setStyle","fieldsSelectorNode","_enableSourceItems","_controlZoomScaleTextBox","_setSearchFields2Node","_getSearchFieldsAlias","_setDisplayFieldOptions","setValue","advancedQueryCapabilities","supportsPagination","_showSuggestibleTips","_hideSuggestibleTips","resultDef","def","content","f","handleAs","callbackParamName","resolve","err","console","error","_getRequestUrl","promise","empty","messageNode","nodeType","toDom","place","messageTr","protocol","location","setHttpProtocol","setHttpsProtocol","fields","fieldsFromDefinition","length","fieldsFromConfig","layerFields","configFields","filter","cf","some","lf","options","alias","value","join","fNames","field","i","len","index","indexOf","push","_setSearchFields","_onSetSourceClick","_openServiceChooser","_openQuerySourceChooser","args","titleLabel","setLayerSource","dijitArgs","multiple","createMapResponse","webMapResponse","portalUrl","style","height","featurePopup","once","item","layerInfo","id","emit","_onFieldsSelectorClick","contentDom","create","maxHeight","forEach","idx","chk","_isSearchable","addClass","domNode","labelNode","setAttr","isRTL","placeAt","data","setSearchFields","autoHeight","container","jimuConfig","layoutId","width","buttons","ok","onClick","cancel","classNames","onClose","_onSearchFieldsOk","_fields","_data","removeData","sf","tipsNode","removeClass","_dijit","validate","focusNode","_disabled","focus","setTimeout","blur"],"mappings":"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","file":"QuerySourceSetting.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright © Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n  'dojo/_base/declare',\r\n  'dojo/_base/html',\r\n  'dijit/_WidgetBase',\r\n  'dijit/_TemplatedMixin',\r\n  'dijit/_WidgetsInTemplateMixin',\r\n  'dojo/text!./QuerySourceSetting.html',\r\n  'dojo/_base/lang',\r\n  'dojo/_base/array',\r\n  'dojo/on',\r\n  'dojo/query',\r\n  'dojo/Deferred',\r\n  'dojo/Evented',\r\n  'jimu/dijit/_FeaturelayerSourcePopup',\r\n  \"jimu/portalUrlUtils\",\r\n  'esri/request',\r\n  \"esri/lang\",\r\n  'jimu/utils',\r\n  'jimu/dijit/Popup',\r\n  'jimu/dijit/CheckBox',\r\n  'jimu/dijit/LoadingShelter',\r\n  'dijit/form/ValidationTextBox',\r\n  'dojo/NodeList-data'\r\n],\r\nfunction(declare, html, _WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin,\r\n  template, lang, array, on, query, Deferred, Evented,\r\n  _FeaturelayerSourcePopup, portalUrlUtils, esriRequest, esriLang,\r\n  jimuUtils, Popup, CheckBox) {\r\n  return declare([_WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin, Evented], {\r\n    baseClass: 'jimu-widget-search-query-source-setting',\r\n    templateString: template,\r\n\r\n    nls: null,\r\n    appConfig: null,\r\n    map: null,\r\n\r\n    tr: null,\r\n    config: null,\r\n    fieldsPopup: null,\r\n    _layerDefinition: null,//include url\r\n    _fieldsCheckBox : null,\r\n    _layerId: null,\r\n    _suggestible: false,\r\n\r\n    _clickSet: false,\r\n    _defaultZoomScale: null,\r\n\r\n    //event\r\n    //reset-query-source\r\n\r\n    postCreate: function() {\r\n      this.inherited(arguments);\r\n\r\n      this.zoomScale.set('placeHolder', window.jimuNls.common.defaults);\r\n      this.exactMatch = new CheckBox({\r\n        checked: false,\r\n        label: this.nls.exactMatch\r\n      }, this.exactMatch);\r\n      this.searchInCurrentMapExtent = new CheckBox({\r\n        checked: false,\r\n        label: this.nls.searchInCurrentMapExtent\r\n      }, this.searchInCurrentMapExtent);\r\n\r\n      this._layerDefinition = {};\r\n      this._fieldsCheckBox = [];\r\n\r\n      this._setMessageNodeContent(\"\");\r\n      this.own(on(this.panToRadio, 'click', lang.hitch(this, this._onRadioClicke)));\r\n      this.own(on(this.zoomToRadio, 'click', lang.hitch(this, this._onRadioClicke)));\r\n    },\r\n\r\n    setDefinition: function(definition) {\r\n      this._layerDefinition = definition || {};\r\n    },\r\n\r\n    getDefinition: function() {\r\n      return this._layerDefinition;\r\n    },\r\n\r\n    setRelatedTr: function(tr) {\r\n      this.tr = tr;\r\n    },\r\n\r\n    getRelatedTr: function() {\r\n      return this.tr;\r\n    },\r\n\r\n    setConfig: function(config) {\r\n      if (Object.prototype.toString.call(config) !== \"[object Object]\") {\r\n        return;\r\n      }\r\n\r\n      var url = config.url;\r\n      if (!url) {\r\n        return;\r\n      }\r\n      this.config = config;\r\n\r\n      this.shelter.show();\r\n      if (this._layerDefinition.url !== url) {\r\n        this._getDefinitionFromRemote(url).then(lang.hitch(this, function(response) {\r\n          if (url && (response && response.type !== 'error')) {\r\n            this._layerDefinition = response;\r\n            this._layerDefinition.url = url;\r\n            this._setSourceItems();\r\n            this._setMessageNodeContent(\"\");\r\n          } else if (url && (response && response.type === 'error')) {\r\n            this._setSourceItems();\r\n            this._disableSourceItems();\r\n            this._setMessageNodeContent(esriLang.substitute({\r\n              'URL': response.url\r\n            }, lang.clone(this.nls.invalidUrlTip)), true);\r\n          }\r\n          this.shelter.hide();\r\n        }));\r\n      } else {\r\n        this._setMessageNodeContent(\"\");\r\n        this._setSourceItems();\r\n        this.shelter.hide();\r\n      }\r\n    },\r\n\r\n    isValidConfig: function() {\r\n      var config = this.getConfig();\r\n      if (config.url && config.name && config.displayField) {\r\n        return true;\r\n      }else {\r\n        return false;\r\n      }\r\n    },\r\n\r\n    showValidationTip: function() {\r\n      this._showValidationErrorTip(this.sourceUrl);\r\n      this._showValidationErrorTip(this.sourceName);\r\n    },\r\n\r\n    getConfig: function() {\r\n      var json = {\r\n        layerId: this._layerId,\r\n        url: this.sourceUrl.get('value'),\r\n        name: jimuUtils.stripHTML(this.sourceName.get('value')),\r\n        placeholder: jimuUtils.stripHTML(this.placeholder.get('value')),\r\n        searchFields: this._getSearchFields(),// defaults to FeatureLayer.displayField\r\n        displayField: this.displayField.get('value'),// defaults to FeatureLayer.displayField\r\n        exactMatch: this.exactMatch.getValue(),\r\n        searchInCurrentMapExtent: this.searchInCurrentMapExtent.checked,\r\n        panToScale: this.panToRadio.get('checked') ? true : false,\r\n        zoomScale: this.zoomScale.get('value') || this._defaultZoomScale,\r\n        maxSuggestions: this.maxSuggestions.get('value'),\r\n        maxResults: this.maxResults.get('value') || 6,\r\n        type: 'query'\r\n      };\r\n\r\n      return json;\r\n    },\r\n\r\n    destroy: function() {\r\n      this.inherited(arguments);\r\n      if (this.fieldsPopup) {\r\n        this.fieldsPopup.close();\r\n        this.fieldsPopup = null;\r\n      }\r\n      this._layerDefinition = null;\r\n      this.config = null;\r\n      this.nls = null;\r\n      this.tr = null;\r\n    },\r\n\r\n    _onSourceNameBlur: function() {\r\n      this.sourceName.set('value', jimuUtils.stripHTML(this.sourceName.get('value')));\r\n    },\r\n\r\n    _onPlaceholderBlur: function() {\r\n      this.placeholder.set('value', jimuUtils.stripHTML(this.placeholder.get('value')));\r\n    },\r\n\r\n    _disableSourceItems: function() {\r\n      this.sourceName.set('disabled', true);\r\n      this.placeholder.set('disabled', true);\r\n      //this.searchFields.set('disabled', true);\r\n      html.setStyle(this.fieldsSelectorNode, 'display', 'none');\r\n      this.displayField.set('disabled', true);\r\n      this.maxSuggestions.set('disabled', true);\r\n      this.maxResults.set('disabled', true);\r\n      this.zoomScale.set('disabled', true);\r\n    },\r\n\r\n    _enableSourceItems: function() {\r\n      this.sourceName.set('disabled', false);\r\n      this.placeholder.set('disabled', false);\r\n      //this.searchFields.set('disabled', false);\r\n      html.setStyle(this.fieldsSelectorNode, 'display', 'inline-block');\r\n      this.displayField.set('disabled', false);\r\n      this.maxSuggestions.set('disabled', false);\r\n      this.maxResults.set('disabled', false);\r\n      this._controlZoomScaleTextBox();\r\n    },\r\n\r\n    _setSourceItems: function() {\r\n      this.sourceUrl.set('value', this.config.url);\r\n      this.sourceName.set('value', jimuUtils.stripHTML(this.config.name || \"\"));\r\n      this.placeholder.set('value', jimuUtils.stripHTML(this.config.placeholder || \"\"));\r\n      this._setSearchFields2Node();\r\n      this.searchFields.set('value', this._getSearchFieldsAlias());\r\n      this._setDisplayFieldOptions();\r\n      this.displayField.set('value', this.config.displayField || \"\");\r\n      this.exactMatch.setValue(!!this.config.exactMatch);\r\n      this.searchInCurrentMapExtent.setValue(!!this.config.searchInCurrentMapExtent);\r\n      if(this.config.panToScale) {\r\n        //html.setAttr(this.panToRadio, 'checked', '');\r\n        this.panToRadio.set('checked', true);\r\n      } else {\r\n        //html.setAttr(this.zoomToRadio, 'checked', '');\r\n        this.zoomToRadio.set('checked', true);\r\n      }\r\n      this.zoomScale.set('value', this.config.zoomScale || this._defaultZoomScale);\r\n      this.maxSuggestions.set('value', this.config.maxSuggestions);\r\n      this.maxResults.set('value', this.config.maxResults || 6);\r\n      this._layerId = this.config.layerId;\r\n\r\n      this._suggestible = this._layerDefinition &&\r\n        this._layerDefinition.advancedQueryCapabilities &&\r\n        this._layerDefinition.advancedQueryCapabilities.supportsPagination;\r\n      if (!this._suggestible) {\r\n        this._showSuggestibleTips();\r\n      } else {\r\n        this._hideSuggestibleTips();\r\n      }\r\n      /*\r\n      var isPointLayer = this._layerDefinition &&\r\n        this._layerDefinition.geometryType === 'esriGeometryPoint';\r\n      if (!isPointLayer) {\r\n        html.setStyle(this.zoomScaleTr, 'display', 'none');\r\n      } else {\r\n        html.setStyle(this.zoomScaleTr, 'display', '');\r\n      }\r\n      */\r\n      this._enableSourceItems();\r\n    },\r\n\r\n    _getDefinitionFromRemote: function(url) {\r\n      var resultDef = new Deferred();\r\n      var def = esriRequest({\r\n          url: url,\r\n          content: {\r\n            f: 'json'\r\n          },\r\n          handleAs: 'json',\r\n          callbackParamName: 'callback'\r\n        });\r\n      this.own(def);\r\n      def.then(lang.hitch(this, function(response) {\r\n        resultDef.resolve(response);\r\n      }), lang.hitch(this, function(err) {\r\n        console.error(err);\r\n        resultDef.resolve({\r\n          type: 'error',\r\n          url: this._getRequestUrl(url)\r\n        });\r\n      }));\r\n      return resultDef.promise;\r\n    },\r\n\r\n    _setMessageNodeContent: function(content, err) {\r\n      html.empty(this.messageNode);\r\n      if (!content.nodeType) {\r\n        content = html.toDom(content);\r\n      }\r\n      html.place(content, this.messageNode);\r\n      if (err) {\r\n        html.setStyle(this.messageTr, 'display', '');\r\n      } else {\r\n        html.setStyle(this.messageTr, 'display', 'none');\r\n      }\r\n    },\r\n\r\n    _getRequestUrl: function(url) {\r\n      var protocol = window.location.protocol;\r\n      if (protocol === 'http:') {\r\n        return portalUrlUtils.setHttpProtocol(url);\r\n      } else if (protocol === 'https:'){\r\n        return portalUrlUtils.setHttpsProtocol(url);\r\n      } else {\r\n        return url;\r\n      }\r\n    },\r\n\r\n    _setSearchFields2Node: function() {\r\n      var fields = null;\r\n      var fieldsFromDefinition = this._layerDefinition &&\r\n        this._layerDefinition.fields && this._layerDefinition.fields.length > 0;\r\n      var fieldsFromConfig = this.config && this.config.searchFields &&\r\n        this.config.searchFields.length > 0;\r\n\r\n      if (!fieldsFromConfig) {\r\n        fields = [];\r\n      }\r\n      if (!fieldsFromDefinition) {\r\n        fields = this.config.searchFields;\r\n      } else { //fieldsFromDefinition && fieldsFromConfig\r\n        var layerFields = this._layerDefinition.fields;\r\n        var configFields = this.config.searchFields;\r\n        fields = array.filter(configFields, function(cf) {\r\n          return array.some(layerFields, function(lf) {\r\n            return lf.name === cf;\r\n          });\r\n        });\r\n      }\r\n\r\n      this.searchFields.set('_fields', fields);\r\n    },\r\n\r\n    _setDisplayFieldOptions: function() {\r\n      var fieldsFromDefinition = this._layerDefinition &&\r\n        this._layerDefinition.fields && this._layerDefinition.fields.length > 0;\r\n      var options = [];\r\n      if (fieldsFromDefinition) {\r\n        var layerFields = this._layerDefinition.fields;\r\n        options = array.map(layerFields, function(lf) {\r\n          return {\r\n            label: lf.alias || lf.name || \"\",\r\n            value: lf.name || \"\"\r\n          };\r\n        });\r\n      } else if (this.config && this.config.displayField) {\r\n        options = [{\r\n          label: this.config.displayField,\r\n          value: this.config.displayField\r\n        }];\r\n      }\r\n\r\n      this.displayField.set('options', options);\r\n    },\r\n\r\n    _getSearchFieldsAlias: function() {\r\n      var fields = this._getSearchFields();\r\n      var fieldsFromDefinition = this._layerDefinition &&\r\n        this._layerDefinition.fields && this._layerDefinition.fields.length > 0;\r\n      var fieldsFromConfig = fields && fields.length > 0;\r\n      if (!fieldsFromConfig) {\r\n        return \"\";\r\n      }\r\n      if (!fieldsFromDefinition) {\r\n        return fields.join(',');\r\n      } else { //fieldsFromDefinition && fieldsFromConfig\r\n        var layerFields = this._layerDefinition.fields;\r\n        var fNames = array.map(layerFields, function(field) {\r\n          return field && field.name;\r\n        });\r\n        var alias = [];\r\n        for (var i = 0, len = fields.length; i < len; i++) {\r\n          var index = fNames.indexOf(fields[i]);\r\n          if (index > -1) {\r\n            alias.push(layerFields[index].alias);\r\n          }\r\n        }\r\n        return alias.join(',');\r\n      }\r\n    },\r\n\r\n    _getSearchFields: function() {\r\n      return this.searchFields.get('_fields');\r\n    },\r\n\r\n    _setSearchFields: function(fields) {\r\n      this.searchFields.set('_fields', fields);\r\n    },\r\n\r\n    _onSetSourceClick: function() {\r\n      this._clickSet = true;\r\n      this._openServiceChooser();\r\n    },\r\n\r\n    _openQuerySourceChooser: function() {\r\n      this._clickSet = false;\r\n      this._openServiceChooser();\r\n    },\r\n\r\n    _openServiceChooser: function() {\r\n      var args = {\r\n        titleLabel: this.nls.setLayerSource,\r\n\r\n        dijitArgs: {\r\n          multiple: false,\r\n          createMapResponse: this.map.webMapResponse,\r\n          portalUrl: this.appConfig.portalUrl,\r\n          style: {\r\n            height: '100%'\r\n          }\r\n        }\r\n      };\r\n\r\n      var featurePopup = new _FeaturelayerSourcePopup(args);\r\n      on.once(featurePopup, 'ok', lang.hitch(this, function(item) {\r\n        featurePopup.close();\r\n        this.setDefinition(item.definition || {});\r\n        this.setConfig({\r\n          layerId: item.layerInfo && item.layerInfo.id || null,\r\n          url: item.url,\r\n          name: item.name || \"\",\r\n          placeholder: \"\",\r\n          searchFields: [],\r\n          displayField: this._layerDefinition.displayField || \"\",\r\n          exactMatch: false,\r\n          zoomScale: this._defaultZoomScale, //default\r\n          maxSuggestions: 6, //default\r\n          maxResults: 6,//default\r\n          type: \"query\"\r\n        });\r\n        featurePopup = null;\r\n        this._setMessageNodeContent(\"\");\r\n\r\n        if (this._clickSet) {\r\n          this.emit('reselect-query-source-ok', item);\r\n        } else {\r\n          this.emit('select-query-source-ok', item);\r\n        }\r\n      }));\r\n\r\n      on.once(featurePopup, 'cancel', lang.hitch(this, function() {\r\n        featurePopup.close();\r\n        featurePopup = null;\r\n\r\n        this.emit('select-query-source-cancel');\r\n      }));\r\n    },\r\n\r\n    _onFieldsSelectorClick: function() {\r\n      var contentDom = html.create('div', {\r\n        style: {\r\n          maxHeight: '480px'\r\n        }\r\n      });\r\n\r\n      var layerFields = this._layerDefinition.fields;\r\n      this._fieldsCheckBox = [];\r\n      array.forEach(layerFields, lang.hitch(this, function(field, idx) {\r\n        var chk = new CheckBox({\r\n          checked: this._isSearchable(field),\r\n          label: field.alias || field.name\r\n        });\r\n        html.addClass(chk.domNode, 'fields-checkbox');\r\n        html.addClass(chk.labelNode, 'jimu-ellipsis');\r\n        html.setAttr(chk.domNode, {\r\n          'title': field.alias || field.name\r\n        });\r\n        if (idx % 3 === 0) {\r\n          if (window.isRTL) {\r\n            html.setStyle(chk.domNode, 'marginRight', 0);\r\n          } else {\r\n            html.setStyle(chk.domNode, 'marginLeft', 0);\r\n          }\r\n        }\r\n        chk.placeAt(contentDom);\r\n        query(chk.domNode).data('fieldName', field.name);\r\n        this._fieldsCheckBox.push(chk);\r\n      }));\r\n\r\n      this.fieldsPopup = new Popup({\r\n        titleLabel: this.nls.setSearchFields,\r\n        autoHeight: true,\r\n        content: contentDom,\r\n        container: window.jimuConfig.layoutId,\r\n        width: 640,\r\n        maxHeight: 600,\r\n        buttons: [{\r\n          label: this.nls.ok,\r\n          onClick: lang.hitch(this, '_onSearchFieldsOk')\r\n        }, {\r\n          label: this.nls.cancel,\r\n          classNames: ['jimu-btn-vacation']\r\n        }],\r\n        onClose: lang.hitch(this, function() {\r\n          this.fieldsPopup = null;\r\n        })\r\n      });\r\n      html.addClass(this.fieldsPopup.domNode, 'jimu-widget-search-query-source-setting-fields');\r\n    },\r\n\r\n    _onSearchFieldsOk: function() {\r\n      var _fields = [];\r\n      array.forEach(this._fieldsCheckBox, function(chk) {\r\n        if (chk.getValue()) {\r\n          var _data = query(chk.domNode).data('fieldName');\r\n          _fields.push(_data[0]);\r\n          query(chk.domNode).removeData();\r\n        }\r\n      });\r\n      this._setSearchFields(_fields);\r\n      this.searchFields.set('value', this._getSearchFieldsAlias());\r\n      this.fieldsPopup.close();\r\n    },\r\n\r\n    _isSearchable: function(field) {\r\n      var searchFields = this._getSearchFields();\r\n      return array.some(searchFields, lang.hitch(this, function(sf){\r\n        return field.name === sf;\r\n      }));\r\n    },\r\n\r\n    _showSuggestibleTips: function() {\r\n      html.addClass(this.tipsNode, 'source-tips-show');\r\n      html.setStyle(this.maxSuggestions.domNode, 'display', 'none');\r\n    },\r\n\r\n    _hideSuggestibleTips: function() {\r\n      html.removeClass(this.tipsNode, 'source-tips-show');\r\n      html.setStyle(this.maxSuggestions.domNode, 'display', 'block');\r\n    },\r\n\r\n    _showValidationErrorTip: function(_dijit){\r\n      if (!_dijit.validate() && _dijit.domNode) {\r\n        if (_dijit.focusNode) {\r\n          var _disabled = _dijit.get('disabled');\r\n          if (_disabled) {\r\n            _dijit.set('disabled', false);\r\n          }\r\n          _dijit.focusNode.focus();\r\n          setTimeout(lang.hitch(this, function() {\r\n            _dijit.focusNode.blur();\r\n            if (_disabled) {\r\n              _dijit.set('disabled', true);\r\n            }\r\n            _dijit = null;\r\n          }), 100);\r\n        }\r\n      }\r\n    },\r\n\r\n    _controlZoomScaleTextBox: function() {\r\n      if(this.panToRadio.get('checked')){\r\n        this.zoomScale.set(\"disabled\", true);\r\n      } else if(this.zoomToRadio.get('checked')){\r\n        this.zoomScale.set(\"disabled\", false);\r\n      }\r\n    },\r\n\r\n    _onRadioClicke: function() {\r\n      this._controlZoomScaleTextBox();\r\n    }\r\n\r\n  });\r\n});\r\n"]}