{"version":3,"sources":["../../../widgets/Search/Widget.js"],"names":["define","declare","lang","array","html","when","on","aspect","query","keys","Deferred","all","focusUtil","BaseWidget","LayerInfos","jimuUtils","wkidUtils","esriConfig","Search","Locator","FeatureLayer","PopupTemplate","esriLang","Point","coordinateFormatter","SpatialReference","FeatureQuery","Color","SimpleMarkerSymbol","SimpleFillSymbol","SimpleLineSymbol","utils","name","baseClass","searchDijit","searchResults","_startWidth","_pointOfSpecifiedUtmCache","postCreate","closeable","isOnScreen","addClass","searchNode","listenWidgetIds","push","startup","inherited","arguments","config","sources","load","getInstance","map","itemInfo","then","hitch","layerInfosObj","own","onLayerInfosFilterChanged","setMap","setLayerInfosObj","setAppConfig","appConfig","getConfigInfo","_convertConfig","searchSouces","filter","source","domNode","activeSourceIndex","length","allPlaceholder","stripHTML","isDefined","autoSelect","enableButtonMode","enableLabel","enableHighlight","enableInfoWindow","showInfoWindowOnSelect","theme","place","_resetSearchDijitStyle","watch","around","before","results","idx","value","newResults","result","Error","message","err","console","log","initFirstFocusNode","inputNode","sourcesBtnNode","initLastFocusNode","submitNode","evt","hasClass","target","keyCode","ENTER","focus","ESCAPE","getStyle","searchResultsNode","setStyle","originalFun","e","returnValue","_inputKey","apply","UP_ARROW","DOWN_ARROW","_onClearSearch","window","document","isDescendant","_hideResultMenu","_resetSelectorPosition","suggestionsNode","_hideSuggestionsMenu","fetchData","sourceDefs","def","url","type","_source","locator","outFields","singleLineFieldName","placeholder","countryCode","maxResults","zoomScale","useMapExtent","searchInCurrentMapExtent","_zoomScaleOfConfigSource","_panToScale","panToScale","maxSuggestions","enableSuggestions","undefined","enableLocalSearch","localSearchOptions","minScale","localSearchMinScale","distance","_getLocalSearchDistance","autoNavigate","resolve","searchLayer","flayer","layer","sourceLayer","getLayer","layerId","sourceLayerInfo","getLayerInfoById","fNames","searchFields","forEach","fields","field","objectIdField","convertedSource","featureLayer","displayField","exactMatch","_featureLayerId","layerInfo","setDefinitionExpression","getFilter","_getInfoTemplate","infoTemplate","geometryType","highlightSymbol","STYLE_CIRCLE","STYLE_SOLID","STYLE_NULL","radiusUnit","localSearchDistance","fLayer","template","loadInfoTemplate","fieldNames","fieldName","toLowerCase","indexOf","title","popupInfo","getDefaultPopupInfo","_getSourceIndexOfResult","i","sourceResults","pos","parseInt","_zoomToScale","features","setScale","featureAction","panTo","_showPopupByFeatures","selectEvent","location","isPoint","infoWindow","setFeatures","geometry","extent","getExtent","getCenter","show","closetFirst","updateHighlight","showHighlight","featureSet","toFeatureSet","zoomToFeatureSet","_cloneInfoTemplate","newInfoTemplate","toJson","constructor","_loadInfoTemplateAndShowPopup","selectedFeature","layerObjectInMap","id","isPopupEnabled","setInfoTemplate","handle","remove","_onSelectResult","dataSourceIndex","sourceIndex","dataIndex","resultFeature","feature","sourceLayerId","getGraphics","fid","graphics","gs","g","attributes","len","isEqual","li","removeClass","getAttr","dIdx","dsIndex","toString","getLayerObject","featureQuery","where","outSpatialReference","spatialReference","queryFeatures","zoomToExtent","publishData","destroy","clear","onReceiveData","widgetId","data","searchString","set","search","changedLayerInfos","some","info","s","_onSourceIndexChange","_onSearchResults","get","sanitizeHTML","htmlContent","_activeSourceNumber","outputTextforCustomInput","_getOutputTextForCustomInput","numResults","containerNode","nls","showAll","showAllResults","j","text","untitled","innerHTML","_showResultMenu","_onSuggestResults","_showSuggestionsMenu","_hidePopup","isShowing","hide","setPosition","position","resize","setTimeout","box","w","appInfo","isRunInMobile","getComputedStyle","width","sourcesBox","getMarginBox","submitBox","style","isFinite","isRTL","left","right","inputGroup","groupBox","extents","getPadBorderExtents","_convertSR","index","pointOfSpecifiedWkid","_getPointFromSpecifiedWkid","projectToSpatialReference","wkid","event","targetPoint","inputText","_getFormatedInputFromPoint","clone","_getPointFromSpecifiedUtm","pointOfSpecifiedUtm","point","isNaN","x","y","inputString","coordinateParams","split","coordinateText","Number","isValidWkid","coordinateValues","_getPointFromSpecifiedUtmByGeometryService","retDef","resultPoint","params","sr","conversionType","conversionMode","strings","geometryService","defaults","declaredClass","fromGeoCoordinateString","_isValidUtmFormat","utmString","isSupported","isLoaded","fromUtm","outputText","_onSearchDijitClick","_onSelectSearchResult","hasAttr","parentNode","select","groupNode","l","cls","layoutBox","jimuConfig","layoutId","menu","menuPosition","dijitPosition","up","down","h","Math","max","lists","TAB","stopPropagation","preventDefault","nextLi","ctrlKey","metaKey","copyKey","LEFT_ARROW","RIGHT_ARROW","_onSearchResultLiKey"],"mappings":"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","file":"Widget.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright © Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n    'dojo/_base/declare',\r\n    'dojo/_base/lang',\r\n    'dojo/_base/array',\r\n    'dojo/_base/html',\r\n    'dojo/when',\r\n    'dojo/on',\r\n    'dojo/aspect',\r\n    'dojo/query',\r\n    'dojo/keys',\r\n    'dojo/Deferred',\r\n    'dojo/promise/all',\r\n    \"dijit/focus\",\r\n    'jimu/BaseWidget',\r\n    'jimu/LayerInfos/LayerInfos',\r\n    'jimu/utils',\r\n    'jimu/SpatialReference/wkidUtils',\r\n    'esri/config',\r\n    'esri/dijit/Search',\r\n    'esri/tasks/locator',\r\n    'esri/layers/FeatureLayer',\r\n    'esri/dijit/PopupTemplate',\r\n    'esri/lang',\r\n    'esri/geometry/Point',\r\n    'esri/geometry/coordinateFormatter',\r\n    'esri/SpatialReference',\r\n    'esri/tasks/query',\r\n    'esri/Color',\r\n    'esri/symbols/SimpleMarkerSymbol',\r\n    'esri/symbols/SimpleFillSymbol',\r\n    'esri/symbols/SimpleLineSymbol',\r\n    './utils',\r\n    'dojo/NodeList-dom'\r\n  ],\r\n  function(declare, lang, array, html, when, on, aspect, query, keys, Deferred, all, focusUtil,\r\n    BaseWidget, LayerInfos, jimuUtils, wkidUtils, esriConfig, Search, Locator,\r\n    FeatureLayer, PopupTemplate, esriLang, Point, coordinateFormatter, SpatialReference, FeatureQuery,\r\n    Color, SimpleMarkerSymbol, SimpleFillSymbol, SimpleLineSymbol, utils) {\r\n    //To create a widget, you need to derive from BaseWidget.\r\n    return declare([BaseWidget], {\r\n      name: 'Search',\r\n      baseClass: 'jimu-widget-search',\r\n      searchDijit: null,\r\n      searchResults: null,\r\n      _startWidth: null,\r\n      _pointOfSpecifiedUtmCache: null,\r\n\r\n      postCreate: function() {\r\n\r\n        if (this.closeable || !this.isOnScreen) {\r\n          html.addClass(this.searchNode, 'default-width-for-openAtStart');\r\n        }\r\n\r\n        this.listenWidgetIds.push('framework');\r\n        this._pointOfSpecifiedUtmCache = {};\r\n      },\r\n\r\n      startup: function() {\r\n        this.inherited(arguments);\r\n\r\n        if (!(this.config && this.config.sources)) {\r\n          this.config.sources = [];\r\n        }\r\n\r\n        coordinateFormatter.load();\r\n        LayerInfos.getInstance(this.map, this.map.itemInfo)\r\n          .then(lang.hitch(this, function(layerInfosObj) {\r\n            this.layerInfosObj = layerInfosObj;\r\n            this.own(this.layerInfosObj.on(\r\n            'layerInfosFilterChanged',\r\n            lang.hitch(this, this.onLayerInfosFilterChanged)));\r\n\r\n            utils.setMap(this.map);\r\n            utils.setLayerInfosObj(this.layerInfosObj);\r\n            utils.setAppConfig(this.appConfig);\r\n            when(utils.getConfigInfo(this.config)).then(lang.hitch(this, function(config) {\r\n              return all(this._convertConfig(config)).then(function(searchSouces) {\r\n                return array.filter(searchSouces, function(source) {\r\n                  return source;\r\n                });\r\n              });\r\n            })).then(lang.hitch(this, function(searchSouces) {\r\n              if (!this.domNode) {\r\n                return;\r\n              }\r\n\r\n              this.searchDijit = new Search({\r\n                activeSourceIndex: searchSouces.length === 1 ? 0 : 'all',\r\n                allPlaceholder: jimuUtils.stripHTML(esriLang.isDefined(this.config.allPlaceholder) ?\r\n                  this.config.allPlaceholder : \"\"),\r\n                autoSelect: true,\r\n                enableButtonMode: false,\r\n                enableLabel: false,\r\n                enableHighlight: true,\r\n                enableInfoWindow: true,\r\n                showInfoWindowOnSelect: true,\r\n                map: this.map,\r\n                sources: searchSouces,\r\n                //minCharacters: 1,\r\n                theme: 'arcgisSearch'\r\n              });\r\n              html.place(this.searchDijit.domNode, this.searchNode);\r\n              this.searchDijit.startup();\r\n\r\n              this._resetSearchDijitStyle();\r\n\r\n              this.own(\r\n                this.searchDijit.watch(\r\n                  'activeSourceIndex',\r\n                  lang.hitch(this, '_onSourceIndexChange')\r\n                )\r\n              );\r\n\r\n              this.own(\r\n                on(this.searchDijit, 'search-results', lang.hitch(this, '_onSearchResults'))\r\n              );\r\n\r\n              this.own(\r\n                on(this.searchDijit, 'suggest-results', lang.hitch(this, '_onSuggestResults'))\r\n              );\r\n\r\n              this.own(\r\n                on(this.searchDijit, 'select-result', lang.hitch(this, '_onSelectResult'))\r\n              );\r\n\r\n              this.own(\r\n                on(this.searchDijit, 'clear-search', lang.hitch(this, '_onClearSearch'))\r\n              );\r\n\r\n              this.own(\r\n                aspect.around(this.searchDijit, '_search', lang.hitch(this, '_convertSR'))\r\n              );\r\n\r\n              this.own(\r\n                aspect.before(this.searchDijit, '_formatResults',\r\n                  lang.hitch(this.searchDijit, function(results, idx, value) {\r\n                  try{\r\n                    var newResults = array.map(results, function(result) {\r\n                      if(result && (result instanceof Error || result.length >= 0)) {\r\n                        return result;\r\n                      } else {\r\n                        return new Error( result && result.message || \"Invalid query source or locator\" );\r\n                      }\r\n                    });\r\n                    return [newResults, idx, value];\r\n                  } catch (err) {\r\n                    console.log(err && err.message);\r\n                    return [results, idx, value];\r\n                  }\r\n                }))\r\n              );\r\n\r\n              /*****************************************\r\n               * Binding events about 508 accessbility\r\n               * ***************************************/\r\n\r\n              if(searchSouces.length === 1){\r\n                jimuUtils.initFirstFocusNode(this.domNode, this.searchDijit.inputNode);\r\n              }else{\r\n                jimuUtils.initFirstFocusNode(this.domNode, this.searchDijit.sourcesBtnNode);\r\n              }\r\n              jimuUtils.initLastFocusNode(this.domNode, this.searchDijit.submitNode);\r\n              this.own(on(this.domNode, \"keydown\", lang.hitch(this, function(evt) {\r\n                if(html.hasClass(evt.target, this.baseClass) && evt.keyCode === keys.ENTER) {//enter to first node\r\n                  this.searchDijit.sourcesBtnNode.focus();\r\n                }\r\n                //esc to close searched list\r\n                else if(!html.hasClass(evt.target, this.baseClass) && evt.keyCode === keys.ESCAPE) {\r\n                  if(html.getStyle(this.searchResultsNode, 'display') === 'block'){\r\n                    html.setStyle(this.searchResultsNode, 'display', 'none');\r\n                  }\r\n                }\r\n              })));\r\n\r\n              this.own(\r\n                aspect.around(this.searchDijit, '_inputKey', lang.hitch(this, function(originalFun) {\r\n                  return lang.hitch(this, function(e) {\r\n                    var returnValue = null;\r\n                    if(html.getStyle(this.searchResultsNode, 'display') === 'block') {\r\n                      console.log(\"searchResultsNode\");\r\n                      this._inputKey(e);\r\n                    } else {\r\n                      returnValue = originalFun.apply(this.searchDijit, [e]);\r\n                    }\r\n                    return returnValue;\r\n                  });\r\n                }))\r\n              );\r\n\r\n              /*****************************************\r\n               * Binding events for control result menu\r\n               * ***************************************/\r\n              this.own(\r\n                on(this.searchDijit.domNode, 'click', lang.hitch(this, '_onSearchDijitClick'))\r\n              );\r\n\r\n              this.own(on(this.searchDijit.inputNode, \"keyup\", lang.hitch(this, function(e) {\r\n                if (e.keyCode !== keys.ENTER && e.keyCode !== keys.UP_ARROW && e.keyCode !== keys.DOWN_ARROW) {\r\n                  this._onClearSearch();\r\n                }\r\n              })));\r\n\r\n              this.own(\r\n                on(this.searchResultsNode, 'li:click', lang.hitch(this, '_onSelectSearchResult'))\r\n              );\r\n              this.own(\r\n                on(this.searchResultsNode, 'li:keyup', lang.hitch(this, '_onSearchResultLiKey'))\r\n              );\r\n\r\n              this.own(on(\r\n                this.searchResultsNode,\r\n                '.show-all-results:click',\r\n                lang.hitch(this, '_showResultMenu')\r\n              ));\r\n\r\n              this.own(\r\n                on(window.document, 'click', lang.hitch(this, function(e) {\r\n                  if (!html.isDescendant(e.target, this.searchResultsNode)) {\r\n                    this._hideResultMenu();\r\n                    this._resetSelectorPosition('.show-all-results');\r\n                  }\r\n                  if (!html.isDescendant(e.target, this.searchDijit.suggestionsNode)) {\r\n                    this._hideSuggestionsMenu();\r\n                  }\r\n                }))\r\n              );\r\n              this.fetchData('framework');\r\n            }));\r\n          }));\r\n      },\r\n\r\n      _convertConfig: function(config) {\r\n        var sourceDefs = array.map(config.sources, lang.hitch(this, function(source) {\r\n          var def = new Deferred();\r\n          if (source && source.url && source.type === 'locator') {\r\n            var _source = {\r\n              locator: new Locator(source.url || \"\"),\r\n              outFields: [\"*\"],\r\n              singleLineFieldName: source.singleLineFieldName || \"\",\r\n              name: jimuUtils.stripHTML(source.name || \"\"),\r\n              placeholder: jimuUtils.stripHTML(source.placeholder || \"\"),\r\n              countryCode: source.countryCode || \"\",\r\n              maxResults: source.maxResults || 6,\r\n              zoomScale: source.zoomScale || 50000,\r\n              useMapExtent: !!source.searchInCurrentMapExtent,\r\n              enableInfoWindow: esriLang.isDefined(this.config.showInfoWindowOnSelect) ?\r\n                !!this.config.showInfoWindowOnSelect : true,\r\n              showInfoWindowOnSelect: esriLang.isDefined(this.config.showInfoWindowOnSelect) ?\r\n                !!this.config.showInfoWindowOnSelect : true,\r\n              _zoomScaleOfConfigSource: source.zoomScale,\r\n              _panToScale: source.panToScale\r\n            };\r\n\r\n            if(source.maxSuggestions === 0) {\r\n              _source.enableSuggestions = false;\r\n            } else if (source.maxSuggestions === null || source.maxSuggestions === undefined) {\r\n              _source.maxSuggestions = 6;\r\n            } else {\r\n              _source.maxSuggestions = source.maxSuggestions;\r\n            }\r\n\r\n            if (source.enableLocalSearch) {\r\n              _source.localSearchOptions = {\r\n                minScale: source.localSearchMinScale,\r\n                distance: this._getLocalSearchDistance(source)\r\n              };\r\n            }\r\n\r\n            if (source.panToScale || source.zoomScale) {\r\n              _source.autoNavigate = false;\r\n            }\r\n\r\n            def.resolve(_source);\r\n          } else if (source && source.url && source.type === 'query') {\r\n            var searchLayer = new FeatureLayer(source.url || null, {\r\n              outFields: [\"*\"]\r\n            });\r\n\r\n            this.own(on(searchLayer, 'load', lang.hitch(this, function(result) {\r\n              var flayer = result.layer;\r\n\r\n              // identify the data source\r\n              var sourceLayer = this.map.getLayer(source.layerId);\r\n              var sourceLayerInfo = this.layerInfosObj.getLayerInfoById(source.layerId);\r\n              var showInfoWindowOnSelect;\r\n              var enableInfoWindow;\r\n              if(sourceLayer) {\r\n                // pure feature service layer defined in the map\r\n                showInfoWindowOnSelect = false;\r\n                enableInfoWindow = false;\r\n              } else if (sourceLayerInfo){\r\n                // feature service layer defined in the map\r\n                showInfoWindowOnSelect = false;\r\n                enableInfoWindow = false;\r\n              } else {\r\n                // data source from the outside\r\n                showInfoWindowOnSelect = esriLang.isDefined(this.config.showInfoWindowOnSelect) ?\r\n                  !!this.config.showInfoWindowOnSelect : true;\r\n                enableInfoWindow = esriLang.isDefined(this.config.showInfoWindowOnSelect) ?\r\n                  !!this.config.showInfoWindowOnSelect : true;\r\n              }\r\n\r\n              var fNames = null;\r\n              if (source.searchFields && source.searchFields.length > 0) {\r\n                fNames = source.searchFields;\r\n              } else {\r\n                fNames = [];\r\n                array.forEach(flayer.fields, function(field) {\r\n                  if (field.type !== \"esriFieldTypeOID\" && field.name !== flayer.objectIdField &&\r\n                    field.type !== \"esriFieldTypeGeometry\") {\r\n                    fNames.push(field.name);\r\n                  }\r\n                });\r\n              }\r\n\r\n              var convertedSource = {\r\n                featureLayer: flayer,\r\n                outFields: [\"*\"],\r\n                searchFields: fNames,\r\n                autoNavigate: false,\r\n                displayField: source.displayField || \"\",\r\n                exactMatch: !!source.exactMatch,\r\n                name: jimuUtils.stripHTML(source.name || \"\"),\r\n                placeholder: jimuUtils.stripHTML(source.placeholder || \"\"),\r\n                maxResults: source.maxResults || 6,\r\n                zoomScale: source.zoomScale || 50000,\r\n                //infoTemplate: lang.clone(template),\r\n                useMapExtent: !!source.searchInCurrentMapExtent,\r\n                showInfoWindowOnSelect: showInfoWindowOnSelect,\r\n                enableInfoWindow: enableInfoWindow,\r\n                _featureLayerId: source.layerId,\r\n                _zoomScaleOfConfigSource: source.zoomScale,\r\n                _panToScale: source.panToScale\r\n              };\r\n              /*\r\n              if (!template) {\r\n                delete convertedSource.infoTemplate;\r\n              }\r\n              */\r\n\r\n              if(source.maxSuggestions === 0) {\r\n                convertedSource.enableSuggestions = false;\r\n              } else if (source.maxSuggestions === null || source.maxSuggestions === undefined) {\r\n                convertedSource.maxSuggestions = 6;\r\n              } else {\r\n                convertedSource.maxSuggestions = source.maxSuggestions;\r\n              }\r\n\r\n              if (convertedSource._featureLayerId) {\r\n                var layerInfo = this.layerInfosObj\r\n                  .getLayerInfoById(convertedSource._featureLayerId);\r\n                if(layerInfo) {\r\n                  flayer.setDefinitionExpression(layerInfo.getFilter());\r\n                }\r\n              }\r\n\r\n              //var template = this._getInfoTemplate(flayer, source, source.displayField);\r\n              this._getInfoTemplate(flayer, source).then(lang.hitch(this, function(infoTemplate){\r\n                //convertedSource.infoTemplate = lang.clone(infoTemplate);\r\n                convertedSource.infoTemplate = infoTemplate;\r\n                def.resolve(convertedSource);\r\n              }), lang.hitch(this, function() {\r\n                def.resolve(convertedSource);\r\n              }));\r\n\r\n              if(sourceLayerInfo) {\r\n                if(searchLayer.geometryType === \"esriGeometryPoint\") {\r\n                  convertedSource.highlightSymbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,\r\n                                                                     10,\r\n                                                                     new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,\r\n                                                                                          new Color([0, 255, 255, 0.0]),\r\n                                                                                          2),\r\n                                                                     new Color([0, 0, 0, 0.0]));\r\n                } else if(searchLayer.geometryType === \"esriGeometryPolyline\") {\r\n                  convertedSource.highlightSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,\r\n                                                                         new Color([0, 255, 255, 0.0]),\r\n                                                                         2);\r\n                } else if(searchLayer.geometryType === \"esriGeometryPolygon\") {\r\n                  convertedSource.highlightSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NULL,\r\n                                                      new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,\r\n                                                                           new Color([0, 255, 255, 0.0]),\r\n                                                                           2));\r\n                }\r\n              } else {\r\n                if(searchLayer.geometryType === \"esriGeometryPoint\") {\r\n                  convertedSource.highlightSymbol = new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,\r\n                                                                     10,\r\n                                                                     new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,\r\n                                                                                          new Color([0, 255, 255]),\r\n                                                                                          2),\r\n                                                                     new Color([0, 0, 0]));\r\n                } else if(searchLayer.geometryType === \"esriGeometryPolyline\") {\r\n                  convertedSource.highlightSymbol = new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,\r\n                                                                         new Color([0, 255, 255]),\r\n                                                                         2);\r\n                } else if(searchLayer.geometryType === \"esriGeometryPolygon\") {\r\n                  convertedSource.highlightSymbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_NULL,\r\n                                                      new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,\r\n                                                                           new Color([0, 255, 255]),\r\n                                                                           2));\r\n                }\r\n              }\r\n            })));\r\n\r\n            this.own(on(searchLayer, 'error', function() {\r\n              def.resolve(null);\r\n            }));\r\n          } else {\r\n            def.resolve(null);\r\n          }\r\n          return def;\r\n        }));\r\n\r\n        return sourceDefs;\r\n      },\r\n\r\n      _getLocalSearchDistance: function(source) {\r\n        var result;\r\n        switch(source.radiusUnit || \"meter\") {\r\n          case \"kilometer\":\r\n            result = source.localSearchDistance * 1000;\r\n            break;\r\n          case \"nauticalMile\":\r\n            result = source.localSearchDistance * 1852;\r\n            break;\r\n          case \"mile\":\r\n            result = source.localSearchDistance * 1609.344;\r\n            break;\r\n          case \"yard\":\r\n            result = source.localSearchDistance * 0.9144;\r\n            break;\r\n          case \"foot\":\r\n            result = source.localSearchDistance * 0.3048;\r\n            break;\r\n          case \"inch\":\r\n            result = source.localSearchDistance * 0.0254;\r\n            break;\r\n          default:\r\n            result = source.localSearchDistance;\r\n            break;\r\n        }\r\n        return result;\r\n      },\r\n\r\n      _getInfoTemplate: function(fLayer, source) {\r\n        var def = new Deferred();\r\n        var layerInfo = this.layerInfosObj.getLayerInfoById(source.layerId);\r\n        var template;\r\n\r\n        if (layerInfo) {\r\n          def = layerInfo.loadInfoTemplate();\r\n        } else {\r\n          var fieldNames = [];\r\n          array.filter(fLayer.fields, function(field) {\r\n            var fieldName = field.name.toLowerCase();\r\n            if(fieldName.indexOf(\"shape\") < 0 &&\r\n               fieldName.indexOf(\"objectid\") < 0 &&\r\n               fieldName.indexOf(\"globalid\") < 0 &&\r\n               fieldName.indexOf(\"perimeter\") < 0) {\r\n              fieldNames.push(field.name);\r\n            }\r\n          });\r\n\r\n          var title =  source.name + \": {\" + source.displayField + \"}\";\r\n          var popupInfo = jimuUtils.getDefaultPopupInfo(fLayer, title, fieldNames);\r\n          if(popupInfo) {\r\n            template = new PopupTemplate(popupInfo);\r\n          }\r\n          def.resolve(template);\r\n        }\r\n        return def;\r\n      },\r\n\r\n      _getSourceIndexOfResult: function(e) {\r\n        if (this.searchResults){\r\n          for (var i in this.searchResults) {\r\n            var sourceResults = this.searchResults[i];\r\n            var pos = array.indexOf(sourceResults, e);\r\n            if (pos > -1) {\r\n              return parseInt(i, 10);\r\n            }\r\n          }\r\n        }\r\n\r\n        return null;\r\n      },\r\n\r\n\r\n      _zoomToScale: function(zoomScale, features) {\r\n        this.map.setScale(zoomScale);\r\n        jimuUtils.featureAction.panTo(this.map, features);\r\n      },\r\n\r\n      _showPopupByFeatures: function(layerInfo, features, selectEvent) {\r\n        /*jshint unused: false*/\r\n        var location = null;\r\n        var isPoint = false;\r\n\r\n        if(this.config.showInfoWindowOnSelect) {\r\n          //this.map.infoWindow.clearFeatures();\r\n          //this.map.infoWindow.hide();\r\n          this.map.infoWindow.setFeatures(features);\r\n          if (features[0].geometry.type === \"point\") {\r\n            location = features[0].geometry;\r\n            isPoint = true;\r\n          } else {\r\n            var extent = features[0].geometry && features[0].geometry.getExtent();\r\n            location = extent && extent.getCenter();\r\n          }\r\n          if(location) {\r\n            this.map.infoWindow.show(location, {\r\n              closetFirst: true\r\n            });\r\n          }\r\n        } else {\r\n          // hightlight result\r\n          this.map.infoWindow.setFeatures(features);\r\n          this.map.infoWindow.updateHighlight(this.map, features[0]);\r\n          this.map.infoWindow.showHighlight();\r\n        }\r\n\r\n        // zoomto result\r\n        if (selectEvent.source._panToScale) {\r\n          jimuUtils.featureAction.panTo(this.map, features);\r\n        } else if(selectEvent.source._zoomScaleOfConfigSource) {\r\n          this._zoomToScale(selectEvent.source.zoomScale, features);\r\n        } else {\r\n          var featureSet = jimuUtils.toFeatureSet(features);\r\n          jimuUtils.zoomToFeatureSet(this.map, featureSet);\r\n        }\r\n      },\r\n\r\n      _cloneInfoTemplate: function(infoTemplate) {\r\n        var newInfoTemplate = null;\r\n        if(infoTemplate && infoTemplate.toJson) {\r\n          newInfoTemplate = new infoTemplate.constructor(infoTemplate.toJson());\r\n        }\r\n        return newInfoTemplate;\r\n      },\r\n\r\n      _loadInfoTemplateAndShowPopup: function(layerInfo, selectedFeature, selectEvent) {\r\n        if(layerInfo) {\r\n          //this.searchDijit.clearGraphics();\r\n          var layerObjectInMap = this.map.getLayer(layerInfo.id);\r\n          if(layerInfo.isPopupEnabled() && layerObjectInMap) {\r\n            this._showPopupByFeatures(layerInfo, [selectedFeature], selectEvent);\r\n          } else {\r\n            layerInfo.loadInfoTemplate().then(lang.hitch(this, function(infoTemplate) {\r\n              //temporary set infoTemplate to selectedFeature.\r\n              selectedFeature.setInfoTemplate(this._cloneInfoTemplate(infoTemplate));\r\n              this._showPopupByFeatures(layerInfo, [selectedFeature], selectEvent);\r\n              // clear infoTemplate for selectedFeature;\r\n              var handle = aspect.before(this.map, 'onClick', lang.hitch(this, function() {\r\n                selectedFeature.setInfoTemplate(null);\r\n                handle.remove();\r\n              }));\r\n            }));\r\n          }\r\n        }\r\n      },\r\n\r\n      _onSelectResult: function(e) {\r\n        var result = e.result;\r\n        var dataSourceIndex = e.sourceIndex;\r\n        var sourceResults = this.searchResults[dataSourceIndex];\r\n        var dataIndex = 0;\r\n        var resultFeature = e.result.feature;\r\n        var sourceLayerId = e.source._featureLayerId;\r\n\r\n        var getGraphics = function(layer, fid) {\r\n          var graphics = layer.graphics;\r\n          var gs = array.filter(graphics, function(g) {\r\n            return g.attributes[layer.objectIdField] === fid;\r\n          });\r\n          return gs;\r\n        };\r\n\r\n        for (var i = 0, len = sourceResults.length; i < len; i++) {\r\n          if (jimuUtils.isEqual(sourceResults[i], result)) {\r\n            dataIndex = i;\r\n            break;\r\n          }\r\n        }\r\n        query('li', this.searchResultsNode)\r\n          .forEach(lang.hitch(this, function(li) {\r\n            html.removeClass(li, 'result-item-selected');\r\n            var title = html.getAttr(li, 'title');\r\n            var dIdx = html.getAttr(li, 'data-index');\r\n            var dsIndex = html.getAttr(li, 'data-source-index');\r\n\r\n            if (result &&\r\n              result.name &&\r\n              title === result.name.toString() &&\r\n              dIdx === dataIndex.toString() &&\r\n              dsIndex === dataSourceIndex.toString()) {\r\n              html.addClass(li, 'result-item-selected');\r\n              focusUtil.focus(li);\r\n            }\r\n          }));\r\n\r\n        //var layer = this.map.getLayer(sourceLayerId);\r\n        var layerInfo = this.layerInfosObj.getLayerInfoById(sourceLayerId);\r\n\r\n        if (layerInfo) {\r\n          layerInfo.getLayerObject().then(lang.hitch(this, function(layer) {\r\n            var gs = getGraphics(layer, resultFeature.attributes[layer.objectIdField]);\r\n            if (gs && gs.length > 0) {\r\n              //this._showPopupByFeatures(gs);\r\n              this._loadInfoTemplateAndShowPopup(layerInfo, gs[0], e);\r\n            } else {\r\n\r\n              var featureQuery = new FeatureQuery();\r\n              featureQuery.where = layer.objectIdField + \" = \" +\r\n                                 resultFeature.attributes[layer.objectIdField];\r\n              featureQuery.outSpatialReference = this.map.spatialReference;\r\n              featureQuery.outFields = [\"*\"];\r\n\r\n              layer.queryFeatures(featureQuery, lang.hitch(this, function(featureSet) {\r\n                var selectedFeature = null;\r\n                if(featureSet && featureSet.features.length > 0) {\r\n                  selectedFeature = featureSet.features[0];\r\n                  // working around for js-api's generalization.\r\n                  //   incorrect geometry of polygon result of queryFeatures.\r\n                  selectedFeature.geometry = resultFeature.geometry;\r\n\r\n                  this._loadInfoTemplateAndShowPopup(layerInfo, selectedFeature, e);\r\n                }\r\n              }), lang.hitch(this, function() {\r\n                // show popupInfo of searchResult.\r\n                var selectedFeature = resultFeature;\r\n                this._loadInfoTemplateAndShowPopup(layerInfo, selectedFeature, e);\r\n              }));\r\n            }\r\n          }));\r\n\r\n        } else if (e.source.featureLayer && !e.source.locator){\r\n          // outside resource result:\r\n          // zoomTo or panto by zoomToExtent, popup by search dijit\r\n          if (e.source._panToScale) {\r\n            jimuUtils.featureAction.panTo(this.map, [e.result.feature]);\r\n          } else if(e.source._zoomScaleOfConfigSource) {\r\n            this._zoomToScale(e.source._zoomScaleOfConfigSource, [e.result.feature]);\r\n          } else {\r\n            jimuUtils.zoomToExtent(this.map, e.result.extent);\r\n          }\r\n        } else {\r\n          //result of geocoder service\r\n          if (e.source._panToScale) {\r\n            //panToScale is configed, panTo by jimuFeatureAction. popup by search dijit\r\n            jimuUtils.featureAction.panTo(this.map, [e.result.feature]);\r\n          } else if (e.source._zoomScaleOfConfigSource) {\r\n            //zoomScale is configed, zoomto by _zoomScale. popup by search dijit\r\n            this._zoomToScale(e.source._zoomScaleOfConfigSource, [e.result.feature]);\r\n          }\r\n          //zoomSclae keep default value, popup and zoomto by search dijit;\r\n        }\r\n\r\n        // publish select result to other widgets\r\n        this.publishData({\r\n          'selectResult': e\r\n        });\r\n      },\r\n\r\n      destroy: function() {\r\n        utils.setMap(null);\r\n        utils.setLayerInfosObj(null);\r\n        utils.setAppConfig(null);\r\n        if (this.searchDijit) {\r\n          this.searchDijit.clear();\r\n        }\r\n\r\n        this.inherited(arguments);\r\n      },\r\n\r\n      /*********************************\r\n       * Methods for Events\r\n       * ******************************/\r\n      onReceiveData: function(name, widgetId, data) {\r\n        if (name === 'framework' && widgetId === 'framework' && data && data.searchString) {\r\n          this.searchDijit.set('value', data.searchString);\r\n          this.searchDijit.search();\r\n        }\r\n      },\r\n\r\n      onLayerInfosFilterChanged: function(changedLayerInfos) {\r\n        array.some(changedLayerInfos, lang.hitch(this, function(info) {\r\n          if (this.searchDijit && this.searchDijit.sources && this.searchDijit.sources.length > 0) {\r\n            array.forEach(this.searchDijit.sources, function(s) {\r\n              if (s._featureLayerId === info.id) {\r\n                s.featureLayer.setDefinitionExpression(info.getFilter());\r\n              }\r\n            });\r\n          }\r\n        }));\r\n      },\r\n\r\n      _onSourceIndexChange: function() {\r\n        if (this.searchDijit.value) {\r\n          this.searchDijit.search(this.searchDijit.value);\r\n        }\r\n      },\r\n\r\n      _onSearchResults: function(evt) {\r\n        var sources = this.searchDijit.get('sources');\r\n        var activeSourceIndex = this.searchDijit.get('activeSourceIndex');\r\n        var value = this.searchDijit.get('value');\r\n        value = jimuUtils.sanitizeHTML(value);\r\n        var htmlContent = \"\";\r\n        var results = evt.results;\r\n        var _activeSourceNumber = null;\r\n\r\n        var outputTextforCustomInput = this._getOutputTextForCustomInput(evt.value); //*******\r\n\r\n        if (results && evt.numResults > 0) {\r\n          html.removeClass(this.searchDijit.containerNode, 'showSuggestions');\r\n\r\n          this.searchResults = results;\r\n          htmlContent += '<div class=\"show-all-results jimu-ellipsis\" title=\"' +\r\n            this.nls.showAll + '\">' +\r\n            this.nls.showAllResults + '<strong >' + value + '</strong></div>';\r\n          htmlContent += '<div class=\"searchMenu\" role=\"menu\">';\r\n          for (var i in results) {\r\n            if (results[i] && results[i].length) {\r\n              var source = sources[parseInt(i, 10)];\r\n              var name = source.name;\r\n              if (sources.length > 1 && activeSourceIndex === 'all') {\r\n                htmlContent += '<div title=\"' + name + '\" class=\"menuHeader\">' + name + '</div>';\r\n              }\r\n              htmlContent += \"<ul>\";\r\n              //var partialMatch = value;\r\n              //var r = new RegExp(\"(\" + partialMatch + \")\", \"gi\");\r\n              var maxResults = sources[i].maxResults;\r\n\r\n              for (var j = 0, len = results[i].length; j < len && j < maxResults; j++) {\r\n                //var text = esriLang.isDefined(results[i][j].name) ?\r\n                //  results[i][j].name : this.nls.untitled;\r\n                var text;\r\n                if(esriLang.isDefined(results[i][j].name)) {\r\n                  if(source && source.locator && outputTextforCustomInput) {\r\n                    results[i][j].name = outputTextforCustomInput;\r\n                  }\r\n                  text = results[i][j].name;\r\n                  text = jimuUtils.sanitizeHTML(text);\r\n                } else {\r\n                  text = this.nls.untitled;\r\n                }\r\n\r\n                htmlContent += '<li title=\"' + text + '\" data-index=\"' + j +\r\n                  '\" data-source-index=\"' + i + '\" role=\"menuitem\" tabindex=\"0\">' +\r\n                  /*text.toString().replace(r, \"<strong >$1</strong>\") +*/ text.toString() + '</li>';\r\n              }\r\n              htmlContent += '</ul>';\r\n\r\n              if (evt.numResults === 1) {\r\n                _activeSourceNumber = i;\r\n              }\r\n            }\r\n          }\r\n          htmlContent += \"</div>\";\r\n          this.searchResultsNode.innerHTML = htmlContent;\r\n\r\n          this._showResultMenu();\r\n\r\n          this._resetSelectorPosition('.searchMenu');\r\n        } else {\r\n          this._onClearSearch();\r\n        }\r\n        // publish search results to other widgets\r\n        this.publishData({\r\n          'searchResults': evt\r\n        });\r\n      },\r\n\r\n      _onSuggestResults: function(evt) {\r\n        this._resetSelectorPosition('.searchMenu');\r\n\r\n        this._hideResultMenu();\r\n        this._showSuggestionsMenu();\r\n        // publish suggest results to other widgets\r\n        this.publishData({\r\n          'suggestResults': evt\r\n        });\r\n      },\r\n\r\n      _onClearSearch: function() {\r\n        html.setStyle(this.searchResultsNode, 'display', 'none');\r\n        this.searchResultsNode.innerHTML = \"\";\r\n        this.searchResults = null;\r\n        //this.map.infoWindow.hideHighlight();\r\n      },\r\n\r\n      /*\r\n      onActive: function() {\r\n        this._mapClickHandle = aspect.before(this.map, 'onClick', lang.hitch(this, function() {\r\n          this._hidePopup();\r\n          return arguments;\r\n        }));\r\n      },\r\n\r\n      onDeActive: function() {\r\n        if (this._mapClickHandle && this._mapClickHandle.remove) {\r\n          this._mapClickHandle.remove();\r\n        }\r\n        this._hidePopup();\r\n      },\r\n      */\r\n\r\n      _hidePopup: function() {\r\n        if (this.map.infoWindow.isShowing) {\r\n          this.map.infoWindow.hide();\r\n        }\r\n      },\r\n\r\n      setPosition: function(position) {\r\n        this._resetSearchDijitStyle(position);\r\n        this.inherited(arguments);\r\n      },\r\n\r\n      resize: function() {\r\n        this._resetSearchDijitStyle();\r\n      },\r\n\r\n      // use for small screen responsive\r\n      _resetSearchDijitStyle: function() {\r\n        html.removeClass(this.domNode, 'use-absolute');\r\n        if (this.searchDijit && this.searchDijit.domNode) {\r\n          html.setStyle(this.searchDijit.domNode, 'width', 'auto');\r\n        }\r\n\r\n        setTimeout(lang.hitch(this, function() {\r\n          if (this.searchDijit && this.searchDijit.domNode) {\r\n            var box = {\r\n              w: !window.appInfo.isRunInMobile ? 274 : // original width of search dijit\r\n                parseInt(html.getComputedStyle(this.domNode).width, 10)\r\n            };\r\n            var sourcesBox = html.getMarginBox(this.searchDijit.sourcesBtnNode);\r\n            var submitBox = html.getMarginBox(this.searchDijit.submitNode);\r\n            var style = null;\r\n            if (box.w) {\r\n              html.setStyle(this.searchDijit.domNode, 'width', box.w + 'px');\r\n              html.addClass(this.domNode, 'use-absolute');\r\n\r\n              if (isFinite(sourcesBox.w) && isFinite(submitBox.w)) {\r\n                if (window.isRTL) {\r\n                  style = {\r\n                    left: submitBox.w + 'px',\r\n                    right: sourcesBox.w + 'px'\r\n                  };\r\n                } else {\r\n                  style = {\r\n                    left: sourcesBox.w + 'px',\r\n                    right: submitBox.w + 'px'\r\n                  };\r\n                }\r\n                var inputGroup = query('.searchInputGroup', this.searchDijit.domNode)[0];\r\n\r\n                if (inputGroup) {\r\n                  html.setStyle(inputGroup, style);\r\n                  var groupBox = html.getMarginBox(inputGroup);\r\n                  var extents = html.getPadBorderExtents(this.searchDijit.inputNode);\r\n                  html.setStyle(this.searchDijit.inputNode, 'width', groupBox.w - extents.w + 'px');\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }), 50);\r\n      },\r\n\r\n      /**************************************\r\n       * Mehtods for covert SR\r\n       * ***********************************/\r\n      _convertSR: function(originalFun) {\r\n        return lang.hitch(this, function(e) {\r\n          var source = this.searchDijit.sources[e.index];\r\n          var pointOfSpecifiedWkid = this._getPointFromSpecifiedWkid(e.text);\r\n          //var pointOfSpecifiedUtm = this._getPointFromSpecifiedUtm(e.text);\r\n          if(source && source.locator && pointOfSpecifiedWkid) {\r\n            return jimuUtils.projectToSpatialReference(pointOfSpecifiedWkid,\r\n                                                       new SpatialReference({wkid: 4326}))\r\n                    .then(lang.hitch(this, function(event, targetPoint) {\r\n              var inputText = this._getFormatedInputFromPoint(targetPoint);\r\n              if(inputText) {\r\n                event.text = inputText;\r\n              }\r\n              return originalFun.apply(this.searchDijit, [event]);\r\n            }, lang.clone(e)));\r\n          } else if (source && source.locator){\r\n            return this._getPointFromSpecifiedUtm(e.text).then(lang.hitch(this, function(event, pointOfSpecifiedUtm) {\r\n              var inputText = this._getFormatedInputFromPoint(pointOfSpecifiedUtm);\r\n              if(inputText) {\r\n                event.text = inputText;\r\n              }\r\n              return originalFun.apply(this.searchDijit, [event]);\r\n            }, lang.clone(e)));\r\n          } else {\r\n            return originalFun.apply(this.searchDijit, [e]);\r\n          }\r\n\r\n        });\r\n      },\r\n\r\n      _getFormatedInputFromPoint: function(point) {\r\n        var inputText = null;\r\n        if(point && !isNaN(point.x) && !isNaN(point.y)) {\r\n          //inputText = \"X:\" + point.x + \",\" + \"Y:\" + point.y;\r\n          inputText = \"Y:\" + point.y + \",\" + \"X:\" + point.x;\r\n        }\r\n        return inputText;\r\n      },\r\n\r\n      _getPointFromSpecifiedWkid: function(inputString) {\r\n        var point = null;\r\n        if(!inputString) {\r\n          return point;\r\n        }\r\n        var coordinateParams = inputString.split(\":\");\r\n        var coordinateText = coordinateParams[0];\r\n        var wkid = Number(coordinateParams[1]);\r\n        if(wkid && wkidUtils.isValidWkid(wkid) && coordinateText) {\r\n          var coordinateValues = coordinateText.split(\",\");\r\n          var x = Number(coordinateValues[0]);\r\n          var y = Number(coordinateValues[1]);\r\n          if(!isNaN(x) && !isNaN(y)) {\r\n            point = new Point(x, y, new SpatialReference({wkid: wkid}));\r\n          }\r\n        }\r\n        return point;\r\n      },\r\n\r\n      _getPointFromSpecifiedUtmByGeometryService: function(inputString) {\r\n        var retDef = new Deferred();\r\n        var resultPoint = null;\r\n        var params = {\r\n          sr: 4326,\r\n          conversionType: \"UTM\",\r\n          conversionMode: 'utmDefault',\r\n          strings: [inputString]\r\n        };\r\n        var geometryService = esriConfig && esriConfig.defaults && esriConfig.defaults.geometryService;\r\n        if(geometryService && geometryService.declaredClass === \"esri.tasks.GeometryService\") {\r\n          geometryService.fromGeoCoordinateString(params, lang.hitch(this, function(result) {\r\n            var x = Number(result[0][0]);\r\n            var y = Number(result[0][1]);\r\n            if(!isNaN(x) && !isNaN(y)) {\r\n              resultPoint = new Point(x, y, new SpatialReference({wkid: 4326}));\r\n              this._pointOfSpecifiedUtmCache[inputString] = resultPoint;\r\n            }\r\n            retDef.resolve(resultPoint);\r\n          }), lang.hitch(this, function() {\r\n            retDef.resolve(resultPoint);\r\n          }));\r\n        } else {\r\n          retDef.resolve(resultPoint);\r\n        }\r\n\r\n        return retDef;\r\n      },\r\n\r\n      _isValidUtmFormat: function(utmString) {\r\n        return utmString && utmString.indexOf && utmString.indexOf(',') < 0 ? true : false;\r\n      },\r\n\r\n      _getPointFromSpecifiedUtm: function(inputString) {\r\n        var retDef = new Deferred();\r\n        var resultPoint = null;\r\n        if(!inputString || !this._isValidUtmFormat(inputString)) {\r\n          retDef.resolve(resultPoint);\r\n          return retDef;\r\n        }\r\n\r\n        if(coordinateFormatter.isSupported()) {\r\n          if(coordinateFormatter.isLoaded()) {\r\n            var point = coordinateFormatter.fromUtm(inputString,\r\n                                                    new SpatialReference({wkid: 4326}),\r\n                                                    \"latitude-band-indicators\");\r\n            if(point && !isNaN(point.x) && !isNaN(point.y)) {\r\n              // the 'fromUtm' will convert the string \"8430 FOX LAIR CIR, Anchorage, AK\" to a point,\r\n              // need to further verify the utm string by geometry service.\r\n              this._getPointFromSpecifiedUtmByGeometryService(inputString).then(lang.hitch(this, function(resultPoint) {\r\n                retDef.resolve(resultPoint);\r\n              }));\r\n            } else {\r\n              retDef.resolve(resultPoint);\r\n            }\r\n          } else {\r\n            coordinateFormatter.load();\r\n            retDef.resolve(resultPoint);\r\n          }\r\n        } else {\r\n          retDef = this._getPointFromSpecifiedUtmByGeometryService(inputString);\r\n        }\r\n        return retDef;\r\n      },\r\n\r\n      _getOutputTextForCustomInput: function(inputText) {\r\n        var outputText = null;\r\n        var pointOfSpecifiedWkid = this._getPointFromSpecifiedWkid(inputText);\r\n        var pointOfSpecifiedUtm = this._pointOfSpecifiedUtmCache[inputText];\r\n        if(pointOfSpecifiedWkid) {\r\n          outputText = \"X:\" + pointOfSpecifiedWkid.x + \" \" + \"Y:\" + pointOfSpecifiedWkid.y;\r\n        } else if(pointOfSpecifiedUtm){\r\n          outputText = inputText;\r\n        }\r\n        return outputText;\r\n      },\r\n      /***********************************\r\n       * Mehtods for control result menu\r\n       * *********************************/\r\n      _onSearchDijitClick: function() {\r\n        this._resetSelectorPosition('.searchMenu');\r\n      },\r\n\r\n      _onSelectSearchResult: function(evt) {\r\n        var target = evt.target;\r\n        while(!(html.hasAttr(target, 'data-source-index') && html.getAttr(target, 'data-index'))) {\r\n          target = target.parentNode;\r\n        }\r\n        var result = null;\r\n        var dataSourceIndex = html.getAttr(target, 'data-source-index');\r\n        var dataIndex = parseInt(html.getAttr(target, 'data-index'), 10);\r\n        // var sources = this.searchDijit.get('sources');\r\n\r\n        if (dataSourceIndex !== 'all') {\r\n          dataSourceIndex = parseInt(dataSourceIndex, 10);\r\n        }\r\n        if (this.searchResults && this.searchResults[dataSourceIndex] &&\r\n          this.searchResults[dataSourceIndex][dataIndex]) {\r\n          result = this.searchResults[dataSourceIndex][dataIndex];\r\n          this.searchDijit.select(result);\r\n        }\r\n      },\r\n\r\n      _hideSuggestionsMenu: function() {\r\n        html.setStyle(this.searchDijit.suggestionsNode, 'display', 'none');\r\n        html.removeClass(this.searchDijit.suggestionsNode, 'show');\r\n      },\r\n\r\n      _showSuggestionsMenu: function() {\r\n        html.setStyle(this.searchDijit.suggestionsNode, 'display', 'block');\r\n        html.addClass(this.searchDijit.suggestionsNode, 'show');\r\n      },\r\n\r\n      _hideResultMenu: function() {\r\n        query('.show-all-results', this.searchResultsNode).style('display', 'block');\r\n        query('.searchMenu', this.searchResultsNode).style('display', 'none');\r\n      },\r\n\r\n      _showResultMenu: function() {\r\n        html.setStyle(this.searchResultsNode, 'display', 'block');\r\n        this._hideSuggestionsMenu();\r\n        query('.show-all-results', this.searchResultsNode).style('display', 'none');\r\n        query('.searchMenu', this.searchResultsNode).style('display', 'block');\r\n\r\n        var groupNode = query('.searchInputGroup', this.searchDijit.domNode)[0];\r\n        if (groupNode) {\r\n          var groupBox = html.getMarginBox(groupNode);\r\n          var style = {\r\n            width: groupBox.w + 'px'\r\n          };\r\n          if (window.isRTL) {\r\n            var box = html.getMarginBox(this.searchDijit.domNode);\r\n            style.right = (box.w - groupBox.l - groupBox.w) + 'px';\r\n          } else {\r\n            style.left = groupBox.l + 'px';\r\n          }\r\n          query('.show-all-results', this.searchResultsNode).style(style);\r\n          query('.searchMenu', this.searchResultsNode).style(style);\r\n        }\r\n      },\r\n\r\n      // set position for 'searchSuggestiongMenu', 'searchResultMenu', 'showAllResultsBox'\r\n      _resetSelectorPosition: function(cls) {\r\n        var layoutBox = html.getMarginBox(window.jimuConfig.layoutId);\r\n        query(cls, this.domNode).forEach(lang.hitch(this, function(menu) {\r\n          var menuPosition = html.position(menu);\r\n          if (html.getStyle(menu, 'display') === 'none') {\r\n            return;\r\n          }\r\n          var dijitPosition = html.position(this.searchDijit.domNode);\r\n          var up = dijitPosition.y - 2;\r\n          var down = layoutBox.h - dijitPosition.y - dijitPosition.h;\r\n          if ((down > menuPosition.y + menuPosition.h) || (up > menuPosition.h)) {\r\n            html.setStyle(\r\n              menu,\r\n              'top',\r\n              (\r\n                (down > menuPosition.y + menuPosition.h) ?\r\n                dijitPosition.h : -menuPosition.h - 2\r\n              ) + 'px'\r\n            );\r\n          } else {\r\n            html.setStyle(menu, 'height', Math.max(down, up) + 'px');\r\n            html.setStyle(menu, 'top', (down > up ? dijitPosition.h : -up - 2) + 'px');\r\n          }\r\n        }));\r\n      },\r\n\r\n      _inputKey: function(e) {\r\n        if (e) {\r\n          var lists = query(\"li\", this.searchResultsNode);\r\n          if (e.keyCode === keys.TAB || e.keyCode === keys.ESCAPE) {\r\n            /*\r\n            if(html.hasClass(evt.target, this.baseClass) && evt.keyCode === keys.ENTER) {//enter to first node\r\n              this.searchDijit.sourcesBtnNode.focus();\r\n            }\r\n            //esc to close searched list\r\n            else if(!html.hasClass(evt.target, this.baseClass) && evt.keyCode === keys.ESCAPE) {\r\n              if(html.getStyle(this.searchResultsNode, 'display') === 'block'){\r\n                html.setStyle(this.searchResultsNode, 'display', 'none');\r\n              }\r\n            }\r\n            */\r\n          } else if (e.keyCode === keys.UP_ARROW) {\r\n            e.stopPropagation();\r\n            e.preventDefault();\r\n            array.some(lists, function(li, index) {\r\n              if(html.hasClass(li, 'result-item-selected')) {\r\n                var nextLi = lists[index - 1];\r\n                if(nextLi) {\r\n                  html.removeClass(li, 'result-item-selected');\r\n                  html.addClass(nextLi, 'result-item-selected');\r\n                  focusUtil.focus(nextLi);\r\n                }\r\n                return true;\r\n              } else {\r\n                return false;\r\n              }\r\n            }, this);\r\n          } else if (e.keyCode === keys.DOWN_ARROW) {\r\n            e.stopPropagation();\r\n            e.preventDefault();\r\n            array.some(lists, function(li, index) {\r\n              if(html.hasClass(li, 'result-item-selected')) {\r\n                var nextLi = lists[index + 1];\r\n                if(nextLi) {\r\n                  html.removeClass(li, 'result-item-selected');\r\n                  html.addClass(nextLi, 'result-item-selected');\r\n                  focusUtil.focus(nextLi);\r\n                }\r\n                return true;\r\n              } else {\r\n                return false;\r\n              }\r\n            }, this);\r\n          }\r\n          // ignored keys\r\n          else if (e.ctrlKey || e.metaKey || e.keyCode === keys.copyKey || e.keyCode === keys.LEFT_ARROW ||\r\n            e.keyCode === keys.RIGHT_ARROW || e.keyCode === keys.ENTER) {\r\n            // just return. don't do anything\r\n            return e;\r\n          }\r\n        }\r\n      },\r\n\r\n      _onSearchResultLiKey: function(e) {\r\n        if (e) {\r\n          if(e.keyCode === keys.ENTER) {\r\n            this._onSelectSearchResult(e);\r\n          } else if (e.keyCode === keys.DOWN_ARROW || e.keyCode === keys.UP_ARROW) {\r\n            this._inputKey(e);\r\n          }\r\n        }\r\n      }\r\n\r\n    });\r\n  });\r\n"]}