{"version":3,"sources":["../../../widgets/Search/utils.js"],"names":["define","lang","array","Deferred","when","all","portalUtils","esriLang","esriRequest","mo","map","layerInfosObj","appConfig","_esriLocatorRegExp","setMap","setLayerInfosObj","lobj","setAppConfig","apc","getConfigInfo","config","sources","length","searchInfo","searchLayer","upgradeFromGeocoder","itemInfo","itemData","applicationProperties","viewing","search","defs","layers","hitch","hintText","_layer","_getQueryTypeGeocoder","then","results","concat","_getSoucesFromPortalAndWebmap","forEach","push","getPortalSelfInfo","portalUrl","response","geocoders","helperServices","geocode","i","len","geocoder","_processSingleLine","validSources","type","json","name","_getGeocodeName","url","singleLineFieldName","placeholder","window","jimuNls","common","findAddressOrPlace","maxResults","searchInCurrentMapExtent","enableLocalSearch","_isEsriLocator","localSearchMinScale","localSearchDistance","item","layer","getLayer","id","_layerInfo","_layerId","isDefined","subLayer","isInMap","traversal","layerInfo","title","layerId","searchFields","field","displayField","exactMatch","lastIndex","test","def","content","f","handleAs","callbackParamName","singleLineAddressField","resolve","console","warn","err","error","promise","geocodeUrl","strs","split","getGeocoderName","hasAppSearchInfo","enabled"],"mappings":"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","file":"utils.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n  'dojo/_base/lang',\r\n  'dojo/_base/array',\r\n  'dojo/Deferred',\r\n  'dojo/when',\r\n  'dojo/promise/all',\r\n  'jimu/portalUtils',\r\n  'esri/lang',\r\n  'esri/request'\r\n], function(lang, array, Deferred, when, all, portalUtils, esriLang, esriRequest) {\r\n  var mo = {\r\n    map: null,\r\n    layerInfosObj: null,\r\n    appConfig: null,\r\n    _esriLocatorRegExp: /geocode(.){0,3}\\.arcgis.com\\/arcgis\\/rest\\/services\\/World\\/GeocodeServer/g\r\n  };\r\n\r\n  mo.setMap = function(map) {\r\n    this.map = map;\r\n  };\r\n\r\n  mo.setLayerInfosObj = function(lobj) {\r\n    this.layerInfosObj = lobj;\r\n  };\r\n\r\n  mo.setAppConfig = function(apc) {\r\n    this.appConfig = apc;\r\n  };\r\n\r\n  mo.getConfigInfo = function(config) {\r\n    if (config && config.sources && config.sources.length > 0) {\r\n      var searchInfo = null;\r\n      if (this.searchLayer(this.map) && config.upgradeFromGeocoder) {\r\n        // back compatibility for config which come from geocoders\r\n        searchInfo = this.map.itemInfo.itemData.applicationProperties.viewing.search;\r\n        var defs = array.map(searchInfo.layers, lang.hitch(this, function(hintText, _layer) {\r\n          _layer.hintText = hintText;\r\n          return this._getQueryTypeGeocoder(_layer);\r\n        }, searchInfo.hintText));\r\n        return all(defs).then(lang.hitch(this, function(results) {\r\n          config.sources = [].concat(results).concat(config.sources);\r\n          return config;\r\n        }));\r\n      } else {\r\n        return config;\r\n      }\r\n    } else {\r\n      return when(this._getSoucesFromPortalAndWebmap())\r\n        .then(lang.hitch(this, function(sources) {\r\n          return {\r\n            \"allPlaceholder\": \"\",\r\n            \"showInfoWindowOnSelect\": true,\r\n            \"sources\": sources\r\n          };\r\n        }));\r\n    }\r\n  };\r\n\r\n  mo._getSoucesFromPortalAndWebmap = function() {\r\n    var defs = [];\r\n    var searchInfo = null;\r\n    if (this.searchLayer(this.map)) {\r\n      searchInfo = this.map.itemInfo.itemData.applicationProperties.viewing.search;\r\n      array.forEach(searchInfo.layers, lang.hitch(this, function(hintText, _layer) {\r\n        _layer.hintText = hintText;\r\n        defs.push(this._getQueryTypeGeocoder(_layer));\r\n      }, searchInfo.hintText));\r\n    } // else do nothing\r\n\r\n    return portalUtils.getPortalSelfInfo(this.appConfig.portalUrl)\r\n      .then(lang.hitch(this, function(response) {\r\n        var geocoders = response.helperServices && response.helperServices.geocode;\r\n\r\n        if (geocoders && geocoders.length > 0) {\r\n          for (var i = 0, len = geocoders.length; i < len; i++) {\r\n            var geocoder = geocoders[i];\r\n            if (geocoder) {\r\n              defs.push(this._processSingleLine(geocoder));\r\n            }\r\n          }\r\n        }\r\n\r\n        return all(defs).then(lang.hitch(this, function(results) {\r\n          var validSources = [];\r\n          for (var i = 0; i < results.length; i++) {\r\n            var geocode = results[i];\r\n            if (!geocode) {\r\n              continue;\r\n            } else if (geocode && geocode.type === 'query') {\r\n              validSources.push(geocode);\r\n            } else {\r\n              var json = {\r\n                name: geocode.name || this._getGeocodeName(geocode.url),\r\n                url: geocode.url,\r\n                singleLineFieldName: geocode.singleLineFieldName,\r\n                placeholder: geocode.placeholder || window.jimuNls.common.findAddressOrPlace ||\r\n                  geocode.name || this._getGeocodeName(geocode.url),\r\n                maxResults: 6,\r\n                searchInCurrentMapExtent: false,\r\n                type: \"locator\"\r\n              };\r\n              json.enableLocalSearch = this._isEsriLocator(json.url);\r\n              json.localSearchMinScale = 300000;\r\n              json.localSearchDistance = 50000;\r\n\r\n              validSources.push(json);\r\n            }\r\n          }\r\n\r\n          return validSources;\r\n        }));\r\n      }));\r\n  };\r\n\r\n  mo._getQueryTypeGeocoder = function(item) {\r\n    var layer = this.map.getLayer(item.id);\r\n    var url = null;\r\n    var _layerInfo = null;\r\n    var _layerId = null;\r\n\r\n    if (esriLang.isDefined(item.subLayer)) {\r\n      _layerId = item.id + \"_\" + item.subLayer;\r\n    } else {\r\n      _layerId = item.id;\r\n    }\r\n\r\n    var isInMap = this.layerInfosObj.traversal(function(layerInfo) {\r\n      if (layerInfo.id === _layerId) {\r\n        _layerInfo = layerInfo;\r\n        return true;\r\n      }\r\n\r\n      return false;\r\n    });\r\n\r\n    if (layer && isInMap && _layerInfo) {\r\n      if (esriLang.isDefined(item.subLayer)) {\r\n        url = _layerInfo.url || (layer.url + \"/\" + item.subLayer);\r\n      } else {\r\n        url = _layerInfo.url || layer.url;\r\n      }\r\n\r\n      return {\r\n        name: _layerInfo.title,\r\n        layerId: _layerId,\r\n        url: url,\r\n        placeholder: item.hintText || window.jimuNls.common.findAddressOrPlace,\r\n        searchFields: [item.field.name],\r\n        displayField: item.field.name,\r\n        exactMatch: item.field.exactMatch || false,\r\n        maxResults: 6,\r\n        searchInCurrentMapExtent: false,\r\n        type: \"query\"\r\n      };\r\n    } else {\r\n      return null;\r\n    }\r\n  };\r\n\r\n  mo._isEsriLocator = function(url) {\r\n    this._esriLocatorRegExp.lastIndex = 0;\r\n    return this._esriLocatorRegExp.test(url);\r\n  };\r\n\r\n  mo._processSingleLine = function(geocode) {\r\n    // this._esriLocatorRegExp.lastIndex = 0;\r\n    if (geocode.singleLineFieldName) {\r\n      return geocode;\r\n    } else if (this._isEsriLocator(geocode.url)) {\r\n      geocode.singleLineFieldName = 'SingleLine';\r\n      return geocode;\r\n    } else {\r\n      var def = new Deferred();\r\n      esriRequest({\r\n        url: geocode.url,\r\n        content: {\r\n          f: \"json\"\r\n        },\r\n        handleAs: \"json\",\r\n        callbackParamName: \"callback\"\r\n      }).then(lang.hitch(this, function(response) {\r\n        if (response.singleLineAddressField && response.singleLineAddressField.name) {\r\n          geocode.singleLineFieldName = response.singleLineAddressField.name;\r\n          def.resolve(geocode);\r\n        } else {\r\n          console.warn(geocode.url + \"has no singleLineFieldName\");\r\n          def.resolve(null);\r\n        }\r\n      }), lang.hitch(this, function(err) {\r\n        console.error(err);\r\n        def.resolve(null);\r\n      }));\r\n\r\n      return def.promise;\r\n    }\r\n  };\r\n\r\n  mo._getGeocodeName = function(geocodeUrl) {\r\n    if (typeof geocodeUrl !== \"string\") {\r\n      return \"geocoder\";\r\n    }\r\n    var strs = geocodeUrl.split('/');\r\n    return strs[strs.length - 2] || \"geocoder\";\r\n  };\r\n\r\n  mo.getGeocoderName = function(url) {\r\n    return this._getGeocodeName(url);\r\n  };\r\n\r\n  mo.hasAppSearchInfo = function(map) {\r\n    return map.itemInfo && map.itemInfo.itemData &&\r\n      map.itemInfo.itemData.applicationProperties &&\r\n      map.itemInfo.itemData.applicationProperties.viewing &&\r\n      map.itemInfo.itemData.applicationProperties.viewing.search;\r\n  };\r\n\r\n  mo.searchLayer = function(map) {\r\n    if (!this.hasAppSearchInfo(map)) {\r\n      return false;\r\n    }\r\n    var search = map.itemInfo.itemData.applicationProperties.viewing.search;\r\n    if (!search.enabled) {\r\n      return false;\r\n    }\r\n    if (!search.layers || search.layers.length === 0) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  };\r\n\r\n  return mo;\r\n});\r\n"]}