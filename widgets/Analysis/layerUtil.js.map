{"version":3,"sources":["../../../widgets/Analysis/layerUtil.js"],"names":["define","lang","array","all","Deferred","FeatureLayer","GeoRSSLayer","WFSLayer","esriRequest","LayerInfos","jimuUtils","mo","proxyCheckPromise","proxyCheckedServers","getLayerObjects","isPortal","retDef","layerInfosObject","getInstanceSync","layerInfos","traversal","layerInfo","push","defs","map","itemInfo","getItemInfo","then","info","getItem","getLayerType","type","isLeaf","forEach","getSubLayers","subLayerInfo","layerObject","name","title","getLayerObjectTryUsingFeatureService","layerObjects","resultArray","i","geometryType","declaredClass","id","json","createFeatureCollectionJsonFromWFS","layer","mode","MODE_SNAPSHOT","outFields","_layerName","capabilities","indexOf","checkLayers","resolve","layers","promAll","def","length","url","isHostedService","isPortalHostedService","analysisProxyCheck","_getProxyServiceInfo","always","lowerCaseUrl","toLowerCase","hosted","curServer","found","serviceUrl","token","_getToken","serverId","substring","some","Object","keys","content","useProxy","getTableInfos","allLayerInfos","concat","getTableInfoArray","getLayerInfoArray","filter","isTable","getTableLayerObjects","dfd","tableInfos","tableInfo","getLayerObject","nonEmptyLayerObjects","getMainGeometryType","mapLayer","counter","points","lines","polygons","graphics","graphic","geometry","wfsLayer","symbol","_pointSymbol","_lineSymbol","_polygonSymbol","featureCollection","layerDefinition","toJson","fields","field","clone","features","index","attributes","__OBJECTID","featureSet"],"mappings":"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","file":"layerUtil.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n  'dojo/_base/lang',\r\n  'dojo/_base/array',\r\n  'dojo/promise/all',\r\n  'dojo/Deferred',\r\n  'esri/layers/FeatureLayer',\r\n  'esri/layers/GeoRSSLayer',\r\n  'esri/layers/WFSLayer',\r\n  'esri/request',\r\n  'jimu/LayerInfos/LayerInfos',\r\n  'jimu/shared/utils'\r\n], function(lang, array, all, Deferred, FeatureLayer, GeoRSSLayer, WFSLayer, esriRequest, LayerInfos, jimuUtils) {\r\n  var mo = {};\r\n  var proxyCheckPromise;\r\n  var proxyCheckedServers = {};\r\n\r\n  mo.getLayerObjects = function(isPortal){\r\n    var retDef = new Deferred();\r\n    var layerInfosObject = LayerInfos.getInstanceSync();\r\n\r\n    var layerInfos = [];\r\n    layerInfosObject.traversal(function(layerInfo){\r\n      layerInfos.push(layerInfo);\r\n    });\r\n\r\n    var defs = array.map(layerInfos, function(layerInfo){\r\n      // if layerInfo.getLayerType() is \"GeoRSSLayer\", assgin name to layerObject if it is undefined\r\n      var itemInfo;\r\n      return layerInfo.getItemInfo()\r\n      .then(function(info) {\r\n        if (info) {\r\n          itemInfo = info.getItem();\r\n        }\r\n      })\r\n      .then(function() {\r\n        return layerInfo.getLayerType();\r\n      })\r\n      .then(function(type){\r\n        if(type === 'GeoRSSLayer') {\r\n          if(!layerInfo.isLeaf()) {\r\n            array.forEach(layerInfo.getSubLayers(), function(subLayerInfo) {\r\n              if(!subLayerInfo.layerObject.name) {\r\n                subLayerInfo.layerObject.name = subLayerInfo.title;\r\n              }\r\n            });\r\n          }\r\n        }\r\n        return layerInfo.getLayerObjectTryUsingFeatureService();\r\n      })\r\n      .then(function(layerObject){\r\n        if(layerObject) {\r\n          layerObject.itemInfo = itemInfo;\r\n          return layerObject;\r\n        }\r\n      });\r\n    });\r\n    all(defs).then(function(layerObjects){\r\n      var resultArray = [];\r\n      array.forEach(layerObjects, function(layerObject, i){\r\n        if (!layerObject || !layerObject.geometryType) {\r\n          return;\r\n        }\r\n        if((layerObject instanceof FeatureLayer &&\r\n          layerObject.declaredClass !== 'esri.layers.StreamLayer') ||\r\n            layerObject instanceof GeoRSSLayer) {\r\n          layerObject.id = layerObject.id || layerInfos[i].id;\r\n          resultArray.push(layerObject);\r\n        } else if (layerObject instanceof WFSLayer) {\r\n          var json = mo.createFeatureCollectionJsonFromWFS(layerObject),\r\n              layer = new FeatureLayer(json, {\r\n                mode: FeatureLayer.MODE_SNAPSHOT,\r\n                outFields: [\"*\"]\r\n              });\r\n          layer.id = layerObject.id || layerInfos[i].id;\r\n          layer.title = layerObject._layerName;\r\n          layer.name = layerObject._layerName;\r\n          if(layer.capabilities) {\r\n            if(layer.capabilities.indexOf(\"Extract\") === -1) {\r\n              layer.capabilities = layer.capabilities + \",Extract\";\r\n            }\r\n          } else {\r\n            layer.capabilities = \"Extract\";\r\n          }\r\n          resultArray.push(layer);\r\n        }\r\n      });\r\n      mo.checkLayers(resultArray, isPortal).then(function() {\r\n        retDef.resolve(resultArray);\r\n      });\r\n    }, function() {\r\n      retDef.resolve([]);\r\n    });\r\n\r\n    return retDef;\r\n  };\r\n\r\n  mo.checkLayers = function(layers, isPortal) {\r\n    var promAll, def;\r\n    if (proxyCheckPromise) {\r\n      // Multiple Requests return first promise\r\n      return proxyCheckPromise;\r\n    }\r\n    def = new Deferred();\r\n    if (isPortal || layers.length === 0) {\r\n      def.resolve();\r\n      return def;\r\n    }\r\n\r\n    proxyCheckPromise = def;\r\n    promAll = [];\r\n    layers.forEach(function(layer) {\r\n      if (layer.url && !jimuUtils.isHostedService(layer.url) && !mo.isPortalHostedService(layer.url)) {\r\n        if (!layer.analysisProxyCheck) {\r\n          promAll.push(mo._getProxyServiceInfo(layer));\r\n        }\r\n      }\r\n    });\r\n    if (promAll.length === 0) {\r\n      def.resolve();\r\n      proxyCheckPromise = null;\r\n    } else {\r\n      all(promAll).always(function() {\r\n        def.resolve();\r\n        proxyCheckPromise = null;\r\n      });\r\n    }\r\n    return def;\r\n  };\r\n\r\n  mo.isPortalHostedService = function(url) {\r\n    if (!url) {\r\n      return false;\r\n    }\r\n    var lowerCaseUrl = url.toLowerCase(), hosted = \"/hosted/\";\r\n    return lowerCaseUrl.indexOf(hosted) !== -1;\r\n  }\r\n\r\n  mo._getProxyServiceInfo = function(layer) {\r\n    var def = new Deferred(), curServer, found;\r\n\r\n    var serviceUrl = layer.url + ((layer.url.indexOf(\"?\") > -1) ? \"&\" : \"?\") + \"f=json\";\r\n    var url = layer.url;\r\n    var token = typeof layer._getToken === 'function' ? layer._getToken() : null;\r\n    var serverId = url.substring(0, url.indexOf(\"/\", 9));\r\n\r\n    // did we already check this server?\r\n    found = array.some(Object.keys(proxyCheckedServers), function(id) {\r\n      curServer = url.substring(0, url.indexOf(\"/\", 9));\r\n      if (id === curServer) {\r\n        layer.analysisProxyCheck = proxyCheckedServers[id]; //set the checked result\r\n        return true;\r\n      }\r\n    }, this);\r\n    if (found) {\r\n      def.resolve();\r\n    } else {\r\n      if (token) {\r\n        serviceUrl += \"&token=\" + token;\r\n      }\r\n      esriRequest({\r\n        url: serviceUrl,\r\n        content: null\r\n      },\r\n      {\r\n        useProxy: true\r\n      }).then(function() {\r\n        layer.analysisProxyCheck = \"success\";\r\n        proxyCheckedServers[serverId] = \"success\";\r\n        def.resolve({});\r\n      }, function() {\r\n        layer.analysisProxyCheck = \"failure\";\r\n        if (!proxyCheckedServers[serverId]) {\r\n          proxyCheckedServers[serverId] = \"failure\";\r\n        }\r\n        def.resolve();\r\n      });\r\n    }\r\n    return def;\r\n  };\r\n\r\n  mo.getTableInfos = function() {\r\n    var layerInfosObject = LayerInfos.getInstanceSync();\r\n    var allLayerInfos = [].concat(layerInfosObject.getTableInfoArray(), layerInfosObject.getLayerInfoArray());\r\n    return array.filter(allLayerInfos, function(layerInfo) {\r\n      return layerInfo.isTable === true;\r\n    });\r\n  };\r\n\r\n  mo.getTableLayerObjects = function() {\r\n    var dfd = new Deferred();\r\n    var tableInfos = mo.getTableInfos();\r\n    var defs = array.map(tableInfos, function(tableInfo) {\r\n      return tableInfo.getLayerObject();\r\n    });\r\n\r\n    all(defs).then(function(layerObjects){\r\n      var nonEmptyLayerObjects = array.filter(layerObjects, function(layerObject) {\r\n        return layerObject !== null;\r\n      });\r\n      dfd.resolve(nonEmptyLayerObjects);\r\n    });\r\n    return dfd;\r\n  };\r\n\r\n  mo.getMainGeometryType = function(mapLayer) {\r\n    var counter = {\r\n      points: 0,\r\n      lines: 0,\r\n      polygons: 0\r\n    };\r\n    array.forEach(mapLayer.graphics, function(graphic){\r\n      if (graphic.geometry.type === \"point\") {\r\n        counter.points++;\r\n      } else if (graphic.geometry.type === \"polyline\") {\r\n        counter.lines++;\r\n      } else if (graphic.geometry.type === \"polygon\") {\r\n        counter.polygons++;\r\n      }\r\n    });\r\n    if (counter.points > counter.lines && counter.points > counter.polygons) {\r\n      return \"esriGeometryPoint\";\r\n    } else if (counter.lines > counter.points && counter.lines > counter.polygons) {\r\n      return \"esriGeometryPolyline\";\r\n    } else {\r\n      return \"esriGeometryPolygon\";\r\n    }\r\n  };\r\n\r\n  mo.createFeatureCollectionJsonFromWFS = function(wfsLayer) {\r\n    var geometryType = mo.getMainGeometryType(wfsLayer);\r\n    var symbol;\r\n    if (geometryType === \"esriGeometryPoint\") {\r\n      symbol = wfsLayer._pointSymbol;\r\n    } else if (geometryType === \"esriGeometryPolyline\") {\r\n      symbol = wfsLayer._lineSymbol;\r\n    } else { //  \"esriGeometryPolygon\"\r\n      symbol = wfsLayer._polygonSymbol;\r\n    }\r\n\r\n    var featureCollection = {\r\n      \"layerDefinition\": null,\r\n      \"featureSet\": {\r\n        \"features\": [],\r\n        \"geometryType\": geometryType\r\n      }\r\n    };\r\n    featureCollection.layerDefinition = {\r\n      \"geometryType\": geometryType,\r\n      \"objectIdField\": \"__OBJECTID\",\r\n      \"type\": \"Feature Layer\",\r\n      \"typeIdField\": \"\",\r\n      \"drawingInfo\": {\r\n        \"renderer\": {\r\n          \"type\": \"simple\",\r\n          \"symbol\": symbol.toJson()\r\n        },\r\n        \"fixedSymbols\": true\r\n      },\r\n      \"fields\": [{\r\n        \"name\": \"__OBJECTID\",\r\n        \"alias\": \"__OBJECTID\",\r\n        \"type\": \"esriFieldTypeOID\"\r\n      }],\r\n      \"types\": [],\r\n      \"capabilities\": \"Query\"\r\n    };\r\n\r\n    array.forEach(wfsLayer.fields, function(field){\r\n      if (array.indexOf([\r\n        \"esriFieldTypeInteger\",\r\n        \"esriFieldTypeDouble\",\r\n        \"esriFieldTypeDate\",\r\n        \"esriFieldTypeString\"], field.type) > -1) {\r\n        featureCollection.layerDefinition.fields.push(lang.clone(field));\r\n      }\r\n    });\r\n\r\n    var features = [];\r\n    array.forEach(wfsLayer.graphics, function(graphic, index){\r\n      var attributes = lang.clone(graphic.attributes);\r\n      attributes.__OBJECTID = index;\r\n      features.push({\r\n        geometry: graphic.geometry.toJson(),\r\n        attributes: attributes\r\n      });\r\n    });\r\n    featureCollection.featureSet.features = features;\r\n\r\n    return featureCollection;\r\n  };\r\n\r\n  return mo;\r\n});\r\n"]}