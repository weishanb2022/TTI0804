{"version":3,"sources":["../../../widgets/Analysis/PrivilegeUtil.js"],"names":["define","declare","lang","array","Deferred","all","portalUtils","portalUrlUtils","Role","esriRequest","esriNs","esriLang","PortalAnalysis","instance","clazz","userRole","userPortalUrl","portalAnalysis","portalSelf","portalUrl","licenseDef","licenseLevel","federatedServers","constructor","_clearLoadedInfo","loadPrivileges","_privilegeLoaded","def","resolve","portal","getPortal","dfd","signInDef","haveSignIn","_loadUserInfo","_signIn","then","hitch","status","isPortal","checkAnalysisLicense","loadSelfInfo","info","portalHost","portalHostname","signIn","credential","_registerOrgCredential","orgPortalUrl","getStandardPortalUrl","c","clone","toJson","restUrl","server","resources","id","registerToken","selfInfoDef","helpmapDef","getHelpMap","defArray","selfInfo","helpmapInfo","helpMap","helpmap","v","m","urlKey","customBaseUrl","user","roleId","role","privileges","setPrivileges","mixin","getUser","isAdmin","getUserPortal","livingAtlasConfigEnabled","livingAtlasGroupQuery","length","canPerformAnalysis","canPerformSpatialAnalytics","canPerformGeoAnalytics","canPerformRasterAnalysis","canPerformGeoEnrichment","_canPerformGeoEnrichment","hasPrivileges","other","shouldCheckLicense","isArray","indexOf","filter","item","isAdvanceLicense","getFederatedServers","restBaseUrl","getSharingUrl","serversUrl","url","content","f","servers","error","console","log","getLicense","hostingserverArr","hostingServer","serverRole","serverInfo","licenseInfo","defaultLicenseLevel","isDefined","edition","level","name","isResolved","getInstance"],"mappings":"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","file":"PrivilegeUtil.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright © Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n  'dojo/_base/declare',\r\n  'dojo/_base/lang',\r\n  'dojo/_base/array',\r\n  'dojo/Deferred',\r\n  'dojo/promise/all',\r\n  'jimu/portalUtils',\r\n  'jimu/portalUrlUtils',\r\n  'jimu/Role',\r\n  'esri/request',\r\n  'esri/kernel',\r\n  'esri/lang',\r\n  './PortalAnalysis'\r\n], function(declare, lang, array, Deferred, all, portalUtils, portalUrlUtils, Role, esriRequest, esriNs,\r\nesriLang, PortalAnalysis) {\r\n  var instance = null;\r\n\r\n  var clazz = declare([], {\r\n    userRole: null,\r\n    userPortalUrl: null,\r\n    portalAnalysis: null,\r\n    portalSelf: null,\r\n    portalUrl: null,\r\n    licenseDef: null,\r\n    licenseLevel: null,\r\n    federatedServers: null,\r\n\r\n    constructor: function(portalUrl){\r\n      this.portalUrl = portalUrl;\r\n    },\r\n\r\n    _clearLoadedInfo: function(){\r\n      this.userRole = null;\r\n      this.userPortalUrl = null;\r\n      this.portalAnalysis = null;\r\n      this.portalSelf = null;\r\n      this.portalUrl = null;\r\n    },\r\n\r\n    loadPrivileges: function(portalUrl){\r\n      if(portalUrl && this.portalUrl !== portalUrl){\r\n        this._clearLoadedInfo();\r\n        this.portalUrl = portalUrl;\r\n      }\r\n\r\n      if(this._privilegeLoaded()){\r\n        var def = new Deferred();\r\n        def.resolve(true);\r\n        return def;\r\n      }\r\n\r\n      var portal = portalUtils.getPortal(this.portalUrl);\r\n      var dfd = new Deferred(), signInDef;\r\n      if(portal.haveSignIn()){\r\n        signInDef = this._loadUserInfo(portal);\r\n      }else{\r\n        signInDef = this._signIn(portal);\r\n      }\r\n      signInDef.then(lang.hitch(this, function(status) {\r\n        if (status && this.isPortal()) {\r\n          this.checkAnalysisLicense().then(function() {\r\n            dfd.resolve(status);\r\n          });\r\n        } else {\r\n          dfd.resolve(status);\r\n        }\r\n      }));\r\n      return dfd;\r\n    },\r\n\r\n    _signIn: function(portal){\r\n      return portal.loadSelfInfo().then(lang.hitch(this, function(info){\r\n        var portalHost = portalUtils.getPortal(info.portalHostname);\r\n        if(portalHost === null){\r\n          return false;\r\n        }else{\r\n          return portalHost.signIn().then(lang.hitch(this, function(credential){\r\n            return this._loadUserInfo(portalHost, credential);\r\n          }), function() {\r\n            return false;\r\n          });\r\n        }\r\n      }), function() {\r\n        return false;\r\n      });\r\n    },\r\n\r\n    _registerOrgCredential: function(credential, orgPortalUrl){\r\n      orgPortalUrl = portalUrlUtils.getStandardPortalUrl(orgPortalUrl);\r\n      var c = lang.clone(credential.toJson());\r\n      var restUrl = orgPortalUrl + '/sharing/rest';\r\n      c.server = restUrl;\r\n      c.resources = [restUrl];\r\n      esriNs.id.registerToken(c);\r\n    },\r\n\r\n    _loadUserInfo: function(portal, credential){\r\n      var selfInfoDef = portal.loadSelfInfo();\r\n      var helpmapDef = portal.getHelpMap();\r\n      return all([selfInfoDef, helpmapDef]).then(lang.hitch(this, function(defArray){\r\n        var selfInfo = defArray[0], helpmapInfo = defArray[1] && defArray[1].helpMap;\r\n        var helpmap = {};\r\n        if (helpmapInfo) {\r\n          if (helpmapInfo.v && helpmapInfo.m) {\r\n            helpmap.helpMap = helpmapInfo;\r\n          } else {\r\n            helpmap.helpMap = {\r\n              v: '1.0',\r\n              m: helpmapInfo\r\n            };\r\n          }\r\n        }\r\n        if(selfInfo.urlKey){\r\n          this.userPortalUrl = selfInfo.urlKey + '.' + selfInfo.customBaseUrl;\r\n        }else{\r\n          this.userPortalUrl = this.portalUrl;\r\n        }\r\n        if(selfInfo && selfInfo.user) {\r\n          this.userRole = new Role({\r\n            id: (selfInfo.user.roleId) ? selfInfo.user.roleId : selfInfo.user.role,\r\n            role: selfInfo.user.role\r\n          });\r\n          if(selfInfo.user.privileges) {\r\n            this.userRole.setPrivileges(selfInfo.user.privileges);\r\n          }\r\n          this.portalSelf = lang.mixin(selfInfo, helpmap);\r\n          if(credential){\r\n            this._registerOrgCredential(credential, this.userPortalUrl);\r\n          }\r\n          this.portalAnalysis = new PortalAnalysis(this.userRole,\r\n              this.portalSelf);\r\n          return true;\r\n        }else{\r\n          return false;\r\n        }\r\n      }), function() {\r\n        return false;\r\n      });\r\n    },\r\n\r\n    _privilegeLoaded: function(){\r\n      return this.portalSelf !== null;\r\n    },\r\n\r\n    getUser: function(){\r\n      if(this._privilegeLoaded()){\r\n        return this.portalSelf.user;\r\n      }else{\r\n        return null;\r\n      }\r\n    },\r\n\r\n    isAdmin: function(){\r\n      if(this._privilegeLoaded()){\r\n        return this.userRole.isAdmin();\r\n      }else{\r\n        return false;\r\n      }\r\n    },\r\n\r\n    getUserPortal: function(){\r\n      if(this._privilegeLoaded()){\r\n        return this.userPortalUrl;\r\n      }else{\r\n        return null;\r\n      }\r\n    },\r\n\r\n    isPortal: function(){\r\n      return this.portalSelf !== null && this.portalSelf.isPortal === true;\r\n    },\r\n\r\n    livingAtlasConfigEnabled: function() {\r\n      // only portal has the option to disable living atlas\r\n      if (this.isPortal()) {\r\n        return this.portalSelf && this.portalSelf.livingAtlasGroupQuery && this.portalSelf.livingAtlasGroupQuery.length > 0;\r\n      }\r\n      return true;\r\n    },\r\n\r\n    //check to show analysis UX\r\n    canPerformAnalysis: function(){\r\n      return this.portalAnalysis !== null && this.portalAnalysis.canPerformAnalysis();\r\n    },\r\n\r\n    canPerformSpatialAnalytics: function() {\r\n      return this.portalAnalysis !== null && this.portalAnalysis.canPerformSpatialAnalytics();\r\n    },\r\n\r\n    canPerformGeoAnalytics: function() {\r\n      return this.portalAnalysis !== null && this.portalAnalysis.canPerformGeoAnalytics();\r\n    },\r\n\r\n    canPerformRasterAnalysis: function () {\r\n      return this.portalAnalysis !== null && this.portalAnalysis.canPerformRasterAnalysis();\r\n    },\r\n\r\n    canPerformGeoEnrichment: function() {\r\n      return this.portalAnalysis !== null && this.portalAnalysis._canPerformGeoEnrichment();\r\n    },\r\n\r\n    hasPrivileges: function(privileges){\r\n      var other = privileges, shouldCheckLicense = false;\r\n      if (lang.isArray(privileges) && privileges.indexOf('svradvanced') >= 0) {\r\n        shouldCheckLicense = true;\r\n        other = array.filter(privileges, function(item) {\r\n          return item !== 'svradvanced';\r\n        });\r\n      }\r\n      if (shouldCheckLicense && this.isPortal()) {\r\n        return this.isAdvanceLicense() && this.portalAnalysis !== null && this.portalAnalysis.hasPrivileges(other);\r\n      }\r\n      return this.portalAnalysis !== null && this.portalAnalysis.hasPrivileges(other);\r\n    },\r\n\r\n    isAdvanceLicense: function() {\r\n      return this.licenseLevel === 'svradvanced';\r\n    },\r\n\r\n    getFederatedServers: function() {\r\n      var dfd = new Deferred(),\r\n        isPortal = this.isPortal();\r\n      if (isPortal && this.userRole && !this.federatedServers) {\r\n        var restBaseUrl = portalUrlUtils.getSharingUrl(this.portalUrl);\r\n        var serversUrl = restBaseUrl + '/portals/' + this.portalSelf.id + '/servers';\r\n        esriRequest({url: serversUrl, content: {f: 'json'}}).then(lang.hitch(this, function (servers) {\r\n          this.federatedServers = servers.servers;\r\n          dfd.resolve(this.federatedServers);\r\n        }), lang.hitch(this, function (error) {\r\n          console.log('cannot load federated servers', error);\r\n          this.federatedServers = [];\r\n          dfd.resolve([]);\r\n        }));\r\n      } else {\r\n        dfd.resolve(this.federatedServers);\r\n      }\r\n      return dfd;\r\n    },\r\n\r\n    getLicense: function(servers) {\r\n      //console.log(servers);\r\n      var dfd = new Deferred(), hostingserverArr, hostingServer;\r\n      if(servers.length === 0) {\r\n        dfd.resolve(null);\r\n        return dfd;\r\n      }\r\n      hostingserverArr = array.filter(servers, function(server) {\r\n        return server.serverRole === 'HOSTING_SERVER';\r\n      } , this);\r\n\r\n      if(hostingserverArr.length > 0) {\r\n        hostingServer = hostingserverArr[0];\r\n      }\r\n      var restBaseUrl = portalUrlUtils.getSharingUrl(this.portalUrl);\r\n      esriRequest({\r\n        url: restBaseUrl + '/portals/' + this.portalSelf.id + '/servers/' + hostingServer.id,\r\n        content: {f: 'json'}\r\n      }).then(lang.hitch(this, function(serverInfo) {\r\n        //console.log(serverInfo);\r\n        var licenseInfo = lang.mixin({}, serverInfo);\r\n        var defaultLicenseLevel =\r\n          !esriLang.isDefined(serverInfo.edition) && !esriLang.isDefined(serverInfo.level) ? 'svradvanced' : null;\r\n        this.licenseLevel = licenseInfo.edition ? licenseInfo.edition.name : defaultLicenseLevel;\r\n        dfd.resolve({licenseInfo: licenseInfo,\r\n          licenseLevel: this.licenseLevel\r\n        });\r\n      }), lang.hitch(this, function (error) {\r\n        console.log('cannot load hostingServer info', error);\r\n        dfd.resolve({});\r\n      }));\r\n      return dfd;\r\n    },\r\n\r\n    /**\r\n     * Copied from arcgisonline/map/dijit/toc/analysis.js\r\n     */\r\n    checkAnalysisLicense: function() {\r\n      var def = new Deferred();\r\n      if(this.licenseDef) {\r\n        if(this.licenseDef.isResolved()) {\r\n          def.resolve(this.licenseLevel === 'svradvanced');\r\n        } else {\r\n          this.licenseDef.then(lang.hitch(this, function() {\r\n            def.resolve(this.licenseLevel === 'svradvanced');\r\n          }));\r\n        }\r\n      } else {\r\n        this.licenseDef = this.getFederatedServers().then(lang.hitch(this, function(servers) {\r\n          return this.getLicense(servers);\r\n        }));\r\n        this.licenseDef.then(lang.hitch(this, function() {\r\n          return def.resolve(this.licenseLevel === 'svradvanced');\r\n        }));\r\n      }\r\n      return def;\r\n    }\r\n  });\r\n\r\n  clazz.getInstance = function(portalUrl) {\r\n    if(instance === null) {\r\n      instance = new clazz(portalUrl);\r\n    }\r\n    return instance;\r\n  };\r\n\r\n  return clazz;\r\n});\r\n"]}