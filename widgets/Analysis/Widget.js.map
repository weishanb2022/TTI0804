{"version":3,"sources":["../../../widgets/Analysis/Widget.js"],"names":["define","declare","lang","html","array","domStyle","domAttr","domClass","domGeom","Deferred","on","a11yclick","a11y","Evented","query","all","domConstruct","jsapiBundle","JSON","_WidgetsInTemplateMixin","esriRequest","JobInfo","FeatureSet","EsriQuery","QueryTask","FeatureLayer","PopupTemplate","AnalysisUtils","Extent","BaseWidget","ViewStack","Message","PopupMenu","jimuUtils","portalUtils","portalUrlUtils","LayerInfos","layerUtil","toolValidate","PrivilegeUtil","toolSettings","HelpLink","settingBundle","TOOLLIST_VIEW","ANALYSIS_VIEW","MESSAGE_VIEW","clazz","baseClass","isPortal","_hasContent","privilegeUtil","currentStack","toolCountInList","analysisMode","postMixInProperties","inherited","arguments","isRenderIdForAttrs","mixin","nls","analysisTools","window","jimuNls","common","toolNotAvailable","postCreate","popupMenu","getInstance","isOnline","_getPortalUrl","viewStack","viewType","views","toolListPanel","toolPanel","messagePanel","place","domNode","widgetContent","_switchView","a11y_addMessagePanelEvent","_closeHelpDialog","_helpDialog","close","onClose","_deactiveDrawTool","_setDrawingLayersVisibility","_unbindAnalysisEvent","onOpen","_refreshAnalysisTool","onDeActive","shelter","show","getLayerObjects","then","hitch","layerObjects","isValid","currentToolSetting","hide","_setIconAndLink","_switchToAnalysisTool","_checkValidation","def","empty","toolsTbody","config","length","resolve","loadPrivileges","status","canPerformAnalysis","_noPrivilegeHandler","privilegeError","set","toolsSection","noQueryTipSection","a11y_initFirstFocusNode","_initToolList","_clearContent","currentAnalysisDijit","clear","toolCtr","message","stripHTML","homeBtn","lastToolConfig","forEach","item","idx","toolSetting","findToolSetting","name","toolLabel","title","hasPrivileges","privileges","_addTool","a11y_initLastFocusNode","console","error","destroy","rowData","toolItemDOM","create","add","iconTd","label","nameDiv","innerHTML","iconDiv","src","folderUrl","imgDisplay","tooltipTd","showHelp","index","dijitID","lastIndexOf","helpFileName","substring","toLowerCase","tooltipLink","isSingleTenant","iconClassName","portalSelf","placeAt","initHelpLinks","err","log","own","remove","a11y_addTool","smallIcon","icon","toolTitle","helpLink","inputHeader","toolLoadErrorNode","require","AnalysisDijit","args","map","showSelectFolder","helperServices","portalUrl","getUserPortal","showCredits","showChooseExtent","returnFeatureCollection","showReadyToUseLayers","livingAtlasConfigEnabled","disableRunAnalysis","showGeoAnalyticsParams","canPerformGeoAnalytics","showBrowseLayers","creditAssignments","checkCreditLimits","enableTravelModes","showTemporalJoin","showJoinCondition","showOutputType","enableEnrichmentFields","canPerformGeoEnrichment","allowChooseLabel","layerObjectsDfd","asyncGeocode","analysisGpServer","url","getTableLayerObjects","showSelectAnalysisLayer","inputTables","analysisLayer","_prepareLayers","geomTypes","indexOf","optionalArgs","_prepareLayerParams","primaryActionButttonClass","style","width","_setTitleAttr","_bindAnalysisEvents","startup","currentDijitID","backBtn","submitButton","btnDiv","back","_switchToPrevious","a11y_analysisTool_backBtn","a11y_analysisTool_submitBtn","a11y_analysisTool_toolPanel","matchedLayers","requiredParam","isArray","optionalParams","param","_isAnalysisLayer","layer","isInternal","analysisProxyCheck","geoType","types","esriGeoType","getTypeByGeometryType","declaredClass","geometryType","graphics","push","_deactivateGenerator","toggleButtons","tool","toggleButton","deactivateDrawTool","calculateDensity","createViewshed","createWatershed","extractData","_drawExtentBtn","_toolbar","deactivate","findHotSpots","findSimilarLocations","_selectBtn","selectionLayer","clearSelection","interpolatePoints","planRoutes","traceDownstream","apply","setInfoWindowOnClick","visible","_getDrawLayerAttr","startListener","submitListener","cancelListener","failedListener","succeedListener","statusListener","resultListener","activeDrawListener","deactiveDrawListener","analysisDijit","_onJobStart","_onJobSubmitted","_onJobCancelled","_onJobFailed","_onJobSucceed","_onJobStatusChange","_onJobResultData","_clearMessageLogs","emit","res","outputProperties","OutputName","parse","_appendMessage","jobSubmitted","node","messageSection","jobStatus","jobCancelled","_onJobDone","buttonSection","type","jobFailed","analysisReport","jobSuccess","resultLoading","jobId","currentToolJobId","STATUS_EXECUTING","_appendExecutingMessage","STATUS_FAILED","STATUS_CANCELLED","STATUS_DELETED","STATUS_TIMED_OUT","STATUS_SUCCEEDED","focus","currentJobStatus","a11y_updateTitleForMsgDom","resultSection","outputLayerName","_appendResultMessage","outputtip","outputSaveInPortal","popupTemplate","value","itemId","popupInfo","layerInfo","_fetchResultByItemId","popupInfoLocal","fieldInfos","layerDefinition","fields","field","objectIdField","fieldName","alias","isEditable","featureLayer","infoTemplate","addLayer","_createExportNode","featureSet","portal","getPortal","getItemById","portalItem","baseUrl","itemUrl","content","f","handleAs","serviceMeta","defs","tables","layers","reverse","table","tableUrl","id","itemInfo","layerInfosObject","addTable","options","outFields","_createExportNodeForUrl","layerUrl","popupLocal","_buildFeatureLayer","initialExtent","setExtent","layerName","ret","mode","MODE_SNAPSHOT","_wabProperties","itemLayerInfo","appConfig","outputSection","msg","messageStatusNode","nodeList","executing","cannotCancel","closeImg","cancelJob","_cancelTask","a11y_addAttrsAndEventForCancelBtn","_getLayerNameSuffix","test","names","split","Number","paramName","count","suffix","graphicsLayerIds","layerId","getLayer","layerIds","getItemDetailsPageUrl","itemProperties","serviceProperties","outputLink","href","target","a11y_addAttrsForOutputLink","hasGeometry","queryParams","returnGeometry","outSpatialReference","spatialReference","where","queryTask","execute","data","container","exportNode","a11y_addAttrsForExportNode","event","_showActions","prepareActions","allowToExport","position","_setFocusedNodeBeforeOpen","getStandardPortalUrl","jobInfo","cancel","_switchToHome","switchView","noToolTip","a11y_switchView_toolList","a11y_switchView_others","extend"],"mappings":"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","file":"Widget.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright © Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine(['dojo/_base/declare',\r\n  'dojo/_base/lang',\r\n  'dojo/_base/html',\r\n  'dojo/_base/array',\r\n  'dojo/dom-style',\r\n  'dojo/dom-attr',\r\n  'dojo/dom-class',\r\n  'dojo/dom-geometry',\r\n  'dojo/Deferred',\r\n  'dojo/on',\r\n  \"dijit/a11yclick\",\r\n  \"./a11y/Widget\",\r\n  'dojo/Evented',\r\n  'dojo/query',\r\n  'dojo/promise/all',\r\n  'dojo/dom-construct',\r\n  'dojo/i18n!esri/nls/jsapi',\r\n  'dojo/json',\r\n  'dijit/_WidgetsInTemplateMixin',\r\n  'esri/request',\r\n  'esri/tasks/JobInfo',\r\n  'esri/tasks/FeatureSet',\r\n  'esri/tasks/query',\r\n  'esri/tasks/QueryTask',\r\n  'esri/layers/FeatureLayer',\r\n  'esri/dijit/PopupTemplate',\r\n  'esri/dijit/analysis/utils',\r\n  'esri/geometry/Extent',\r\n  'jimu/BaseWidget',\r\n  'jimu/dijit/ViewStack',\r\n  'jimu/dijit/Message',\r\n  'jimu/dijit/FeatureActionPopupMenu',\r\n  'jimu/utils',\r\n  'jimu/portalUtils',\r\n  'jimu/portalUrlUtils',\r\n  'jimu/LayerInfos/LayerInfos',\r\n  './layerUtil',\r\n  './toolValidate',\r\n  './PrivilegeUtil',\r\n  './toolSettings',\r\n  './helpLink',\r\n  'dojo/i18n!./setting/nls/strings',\r\n  'dijit/form/Button',\r\n  'jimu/dijit/LoadingIndicator'\r\n],\r\nfunction(declare, lang, html, array, domStyle, domAttr, domClass, domGeom, Deferred, on, a11yclick, a11y, Evented,\r\n  query, all, domConstruct, jsapiBundle, JSON, _WidgetsInTemplateMixin,\r\n  esriRequest, JobInfo, FeatureSet, EsriQuery, QueryTask, FeatureLayer, PopupTemplate,\r\n  AnalysisUtils, Extent, BaseWidget, ViewStack, Message, PopupMenu, jimuUtils, portalUtils,\r\n  portalUrlUtils, LayerInfos, layerUtil, toolValidate, PrivilegeUtil,\r\n  toolSettings, HelpLink, settingBundle) {\r\n  var TOOLLIST_VIEW = 0, ANALYSIS_VIEW = 1, MESSAGE_VIEW = 2;\r\n\r\n  var clazz = declare([BaseWidget, _WidgetsInTemplateMixin, Evented], {\r\n    baseClass: 'jimu-widget-analysis esriAnalysis',\r\n\r\n    isPortal: null,\r\n    _hasContent: null,\r\n    privilegeUtil: null,\r\n    currentStack: 0,\r\n    toolCountInList: 0,\r\n    analysisMode: 'default', // 'bigdata', 'raster', 'standard', 'default'\r\n\r\n    postMixInProperties: function() {\r\n      this.inherited(arguments);\r\n      this.isRenderIdForAttrs = true;\r\n      lang.mixin(this.nls, jsapiBundle.analysisTools);\r\n      lang.mixin(this.nls, window.jimuNls.common);\r\n      this.nls.toolNotAvailable = settingBundle.toolNotAvailable;\r\n    },\r\n\r\n    postCreate: function() {\r\n      this.inherited(arguments);\r\n\r\n      this.popupMenu = PopupMenu.getInstance();\r\n      this.privilegeUtil = PrivilegeUtil.getInstance();\r\n      this.isPortal = !portalUrlUtils.isOnline(this._getPortalUrl());\r\n\r\n      this.viewStack = new ViewStack({\r\n        viewType: 'dom',\r\n        views: [this.toolListPanel, this.toolPanel, this.messagePanel]\r\n      });\r\n      html.place(this.viewStack.domNode, this.widgetContent);\r\n\r\n      this._switchView(TOOLLIST_VIEW);\r\n\r\n      this.a11y_addMessagePanelEvent();\r\n    },\r\n\r\n    _closeHelpDialog: function(){\r\n      if (AnalysisUtils._helpDialog &&\r\n        typeof AnalysisUtils._helpDialog.close === 'function') {\r\n        AnalysisUtils._helpDialog.close();\r\n      }\r\n    },\r\n\r\n    onClose: function() {\r\n      this._closeHelpDialog();\r\n      this._deactiveDrawTool();\r\n      this._setDrawingLayersVisibility(false);\r\n      this._unbindAnalysisEvent();\r\n    },\r\n\r\n    onOpen: function() {\r\n      this._setDrawingLayersVisibility(true);\r\n\r\n      if(this.currentStack === ANALYSIS_VIEW) {\r\n        this._refreshAnalysisTool();\r\n      }\r\n    },\r\n\r\n    onDeActive: function(){\r\n      this._deactiveDrawTool();\r\n    },\r\n\r\n    _refreshAnalysisTool: function() {\r\n      this.shelter.show();\r\n      layerUtil.getLayerObjects(this.isPortal).then(lang.hitch(this, function(layerObjects) {\r\n        // Validate the tool again because the map may has been changed.\r\n        toolValidate.isValid(layerObjects, this.currentToolSetting, this.privilegeUtil);\r\n        this.shelter.hide();\r\n        this._setIconAndLink(this.currentToolSetting);\r\n        this._switchToAnalysisTool();\r\n      }));\r\n    },\r\n\r\n    _checkValidation: function() {\r\n      var def;\r\n      //empty tool list\r\n      domConstruct.empty(this.toolsTbody);\r\n\r\n      if (this.config.analysisTools.length === 0) {\r\n        def = new Deferred();\r\n        def.resolve();\r\n        return def;\r\n      }\r\n\r\n      this.shelter.show();\r\n      return this.privilegeUtil.loadPrivileges(this._getPortalUrl()).then(\r\n        lang.hitch(this, function(status) {\r\n          if (!status || !this.privilegeUtil.canPerformAnalysis()) {\r\n            this._noPrivilegeHandler(this.nls.privilegeError);\r\n          } else {\r\n            domStyle.set(this.toolsSection, 'display', 'block');\r\n            domStyle.set(this.noQueryTipSection, 'display', 'none');\r\n            this.a11y_initFirstFocusNode();//init first node\r\n            return this._initToolList().then(lang.hitch(this, function() {\r\n              this.shelter.hide();\r\n            }));\r\n          }\r\n        }), lang.hitch(this, function() {\r\n          //load privileges error\r\n          this._noPrivilegeHandler(this.nls.privilegeError);\r\n          this.shelter.hide();\r\n        }));\r\n    },\r\n\r\n    _clearContent: function() {\r\n      //empty tool list\r\n      domConstruct.empty(this.toolsTbody);\r\n\r\n      //remove dijit if exists\r\n      if (this.currentAnalysisDijit) {\r\n        if(typeof this.currentAnalysisDijit.clear === 'function') {\r\n          this.currentAnalysisDijit.clear();\r\n        }\r\n        this.currentAnalysisDijit = null;\r\n        domConstruct.empty(this.toolCtr);\r\n      }\r\n      this.currentToolSetting = null;\r\n    },\r\n\r\n    _noPrivilegeHandler: function(message) {\r\n      this.shelter.hide();\r\n      domStyle.set(this.toolsSection, 'display', 'none');\r\n      domAttr.set(this.noQueryTipSection, 'innerHTML', jimuUtils.stripHTML(message));\r\n      domStyle.set(this.noQueryTipSection, 'display', 'block');\r\n    },\r\n\r\n    _initToolList: function() {\r\n      domStyle.set(this.homeBtn, 'display', '');\r\n      this.toolCountInList = 0;\r\n      var lastToolConfig = null;\r\n      return layerUtil.getLayerObjects(this.isPortal).then(lang.hitch(this, function(layerObjects) {\r\n        array.forEach(this.config.analysisTools, lang.hitch(this, function(item, idx) {\r\n          var toolSetting = toolSettings.findToolSetting(item.name);\r\n          if (toolSetting !== null) {\r\n            toolSetting = lang.mixin(toolSetting, this.config.analysisTools[idx]);\r\n            if(!toolSetting.toolLabel){//If upgrade from 1.2, toolLabel is undefined.\r\n              toolSetting.toolLabel = this.nls[toolSetting.title];\r\n            }\r\n            //check extra privileges\r\n            var hasPrivileges =\r\n                this.privilegeUtil.hasPrivileges(toolSetting.privileges);\r\n\r\n            if (hasPrivileges) {\r\n              //validate tool, check whether there are feature layer(s)\r\n              //required to run this tool\r\n              var isValid = toolValidate.isValid(layerObjects, toolSetting, this.privilegeUtil);\r\n              this._addTool(toolSetting, idx, isValid);\r\n              this.toolCountInList += 1;\r\n              lastToolConfig = toolSetting;\r\n            }\r\n          }\r\n        }));\r\n        this.a11y_initLastFocusNode();//init last node\r\n        if (this.toolCountInList === 1) {\r\n          domStyle.set(this.homeBtn, 'display', 'none');\r\n          this.currentToolSetting = lastToolConfig;\r\n        }\r\n      }), lang.hitch(this, function() {\r\n        console.error('layerUtil: getLayerObjects error');\r\n      }));\r\n    },\r\n\r\n    destroy: function() {\r\n      this._clearContent();\r\n      this.inherited(arguments);\r\n    },\r\n\r\n    _addTool: function(rowData, idx, isValid) {\r\n      var toolItemDOM = domConstruct.create(\"div\", {\r\n        'class': 'tools-table-item',\r\n        'data-toolname': rowData.name\r\n      }, this.toolsTbody);\r\n      if (idx % 2 === 0) {\r\n        domClass.add(toolItemDOM, 'even');\r\n      } else {\r\n        domClass.add(toolItemDOM, 'odd');\r\n      }\r\n      toolItemDOM.rowData = rowData;\r\n\r\n      //create name\r\n      var iconTd = domConstruct.create(\"div\", {\r\n        'class': 'icon-section'\r\n      }, toolItemDOM);\r\n      var label = jimuUtils.stripHTML(rowData.toolLabel);\r\n      var nameDiv = domConstruct.create('div', {\r\n        'class': 'tool-name jimu-ellipsis',\r\n        title: label,\r\n        innerHTML: jimuUtils.stripHTML(label)\r\n      }, iconTd);\r\n      //create img\r\n      var iconDiv = domConstruct.create('div', {\r\n        'class': 'icon-div'\r\n      }, iconTd);\r\n      domConstruct.create('img', {\r\n        src: this.folderUrl + rowData.imgDisplay,\r\n        'class': 'tool-icon'\r\n      }, iconDiv);\r\n\r\n      //create tooltip\r\n      var tooltipTd = domConstruct.create('div', {\r\n        'class': 'tooltip-section esriAnalysis'\r\n      }, toolItemDOM);\r\n      if(rowData.showHelp){\r\n        //bind event\r\n        var index = rowData.dijitID.lastIndexOf('\\/');\r\n        var helpFileName = rowData.dijitID.substring(index + 1);\r\n        // Adjust for GeocodeLocationsfromTable, since its dijitID is GeocodeLocationsFromTable\r\n        if (helpFileName.toLowerCase() === 'geocodelocationsfromtable') {\r\n          helpFileName = 'GeocodeLocationsfromTable';\r\n        }\r\n\r\n        var tooltipLink = new HelpLink({\r\n          helpFileName: helpFileName,\r\n          isSingleTenant: this.isPortal,\r\n          iconClassName: 'tooltip-icon',\r\n          toolLabel: rowData.toolLabel,\r\n          folderUrl: this.folderUrl,\r\n          portalSelf: this.privilegeUtil.portalSelf\r\n        });\r\n        tooltipLink.placeAt(tooltipTd);\r\n\r\n        try {\r\n          AnalysisUtils.initHelpLinks(tooltipLink.domNode, true);\r\n        }catch (err) {\r\n          console.log(err);\r\n        }\r\n      }\r\n\r\n      if (isValid === true) {\r\n        domAttr.set(toolItemDOM, 'title', '');\r\n        //use a11yclick instead of click\r\n        this.own(on(toolItemDOM, a11yclick, lang.hitch(this, function() {\r\n          this._setIconAndLink(rowData);\r\n          this.currentToolSetting = rowData;\r\n          this._switchToAnalysisTool();\r\n        })));\r\n      } else {\r\n        //create valid tips\r\n        domAttr.set(toolItemDOM, 'title', this.nls.toolNotAvailable);\r\n        domClass.remove(toolItemDOM, 'even');\r\n        domClass.remove(toolItemDOM, 'odd');\r\n        domClass.add(toolItemDOM, 'disabled');\r\n      }\r\n      this.a11y_addTool(toolItemDOM, nameDiv, isValid);\r\n    },\r\n\r\n    _setIconAndLink: function(rowData) {\r\n      domAttr.set(this.smallIcon, 'src', this.folderUrl + rowData.icon);\r\n      domAttr.set(this.toolTitle, 'innerHTML', jimuUtils.stripHTML(rowData.toolLabel));\r\n\r\n      //change help icon link\r\n      var idx = rowData.dijitID.lastIndexOf('\\/');\r\n      var helpFileName = rowData.dijitID.substring(idx + 1);\r\n\r\n      if (this.helpLink) {\r\n        // domConstruct.destroy(this.helpLink);\r\n        this.helpLink.destroy();\r\n        this.helpLink = null;\r\n      }\r\n      if(rowData.showHelp){\r\n        // Adjust for GeocodeLocationsfromTable, since its dijitID is GeocodeLocationsFromTable\r\n        if (helpFileName.toLowerCase() === 'geocodelocationsfromtable') {\r\n          helpFileName = 'GeocodeLocationsfromTable';\r\n        }\r\n        this.helpLink = new HelpLink({\r\n          helpFileName: helpFileName,\r\n          isSingleTenant: this.isPortal,\r\n          iconClassName: 'help-icon jimu-float-trailing',\r\n          toolLabel: rowData.toolLabel,\r\n          folderUrl: this.folderUrl,\r\n          portalSelf: this.privilegeUtil.portalSelf\r\n        });\r\n        this.helpLink.placeAt(this.inputHeader);\r\n\r\n        try{\r\n          AnalysisUtils.initHelpLinks(this.helpLink.domNode, true);\r\n        }catch(error){\r\n          console.log(error);\r\n        }\r\n      }\r\n    },\r\n\r\n    _switchToAnalysisTool: function() {\r\n      domStyle.set(this.toolLoadErrorNode, 'display', 'none');\r\n\r\n      this.shelter.show();\r\n      require([this.currentToolSetting.dijitID], lang.hitch(this, function(AnalysisDijit) {\r\n        if (this.currentAnalysisDijit) {\r\n          //this.currentAnalysisDijit.destroy();\r\n          if(typeof this.currentAnalysisDijit.clear === 'function') {\r\n            this.currentAnalysisDijit.clear();\r\n          }\r\n          this.currentAnalysisDijit = null;\r\n          domConstruct.empty(this.toolCtr);\r\n        }\r\n\r\n        var args = {\r\n          map: this.map,\r\n          //analysisGpServer: analysisGpServer,\r\n          showSelectFolder: true,\r\n          helperServices: this.privilegeUtil.portalSelf.helperServices,\r\n          portalUrl: this._getPortalUrl(this.privilegeUtil.getUserPortal()),\r\n          portalSelf: this.privilegeUtil.portalSelf,\r\n          showCredits: this.currentToolSetting.showCredits,\r\n          showHelp: this.currentToolSetting.showHelp,\r\n          showChooseExtent: this.currentToolSetting.showChooseExtent,\r\n          returnFeatureCollection: this.currentToolSetting.returnFeatureCollection,\r\n          showReadyToUseLayers: this.privilegeUtil.livingAtlasConfigEnabled() && this.currentToolSetting.showReadyToUseLayers,\r\n          isSingleTenant: this.isPortal,\r\n          disableRunAnalysis: this.currentToolSetting.disableRunAnalysis === true,\r\n          analysisMode: this.analysisMode,\r\n          showGeoAnalyticsParams: this.analysisMode === \"bigdata\" &&\r\n            this.privilegeUtil.canPerformGeoAnalytics(),\r\n          showBrowseLayers: this.isPortal && this.analysisMode !== \"raster\"\r\n        };\r\n\r\n        if(this.privilegeUtil.portalSelf && this.privilegeUtil.portalSelf.creditAssignments === 'enabled') {\r\n          args.checkCreditLimits = true;\r\n        }\r\n\r\n        if(this.currentToolSetting.title === 'findNearest' ||\r\n            this.currentToolSetting.title === 'summarizeNearby' ||\r\n            this.currentToolSetting.title === 'enrichLayer'){\r\n          args.enableTravelModes = this.privilegeUtil.hasPrivileges(['networkanalysis']);\r\n        }\r\n\r\n        if(this.currentToolSetting.title === 'joinFeatures') {\r\n          args.showTemporalJoin = args.showGeoAnalyticsParams;\r\n          args.showJoinCondition = args.showGeoAnalyticsParams;\r\n        }\r\n\r\n        if(this.currentToolSetting.title === 'findNearest' ||\r\n            this.currentToolSetting.title === 'planRoutes' ||\r\n            this.currentToolSetting.title === 'connectOriginsToDestinations'){\r\n          args.showOutputType = this.currentToolSetting.showOutputType === true;\r\n        }\r\n\r\n        if(this.currentToolSetting.title === 'findOutliers') {\r\n          args.enableEnrichmentFields = this.privilegeUtil.canPerformGeoEnrichment();\r\n          args.allowChooseLabel = false;\r\n        }\r\n\r\n        var layerObjectsDfd = layerUtil.getLayerObjects(this.isPortal);\r\n\r\n        if(this.currentToolSetting.title === 'geocodeLocations') {\r\n          if(this.privilegeUtil.portalSelf.helperServices.asyncGeocode) {\r\n            args.analysisGpServer = this.privilegeUtil.portalSelf.helperServices.asyncGeocode.url;\r\n          }\r\n          args.checkCreditLimits = false;\r\n          args.showReadyToUseLayers = false;\r\n          args.showBrowseLayers = true;\r\n          args.showChooseExtent = false;\r\n          args.returnFeatureCollection = false;\r\n          layerObjectsDfd = layerUtil.getTableLayerObjects();\r\n        }\r\n\r\n        if('returnFeatureCollection' in this.currentToolSetting){\r\n          args.showSelectFolder = !this.currentToolSetting.returnFeatureCollection;\r\n        }\r\n\r\n        layerObjectsDfd.then(lang.hitch(this, function(layerObjects){\r\n          //set analysis param\r\n          args.showSelectAnalysisLayer = true;\r\n          if(this.currentToolSetting.title === 'geocodeLocations') {\r\n            args.inputTables = layerObjects;\r\n          } else if (this.currentToolSetting.analysisLayer) {\r\n            // args[this.currentToolSetting.analysisLayer.name] = this.inputLayer;\r\n            args[this.currentToolSetting.analysisLayer.name + 's'] =\r\n                this._prepareLayers(layerObjects, this.currentToolSetting.analysisLayer.geomTypes);\r\n            if (this.currentToolSetting.dijitID.indexOf('DeriveNewLocations') !== -1 &&\r\n              args[this.currentToolSetting.analysisLayer.name + 's'].length > 0) {\r\n              args[this.currentToolSetting.analysisLayer.name] = args[this.currentToolSetting.analysisLayer.name + 's'][0];\r\n            }\r\n          }\r\n\r\n          //set required and optional param\r\n          var optionalArgs = this._prepareLayerParams(layerObjects);\r\n          lang.mixin(args, optionalArgs);\r\n          try {\r\n            //TODO: fix it, if don't set primaryActionButttonClass,\r\n            //DeriveNewLocations, FindExistingLocations, FindSimilarLocations fails to build ui\r\n            if (this.currentToolSetting.dijitID.indexOf('DeriveNewLocations') !== -1 ||\r\n              this.currentToolSetting.dijitID.indexOf('FindExistingLocations') !== -1 ||\r\n              this.currentToolSetting.dijitID.indexOf('FindSimilarLocations') !== -1) {\r\n              args.primaryActionButttonClass = 'esriAnalysisSubmitButton';\r\n            }\r\n            this.currentAnalysisDijit = new AnalysisDijit(args, domConstruct.create('div', {\r\n              style: {width:'100%'}\r\n            }, this.toolCtr));\r\n            this.currentAnalysisDijit._setTitleAttr(this.currentToolSetting.toolLabel);\r\n            this._bindAnalysisEvents(this.currentAnalysisDijit);\r\n            this.currentAnalysisDijit.startup();\r\n\r\n            this.currentDijitID = this.currentToolSetting.dijitID;\r\n\r\n            var backBtn;\r\n            var submitButton = query('.esriAnalysis .esriAnalysisSubmitButton', this.toolPanel)[0];\r\n            if (typeof submitButton !== 'undefined') {\r\n              if (this.toolCountInList > 1) {\r\n                domClass.add(submitButton, 'multiTool');\r\n                var btnDiv = domConstruct.create('div', {\r\n                  'class': 'toolpanel-button'\r\n                });\r\n                //create back button\r\n                backBtn = domConstruct.create('div', {\r\n                  'class': 'jimu-btn',\r\n                  innerHTML: this.nls.back\r\n                }, btnDiv);\r\n                domConstruct.place(btnDiv, submitButton, 'before');\r\n                domConstruct.place(submitButton, btnDiv);\r\n                this.currentAnalysisDijit.own(on(backBtn, a11yclick,\r\n                  lang.hitch(this, this._switchToPrevious)));\r\n\r\n                this.a11y_analysisTool_backBtn(backBtn, submitButton);\r\n              }\r\n\r\n              this.a11y_analysisTool_submitBtn(backBtn, submitButton);\r\n              this.a11y_analysisTool_toolPanel(backBtn, submitButton);\r\n            }\r\n          } catch (err) {\r\n            console.error(err.message || err);\r\n            domAttr.set(this.toolLoadErrorNode, 'innerHTML',\r\n                jimuUtils.stripHTML(err.message || err));\r\n            domStyle.set(this.toolLoadErrorNode, 'display', '');\r\n          }\r\n          this._switchView(ANALYSIS_VIEW);\r\n          this.shelter.hide();\r\n        }));\r\n      }), lang.hitch(this, function(err) {\r\n        this._switchView(ANALYSIS_VIEW);\r\n        domAttr.set(this.toolLoadErrorNode, 'innerHTML', jimuUtils.stripHTML(err));\r\n        domStyle.set(this.toolLoadErrorNode, 'display', '');\r\n        this.shelter.hide();\r\n      }));\r\n    },\r\n\r\n    _prepareLayerParams: function(layerObjects) {\r\n      var optionalArgs = {};\r\n      if ('optionalParams' in this.currentToolSetting ||\r\n          'requiredParam' in this.currentToolSetting) {\r\n        var matchedLayers;\r\n        if ('requiredParam' in this.currentToolSetting) {\r\n          matchedLayers = this._prepareLayers(layerObjects,\r\n            this.currentToolSetting.requiredParam.geomTypes);\r\n          if (this.currentToolSetting.requiredParam.isArray) {\r\n            optionalArgs[this.currentToolSetting.requiredParam.name] = matchedLayers;\r\n          } else {\r\n            optionalArgs[this.currentToolSetting.requiredParam.name] =\r\n              matchedLayers.length > 0 ? matchedLayers[0] : null;\r\n          }\r\n        }\r\n        if ('optionalParams' in this.currentToolSetting) {\r\n          array.forEach(this.currentToolSetting.optionalParams, function(param) {\r\n            matchedLayers = this._prepareLayers(layerObjects, param.geomTypes);\r\n            if (param.isArray) {\r\n              optionalArgs[param.name] = matchedLayers;\r\n            } else {\r\n              optionalArgs[param.name] = matchedLayers.length > 0 ? matchedLayers[0] : null;\r\n            }\r\n          }, this);\r\n        }\r\n      }\r\n      return optionalArgs;\r\n    },\r\n\r\n    _isAnalysisLayer: function(layer) {\r\n      var isInternal = !this.isPortal && layer.analysisProxyCheck != null ? layer.analysisProxyCheck === \"failure\" : false;\r\n\r\n      return !isInternal;\r\n    },\r\n\r\n    _prepareLayers: function(layerObjects, geomTypes) {\r\n      var geoType, types = ['point', 'polyline', 'polygon'], matchedLayers = [];\r\n\r\n      if (geomTypes[0] !== '*') {\r\n        types = array.map(geomTypes, function(esriGeoType){\r\n          return jimuUtils.getTypeByGeometryType(esriGeoType);\r\n        });\r\n      }\r\n\r\n      array.forEach(layerObjects, function(layer) {\r\n        if (this._isAnalysisLayer(layer) && layer.declaredClass === \"esri.layers.FeatureLayer\") {\r\n          geoType = jimuUtils.getTypeByGeometryType(layer.geometryType);\r\n          if (types.indexOf(geoType) >= 0 && (layer.url || layer.graphics.length > 0)) {\r\n            matchedLayers.push(layer);\r\n          }\r\n        }\r\n      }, this);\r\n\r\n      return matchedLayers;\r\n    },\r\n\r\n    _deactivateGenerator: function(toggleButtons) {\r\n      var tool = this.currentAnalysisDijit;\r\n\r\n      return function() {\r\n        array.forEach(toggleButtons, function(toggleButton) {\r\n          if(tool[toggleButton]) {\r\n            tool[toggleButton].set(\"checked\", false);\r\n          }\r\n        });\r\n      };\r\n    },\r\n\r\n    _deactiveDrawTool: function() {\r\n      if (!this.currentAnalysisDijit) {\r\n        return;\r\n      }\r\n      var deactivateDrawTool = {\r\n        calculateDensity: this._deactivateGenerator(['_bndgPolyDrawBtn']),\r\n        createViewshed: this._deactivateGenerator(['_analysisPointDrawBtn']),\r\n        createWatershed: this._deactivateGenerator(['_analysisPointDrawBtn']),\r\n        extractData: lang.hitch(this, function() {\r\n          if(this.currentAnalysisDijit._drawExtentBtn){\r\n            this.currentAnalysisDijit._drawExtentBtn.set('checked', false);\r\n          }\r\n          if(this.currentAnalysisDijit._toolbar) {\r\n            this.currentAnalysisDijit._toolbar.deactivate();\r\n          }\r\n        }),\r\n        findHotSpots: this._deactivateGenerator(['_boundingDrawBtn']),\r\n        findSimilarLocations: lang.hitch(this, function() {\r\n          if(this.currentAnalysisDijit._selectBtn) {\r\n            this.currentAnalysisDijit._selectBtn.set('checked', false);\r\n          }\r\n          if(this.currentAnalysisDijit.selectionLayer) {\r\n            this.currentAnalysisDijit.selectionLayer.clearSelection();\r\n          }\r\n        }),\r\n        interpolatePoints: this._deactivateGenerator(['_bndgPolyDrawBtn', '_predictPointDrawBtn']),\r\n        planRoutes: this._deactivateGenerator(['_startPointDrawBtn', '_endPointDrawBtn']),\r\n        traceDownstream: this._deactivateGenerator(['_analysisPointDrawBtn', '_bndgPolyDrawBtn'])\r\n      };\r\n\r\n      if(typeof deactivateDrawTool[this.currentToolSetting.title] === 'function') {\r\n        deactivateDrawTool[this.currentToolSetting.title].apply(this);\r\n        this.map.setInfoWindowOnClick(true);\r\n      }\r\n    },\r\n\r\n    _setDrawingLayersVisibility: function(visible) {\r\n      if (!this.currentAnalysisDijit) {\r\n        return;\r\n      }\r\n      if(typeof this.currentAnalysisDijit._getDrawLayerAttr === 'function') {\r\n        array.forEach(this.currentAnalysisDijit._getDrawLayerAttr(), function(layer) {\r\n          if(visible) {\r\n            layer.show();\r\n          } else {\r\n            layer.hide();\r\n          }\r\n        });\r\n      }\r\n    },\r\n\r\n    _unbindAnalysisEvent: function() {\r\n      if (this.startListener) {\r\n        this.startListener.remove();\r\n        this.startListener = null;\r\n      }\r\n      if (this.submitListener) {\r\n        this.submitListener.remove();\r\n        this.submitListener = null;\r\n      }\r\n      if (this.cancelListener) {\r\n        this.cancelListener.remove();\r\n        this.cancelListener = null;\r\n      }\r\n      if (this.failedListener) {\r\n        this.failedListener.remove();\r\n        this.failedListener = null;\r\n      }\r\n      if (this.succeedListener) {\r\n        this.succeedListener.remove();\r\n        this.succeedListener = null;\r\n      }\r\n      if (this.statusListener) {\r\n        this.statusListener.remove();\r\n        this.statusListener = null;\r\n      }\r\n      if (this.resultListener) {\r\n        this.resultListener.remove();\r\n        this.resultListener = null;\r\n      }\r\n      if (this.activeDrawListener) {\r\n        this.activeDrawListener.remove();\r\n        this.activeDrawListener = null;\r\n      }\r\n      if (this.deactiveDrawListener) {\r\n        this.deactiveDrawListener.remove();\r\n        this.deactiveDrawListener = null;\r\n      }\r\n    },\r\n\r\n    _bindAnalysisEvents: function(analysisDijit) {\r\n      this._unbindAnalysisEvent();\r\n\r\n      this.startListener = on(analysisDijit, 'start',\r\n        lang.hitch(this, this._onJobStart));\r\n      this.submitListener = on(analysisDijit, 'job-submit',\r\n        lang.hitch(this, this._onJobSubmitted));\r\n      this.cancelListener = on(analysisDijit, 'job-cancel',\r\n        lang.hitch(this, this._onJobCancelled));\r\n      this.failedListener = on(analysisDijit, 'job-fail',\r\n        lang.hitch(this, this._onJobFailed));\r\n      this.succeedListener = on(analysisDijit, 'job-success',\r\n        lang.hitch(this, this._onJobSucceed));\r\n      this.statusListener = on(analysisDijit, 'job-status',\r\n        lang.hitch(this, this._onJobStatusChange));\r\n      this.resultListener = on(analysisDijit, 'job-result',\r\n        lang.hitch(this, this._onJobResultData));\r\n      this.activeDrawListener = on(analysisDijit, 'drawtool-activate',\r\n        lang.hitch(this, function() {\r\n          this.map.setInfoWindowOnClick(false);\r\n        }));\r\n      this.deactiveDrawListener = on(analysisDijit, 'drawtool-deactivate',\r\n        lang.hitch(this, function() {\r\n          this.map.setInfoWindowOnClick(true);\r\n        }));\r\n    },\r\n\r\n    _onJobStart: function() {\r\n      this._clearMessageLogs();\r\n      this.shelter.show();\r\n      this._switchView(MESSAGE_VIEW);\r\n      this.emit('start');\r\n    },\r\n\r\n    _onJobSubmitted: function(res) {\r\n      /*{\r\n        params: <Object>\r\n      }*/\r\n      this.shelter.hide();\r\n      this.outputProperties = null;\r\n      if (res.OutputName) {\r\n        this.outputProperties = JSON.parse(res.OutputName, true);\r\n      }\r\n\r\n      this._appendMessage(this.nls[this.currentToolSetting.title] + ' ' +\r\n        this.nls.jobSubmitted);\r\n      //add loading icon, wait for next message\r\n      var node = domConstruct.create('div', {\r\n        'class': 'job-message waiting'\r\n      }, this.messageSection);\r\n      domConstruct.create('img', {\r\n        'class': 'job-executing',\r\n        src: this.folderUrl + 'images/loading.gif'\r\n      }, node);\r\n      this.emit('job-submit', res);\r\n    },\r\n\r\n    _onJobCancelled: function(res) {\r\n      /*{\r\n        \"inputs\": {},\r\n        \"jobId\": <job id>,\r\n        \"jobStatus\": <job status>,\r\n        \"messages\": <an array of message text>,\r\n        \"results\": {}\r\n      }*/\r\n      if (res.jobStatus) {\r\n        this._appendMessage(this.nls.jobCancelled + ': ' + res.jobStatus, 'cancelled');\r\n      } else {\r\n        this._appendMessage(this.nls.jobCancelled, 'cancelled');\r\n      }\r\n\r\n      this._onJobDone();\r\n      //show button area\r\n      domStyle.set(this.buttonSection, 'display', '');\r\n      this.emit('job-cancel', res);\r\n    },\r\n\r\n    _onJobFailed: function(res) {\r\n      /*\r\n      If job parameter has some error, res structure\r\n      {\r\n        message: \"A result layer already exists with this name. Result layers\r\n        must be named uniquely across the organization. Please use a different name.\"\r\n        messageCode: \"AB_0002\"\r\n        type: \"warning\"\r\n      }\r\n      If job submitted and returns error, res structure\r\n      {\r\n        \"analysisReport\": <analysis report message>,\r\n        \"dataType\": <analysis report message>,\r\n        \"paramName\": < parameter  name >,\r\n        \"value\": <output item info | feature collection>\r\n      }*/\r\n      this.shelter.hide();\r\n\r\n      if(res.type === 'warning'){\r\n        //re enable run\r\n        this.currentAnalysisDijit.set('disableRunAnalysis', false);\r\n        this._switchView(ANALYSIS_VIEW);\r\n        new Message({\r\n          message: res.message\r\n        });\r\n        this.emit('job-fail', res);\r\n        return;\r\n      }\r\n\r\n      if (this.currentStack !== MESSAGE_VIEW) {\r\n        this._clearMessageLogs();\r\n        this._switchView(MESSAGE_VIEW);\r\n      }\r\n      this._appendMessage(this.nls.jobFailed + ': ' +\r\n        (res.analysisReport || res.message), 'failed');\r\n      this._onJobDone();\r\n      //show button area\r\n      domStyle.set(this.buttonSection, 'display', '');\r\n      this.emit('job-fail', res);\r\n    },\r\n\r\n    _onJobSucceed: function(res) {\r\n      /*\r\n        jobInfo: {\r\n          \"inputs\": {},\r\n          \"jobParams\": <job parameters>,\r\n          \"jobId\": <job id>,\r\n          \"jobStatus\": <job status>,\r\n          \"messages\": <an array of message text>,\r\n          \"results\": {}\r\n        }\r\n      */\r\n      /*jshint unused: false*/\r\n      this._appendMessage(this.nls.jobSuccess, 'success');\r\n      this._onJobDone();\r\n\r\n      domStyle.set(this.resultLoading, 'display', '');\r\n      this.emit('job-success', res);\r\n    },\r\n\r\n    _onJobDone: function() {\r\n      //remove running and cancel images\r\n      query('img.job-executing', this.messagePanel).forEach(function(node) {\r\n        domConstruct.destroy(node);\r\n      });\r\n    },\r\n\r\n    _onJobStatusChange: function(res) {\r\n      /*\r\n        jobInfo: {\r\n          \"inputs\": {},\r\n          \"jobParams\": <job parameters>,\r\n          \"jobId\": <job id>,\r\n          \"jobStatus\": <job status>,\r\n          \"messages\": <an array of message text>,\r\n          \"results\": {}\r\n        }\r\n      */\r\n      this.shelter.hide();\r\n      if (res.jobId && res.jobId !== this.currentToolJobId) {\r\n        this.currentToolJobId = res.jobId;\r\n      }\r\n\r\n      if (res.jobStatus === JobInfo.STATUS_EXECUTING) {\r\n        this._appendExecutingMessage();\r\n      } else {\r\n        switch (res.jobStatus) {\r\n          case JobInfo.STATUS_FAILED:\r\n          case JobInfo.STATUS_CANCELLED:\r\n          case JobInfo.STATUS_DELETED:\r\n          case JobInfo.STATUS_TIMED_OUT:\r\n            this.shelter.hide();\r\n            if (typeof res.message === 'string') {\r\n              this._appendMessage(res.message, 'failed');\r\n            }\r\n            this._onJobDone();\r\n            domStyle.set(this.buttonSection, 'display', '');\r\n            break;\r\n          case JobInfo.STATUS_SUCCEEDED:\r\n            if (typeof res.message === 'string') {\r\n              this._appendMessage(res.message, 'success');\r\n            }\r\n            this._onJobDone();\r\n            domStyle.set(this.buttonSection, 'display', '');\r\n            domStyle.set(this.resultLoading, 'display', '');\r\n            break;\r\n        }\r\n        this.messagePanel.focus();//focus msg panel when job is done.\r\n      }\r\n      this.currentJobStatus = res.jobStatus;\r\n      this.a11y_updateTitleForMsgDom(res.jobStatus, JobInfo);\r\n\r\n      this.emit('job-status', res);\r\n    },\r\n\r\n    _onJobResultData: function(res) {\r\n      /*\r\n        result: {\r\n          \"analysisReport\": <analysis report message>,\r\n          \"dataType\": <analysis report message>,\r\n          \"outputLayerName\": <result layer name>,\r\n          \"paramName\": < parameter  name >,\r\n          \"value\": <output item info | feature collection>\r\n        }\r\n      */\r\n      domStyle.set(this.resultSection, 'display', '');\r\n      domStyle.set(this.buttonSection, 'display', '');\r\n      var outputLayerName = this._appendResultMessage(res);\r\n\r\n      if(this.currentToolSetting.dijitID.indexOf('ExtractData') >= 0) {\r\n        domAttr.set(this.outputtip, 'innerHTML', jimuUtils.stripHTML(this.nls.outputSaveInPortal));\r\n        domStyle.set(this.resultLoading, 'display', 'none');\r\n      } else {\r\n        domAttr.set(this.outputtip, 'innerHTML', jimuUtils.stripHTML(this.nls.outputtip));\r\n        var popupTemplate;\r\n        if (res.value.itemId) {\r\n          var popupInfo = null;\r\n          if ('layerInfo' in res.value) {\r\n            popupInfo = res.value.layerInfo.popupInfo;\r\n          }\r\n          this._fetchResultByItemId(outputLayerName, res.value.itemId, popupInfo).then(\r\n            lang.hitch(this, function(){\r\n            domStyle.set(this.resultLoading, 'display', 'none');\r\n          }));\r\n        } else if ('layerDefinition' in res.value) { // feature set\r\n          var popupInfoLocal = {\r\n            title: outputLayerName ? outputLayerName : 'output',\r\n            fieldInfos: []\r\n          };\r\n          array.forEach(res.value.layerDefinition.fields, function(field) {\r\n            if (field.name !== res.value.layerDefinition.objectIdField) {\r\n              popupInfoLocal.fieldInfos.push({\r\n                fieldName: field.name,\r\n                visible: true,\r\n                label: field.alias,\r\n                isEditable: false\r\n              });\r\n            }\r\n          });\r\n          popupTemplate = new PopupTemplate(popupInfoLocal);\r\n          var featureLayer = new FeatureLayer(res.value, {\r\n            infoTemplate: popupTemplate\r\n          });\r\n          featureLayer.title = outputLayerName ? outputLayerName : 'output';\r\n          featureLayer.name = outputLayerName ? outputLayerName : 'output';\r\n          this.map.addLayer(featureLayer);\r\n\r\n          this._createExportNode(new FeatureSet(res.value.featureSet));\r\n          domStyle.set(this.resultLoading, 'display', 'none');\r\n        }\r\n      }\r\n      this.emit('job-result', res);\r\n    },\r\n\r\n    _fetchResultByItemId: function(outputLayerName, itemId, popupInfo) {\r\n      var portal = portalUtils.getPortal(\r\n        this._getPortalUrl(this.privilegeUtil.getUserPortal()));\r\n      return portal.getItemById(itemId).then(lang.hitch(this, function(portalItem) {\r\n        var baseUrl = portalItem.url || portalItem.itemUrl;\r\n        return esriRequest({\r\n          url: baseUrl,\r\n          content: {\r\n            f: 'json'\r\n          },\r\n          handleAs: 'json'\r\n        }).then(lang.hitch(this, function(serviceMeta) {\r\n          var defs = [], def;\r\n          var tables = serviceMeta.tables || [];\r\n          var layers = serviceMeta.layers || [];\r\n          tables.reverse();\r\n          layers.reverse();\r\n          array.forEach(tables, function(table) {\r\n            var tableUrl = baseUrl + '\\/' + table.id;\r\n            //add table using LayerInfos.addTable\r\n            def = LayerInfos.getInstance(this.map, this.map.itemInfo)\r\n              .then(lang.hitch(this, function(layerInfosObject){\r\n              layerInfosObject.addTable({\r\n                url: tableUrl,\r\n                title: outputLayerName + ' - ' + table.name,\r\n                options: {\r\n                  outFields: [\"*\"]\r\n                }\r\n              });\r\n              defs.push(this._createExportNodeForUrl(table.name, tableUrl, false));\r\n            }));\r\n            defs.push(def);\r\n          }, this);\r\n          array.forEach(layers, function(layer) {\r\n            var layerUrl = baseUrl + '\\/' + layer.id;\r\n            var popupLocal = null;\r\n            if (layers.length === 1) {\r\n              popupLocal = popupInfo;\r\n            }\r\n            def = this._buildFeatureLayer(layer.name, layerUrl, popupLocal,\r\n              itemId).then(lang.hitch(this, function(featureLayer) {\r\n              featureLayer.title = layer.name;\r\n              this.map.addLayer(featureLayer);\r\n            }));\r\n            defs.push(this._createExportNodeForUrl(layer.name, layerUrl, true));\r\n            defs.push(def);\r\n          }, this);\r\n\r\n          if (serviceMeta.initialExtent) {\r\n            this.map.setExtent(new Extent(serviceMeta.initialExtent));\r\n          }\r\n          return all(defs);\r\n        }));\r\n      }));\r\n    },\r\n\r\n    _buildFeatureLayer: function(layerName, url, popupInfo, itemId) {\r\n      if (popupInfo !== null) {\r\n        var ret = new Deferred();\r\n        popupInfo.title = layerName;\r\n        var featureLayer = new FeatureLayer(url, {\r\n          mode: FeatureLayer.MODE_SNAPSHOT,\r\n          infoTemplate: new PopupTemplate(popupInfo),\r\n          outFields: [\"*\"]\r\n        });\r\n        featureLayer._wabProperties = {\r\n          itemLayerInfo: {\r\n            portalUrl: this.appConfig.portalUrl,\r\n            itemId: itemId\r\n          }\r\n        };\r\n        ret.resolve(featureLayer);\r\n        return ret;\r\n      } else {\r\n        return esriRequest({\r\n          url: url,\r\n          content: {\r\n            f: 'json'\r\n          },\r\n          handleAs: 'json'\r\n        }).then(lang.hitch(this, function(layerDefinition) {\r\n          var popupInfoLocal = {\r\n            title: layerName,\r\n            fieldInfos: []\r\n          };\r\n          array.forEach(layerDefinition.fields, function(field) {\r\n            if (field.name !== layerDefinition.objectIdField) {\r\n              popupInfoLocal.fieldInfos.push({\r\n                fieldName: field.name,\r\n                visible: true,\r\n                label: field.alias,\r\n                isEditable: false\r\n              });\r\n            }\r\n          });\r\n\r\n          var featureLayer = new FeatureLayer(url, {\r\n            mode: FeatureLayer.MODE_SNAPSHOT,\r\n            infoTemplate: new PopupTemplate(popupInfoLocal),\r\n            outFields: [\"*\"]\r\n          });\r\n          featureLayer._wabProperties = {\r\n            itemLayerInfo: {\r\n              portalUrl: this.appConfig.portalUrl,\r\n              itemId: itemId\r\n            }\r\n          };\r\n          return featureLayer;\r\n        }), lang.hitch(this, function() { //on Error\r\n          var featureLayer = new FeatureLayer(url);\r\n          featureLayer._wabProperties = {\r\n            itemLayerInfo: {\r\n              portalUrl: this.appConfig.portalUrl,\r\n              itemId: itemId\r\n            }\r\n          };\r\n          return featureLayer;\r\n        }));\r\n      }\r\n    },\r\n\r\n    _clearMessageLogs: function() {\r\n      domConstruct.empty(this.messageSection);\r\n      domConstruct.empty(this.outputSection);\r\n      domStyle.set(this.resultSection, 'display', 'none');\r\n      domStyle.set(this.buttonSection, 'display', 'none');\r\n      domStyle.set(this.resultLoading, 'display', 'none');\r\n    },\r\n\r\n    _appendMessage: function(msg, type) {\r\n      var innerHTML = jimuUtils.stripHTML(msg);\r\n      domConstruct.create('div', {\r\n        'class': 'job-message ' + (type ? type : ''),\r\n        innerHTML: innerHTML\r\n      }, this.messageSection);\r\n      //set status msg for screen readers\r\n      this.messageStatusNode.innerHTML = innerHTML;\r\n    },\r\n\r\n    _appendExecutingMessage: function() {\r\n      query('div.waiting', this.messagePanel).forEach(function(node) {\r\n        domConstruct.destroy(node);\r\n      });\r\n      var nodeList = query('div.job-executing', this.messagePanel);\r\n      if (nodeList.length === 0) {\r\n        var node = domConstruct.create('div', {\r\n          'class': 'job-message job-executing'\r\n        }, this.messageSection);\r\n        domConstruct.create('span', {\r\n          innerHTML: jimuUtils.stripHTML(this.nls.executing)\r\n        }, node);\r\n        domConstruct.create('img', {\r\n          'class': 'job-executing',\r\n          src: this.folderUrl + 'images/loading.gif'\r\n        }, node);\r\n        //create cancel button\r\n        var cannotCancel = false;\r\n        if (this.currentToolSetting.cannotCancel === true) {\r\n          cannotCancel = true;\r\n        } else if (this.currentToolSetting.dijitID.indexOf('EnrichLayer') >= 0) {\r\n          //Enrich layer with Drive Time Options also cannot be cancelled\r\n          if (this.currentAnalysisDijit && this.currentAnalysisDijit.enableTravelModes) {\r\n            cannotCancel = true;\r\n          }\r\n        }\r\n        if (!cannotCancel) {\r\n          var closeImg = domConstruct.create('img', {\r\n            'class': 'job-cancel-icon job-executing',\r\n            src: this.folderUrl + 'images/cancel.png',\r\n            title: this.nls.cancelJob\r\n          }, node);\r\n\r\n          this.own(on(closeImg, a11yclick, lang.hitch(this, this._cancelTask)));\r\n          this.a11y_addAttrsAndEventForCancelBtn(closeImg);\r\n        }\r\n      }\r\n    },\r\n\r\n    _getLayerNameSuffix: function(layerName, label) {\r\n      if (layerName === label) {\r\n        return 1;\r\n      } else if (/_\\d+$/.test(layerName) && layerName.indexOf(label) === 0) {\r\n        var names = layerName.split('_');\r\n        return Number(names[names.length - 1]) + 1;\r\n      }\r\n      return 0;\r\n    },\r\n\r\n    _appendResultMessage: function(res) {\r\n      if (res.outputLayerName || res.paramName) {\r\n        var label = res.outputLayerName || res.paramName,\r\n          count = 0, suffix = 0, layer;\r\n\r\n        // check layer with duplicated name\r\n        array.forEach(this.map.graphicsLayerIds, lang.hitch(this, function(layerId) {\r\n          layer = this.map.getLayer(layerId);\r\n          suffix = this._getLayerNameSuffix(layer.title, label);\r\n          if(count < suffix) {\r\n            count = suffix;\r\n          }\r\n        }));\r\n\r\n        array.forEach(this.map.layerIds, lang.hitch(this, function(layerId) {\r\n          var layer = this.map.getLayer(layerId);\r\n          suffix = this._getLayerNameSuffix(layer.title, label);\r\n          if(count < suffix) {\r\n            count = suffix;\r\n          }\r\n        }));\r\n\r\n        if(count > 0) {\r\n          label = label + '_' + count;\r\n        }\r\n\r\n        var node = domConstruct.create('div', {\r\n          'class': 'output-item'\r\n        }, this.outputSection);\r\n\r\n        if (res.value && res.value.itemId) {\r\n          var itemUrl = portalUrlUtils.getItemDetailsPageUrl(\r\n            this._getPortalUrl(this.privilegeUtil.getUserPortal()),\r\n                res.value.itemId);\r\n          if (typeof this.outputProperties === 'object') {\r\n            if (res.value.itemId === this.outputProperties.itemProperties.itemId) {\r\n              label = this.outputProperties.serviceProperties.name;\r\n            }\r\n          }\r\n\r\n          var outputLink = domConstruct.create('a', {\r\n            href: itemUrl,\r\n            target: '_blank',\r\n            innerHTML: jimuUtils.stripHTML(label)\r\n          }, node);\r\n          this.a11y_addAttrsForOutputLink(outputLink);\r\n        } else {\r\n          domAttr.set(node, 'innerHTML', label);\r\n        }\r\n        return label;\r\n      } else {\r\n        return null;\r\n      }\r\n    },\r\n\r\n    _createExportNodeForUrl: function(label, url, hasGeometry){\r\n      var queryParams = new EsriQuery();\r\n      queryParams.returnGeometry = hasGeometry;\r\n      queryParams.outSpatialReference = this.map.spatialReference;\r\n      queryParams.outFields = ['*'];\r\n      queryParams.where = '1=1';\r\n      var queryTask = new QueryTask(url);\r\n      return queryTask.execute(queryParams).then(lang.hitch(this, function(featureSet) {\r\n        var node = domConstruct.create('div', {}, this.outputSection);\r\n        domConstruct.create('div', {\r\n          'class': 'output-item',\r\n          innerHTML: jimuUtils.stripHTML(label)\r\n        }, node);\r\n        this._createExportNode(featureSet, node);\r\n      }), function(err){\r\n        console.error(err.message ? err.message : err);\r\n      });\r\n    },\r\n\r\n    _createExportNode: function(data, container){\r\n      if(!container){\r\n        container = this.outputSection;\r\n      }\r\n\r\n      var exportNode = domConstruct.create('div', {\r\n        'class': 'export-node'\r\n      }, container);\r\n      this.a11y_addAttrsForExportNode(exportNode);\r\n\r\n      this.own(on(exportNode, a11yclick, lang.hitch(this, function(event){\r\n        this._showActions(event, data);\r\n      })));\r\n    },\r\n\r\n    _showActions: function(event, featureSet) {\r\n      this.popupMenu.prepareActions(featureSet, this.currentToolSetting.allowToExport)\r\n      .then(lang.hitch(this, function() {\r\n        var position = domGeom.position(event.target);\r\n        this.popupMenu._setFocusedNodeBeforeOpen();\r\n        this.popupMenu.show(position);\r\n      }));\r\n    },\r\n\r\n    _getPortalUrl: function(url) {\r\n      if (url) {\r\n        return portalUrlUtils.getStandardPortalUrl(url);\r\n      } else {\r\n        return portalUrlUtils.getStandardPortalUrl(this.appConfig.portalUrl);\r\n      }\r\n    },\r\n\r\n    _cancelTask: function() {\r\n      if (this.currentToolJobId && this.currentAnalysisDijit) {\r\n        var jobInfo = {\r\n          jobId: this.currentToolJobId\r\n        };\r\n        this.currentAnalysisDijit.cancel(jobInfo);\r\n      }\r\n    },\r\n\r\n    _switchToPrevious: function() {\r\n      this._deactiveDrawTool();\r\n      if (this.currentStack === MESSAGE_VIEW) {\r\n        this._switchToAnalysisTool();\r\n      } else {\r\n        this._switchView(TOOLLIST_VIEW);\r\n      }\r\n    },\r\n\r\n    _switchToHome: function() {\r\n      this._deactiveDrawTool();\r\n      if (this.toolCountInList > 1) {\r\n        this._switchView(TOOLLIST_VIEW);\r\n      } else {\r\n        this._switchToAnalysisTool();\r\n      }\r\n    },\r\n\r\n    _switchView: function(idx) {\r\n      this._closeHelpDialog();\r\n      if (idx === TOOLLIST_VIEW) {\r\n        //perform validation check\r\n        this._checkValidation().then(lang.hitch(this, function(){\r\n          if (this.toolCountInList === 0) {\r\n            this.currentStack = idx;\r\n            this.viewStack.switchView(idx);\r\n            this._noPrivilegeHandler(this.nls.noToolTip);\r\n          } else if (this.toolCountInList === 1) {\r\n            this._setIconAndLink(this.currentToolSetting);\r\n            this._switchToAnalysisTool();\r\n          } else {\r\n            this.currentStack = idx;\r\n            this.viewStack.switchView(idx);\r\n          }\r\n          this.a11y_switchView_toolList();\r\n        }));\r\n      } else {\r\n        this.currentStack = idx;\r\n        this.viewStack.switchView(idx);\r\n        this.a11y_switchView_others(idx, ANALYSIS_VIEW);\r\n      }\r\n    }\r\n  });\r\n\r\n  clazz.extend(a11y);//for a11y\r\n  return clazz;\r\n});\r\n"]}