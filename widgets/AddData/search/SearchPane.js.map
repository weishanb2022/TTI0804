{"version":3,"sources":["../../../../widgets/AddData/search/SearchPane.js"],"names":["define","declare","lang","array","on","domClass","_WidgetBase","_TemplatedMixin","_WidgetsInTemplateMixin","template","i18n","templateString","qDefaultFilter","qRequiredFilter","searchOnStart","searchContext","wabWidget","_dfd","postCreate","inherited","arguments","forEach","getComponents","component","searchPane","startup","_started","bindEvents","search","_onFilterPlaceholderChanged","contains","filterPlaceholder","remove","filterWrapper","style","top","headerNode","clientHeight","add","_onSearchBoxPlaceholderChanged","own","hitch","buildQueryParams","task","qRequired","length","params","q","canSortByRelevance","appendQueryParams","searchBox","bboxOption","scopeOptions","typeOptions","sortOptions","resultsPane","paging","resultCount","resize","contentNode","self","sortField","sortOrder","portal","scopeIsArcGISOnline","arcgisOnlinePortal","cancel","dfd","queryItems","then","searchResponse","isCanceled","queryParams","start","num","nextQueryParams","nextStart","processResults","otherwise","error","console","warn","_showLayers","showLayers"],"mappings":"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","file":"SearchPane.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\ndefine([\"dojo/_base/declare\",\r\n    \"dojo/_base/lang\",\r\n    \"dojo/_base/array\",\r\n    \"dojo/on\",\r\n    \"dojo/dom-class\",\r\n    \"dijit/_WidgetBase\",\r\n    \"dijit/_TemplatedMixin\",\r\n    \"dijit/_WidgetsInTemplateMixin\",\r\n    \"dojo/text!./templates/SearchPane.html\",\r\n    \"dojo/i18n!../nls/strings\",\r\n    \"./SearchBox\",\r\n    \"./BBoxOption\",\r\n    \"./ScopeOptions\",\r\n    \"./TypeOptions\",\r\n    \"./SortOptions\",\r\n    \"./ResultsPane\",\r\n    \"./Paging\",\r\n    \"./ResultCount\"\r\n  ],\r\n  function(declare, lang, array, on, domClass, _WidgetBase, _TemplatedMixin,\r\n    _WidgetsInTemplateMixin, template, i18n) {\r\n\r\n    return declare([_WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin], {\r\n\r\n      i18n: i18n,\r\n      templateString: template,\r\n\r\n      qDefaultFilter: null,\r\n      qRequiredFilter: null,\r\n      searchOnStart: true,\r\n\r\n      searchContext: null,\r\n      wabWidget: null,\r\n\r\n      _dfd: null,\r\n\r\n      postCreate: function() {\r\n        this.inherited(arguments);\r\n        array.forEach(this.getComponents(), function(component) {\r\n          component.searchPane = this;\r\n        }, this);\r\n      },\r\n\r\n      startup: function() {\r\n        if (this._started) {\r\n          return;\r\n        }\r\n        this.inherited(arguments);\r\n        //console.warn(\"SearchPane.startup .......................\");\r\n        this.bindEvents();\r\n        if (this.searchOnStart) {\r\n          this.search();\r\n        }\r\n      },\r\n\r\n      _onFilterPlaceholderChanged: function() {\r\n        if (domClass.contains(this.filterPlaceholder, \"opened\")) {\r\n          domClass.remove(this.filterPlaceholder, \"opened\");\r\n          domClass.remove(this.filterWrapper, \"show\");\r\n        } else {\r\n          this.filterWrapper.style.top = this.headerNode.clientHeight + \"px\";\r\n          domClass.add(this.filterPlaceholder, \"opened\");\r\n          domClass.add(this.filterWrapper, \"show\");\r\n        }\r\n      },\r\n\r\n      _onSearchBoxPlaceholderChanged: function() {\r\n        /*\r\n        if (!this.searchBox) {\r\n          return;\r\n        }\r\n        if (domClass.contains(this.searchBoxPlaceholder, \"opened\")) {\r\n          domClass.remove(this.searchBoxPlaceholder, \"opened\");\r\n          domClass.remove(this.searchBox.domNode, \"show\");\r\n        } else {\r\n          domClass.add(this.searchBoxPlaceholder, \"opened\");\r\n          domClass.add(this.searchBox.domNode, \"show\");\r\n          this.searchBox.searchTextBox.focus();\r\n        }\r\n        */\r\n      },\r\n\r\n      bindEvents: function() {\r\n        // TODO\r\n        this.own(on(this.filterPlaceholder,'click',\r\n          lang.hitch(this, this._onFilterPlaceholderChanged)));\r\n\r\n        // TODO\r\n        /*\r\n        this.own(on(this.searchBoxPlaceholder,\r\n          'click',\r\n          lang.hitch(this, this._onSearchBoxPlaceholderChanged)));\r\n        */\r\n      },\r\n\r\n      buildQueryParams: function(task) {\r\n        var qRequired = null;\r\n        if (typeof this.qRequiredFilter === \"string\" && this.qRequiredFilter.length > 0) {\r\n          qRequired = this.qRequiredFilter;\r\n        }\r\n        var params = {\r\n          q: qRequired,\r\n          canSortByRelevance: false\r\n        };\r\n        array.forEach(this.getComponents(), function(component) {\r\n          component.appendQueryParams(params, task);\r\n        });\r\n        delete params.canSortByRelevance;\r\n        if (params.q === null && typeof this.qDefaultFilter === \"string\" &&\r\n          this.qDefaultFilter.length > 0) {\r\n          params.q = this.qDefaultFilter;\r\n        }\r\n        return params;\r\n      },\r\n\r\n      getComponents: function() {\r\n        return [this.searchBox,\r\n          this.bboxOption,\r\n          this.scopeOptions,\r\n          this.typeOptions,\r\n          this.sortOptions,\r\n          this.resultsPane,\r\n          this.paging,\r\n          this.resultCount\r\n        ];\r\n      },\r\n\r\n      resize: function() {\r\n        this.contentNode.style.top = this.headerNode.clientHeight + 1 + \"px\";\r\n      },\r\n\r\n      search: function() {\r\n        var self = this, task = {};\r\n        var params = this.buildQueryParams(task);\r\n        if (params === null || params.q === null) {\r\n          return;\r\n        }\r\n        if (params && params.sortField === null) {\r\n          params.sortOrder = \"desc\"; // (wab queryItems issue - unable to use relevance)\r\n          //console.warn(\"search-params\",params);\r\n        }\r\n        var portal = this.searchContext.portal;\r\n        if (task.scopeIsArcGISOnline && this.searchContext.arcgisOnlinePortal) {\r\n          portal = this.searchContext.arcgisOnlinePortal;\r\n        }\r\n        //console.warn(\"portal\",portal);\r\n\r\n        if (this._dfd !== null) {\r\n          this._dfd.cancel(\"Search aborted.\", false);\r\n        }\r\n        var dfd = null;\r\n        this._dfd = dfd = portal.queryItems(params).then(function(searchResponse) {\r\n          //console.warn(\"searchResponse\",searchResponse);\r\n          if (!dfd.isCanceled()) {\r\n            if (!searchResponse.queryParams) {\r\n              searchResponse.queryParams = {\r\n                start: searchResponse.start,\r\n                num: searchResponse.num\r\n              };\r\n              if (!searchResponse.nextQueryParams) {\r\n                if (typeof searchResponse.nextStart !== \"undefined\" &&\r\n                  searchResponse.nextStart !== -1) {\r\n                  searchResponse.nextQueryParams = {\r\n                    start: searchResponse.nextStart\r\n                  };\r\n                }\r\n              }\r\n            }\r\n            array.forEach(self.getComponents(), function(component) {\r\n              component.processResults(searchResponse);\r\n            });\r\n          }\r\n        }).otherwise(function(error) {\r\n          // TODO handle the error\r\n          console.warn(\"searchError\", error);\r\n        });\r\n      },\r\n\r\n      _showLayers: function(){\r\n        if (this.wabWidget) {\r\n          this.wabWidget.showLayers();\r\n        }\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n"]}