{"version":3,"sources":["../../../../widgets/AddData/search/ItemCard.js"],"names":["define","declare","array","locale","domClass","_WidgetBase","_TemplatedMixin","_WidgetsInTemplateMixin","template","i18n","util","LayerLoader","templateString","canRemove","item","resultsPane","_dfd","postCreate","inherited","arguments","startup","_started","render","addClicked","self","btn","addButton","contains","add","map","getMap","setNodeText","messageNode","search","messages","removing","lyrs","findLayersAdded","id","layers","forEach","lyr","removeLayer","actions","remove","adding","loader","addItem","then","result","addFailed","otherwise","error","console","warn","message","length","log","detailsClicked","baseUrl","checkMixedContent","portalUrl","url","encodeURIComponent","window","open","formatDate","date","Date","fmt","dateFormat","format","selector","datePattern","titleNode","title","setNodeTitle","_renderThumbnail","_renderTypeOwnerDate","nd","thumbnailNode","thumbnailUrl","innerHTML","thumbnail","document","createElement","src","appendChild","s","sType","types","type","typeByOwnerPattern","replace","owner","typeByOwnerNode"],"mappings":"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","file":"ItemCard.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\ndefine([\"dojo/_base/declare\",\r\n    \"dojo/_base/array\",\r\n    \"dojo/date/locale\",\r\n    \"dojo/dom-class\",\r\n    \"dijit/_WidgetBase\",\r\n    \"dijit/_TemplatedMixin\",\r\n    \"dijit/_WidgetsInTemplateMixin\",\r\n    \"dojo/text!./templates/ItemCard.html\",\r\n    \"dojo/i18n!../nls/strings\",\r\n    \"./util\",\r\n    \"./LayerLoader\"\r\n  ],\r\n  function(declare, array, locale, domClass, _WidgetBase, _TemplatedMixin,\r\n    _WidgetsInTemplateMixin, template, i18n, util, LayerLoader) {\r\n\r\n    return declare([_WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin], {\r\n\r\n      i18n: i18n,\r\n      templateString: template,\r\n\r\n      canRemove: false,\r\n      item: null,\r\n      resultsPane: null,\r\n\r\n      _dfd: null,\r\n\r\n      postCreate: function() {\r\n        this.inherited(arguments);\r\n      },\r\n\r\n      startup: function() {\r\n        if (this._started) {\r\n          return;\r\n        }\r\n        this.inherited(arguments);\r\n        this.render();\r\n      },\r\n\r\n      addClicked: function() {\r\n        var self = this,\r\n          btn = this.addButton;\r\n        if (domClass.contains(btn, \"disabled\")) {\r\n          return;\r\n        }\r\n        domClass.add(btn, \"disabled\");\r\n\r\n        if (this.canRemove) {\r\n          var map = this.resultsPane.getMap();\r\n          util.setNodeText(self.messageNode, i18n.search.item.messages.removing);\r\n          var lyrs = util.findLayersAdded(map, this.item.id).layers;\r\n          array.forEach(lyrs, function(lyr) {\r\n            //console.warn(\"removingLayer\",lyr);\r\n            map.removeLayer(lyr);\r\n          });\r\n          this.canRemove = false;\r\n          util.setNodeText(self.messageNode, \"\");\r\n          util.setNodeText(this.addButton, i18n.search.item.actions.add);\r\n          domClass.remove(btn, \"disabled\");\r\n\r\n        } else {\r\n          util.setNodeText(self.messageNode, i18n.search.item.messages.adding);\r\n          var loader = new LayerLoader();\r\n          loader.addItem(this.item, this.resultsPane.getMap()).then(function(result) {\r\n            //console.warn(\"addClicked.result\",result);\r\n            if (result) {\r\n              self.canRemove = true;\r\n              util.setNodeText(self.messageNode, \"\");\r\n              util.setNodeText(self.addButton, i18n.search.item.actions.remove);\r\n              domClass.remove(btn, \"disabled\");\r\n            } else {\r\n              util.setNodeText(self.messageNode, i18n.search.item.messages.addFailed);\r\n              domClass.remove(btn, \"disabled\");\r\n            }\r\n          }).otherwise(function(error) {\r\n            console.warn(\"Add layer failed.\");\r\n            console.warn(error);\r\n            util.setNodeText(self.messageNode, i18n.search.item.messages.addFailed);\r\n            domClass.remove(btn, \"disabled\");\r\n            if (error && typeof error.message === \"string\" && error.message.length > 0) {\r\n              // TODO show this message\r\n              //console.warn(\"msg\",error.message);\r\n              //util.setNodeText(self.messageNode,error.message);\r\n              console.log('');\r\n            }\r\n          });\r\n        }\r\n      },\r\n\r\n      detailsClicked: function() {\r\n        var item = this.item;\r\n        var baseUrl = util.checkMixedContent(item.portalUrl);\r\n        var url = baseUrl + \"/home/item.html?id=\" + encodeURIComponent(item.id);\r\n        window.open(url);\r\n      },\r\n\r\n      formatDate: function(date) {\r\n        if (typeof(date) === \"number\") {\r\n          date = new Date(date);\r\n        }\r\n        var fmt = i18n.search.item.dateFormat;\r\n        return locale.format(date, {\r\n          selector: \"date\",\r\n          datePattern: fmt\r\n        });\r\n      },\r\n\r\n      render: function() {\r\n        // TODO escape text or not?\r\n        util.setNodeText(this.titleNode, this.item.title);\r\n        util.setNodeTitle(this.titleNode, this.item.title);\r\n        this._renderThumbnail();\r\n        this._renderTypeOwnerDate();\r\n        if (this.canRemove) {\r\n          util.setNodeText(this.addButton, i18n.search.item.actions.remove);\r\n        }\r\n      },\r\n\r\n      _renderThumbnail: function() {\r\n        var nd = this.thumbnailNode,\r\n          thumbnailUrl = this.item.thumbnailUrl;\r\n        nd.innerHTML = \"\";\r\n        thumbnailUrl = util.checkMixedContent(thumbnailUrl);\r\n        var thumbnail = document.createElement(\"IMG\");\r\n        thumbnail.src = thumbnailUrl || \"widgets/AddData/images/placeholder_120x80.png\";\r\n        nd.appendChild(thumbnail);\r\n      },\r\n\r\n      _renderTypeOwnerDate: function() {\r\n        var s, item = this.item;\r\n\r\n        var sType = i18n.search.item.types[item.type];\r\n        if (typeof sType === \"undefined\" || sType === null) {\r\n          sType = item.type;\r\n        }\r\n        var typeByOwnerPattern = i18n.search.item.typeByOwnerPattern;\r\n        s = typeByOwnerPattern.replace(\"{type}\", sType);\r\n        s = s.replace(\"{owner}\", item.owner);\r\n        util.setNodeText(this.typeByOwnerNode, s);\r\n\r\n        /*\r\n        var sDate = this.formatDate(item.modified);\r\n        s = i18n.search.item.datePattern.replace(\"{date}\",sDate);\r\n        util.setNodeText(this.dateNode,s);\r\n        */\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n"]}