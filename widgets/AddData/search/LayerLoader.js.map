{"version":3,"sources":["../../../../widgets/AddData/search/LayerLoader.js"],"names":["define","declare","lang","array","connection","all","Deferred","djJson","i18n","util","esriLang","esriRequest","agsUtils","ArcGISDynamicMapServiceLayer","ArcGISImageServiceLayer","ArcGISTiledMapServiceLayer","DynamicLayerInfo","FeatureLayer","ImageParameters","ImageServiceParameters","KMLLayer","LayerDrawingOptions","MosaicRule","RasterFunction","RasterXLayer","TileInfo","VectorTileLayer","WFSLayer","WMSLayer","WMSLayerInfo","WMTSLayer","WMTSLayerInfo","WebTiledLayer","PopupTemplate","InfoTemplate","jsonRendererUtils","Extent","SpatialReference","jimuUtils","item","itemUrl","map","serviceUrl","constructor","args","mixin","addItem","dfd","_checkMixedContent","url","type","_addFeatureService","_addImageService","_addKML","_addMapService","_addVectorTileService","_addWFS","_addWMS","_addWMTS","console","warn","resolve","self","itemData","layerIds","layerDfds","featureLayers","_readItemJsonData","then","result","layers","length","forEach","l","id","push","_readRestInfo","layer","_generateLayerId","outFields","_waitForLayer","list","lyr","tables","tbl","bAdd","some","lid","results","reverse","opLayer","_processFeatureLayer","arcgisProps","title","_titleForLegend","isDefined","_addLayer","otherwise","error","reject","_newImageServiceLayer","_newKMLLayer","_newMapServiceLayer","_newVectorTileLayer","_newWFSLayer","log","_newWMSLayer","_newWMTSLayer","xtnItemId","xtnAddData","_wabProperties","itemLayerInfo","itemId","portalUrl","addLayer","uri","checkMixedContent","_checkUrl","_checkVectorTileUrl","operationalLayer","endsWith","sv","sfx","indexOf","styleUrl","params","content","handleAs","callbackParamName","_generateLayerIds","count","i","ids","_generateRandomId","t","Date","now","getTime","r","Math","random","replace","_makeFeatureLayerTitle","pattern","serviceName","layerName","n","s","regexp","substring","test","ex","mapLayerId","layerUrl","layerObject","bandIds","format","compressionQuality","opacity","visibility","minScale","maxScale","refreshInterval","popupInfo","disablePopup","renderingRule","functionName","rasterFunction","mosaicRule","layerDefinition","definitionExpression","imageServiceParameters","noData","noDataInterpretation","interpolation","props","visible","resourceInfo","finish","setDefinitionExpression","setInfoTemplate","imageServiceLayer","tiledLayer","response","tileInfo","singleFusedMapCache","cacheType","_newInfoTemplate","popupTemplate","description","showAttachments","fieldInfos","mediaInfos","infoTemplate","setTitle","options","checkVisibleLayers","f","supportedImageFormatTypes","imageParameters","expressions","dynamicLayerInfo","dynamicLayerInfos","drawingOptions","drawingOptionsArray","source","layerInfo","metaLayerInfos","filter","rlyr","visibleLayers","vis","split","defaultVisibility","drawingInfo","setLayerDefinitions","setDynamicLayerInfos","setLayerDrawingOptions","templates","layerInfos","cfgLyr","name","infoTemplates","_setDynamicLayerInfoTemplates","error2","_getVisibleFeatureLayers","tocLayers","realVisibleLayers","k","dontUseLayerIds","subLayerIds","toString","_newPopupInfo","object","fields","field","fieldInfo","getDefaultPortalFieldInfo","isEditable","editable","wfsJSON","wfsInfo","mode","showLabels","customParameters","maxFeatures","swapXY","version","geometryType","labelingInfo","loadWFSByUrl","Error","h1","on","layerError","remove","fromJson","setOpacity","setVisibility","setScaleRange","renderer","ignorePopups","ex2","itemHasLayers","wkid","legendURL","queryable","showPopup","customLayerParameters","maxWidth","maxHeight","featureInfoFormat","getFeatureInfoURL","featureInfoUrl","getMapURL","mapUrl","spatialReferences","copyright","extent","gcsExtent","transparent","firstLayer","_setWMSVisibleLayers","spatialReference","templateUrl","fullExtent","initialExtent","subDomains","wmtsInfo","loaded","connect","featureLayer","dlPattern","search","featureLayerTitlePattern","info","jsonRenderer","isCustomTemplate","popInfo","jsonPopInfo","layerId","parse","stringify","setShowLabels","setRefreshInterval","showLegend","timeAnimation","displayField","isMaxInclusive","setRenderer","transparency","setMinScale","setMaxScale","_setFeatureLayerInfoTemplate","u","dfds","readLayer","lInfo","exp","template","maxLayers","lyrNames","lyrInfo","setVisibleLayers","handles","loadError","clearHandles","h","layerLoaded","message","layerInaccessible"],"mappings":"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","file":"LayerLoader.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\ndefine([\"dojo/_base/declare\",\r\n    \"dojo/_base/lang\",\r\n    \"dojo/_base/array\",\r\n    \"dojo/_base/connect\",\r\n    \"dojo/promise/all\",\r\n    \"dojo/Deferred\",\r\n    \"dojo/json\",\r\n    \"dojo/i18n!../nls/strings\",\r\n    \"./util\",\r\n    \"esri/lang\",\r\n    \"esri/request\",\r\n    \"esri/arcgis/utils\",\r\n    \"esri/layers/ArcGISDynamicMapServiceLayer\",\r\n    \"esri/layers/ArcGISImageServiceLayer\",\r\n    \"esri/layers/ArcGISTiledMapServiceLayer\",\r\n    \"esri/layers/DynamicLayerInfo\",\r\n    \"esri/layers/FeatureLayer\",\r\n    \"esri/layers/ImageParameters\",\r\n    \"esri/layers/ImageServiceParameters\",\r\n    \"esri/layers/KMLLayer\",\r\n    \"esri/layers/LayerDrawingOptions\",\r\n    \"esri/layers/MosaicRule\",\r\n    \"esri/layers/RasterFunction\",\r\n    \"esri/layers/RasterXLayer\",\r\n    \"esri/layers/TileInfo\",\r\n    \"esri/layers/VectorTileLayer\",\r\n    \"esri/layers/WFSLayer\",\r\n    \"esri/layers/WMSLayer\",\r\n    \"esri/layers/WMSLayerInfo\",\r\n    \"esri/layers/WMTSLayer\",\r\n    \"esri/layers/WMTSLayerInfo\",\r\n    \"esri/layers/WebTiledLayer\",\r\n    \"esri/dijit/PopupTemplate\",\r\n    \"esri/InfoTemplate\",\r\n    \"esri/renderers/jsonUtils\",\r\n    \"esri/geometry/Extent\",\r\n    \"esri/SpatialReference\",\r\n    \"jimu/utils\"\r\n  ],\r\n  function(declare, lang, array, connection, all, Deferred, djJson, i18n, util,\r\n    esriLang, esriRequest, agsUtils,\r\n    ArcGISDynamicMapServiceLayer, ArcGISImageServiceLayer, ArcGISTiledMapServiceLayer,\r\n    DynamicLayerInfo, FeatureLayer, ImageParameters, ImageServiceParameters, KMLLayer,\r\n    LayerDrawingOptions, MosaicRule, RasterFunction, RasterXLayer, TileInfo, VectorTileLayer,\r\n    WFSLayer, WMSLayer, WMSLayerInfo, WMTSLayer, WMTSLayerInfo, WebTiledLayer,\r\n    PopupTemplate, InfoTemplate, jsonRendererUtils, Extent, SpatialReference, jimuUtils) {\r\n\r\n    return declare(null, {\r\n\r\n      item: null,\r\n      itemUrl: null,\r\n      map: null,\r\n      serviceUrl: null,\r\n\r\n      constructor: function(args) {\r\n        lang.mixin(this, args);\r\n      },\r\n\r\n      addItem: function(item, map) {\r\n        // TODO layer position, titles, timeouts, feedback\r\n        //console.warn(\"addItem\",item);\r\n        var dfd = new Deferred();\r\n        this.map = map;\r\n        this.item = item;\r\n        this.itemUrl = this._checkMixedContent(item.itemUrl);\r\n        this.serviceUrl = this._checkMixedContent(item.url);\r\n\r\n        if (item.type === \"Feature Service\") {\r\n          return this._addFeatureService();\r\n        } else if (item.type === \"Image Service\") {\r\n          return this._addImageService();\r\n        } else if (item.type === \"KML\") {\r\n          return this._addKML();\r\n        } else if (item.type === \"Map Service\") {\r\n          return this._addMapService();\r\n        } else if (item.type === \"Vector Tile Service\") {\r\n          return this._addVectorTileService();\r\n        } else if (item.type === \"WFS\") {\r\n          return this._addWFS();\r\n        } else if (item.type === \"WMS\") {\r\n          return this._addWMS();\r\n        } else if (item.type === \"WMTS\") {\r\n          return this._addWMTS();\r\n        } else {\r\n          // TODO reject\r\n          console.warn(\"Unsupported item type: \", item.type);\r\n          dfd.resolve(null);\r\n        }\r\n        return dfd;\r\n      },\r\n\r\n      _addFeatureService: function() {\r\n        var self = this,\r\n          dfd = new Deferred();\r\n        var serviceUrl = this.serviceUrl;\r\n        var item = this.item,\r\n          itemData = {};\r\n        var layerIds = null,\r\n          layerDfds = [],\r\n          featureLayers = [];\r\n\r\n        self._readItemJsonData().then(function(result) {\r\n          //console.warn(\"_addFeatureService.jsonData\",result);\r\n          itemData = result || {};\r\n          if (itemData && itemData.layers && (itemData.layers.length > 0)) {\r\n            array.forEach(itemData.layers, function(l) {\r\n              if ((typeof(l.id) !== \"undefined\") && (l.id !== null)) {\r\n                if (layerIds === null) {\r\n                  layerIds = [];\r\n                }\r\n                layerIds.push(l.id);\r\n              }\r\n            });\r\n          }\r\n          return self._readRestInfo(serviceUrl);\r\n\r\n        }).then(function(result) {\r\n          //console.warn(\"_addFeatureService.serviceInfo\",result);\r\n          if (result && typeof result.type === \"string\" &&\r\n             (result.type === \"Feature Layer\" || result.type === \"Table\")) {\r\n            // a single layer registered from a service /FeatureServer/1 or /MapServer/2\r\n            var layer = new FeatureLayer(serviceUrl, {\r\n              id: self._generateLayerId(),\r\n              outFields: [\"*\"]\r\n            });\r\n            layerDfds.push(self._waitForLayer(layer));\r\n\r\n          } else {\r\n            var list = [];\r\n            if (result && result.layers && result.layers.length > 0) {\r\n              array.forEach(result.layers,function(lyr){\r\n                list.push(lyr);\r\n              });\r\n            }\r\n            if (result && result.tables && result.tables.length > 0) {\r\n              array.forEach(result.tables,function(tbl){\r\n                list.push(tbl);\r\n              });\r\n            }\r\n            if (list.length > 0) {\r\n              array.forEach(list, function(lyr) {\r\n                var bAdd = true;\r\n                if (layerIds !== null && layerIds.length > 0) {\r\n                  bAdd = array.some(layerIds, function(lid) {\r\n                    return (lid === lyr.id);\r\n                  });\r\n                }\r\n                if (bAdd) {\r\n                  var layer = new FeatureLayer(serviceUrl + \"/\" + lyr.id, {\r\n                    id: self._generateLayerId(),\r\n                    outFields: [\"*\"]\r\n                  });\r\n                  layerDfds.push(self._waitForLayer(layer));\r\n                }\r\n              });\r\n            } else {\r\n              // TODO popup a message here?\r\n              console.warn(\"No layers or tables...\");\r\n            }\r\n          }\r\n          return all(layerDfds);\r\n\r\n        }).then(function(results) {\r\n          //console.warn(\"_addFeatureService.layerDfds\",results);\r\n          array.forEach(results, function(result) {\r\n            featureLayers.push(result);\r\n          });\r\n          featureLayers.reverse();\r\n          return featureLayers;\r\n\r\n        }).then(function() {\r\n          array.forEach(featureLayers, function(layer) {\r\n            var opLayer = self._processFeatureLayer(layer, item, itemData);\r\n            layer.arcgisProps = {\r\n              title: opLayer.title\r\n            };\r\n            layer._titleForLegend = opLayer.title;\r\n            if (!esriLang.isDefined(layer.title)) {\r\n              layer.title = opLayer.title;\r\n            }\r\n            self._addLayer(layer);\r\n          });\r\n        }).then(function() {\r\n          dfd.resolve(featureLayers);\r\n        }).otherwise(function(error) {\r\n          dfd.reject(error);\r\n        });\r\n        return dfd;\r\n      },\r\n\r\n      _addImageService: function() {\r\n        var self = this,\r\n          dfd = new Deferred();\r\n        self._readItemJsonData().then(function(result) {\r\n          var itemData = result || {};\r\n          return self._newImageServiceLayer(itemData);\r\n        }).then(function(layer) {\r\n          self._addLayer(layer);\r\n          dfd.resolve(layer);\r\n        }).otherwise(function(error) {\r\n          dfd.reject(error);\r\n        });\r\n        return dfd;\r\n      },\r\n\r\n      _addKML: function() {\r\n        var self = this,\r\n          dfd = new Deferred();\r\n        self._newKMLLayer().then(function(layer) {\r\n          if (layer) {\r\n            layer.title = self.item.title;\r\n          }\r\n          self._addLayer(layer);\r\n          dfd.resolve(layer);\r\n        }).otherwise(function(error) {\r\n          dfd.reject(error);\r\n        });\r\n        return dfd;\r\n      },\r\n\r\n      _addMapService: function() {\r\n        var self = this,\r\n          dfd = new Deferred();\r\n        self._readItemJsonData().then(function(result) {\r\n          var itemData = result || {};\r\n          return self._newMapServiceLayer(itemData);\r\n        }).then(function(layer) {\r\n          self._addLayer(layer);\r\n          dfd.resolve(layer);\r\n        }).otherwise(function(error) {\r\n          dfd.reject(error);\r\n        });\r\n        return dfd;\r\n      },\r\n\r\n      _addVectorTileService: function() {\r\n        var self = this,\r\n          dfd = new Deferred();\r\n        self._newVectorTileLayer().then(function(layer) {\r\n          self._addLayer(layer);\r\n          dfd.resolve(layer);\r\n        }).otherwise(function(error) {\r\n          dfd.reject(error);\r\n        });\r\n        return dfd;\r\n      },\r\n\r\n      _addWFS: function() {\r\n        var self = this,\r\n          dfd = new Deferred();\r\n        self._readItemJsonData().then(function(result) {\r\n          var itemData = result || {};\r\n          return self._newWFSLayer(itemData);\r\n        }).then(function(layer) {\r\n          if (layer) {\r\n            layer.title = self.item.title;\r\n          }\r\n          self._addLayer(layer);\r\n          dfd.resolve(layer);\r\n        }).otherwise(function(error) {\r\n          console.log(\"Error adding WFS\",error)\r\n          dfd.reject(error);\r\n        });\r\n        return dfd;\r\n      },\r\n\r\n      _addWMS: function() {\r\n        var self = this,\r\n          dfd = new Deferred();\r\n        self._readItemJsonData().then(function(result) {\r\n          var itemData = result || {};\r\n          return self._newWMSLayer(itemData);\r\n        }).then(function(layer) {\r\n          if (layer) {\r\n            layer.title = self.item.title;\r\n          }\r\n          self._addLayer(layer);\r\n          dfd.resolve(layer);\r\n        }).otherwise(function(error) {\r\n          dfd.reject(error);\r\n        });\r\n        return dfd;\r\n      },\r\n\r\n      _addWMTS: function() {\r\n        var self = this,\r\n          dfd = new Deferred();\r\n        self._readItemJsonData().then(function(result) {\r\n          var itemData = result || {};\r\n          return self._newWMTSLayer(itemData);\r\n        }).then(function(layer) {\r\n          if (layer) {\r\n            layer.title = self.item.title;\r\n          }\r\n          self._addLayer(layer);\r\n          dfd.resolve(layer);\r\n        }).otherwise(function(error) {\r\n          dfd.reject(error);\r\n        });\r\n        return dfd;\r\n      },\r\n\r\n      _addLayer: function(layer) {\r\n        //console.warn(\"_addLayer\",layer);\r\n        //console.warn(\"map\",this.map);\r\n        var item = this.item;\r\n        if (layer) {\r\n          layer.xtnItemId = item.id;\r\n          layer.xtnAddData = true;\r\n          if (!layer.arcgisProps && item) {\r\n            layer.arcgisProps = {\r\n              title: item.title\r\n            };\r\n            layer._titleForLegend = item.title;\r\n          }\r\n          if (!esriLang.isDefined(layer.title)) {\r\n            layer.title = item.title;\r\n          }\r\n\r\n          layer._wabProperties =  {\r\n            itemLayerInfo: {\r\n              itemId: item.id,\r\n              itemUrl: this.itemUrl,\r\n              portalUrl: item.portalUrl\r\n            }\r\n          };\r\n\r\n          this.map.addLayer(layer);\r\n        }\r\n      },\r\n\r\n      _checkMixedContent: function(uri) {\r\n        return util.checkMixedContent(uri);\r\n      },\r\n\r\n      _checkUrl: function(url) {\r\n        return agsUtils._checkUrl(url);\r\n      },\r\n\r\n      /*\r\n      _checkVectorTileUrl: function(url,operationalLayer) {\r\n        var dfd = new Deferred();\r\n        var endsWith = function(sv,sfx) {\r\n          return (sv.indexOf(sfx,(sv.length - sfx.length)) !== -1);\r\n        };\r\n        if (endsWith(url,\".json\")) {\r\n          operationalLayer.styleUrl = url;\r\n          dfd.resolve(url);\r\n        } else {\r\n          var u = this.itemUrl+\"/resources/styles/root.json\";\r\n          var content = {}, options = {};\r\n          esriRequest({url:u,content:content,handleAs:\"json\",callbackParamName:\"callback\"},options).then(\r\n            function(){\r\n              operationalLayer.styleUrl = u;\r\n              dfd.resolve(u);\r\n            },\r\n            function(){\r\n              u = url+\"/resources/styles/root.json\";\r\n              esriRequest({url:u,content:content,handleAs:\"json\",callbackParamName:\"callback\"},options).then(\r\n                function(){\r\n                  operationalLayer.styleUrl = u;\r\n                  dfd.resolve(u);\r\n                },\r\n                function(){\r\n                  operationalLayer.url = url;\r\n                  dfd.resolve(url);\r\n                }\r\n              );\r\n            }\r\n          );\r\n        }\r\n        return dfd;\r\n      },\r\n      */\r\n\r\n      _checkVectorTileUrl: function(url, operationalLayer) {\r\n        var dfd = new Deferred();\r\n        var endsWith = function(sv, sfx) {\r\n          return (sv.indexOf(sfx, (sv.length - sfx.length)) !== -1);\r\n        };\r\n        if (endsWith(url, \".json\")) {\r\n          operationalLayer.styleUrl = url;\r\n          dfd.resolve(url);\r\n          return dfd;\r\n        }\r\n        var params = {\r\n          url: null,\r\n          content: {},\r\n          handleAs: \"json\",\r\n          callbackParamName: \"callback\"\r\n        };\r\n        if (this.itemUrl) {\r\n          params.url = this.itemUrl + \"/resources/styles/root.json\";\r\n          esriRequest(params, {}).then(function() {\r\n            operationalLayer.styleUrl = params.url;\r\n            dfd.resolve(params.url);\r\n          }).otherwise(function() {\r\n            params.url = url + \"/resources/styles/root.json\";\r\n            esriRequest(params, {}).then(function() {\r\n              operationalLayer.styleUrl = params.url;\r\n              dfd.resolve(params.url);\r\n            }).otherwise(function() {\r\n              operationalLayer.url = url;\r\n              dfd.resolve(url);\r\n            });\r\n          });\r\n        } else {\r\n          params.url = url + \"/resources/styles/root.json\";\r\n          esriRequest(params, {}).then(function() {\r\n            operationalLayer.styleUrl = params.url;\r\n            dfd.resolve(params.url);\r\n          }).otherwise(function() {\r\n            operationalLayer.url = url;\r\n            dfd.resolve(url);\r\n          });\r\n        }\r\n        return dfd;\r\n      },\r\n\r\n      _generateLayerId: function() {\r\n        return this._generateLayerIds(1)[0];\r\n      },\r\n\r\n      _generateLayerIds: function(count) {\r\n        var i, ids = [];\r\n        for (i = 0; i < count; i++) {\r\n          ids.push(this._generateRandomId());\r\n        }\r\n        return ids;\r\n      },\r\n\r\n      _generateRandomId: function() {\r\n        var t = null;\r\n        if (typeof Date.now === \"function\") {\r\n          t = Date.now();\r\n        } else {\r\n          t = (new Date()).getTime();\r\n        }\r\n        var r = (\"\" + Math.random()).replace(\"0.\", \"r\");\r\n        return (t + \"\" + r).replace(/-/g, \"\");\r\n      },\r\n\r\n      _makeFeatureLayerTitle: function(pattern, serviceName, layerName) {\r\n        var n, s, regexp;\r\n        try {\r\n          if (serviceName && layerName && (serviceName === layerName)) {\r\n            return serviceName;\r\n          } else if (serviceName && layerName) {\r\n            // try to remove a timestamp suffix\r\n            n = layerName.indexOf(serviceName);\r\n            if (n === 0) {\r\n              s = layerName.substring(n + serviceName.length + 1);\r\n              if (s.length >= 13) {\r\n                regexp = /^\\d+$/;\r\n                if (regexp.test(s)) {\r\n                  return serviceName;\r\n                }\r\n              }\r\n            }\r\n          }\r\n        } catch (ex) {}\r\n        return pattern.replace(\"{serviceName}\", serviceName).replace(\"{layerName}\", layerName);\r\n      },\r\n\r\n      _newImageServiceLayer: function(itemData) {\r\n        //console.warn(\"_newImageServiceLayer.itemData\",itemData);\r\n        var dfd = new Deferred();\r\n        var mapLayerId = this._generateLayerId();\r\n        var serviceUrl = this.serviceUrl;\r\n        var layerUrl = this.serviceUrl;\r\n        var layerObject = {\r\n          mapLayerId: mapLayerId,\r\n          bandIds: null,\r\n          format: null,\r\n          compressionQuality: null,\r\n          opacity: 1.0,\r\n          visibility: true\r\n        };\r\n\r\n        if (esriLang.isDefined(itemData.visibility) && itemData.visibility === false) {\r\n          layerObject.visibility = false; // TODO?\r\n        }\r\n        if (esriLang.isDefined(itemData.opacity)) {\r\n          layerObject.opacity = itemData.opacity;\r\n        }\r\n        if (esriLang.isDefined(itemData.minScale) && !esriLang.isDefined(layerObject.minScale)) {\r\n          layerObject.minScale = itemData.minScale;\r\n        }\r\n        if (esriLang.isDefined(itemData.maxScale) && !esriLang.isDefined(layerObject.maxScale)) {\r\n          layerObject.maxScale = itemData.maxScale;\r\n        }\r\n        if (esriLang.isDefined(itemData.refreshInterval) &&\r\n          !esriLang.isDefined(layerObject.refreshInterval)) {\r\n          layerObject.refreshInterval = itemData.refreshInterval;\r\n        }\r\n        if (itemData.popupInfo && !layerObject.popupInfo && !layerObject.disablePopup) {\r\n          layerObject.popupInfo = itemData.popupInfo;\r\n        }\r\n        if (itemData.renderingRule && !layerObject.renderingRule) {\r\n          layerObject.renderingRule = itemData.renderingRule;\r\n          if (itemData.renderingRule.functionName) {\r\n            layerObject.renderingRule.rasterFunction = itemData.renderingRule.functionName;\r\n          }\r\n        }\r\n        if (itemData.bandIds && !layerObject.bandIds) {\r\n          layerObject.bandIds = itemData.bandIds;\r\n        }\r\n        if (itemData.mosaicRule && !layerObject.mosaicRule) {\r\n          layerObject.mosaicRule = itemData.mosaicRule;\r\n        }\r\n        if (itemData.format && !layerObject.format) {\r\n          layerObject.format = itemData.format;\r\n        }\r\n        if (esriLang.isDefined(itemData.compressionQuality) &&\r\n          !esriLang.isDefined(layerObject.compressionQuality)) {\r\n          layerObject.compressionQuality = itemData.compressionQuality;\r\n        }\r\n        if (itemData.layerDefinition && itemData.layerDefinition.definitionExpression &&\r\n          (!esriLang.isDefined(layerObject.layerDefinition) ||\r\n            !esriLang.isDefined(layerObject.layerDefinition.definitionExpression))) {\r\n          layerObject.layerDefinition = layerObject.layerDefinition || {};\r\n          layerObject.layerDefinition.definitionExpression =\r\n            itemData.layerDefinition.definitionExpression;\r\n        }\r\n\r\n        var imageServiceParameters = new ImageServiceParameters();\r\n        //imageServiceParameters.bandIds = layerObject.bandIds;\r\n        if (layerObject.bandIds !== null) {\r\n          imageServiceParameters.bandIds = layerObject.bandIds;\r\n        }\r\n        if (layerObject.format !== null) {\r\n          imageServiceParameters.format = layerObject.format;\r\n          if (layerObject.compressionQuality !== null) {\r\n            imageServiceParameters.compressionQuality = layerObject.compressionQuality;\r\n          }\r\n        }\r\n        if (layerObject.renderingRule && layerObject.renderingRule.rasterFunction) {\r\n          var rasterFunction = new RasterFunction(layerObject.renderingRule);\r\n          imageServiceParameters.renderingRule = rasterFunction;\r\n        }\r\n        if (layerObject.mosaicRule) {\r\n          var mosaicRule = new MosaicRule(layerObject.mosaicRule);\r\n          imageServiceParameters.mosaicRule = mosaicRule;\r\n        }\r\n        if (esriLang.isDefined(layerObject.noData)) {\r\n          imageServiceParameters.noData = layerObject.noData;\r\n        }\r\n        if (esriLang.isDefined(layerObject.noDataInterpretation)) {\r\n          imageServiceParameters.noDataInterpretation = layerObject.noDataInterpretation;\r\n        }\r\n        if (esriLang.isDefined(layerObject.interpolation)) {\r\n          imageServiceParameters.interpolation = layerObject.interpolation;\r\n        }\r\n\r\n        var props = {\r\n          imageServiceParameters: imageServiceParameters,\r\n          opacity: layerObject.opacity,\r\n          visible: layerObject.visibility\r\n        };\r\n        if (esriLang.isDefined(layerObject.mapLayerId)) {\r\n          props.id = layerObject.mapLayerId;\r\n        }\r\n        if (esriLang.isDefined(layerObject.minScale)) {\r\n          props.minScale = layerObject.minScale;\r\n        }\r\n        if (esriLang.isDefined(layerObject.maxScale)) {\r\n          props.maxScale = layerObject.maxScale;\r\n        }\r\n        if (esriLang.isDefined(layerObject.refreshInterval)) {\r\n          props.refreshInterval = layerObject.refreshInterval;\r\n        }\r\n        if (esriLang.isDefined(layerObject.resourceInfo)) {\r\n          props.resourceInfo = layerObject.resourceInfo;\r\n        }\r\n\r\n        var finish = function(layer) {\r\n          //console.warn(\"finish\",layer);\r\n          if (layerObject.layerDefinition && layerObject.layerDefinition.definitionExpression) {\r\n            layer.setDefinitionExpression(layerObject.layerDefinition.definitionExpression, true);\r\n          }\r\n          if (!layerObject.disablePopup && layerObject.popupInfo) {\r\n            layer.setInfoTemplate(new PopupTemplate(layerObject.popupInfo));\r\n          }\r\n          /*\r\n          rasterUtil.populateLayerWROInfo(layer,true).then(\r\n            function(){dfd.resolve(layer);},\r\n            function(error2){dfd.reject(error2);}\r\n          );\r\n          */\r\n          dfd.resolve(layer);\r\n        };\r\n\r\n        var self = this, imageServiceLayer, tiledLayer;\r\n        self._readRestInfo(serviceUrl).then(function(response) {\r\n          var lyr = null;\r\n          if (response && response.tileInfo && response.singleFusedMapCache) {\r\n            if (response.cacheType === \"Raster\") {\r\n              lyr = new RasterXLayer(serviceUrl, {\r\n                id: mapLayerId\r\n              });\r\n            } else {\r\n              lyr = new ArcGISTiledMapServiceLayer(serviceUrl, {\r\n                id: mapLayerId\r\n              });\r\n            }\r\n            return self._waitForLayer(lyr).then(function(layer) {\r\n              tiledLayer = layer;\r\n            });\r\n          } else {\r\n            lyr = new ArcGISImageServiceLayer(self._checkUrl(layerUrl), props);\r\n            return self._waitForLayer(lyr).then(function(layer) {\r\n              imageServiceLayer = layer;\r\n            });\r\n          }\r\n        }).then(function() {\r\n          if (imageServiceLayer) {\r\n            finish(imageServiceLayer);\r\n          } else if (tiledLayer) {\r\n            dfd.resolve(tiledLayer);\r\n          } else {\r\n            dfd.resolve();\r\n          }\r\n        }).otherwise(function(ex) {\r\n          dfd.reject(ex)\r\n        });\r\n\r\n        return dfd;\r\n      },\r\n\r\n      _newInfoTemplate: function(popupInfo, title) {\r\n        if (popupInfo) {\r\n          try {\r\n            var popupTemplate = new PopupTemplate({\r\n              description: popupInfo.description,\r\n              title: popupInfo.title,\r\n              showAttachments: popupInfo.showAttachments,\r\n              fieldInfos: popupInfo.fieldInfos,\r\n              mediaInfos: popupInfo.mediaInfos\r\n            });\r\n            return popupTemplate;\r\n          } catch (ex) {\r\n            console.error(ex);\r\n          }\r\n        }\r\n        var infoTemplate = new InfoTemplate();\r\n        if (esriLang.isDefined(title)) {\r\n          infoTemplate.setTitle(title);\r\n        }\r\n        return infoTemplate;\r\n      },\r\n\r\n      _newKMLLayer: function() {\r\n        var options = {\r\n          id: this._generateLayerId()\r\n        };\r\n        var lyr = new KMLLayer(this.serviceUrl, options);\r\n        return this._waitForLayer(lyr);\r\n      },\r\n\r\n      _newMapServiceLayer: function(itemData) {\r\n        var self = this,\r\n          dfd = new Deferred();\r\n        var checkVisibleLayers = false;\r\n        var serviceUrl = this.serviceUrl;\r\n        var mapLayerId = this._generateLayerId();\r\n        var content = {\r\n          f: \"json\"\r\n        };\r\n        esriRequest({\r\n          url: serviceUrl,\r\n          content: content,\r\n          handleAs: \"json\",\r\n          callbackParamName: \"callback\"\r\n        }, {}).then(\r\n          function(response) {\r\n            var lyr = null;\r\n            var options = {\r\n              id: mapLayerId\r\n            };\r\n            if (response.tileInfo) {\r\n              lyr = new ArcGISTiledMapServiceLayer(serviceUrl, options);\r\n            } else {\r\n              if (response && response.supportedImageFormatTypes &&\r\n                  response.supportedImageFormatTypes.indexOf(\"PNG32\") !== -1) {\r\n                options.imageParameters = new ImageParameters();\r\n                options.imageParameters.format = \"png32\";\r\n              }\r\n              lyr = new ArcGISDynamicMapServiceLayer(serviceUrl, options);\r\n\r\n              //console.warn(\"itemData\",itemData);\r\n              //console.warn(\"response\",response);\r\n              if (itemData && itemData.layers && itemData.layers.length > 0) {\r\n                var expressions = [];\r\n                var dynamicLayerInfo;\r\n                var dynamicLayerInfos = [];\r\n                var drawingOptions;\r\n                var drawingOptionsArray = [];\r\n                var source;\r\n                array.forEach(itemData.layers, function(layerInfo){\r\n                  if (layerInfo.layerDefinition && layerInfo.layerDefinition.definitionExpression) {\r\n                    expressions[layerInfo.id] = layerInfo.layerDefinition.definitionExpression;\r\n                  }\r\n                  if (layerInfo.layerDefinition && layerInfo.layerDefinition.source) {\r\n                    dynamicLayerInfo = null;\r\n                    source = layerInfo.layerDefinition.source;\r\n                    if (source.type === \"mapLayer\") {\r\n                      var metaLayerInfos = array.filter(response.layers, function(rlyr) {\r\n                        return rlyr.id === source.mapLayerId;\r\n                      });\r\n                      if (metaLayerInfos.length) {\r\n                        dynamicLayerInfo = lang.mixin(metaLayerInfos[0], layerInfo);\r\n                      }\r\n                    }\r\n                    else {\r\n                      dynamicLayerInfo = lang.mixin({}, layerInfo);\r\n                    }\r\n                    if (dynamicLayerInfo) {\r\n                      dynamicLayerInfo.source = source;\r\n                      delete dynamicLayerInfo.popupInfo;\r\n                      dynamicLayerInfo = new DynamicLayerInfo(dynamicLayerInfo);\r\n                      if (itemData.visibleLayers) {\r\n                        var vis = ((typeof itemData.visibleLayers) === \"string\") ?\r\n                          itemData.visibleLayers.split(\",\") : itemData.visibleLayers;\r\n                        if (array.indexOf(vis, layerInfo.id) > -1) {\r\n                          dynamicLayerInfo.defaultVisibility = true;\r\n                        } else {\r\n                          dynamicLayerInfo.defaultVisibility = false;\r\n                        }\r\n                      }\r\n                      dynamicLayerInfos.push(dynamicLayerInfo);\r\n                    }\r\n                  }\r\n                  if (layerInfo.layerDefinition && layerInfo.layerDefinition.source &&\r\n                      layerInfo.layerDefinition.drawingInfo) {\r\n                    drawingOptions = new LayerDrawingOptions(layerInfo.layerDefinition.drawingInfo);\r\n                    drawingOptionsArray[layerInfo.id] = drawingOptions;\r\n                  }\r\n                });\r\n\r\n                if (expressions.length > 0) {\r\n                  lyr.setLayerDefinitions(expressions);\r\n                }\r\n                if (dynamicLayerInfos.length > 0) {\r\n                  lyr.setDynamicLayerInfos(dynamicLayerInfos, true);\r\n                  if (drawingOptionsArray.length > 0) {\r\n                    lyr.setLayerDrawingOptions(drawingOptionsArray, true);\r\n                  }\r\n                } else {\r\n                  checkVisibleLayers = true;\r\n                }\r\n              }\r\n\r\n            }\r\n            self._waitForLayer(lyr).then(\r\n              function(layer) {\r\n                //console.warn(\"MapServiceLayer\",layer);\r\n                var templates = null;\r\n                array.forEach(layer.layerInfos, function(layerInfo) {\r\n                  //console.warn(\"MapServiceLayer.layerInfo\",layerInfo);\r\n                  var cfgLyr = null;\r\n                  if (itemData) {\r\n                    array.some(itemData.layers, function(l) {\r\n                      if (layerInfo.id === l.id) {\r\n                        cfgLyr = l;\r\n                        return true;\r\n                      }\r\n                    });\r\n                  }\r\n                  var popupInfo = null;\r\n                  if (cfgLyr && cfgLyr.popupInfo) {\r\n                    popupInfo = cfgLyr.popupInfo;\r\n                  }\r\n                  if (popupInfo) {\r\n                    if (templates === null) {\r\n                      templates = {};\r\n                    }\r\n                    templates[layerInfo.id] = {\r\n                      infoTemplate: self._newInfoTemplate(popupInfo, layerInfo.name)\r\n                    };\r\n                  }\r\n                });\r\n                if (layer.infoTemplates === null) {\r\n                  if (templates) {\r\n                    layer.infoTemplates = templates;\r\n                  } else {\r\n                    self._setDynamicLayerInfoTemplates(layer);\r\n                  }\r\n                }\r\n                /*\r\n                if (checkVisibleLayers) {\r\n                  var visibleLayers = itemData.visibleLayers;\r\n                  if (!itemData.visibleLayers) {\r\n                    var subIds = \"\";\r\n                    array.forEach(layer.layerInfos, function(layerInfo){\r\n                      if (layerInfo.defaultVisibility) {\r\n                        subIds += (subIds.length > 0 ? \",\" : \"\") + layerInfo.id;\r\n                      }\r\n                    });\r\n                    visibleLayers = subIds;\r\n                  }\r\n                  visibleLayers = self._getVisibleFeatureLayers(layer.layerInfos,visibleLayers);\r\n                  layer.setVisibleLayers(visibleLayers);\r\n                }\r\n                */\r\n                dfd.resolve(layer);\r\n              },\r\n              function(error2) {\r\n                dfd.reject(error2);\r\n              }\r\n            );\r\n          },\r\n          function(error) {\r\n            dfd.reject(error);\r\n          }\r\n        );\r\n        return dfd;\r\n      },\r\n\r\n      _getVisibleFeatureLayers: function(layerInfos, visibleLayers) {\r\n        // don't list the group layers\r\n        if (!layerInfos || !visibleLayers || visibleLayers.length === 0) {\r\n          return [];\r\n        }\r\n        var tocLayers = \",\" + visibleLayers + \",\";\r\n        var realVisibleLayers = [];\r\n        var k, dontUseLayerIds = \",\";\r\n        for (k = 0; k < layerInfos.length; k++) {\r\n          if (layerInfos[k].subLayerIds !== null) {\r\n            if (tocLayers.indexOf(\",\" + layerInfos[k].id + \",\") === -1 ||\r\n              dontUseLayerIds.indexOf(\",\" + layerInfos[k].id + \",\") > -1) {\r\n              dontUseLayerIds += layerInfos[k].subLayerIds.toString() + \",\";\r\n            }\r\n          } else if (tocLayers.indexOf(\",\" + layerInfos[k].id + \",\") > -1 &&\r\n            dontUseLayerIds.indexOf(\",\" + layerInfos[k].id + \",\") === -1) {\r\n            realVisibleLayers.push(layerInfos[k].id);\r\n          }\r\n        }\r\n        return realVisibleLayers;\r\n      },\r\n\r\n      _newPopupInfo: function(object,title) {\r\n        if (object && object.fields) {\r\n          var popupInfo = {\r\n            title: object.name,\r\n            fieldInfos:[],\r\n            description: null,\r\n            showAttachments: true,\r\n            mediaInfos: []\r\n          };\r\n          if (typeof title === \"string\" && title.length > 0) {\r\n            popupInfo.title = title;\r\n          }\r\n          array.forEach(object.fields, function(field){\r\n            var fieldInfo = jimuUtils.getDefaultPortalFieldInfo(field);\r\n            fieldInfo.visible = true;\r\n            fieldInfo.isEditable = field.editable;\r\n            popupInfo.fieldInfos.push(fieldInfo);\r\n          });\r\n          return popupInfo;\r\n        }\r\n        return null;\r\n      },\r\n\r\n      _newVectorTileLayer: function() {\r\n        var self = this,\r\n          dfd = new Deferred(),\r\n          opLayer = {};\r\n        var serviceUrl = this.serviceUrl;\r\n        var mapLayerId = this._generateLayerId();\r\n        if ((typeof serviceUrl === \"string\") && (serviceUrl.length > 0)) {\r\n          this._checkVectorTileUrl(serviceUrl, opLayer).then(\r\n            function(url) {\r\n              if ((typeof url === \"string\") && (url.length > 0)) {\r\n                url = self._checkMixedContent(url);\r\n                var props = {\r\n                  id: mapLayerId,\r\n                  opacity: 1,\r\n                  visible: true\r\n                };\r\n                //console.warn(\"url\",url,props);\r\n                var lyr = new VectorTileLayer(url, props);\r\n                //console.warn(\"lyr\",lyr);\r\n                self._waitForLayer(lyr).then(\r\n                  function(layer) {\r\n                    dfd.resolve(layer);\r\n                  },\r\n                  function(error2) {\r\n                    dfd.reject(error2);\r\n                  }\r\n                );\r\n              } else {\r\n                dfd.resolve(null);\r\n              }\r\n            },\r\n            function(error) {\r\n              dfd.reject(error);\r\n            }\r\n          );\r\n        } else {\r\n          dfd.resolve(null);\r\n        }\r\n        return dfd;\r\n      },\r\n\r\n      _newWFSLayer: function(itemData) {\r\n        var dfd = new Deferred();\r\n        try {\r\n          var wfsJSON;\r\n          var id = this._generateLayerId();\r\n          if (itemData && itemData.wfsInfo && itemData.layerDefinition) {\r\n            wfsJSON = {\r\n              id: id,\r\n              mode: itemData.mode,\r\n              showLabels: true,\r\n              title: itemData.title,\r\n              url: this._checkMixedContent(itemData.url),\r\n              // visible: itemData.visibility,\r\n              customParameters: itemData.wfsInfo.customParameters,\r\n              maxFeatures: itemData.wfsInfo.maxFeatures,\r\n              name: itemData.wfsInfo.name,\r\n              swapXY: itemData.wfsInfo.swapXY,\r\n              version: itemData.wfsInfo.version,\r\n              geometryType: itemData.layerDefinition.geometryType,\r\n              labelingInfo: itemData.layerDefinition.drawingInfo.labelingInfo,\r\n              //wkid: itemData.layerDefinition.spatialReference.wkid\r\n            };\r\n          } else {\r\n            var serviceUrl = this.serviceUrl;\r\n            if (serviceUrl) {\r\n              util.loadWFSByUrl(dfd,map,this,serviceUrl,id,false);\r\n            } else {\r\n              dfd.reject(new Error(\"Error adding WFS, no URL\"));\r\n            }\r\n            return dfd;\r\n          }\r\n\r\n          var layer = new WFSLayer();\r\n          var h1 = layer.on(\"error\", function(layerError) {\r\n            if (h1) h1.remove();\r\n            var error = layerError.error;\r\n            dfd.reject(error);\r\n          });\r\n          layer.fromJson(wfsJSON, function() {\r\n            try {\r\n              if (h1) h1.remove();\r\n              if (itemData && itemData.wfsInfo && itemData.layerDefinition) {\r\n                if (esriLang.isDefined(itemData.opacity)) {\r\n                  layer.setOpacity(itemData.opacity);\r\n                }\r\n                if (esriLang.isDefined(itemData.visibility)) {\r\n                  layer.setVisibility(itemData.visibility);\r\n                }\r\n                if (itemData.minScale || itemData.maxScale) {\r\n                  layer.setScaleRange(itemData.minScale, itemData.maxScale);\r\n                }\r\n                var drawingInfo = itemData.layerDefinition.drawingInfo;\r\n                if (drawingInfo && drawingInfo.renderer) {\r\n                  layer.renderer = jsonRendererUtils.fromJson(\r\n                    drawingInfo.renderer,\r\n                    {geometryType: wfsJSON.geometryType}\r\n                  );\r\n                }\r\n                var ignorePopups = false;\r\n                if (!ignorePopups && itemData.popupInfo) {\r\n                  layer.setInfoTemplate(new PopupTemplate(itemData.popupInfo));\r\n                }\r\n              }\r\n              dfd.resolve(layer);\r\n            } catch(ex2) {\r\n              console.error(\"Error adding WFS\",ex2);\r\n              dfd.reject(ex);\r\n            }\r\n          });\r\n        } catch(ex) {\r\n          console.error(\"Error adding WFS\",ex);\r\n          dfd.reject(ex);\r\n        }\r\n        return dfd;\r\n      },\r\n\r\n      _newWMSLayer: function(itemData) {\r\n        var self = this;\r\n        var item = this.item;\r\n        var itemHasLayers = false;\r\n        var wkid = null;\r\n        var options = {\r\n          id: this._generateLayerId()\r\n        };\r\n        if (itemData) {\r\n          var visibleLayers = [];\r\n          var layerInfos = [];\r\n          array.forEach(itemData.layers, function(layer){\r\n            itemHasLayers = true;\r\n            layerInfos.push(new WMSLayerInfo({\r\n              name: layer.name,\r\n              title: layer.title,\r\n              legendURL: layer.legendURL,\r\n              queryable: layer.queryable,\r\n              showPopup: layer.showPopup\r\n            }));\r\n            visibleLayers.push(layer.name);\r\n          }, this);\r\n          if (itemData.visibleLayers) {\r\n            visibleLayers = itemData.visibleLayers;\r\n          }\r\n\r\n          var resourceInfo = {\r\n            customLayerParameters: itemData.customLayerParameters,\r\n            customParameters: itemData.customParameters,\r\n            layerInfos: layerInfos,\r\n            version: itemData.version,\r\n            maxWidth: itemData.maxWidth,\r\n            maxHeight: itemData.maxHeight,\r\n            featureInfoFormat: itemData.featureInfoFormat,\r\n            getFeatureInfoURL: itemData.featureInfoUrl,\r\n            getMapURL: itemData.mapUrl,\r\n            spatialReferences: itemData.spatialReferences,\r\n            title: itemData.title,\r\n            copyright: itemData.copyright,\r\n            minScale: itemData.minScale || 0,\r\n            maxScale: itemData.maxScale || 0,\r\n            format: itemData.format\r\n          };\r\n          // TODO item vs itemData? title copyright\r\n          if (item && item.extent) {\r\n            var gcsExtent = new Extent(\r\n              item.extent[0][0],item.extent[0][1],item.extent[1][0],item.extent[1][1],\r\n              new SpatialReference({wkid:4326})\r\n            );\r\n            resourceInfo.extent = gcsExtent;\r\n          }\r\n          if (itemData.spatialReferences && itemData.spatialReferences.length > 0) {\r\n            wkid = itemData.spatialReferences[0];\r\n          }\r\n          options = {\r\n            id: this._generateLayerId(),\r\n            visibleLayers: visibleLayers,\r\n            format: \"png\",\r\n            transparent: itemData.firstLayer ? false : true,\r\n            opacity: itemData.opacity,\r\n            visible: (itemData.visibility !== null) ? itemData.visibility : true,\r\n            resourceInfo: resourceInfo,\r\n            refreshInterval: itemData.refreshInterval\r\n          };\r\n        }\r\n\r\n        var lyr = new WMSLayer(this.serviceUrl, options);\r\n        var dfd = this._waitForLayer(lyr);\r\n        dfd.then(function(layer) {\r\n          if (!itemHasLayers) {\r\n            self._setWMSVisibleLayers(layer);\r\n          }\r\n          if (wkid && layer.spatialReference) {\r\n            layer.spatialReference.wkid = wkid;\r\n          }\r\n        });\r\n        return dfd;\r\n      },\r\n\r\n      _newWMTSLayer: function(itemData) {\r\n        //console.log(\"_newWMTSLayer.itemData\",itemData)\r\n        if (itemData) {\r\n\r\n          var layer = new WebTiledLayer(itemData.templateUrl, {\r\n            id: this._generateLayerId(),\r\n            visible: (itemData.visibility !== null) ? itemData.visibility : true,\r\n            opacity: itemData.opacity,\r\n            copyright: itemData.copyright,\r\n            fullExtent: itemData.fullExtent && new Extent(itemData.fullExtent),\r\n            initialExtent: itemData.fullExtent && new Extent(itemData.fullExtent),\r\n            subDomains: itemData.subDomains,\r\n            tileInfo: itemData.tileInfo ? new TileInfo(itemData.tileInfo) : null,\r\n            refreshInterval: itemData.refreshInterval,\r\n            wmtsInfo: itemData.wmtsInfo\r\n          });\r\n\r\n          if (esriLang.isDefined(itemData.minScale) || esriLang.isDefined(itemData.maxScale)) {\r\n            if (layer.loaded) {\r\n              layer.setScaleRange(itemData.minScale, itemData.maxScale);\r\n            } else {\r\n              connection.connect(layer, \"onLoad\", function () {\r\n                layer.setScaleRange(itemData.minScale, itemData.maxScale);\r\n              });\r\n            }\r\n          }\r\n\r\n          return this._waitForLayer(layer);\r\n        } else {\r\n          var dfd = new Deferred();\r\n          dfd.resolve();\r\n          return dfd;\r\n        }\r\n      },\r\n\r\n      _processFeatureLayer: function(featureLayer, item, itemData) {\r\n        var self = this,\r\n          dlPattern = i18n.search.featureLayerTitlePattern;\r\n        var opLayer = null;\r\n        if (itemData && itemData.layers && (itemData.layers.length > 0)) {\r\n          array.some(itemData.layers, function(info) {\r\n            var layerDefinition, jsonRenderer, renderer, isCustomTemplate = false;\r\n            var popInfo, jsonPopInfo, infoTemplate;\r\n            if (info.id === featureLayer.layerId) {\r\n              //console.warn(\"layerInfo\",info);\r\n              if (info.popupInfo) {\r\n                popInfo = info.popupInfo;\r\n                jsonPopInfo = djJson.parse(djJson.stringify(popInfo));\r\n                infoTemplate = new PopupTemplate(jsonPopInfo);\r\n                featureLayer.setInfoTemplate(infoTemplate);\r\n                isCustomTemplate = true;\r\n              }\r\n              if (esriLang.isDefined(info.showLabels)) {\r\n                featureLayer.setShowLabels(info.showLabels);\r\n              }\r\n              if (esriLang.isDefined(info.refreshInterval)) {\r\n                featureLayer.setRefreshInterval(info.refreshInterval);\r\n              }\r\n              if (esriLang.isDefined(info.showLegend)) {\r\n                // TODO?\r\n                console.log('');\r\n              }\r\n              if (esriLang.isDefined(info.timeAnimation)) {\r\n                if (info.timeAnimation === false) {\r\n                  // TODO?\r\n                  console.log(\"\");\r\n                }\r\n              }\r\n              layerDefinition = info.layerDefinition;\r\n              if (layerDefinition) {\r\n                if (layerDefinition.definitionExpression) {\r\n                  featureLayer.setDefinitionExpression(layerDefinition.definitionExpression);\r\n                }\r\n                if (layerDefinition.displayField) {\r\n                  featureLayer.displayField(layerDefinition.displayField);\r\n                }\r\n                if (layerDefinition.drawingInfo) {\r\n                  if (layerDefinition.drawingInfo.renderer) {\r\n                    jsonRenderer = djJson.parse(\r\n                      djJson.stringify(layerDefinition.drawingInfo.renderer)\r\n                    );\r\n                    renderer = jsonRendererUtils.fromJson(jsonRenderer);\r\n                    if (jsonRenderer.type && (jsonRenderer.type === \"classBreaks\")) {\r\n                      renderer.isMaxInclusive = true;\r\n                    }\r\n                    featureLayer.setRenderer(renderer);\r\n                  }\r\n                  if (esriLang.isDefined(layerDefinition.drawingInfo.transparency)) {\r\n                    // TODO validate before setting?\r\n                    featureLayer.setOpacity(1 - (layerDefinition.drawingInfo.transparency / 100));\r\n                  }\r\n                }\r\n                if (esriLang.isDefined(layerDefinition.minScale)) {\r\n                  featureLayer.setMinScale(layerDefinition.minScale);\r\n                }\r\n                if (esriLang.isDefined(layerDefinition.maxScale)) {\r\n                  featureLayer.setMaxScale(layerDefinition.maxScale);\r\n                }\r\n                if (esriLang.isDefined(layerDefinition.defaultVisibility)) {\r\n                  if (layerDefinition.defaultVisibility === false) {\r\n                    featureLayer.setVisibility(false); // TODO?\r\n                  }\r\n                }\r\n              }\r\n              if (!isCustomTemplate) {\r\n                self._setFeatureLayerInfoTemplate(featureLayer, info.popupInfo);\r\n              }\r\n              opLayer = {\r\n                url: featureLayer.url,\r\n                id: featureLayer.id,\r\n                itemId: item.id,\r\n                title: self._makeFeatureLayerTitle(dlPattern, item.title, featureLayer.name)\r\n              };\r\n              return true;\r\n            }\r\n          });\r\n          return opLayer;\r\n\r\n        } else {\r\n          opLayer = {\r\n            url: featureLayer.url,\r\n            id: featureLayer.id,\r\n            itemId: item.id,\r\n            title: self._makeFeatureLayerTitle(dlPattern, item.title, featureLayer.name)\r\n          };\r\n          self._setFeatureLayerInfoTemplate(featureLayer, null, opLayer.title);\r\n          return opLayer;\r\n        }\r\n      },\r\n\r\n      _readItemJsonData: function() {\r\n        var u = this.itemUrl + \"/data\";\r\n        var content = {\r\n            f: \"json\"\r\n          },\r\n          options = {};\r\n        return esriRequest({\r\n          url: u,\r\n          content: content,\r\n          handleAs: \"json\"\r\n        }, options);\r\n      },\r\n\r\n      _readRestInfo: function(url) {\r\n        return esriRequest({\r\n          url: url,\r\n          content: {\r\n            f: \"json\"\r\n          },\r\n          handleAs: \"json\",\r\n          callbackParamName: \"callback\"\r\n        }, {});\r\n      },\r\n\r\n      _setDynamicLayerInfoTemplates: function(layer) {\r\n        var self = this, templates = null, dfds = [];\r\n\r\n        var readLayer = function(lInfo) {\r\n          var dfd = self._readRestInfo(layer.url + \"/\" + lInfo.id);\r\n          dfd.then(function(result){\r\n            try {\r\n              var popupInfo = self._newPopupInfo(result);\r\n              if (popupInfo) {\r\n                templates[lInfo.id] = {\r\n                  infoTemplate: self._newInfoTemplate(popupInfo)\r\n                };\r\n              }\r\n            } catch(exp) {\r\n              console.warn(\"Error setting popup.\");\r\n              console.error(exp);\r\n            }\r\n          });\r\n          return dfd;\r\n        };\r\n\r\n        if (layer.infoTemplates === null) {\r\n          array.forEach(layer.layerInfos, function(lInfo) {\r\n            if (templates === null) {\r\n              templates = {};\r\n            }\r\n            if (!lInfo.subLayerIds) {\r\n              dfds.push(readLayer(lInfo));\r\n            }\r\n          });\r\n        }\r\n        if (dfds.length > 0) {\r\n          all(dfds).then(function(){\r\n            if (templates) {\r\n              layer.infoTemplates = templates;\r\n            }\r\n          }).otherwise(function(ex){\r\n            console.warn(\"Error reading sublayers.\");\r\n            console.error(ex);\r\n          });\r\n        }\r\n      },\r\n\r\n      _setFeatureLayerInfoTemplate: function(featureLayer, popupInfo, title) {\r\n        if (!popupInfo) {\r\n          popupInfo = this._newPopupInfo(featureLayer,title);\r\n        }\r\n        var template = this._newInfoTemplate(popupInfo, title);\r\n        featureLayer.setInfoTemplate(template);\r\n      },\r\n\r\n      _setWMSVisibleLayers: function(layer) {\r\n        var maxLayers = 10,\r\n          lyrNames = [];\r\n        if (layer) {\r\n          array.some(layer.layerInfos, function(lyrInfo) {\r\n            //console.warn(\"lyrInfo\",lyrInfo);\r\n            if (typeof lyrInfo.name === \"string\" && lyrInfo.name.length > 0) {\r\n              if (lyrNames.length < maxLayers) {\r\n                lyrNames.push(lyrInfo.name);\r\n              } else {\r\n                return true;\r\n              }\r\n            }\r\n          });\r\n          //console.warn(\"lyrNames\",lyrNames);\r\n          if (lyrNames.length <= maxLayers) {\r\n            layer.setVisibleLayers(lyrNames);\r\n          }\r\n        }\r\n      },\r\n\r\n      _waitForLayer: function(layer) {\r\n        var dfd = new Deferred(),\r\n          handles = [];\r\n        if (layer.loaded) {\r\n          dfd.resolve(layer);\r\n          return dfd;\r\n        }\r\n        if (layer.loadError) {\r\n          dfd.reject(layer.loadError);\r\n          return dfd;\r\n        }\r\n        var clearHandles = function() {\r\n          array.forEach(handles, function(h) {\r\n            h.remove();\r\n          });\r\n        };\r\n        //console.warn(\"_waitForLayer\");\r\n        handles.push(layer.on(\"load\", function(layerLoaded) {\r\n          //console.warn(\"_waitForLayer.load\",layerLoaded);\r\n          clearHandles();\r\n          dfd.resolve(layerLoaded.layer);\r\n        }));\r\n        handles.push(layer.on(\"error\", function(layerError) {\r\n          //console.warn(\"_waitForLayer.error\",layerError);\r\n          clearHandles();\r\n          var error = layerError.error;\r\n          try {\r\n            if (error.message && (error.message.indexOf(\"Unable to complete\") !== -1)) {\r\n              console.warn(\"layerAccessError\", error);\r\n              dfd.reject(new Error(i18n.search.layerInaccessible));\r\n            } else {\r\n              dfd.reject(error);\r\n            }\r\n          } catch (ex) {\r\n            //console.warn(\"layerAccessError\",ex);\r\n            dfd.reject(error);\r\n          }\r\n        }));\r\n        return dfd;\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n"]}