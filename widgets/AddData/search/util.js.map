{"version":3,"sources":["../../../../widgets/AddData/search/util.js"],"names":["define","array","aspect","ioQuery","InfoTemplate","WFSLayer","checkMixedContent","uri","window","location","href","indexOf","substring","endsWith","sv","sfx","length","escapeForLucene","value","a","r","RegExp","join","replace","findLayersAdded","map","itemId","ids","itemIds","layers","response","checkId","forEach","layerIds","id","push","graphicsLayerIds","lyr","getLayer","xtnItemId","loadWFSByUrl","dfd","loader","url","addToMap","h1","h2","h3","title","reqInfo","makeOGCRequestInfo","layer","on","layerError","remove","error","reject","fromJson","layerList","wfsOptions","version","_version","name","wfsLayer","infoTemplate","after","fields","_setFeatureLayerInfoTemplate","xtnAddData","addLayer","resolve","Error","ex","console","warn","idx","k","v","lc","q","qObj","queryToObject","qObj2","hasOwnProperty","toLowerCase","objectToQuery","setNodeText","nd","text","innerHTML","appendChild","document","createTextNode","setNodeTitle","setAttribute","setNodeHTML","html"],"mappings":"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","file":"util.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\ndefine([\"dojo/_base/array\",\r\n    \"dojo/aspect\",\r\n    \"dojo/io-query\",\r\n    \"esri/InfoTemplate\",\r\n    \"esri/layers/WFSLayer\"],\r\n  function(array, aspect, ioQuery, InfoTemplate, WFSLayer) {\r\n\r\n    return {\r\n\r\n      checkMixedContent: function(uri) {\r\n        if ((typeof window.location.href === \"string\") &&\r\n          (window.location.href.indexOf(\"https://\") === 0)) {\r\n          if ((typeof uri === \"string\") && (uri.indexOf(\"http://\") === 0)) {\r\n            uri = \"https:\" + uri.substring(\"5\");\r\n          }\r\n        }\r\n        return uri;\r\n      },\r\n\r\n      endsWith: function(sv, sfx) {\r\n        return (sv.indexOf(sfx, (sv.length - sfx.length)) !== -1);\r\n      },\r\n\r\n      escapeForLucene: function(value) {\r\n        var a = ['+', '-', '&', '!', '(', ')', '{', '}', '[', ']',\r\n        '^', '\"', '~', '*', '?', ':', '\\\\'];\r\n        var r = new RegExp(\"(\\\\\" + a.join(\"|\\\\\") + \")\", \"g\");\r\n        return value.replace(r, \"\\\\$1\");\r\n      },\r\n\r\n      findLayersAdded: function(map, itemId) {\r\n        var ids = [],\r\n          itemIds = [],\r\n          layers = [];\r\n        var response = {\r\n          itemIds: itemIds,\r\n          layers: layers\r\n        };\r\n        if (!map) {\r\n          return response;\r\n        }\r\n        var checkId = (typeof itemId === \"string\" && itemId.length > 0);\r\n        array.forEach(map.layerIds, function(id) {\r\n          ids.push(id);\r\n        });\r\n        array.forEach(map.graphicsLayerIds, function(id) {\r\n          ids.push(id);\r\n        });\r\n        array.forEach(ids, function(id) {\r\n          var lyr = map.getLayer(id);\r\n          if (lyr && typeof lyr.xtnItemId === \"string\" && lyr.xtnItemId.length > 0) {\r\n            //console.warn(\"found added layer\",lyr);\r\n            if (!checkId || lyr.xtnItemId === itemId) {\r\n              layers.push(lyr);\r\n              if (itemIds.indexOf(lyr.xtnItemId) === -1) {\r\n                itemIds.push(lyr.xtnItemId);\r\n              }\r\n            }\r\n          }\r\n        });\r\n        return response;\r\n      },\r\n\r\n      loadWFSByUrl: function(dfd, map, loader, url, id, addToMap) {\r\n        var h1, h2, h3, title;\r\n        var reqInfo = this.makeOGCRequestInfo(url);\r\n        url = reqInfo.url;\r\n        var layer = new WFSLayer();\r\n        h1 = layer.on(\"error\", function(layerError) {\r\n          if (h1) h1.remove();\r\n          var error = layerError.error;\r\n          dfd.reject(error);\r\n        });\r\n        layer.fromJson(reqInfo,function(layerList){\r\n          try {\r\n            if (h1) h1.remove();\r\n            if (layerList && layerList.push && layerList.length > 0) {\r\n              var lyr = layerList[0];\r\n              var wfsOptions = {\r\n                url: url,\r\n                version: layer._version,\r\n                name: lyr.name\r\n              };\r\n              title = lyr.name || lyr.title;\r\n              if (typeof wfsOptions.version === \"string\" &&\r\n                  wfsOptions.version.length > 0 &&\r\n                  typeof wfsOptions.name === \"string\" &&\r\n                  wfsOptions.name.length > 0) {\r\n                var wfsLayer = new WFSLayer({\r\n                  id: id,\r\n                  infoTemplate: new InfoTemplate()\r\n                });\r\n                if (typeof title === \"string\" && title.length > 0) {\r\n                  wfsLayer.name = title;\r\n                }\r\n                h2 = wfsLayer.on(\"error\", function(layerError) {\r\n                  if (h2) h2.remove();\r\n                  var error = layerError.error;\r\n                  dfd.reject(error);\r\n                });\r\n                h3 = aspect.after(wfsLayer,\"_describeFeatureTypeResponse\",function() {\r\n                  if (h3) h3.remove();\r\n                  if (wfsLayer.fields && wfsLayer.fields.length > 0) {\r\n                    loader._setFeatureLayerInfoTemplate(wfsLayer);\r\n                  }\r\n                });\r\n                wfsLayer.fromJson(wfsOptions,function(){\r\n                  if (h2) h2.remove();\r\n                  wfsLayer.xtnAddData = true;\r\n                  if (map && addToMap) {\r\n                    map.addLayer(wfsLayer);\r\n                  }\r\n                  dfd.resolve(wfsLayer)\r\n                });\r\n              } else {\r\n                dfd.reject(new Error(\"Error loading WFSLayer, missing version and/or layer\"));\r\n              }\r\n            } else {\r\n              dfd.reject(new Error(\"Error loading WFSLayer, no layers\"));\r\n            }\r\n          } catch(ex) {\r\n            console.warn(\"Error loading WFSLayer\",url);\r\n            console.error(ex);\r\n            dfd.reject(ex);\r\n          }\r\n        });\r\n      },\r\n\r\n      makeOGCRequestInfo: function(url) {\r\n        var reqInfo = {url: url};\r\n        var idx = url.indexOf(\"?\");\r\n        if (idx !== -1) {\r\n          reqInfo.url = url.substring(0,idx);\r\n          var k, v, lc, q = url.substring(idx + 1,url.length);\r\n          if (typeof q === \"string\" && q.length > 0) {\r\n            var qObj = ioQuery.queryToObject(q);\r\n            var qObj2 = {};\r\n            if (qObj) {\r\n              for (k in qObj) {\r\n                if (qObj.hasOwnProperty(k)) {\r\n                  v = qObj[k];\r\n                  lc = k.toLowerCase();\r\n                  if (lc ===\"request\") {\r\n                  } else if (lc ===\"service\") {\r\n                  } else if (lc ===\"version\") {\r\n                    if (typeof v === \"string\" && v.length > 0) {\r\n                      reqInfo.version = v;\r\n                    }\r\n                  } else if (lc ===\"name\") {\r\n                    // non-standard parameter\r\n                    if (typeof v === \"string\" && v.length > 0) {\r\n                      reqInfo.name = v;\r\n                    }\r\n                  } else {\r\n                    qObj2[k] = v;\r\n                  }\r\n                }\r\n              }\r\n              v = ioQuery.objectToQuery(qObj2);\r\n              if (typeof v === \"string\" && v.length > 0) {\r\n                reqInfo.url = reqInfo.url + \"?\" + v;\r\n              }\r\n            }\r\n          }\r\n        }\r\n        return reqInfo;\r\n      },\r\n\r\n      setNodeText: function(nd, text) {\r\n        nd.innerHTML = \"\";\r\n        if (text) {\r\n          nd.appendChild(document.createTextNode(text));\r\n        }\r\n      },\r\n\r\n      setNodeTitle: function(nd, text) {\r\n        nd.title = \"\";\r\n        if (text) {\r\n          nd.setAttribute(\"title\", text);\r\n        }\r\n      },\r\n\r\n      setNodeHTML: function(nd, html) {\r\n        nd.innerHTML = \"\";\r\n        if (html) {\r\n          nd.innerHTML = html;\r\n        }\r\n      }\r\n\r\n    };\r\n\r\n  });\r\n"]}