{"version":3,"sources":["../../../../widgets/AddData/search/AddFromFilePane.js"],"names":["define","declare","lang","array","dojoJson","on","Deferred","domClass","Viewport","sniff","_WidgetBase","_TemplatedMixin","_WidgetsInTemplateMixin","template","i18n","LayerLoader","util","kernel","esriRequest","FeatureLayer","KMLLayer","scaleUtils","Message","templateString","wabWidget","maxRecordCount","maxRecordThreshold","SHAPETYPE_ICONS","postCreate","inherited","arguments","generalizeCheckBox","setLabel","addFromFile","generalizeOn","own","resize","destroy","startup","_started","isPortal","self","dropNode","dropArea","v","config","Number","isNaN","Math","floor","ex","console","warn","types","fileTypeName","_createFileTypeImage","fileNode","_getBusy","_setBusy","fileInfo","_getFileInfo","ok","_execute","value","uploadLabel","event","preventDefault","stopPropagation","add","_setStatus","remove","nd","domNode","hintButton","hitch","test","intro","Shapefile","CSV","KML","GPX","GeoJSON","maxFeaturesAllowedPattern","replace","message","_addFeatures","job","featureCollection","fullExtent","layers","map","nLayers","loader","length","forEach","layer","featureLayer","id","_generateLayerId","outFields","xtnAddData","graphics","numFeatures","name","baseFileName","indexOf","layerNamePattern","_setFeatureLayerInfoTemplate","extentCenter","getCenter","x","y","union","push","addLayers","setExtent","expand","_analyze","formData","fileType","toLowerCase","dfd","resolve","geocoder","batchGeocoderServers","analyzeParams","locale","geocodeServiceUrl","url","isWorldGeocodeServer","sourceCountry","sourceCountryHint","sharingUrl","content","f","filetype","analyzeParameters","window","JSON","stringify","req","form","handleAs","then","response","publishParameters","isRTL","some","filetypeIcon","index","type","iconImg","document","createElement","src","folderUrl","alt","className","supportedFileTypes","appendChild","getSharingUrl","fileName","generalize","getValue","addingPattern","_executeKml","FormData","append","file","locationType","titleLabel","_widgetLabel","featureLocationsCouldNotBeFound","_generateFeatures","featureCountPattern","otherwise","error","addFailedPattern","generalIssue","_self","reader","FileReader","handleError","pfx","onerror","err","onload","target","result","linkInfo","visibility","visible","_parseKml","_fireUpdateStart","_io","serviceUrl","kmlString","encodeURIComponent","model","folders","refresh","loaded","undefined","outSR","toJson","_outSR","callbackParamName","load","_initLayer","_waitForLayer","lyr","num","getLayers","l","mapSR","spatialReference","projOk","equals","isWebMercator","wkid","addLayer","kmlProjectionMismatch","mixin","Error","_fireUpdateEnd","_errorHandler","usePost","readAsText","params","targetSR","enforceInputFileSizeLimit","enforceOutputJsonSizeLimit","extent","getExtentForScale","resolution","getWidth","width","maxAllowableOffset","numDecimals","reducePrecision","numberOfDigitsAfterDecimal","_getBaseFileName","a","split","contains","dropEvent","files","info","dataTransfer","endsWith","msg","invalidType","usePopup","invalidTypePattern","createTextNode","isBusy"],"mappings":"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","file":"AddFromFilePane.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright © Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\ndefine([\"dojo/_base/declare\",\r\n    \"dojo/_base/lang\",\r\n    \"dojo/_base/array\",\r\n    \"dojo/_base/json\",\r\n    \"dojo/on\",\r\n    \"dojo/Deferred\",\r\n    \"dojo/dom-class\",\r\n    \"dijit/Viewport\",\r\n    \"dojo/sniff\",\r\n    \"dijit/_WidgetBase\",\r\n    \"dijit/_TemplatedMixin\",\r\n    \"dijit/_WidgetsInTemplateMixin\",\r\n    \"dojo/text!./templates/AddFromFilePane.html\",\r\n    \"dojo/i18n!../nls/strings\",\r\n    \"./LayerLoader\",\r\n    \"./util\",\r\n    \"dojo/_base/kernel\",\r\n    \"esri/request\",\r\n    \"esri/layers/FeatureLayer\",\r\n    \"esri/layers/KMLLayer\",\r\n    \"esri/geometry/scaleUtils\",\r\n    \"jimu/dijit/Message\",\r\n    \"jimu/dijit/CheckBox\"\r\n  ],\r\n  function(declare, lang, array, dojoJson, on, Deferred, domClass, Viewport, sniff,\r\n    _WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin,template, i18n,\r\n     LayerLoader, util, kernel, esriRequest, FeatureLayer, KMLLayer, scaleUtils,\r\n     Message) {\r\n\r\n    return declare([_WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin], {\r\n\r\n      i18n: i18n,\r\n      templateString: template,\r\n      wabWidget: null,\r\n      maxRecordCount: 1000,\r\n      maxRecordThreshold: 100000,\r\n      SHAPETYPE_ICONS: [{\r\n        \"type\": \"shapefile\",\r\n        \"url\": \"images/filetypes/zip.svg\"\r\n      },{\r\n        \"type\": \"csv\",\r\n        \"url\": \"images/filetypes/csv.svg\"\r\n      },{\r\n        \"type\": \"kml\",\r\n        \"url\": \"images/filetypes/kml.svg\"\r\n      },{\r\n        \"type\": \"gpx\",\r\n        \"url\": \"images/filetypes/gpx.svg\"\r\n      },{\r\n        \"type\": \"geojson\",\r\n        \"url\": \"images/filetypes/geojson.svg\"\r\n      }],\r\n\r\n      postCreate: function() {\r\n        this.inherited(arguments);\r\n        this.generalizeCheckBox.setLabel(i18n.addFromFile.generalizeOn);\r\n        this.own(Viewport.on(\"resize\",this.resize()));\r\n      },\r\n\r\n      destroy: function() {\r\n        this.inherited(arguments);\r\n        //console.warn(\"AddFromFilePane::destroy\");\r\n      },\r\n\r\n      startup: function() {\r\n        if (this._started) {\r\n          return;\r\n        }\r\n        if (this.wabWidget.isPortal) {\r\n          this.SHAPETYPE_ICONS = [{\r\n            \"type\": \"shapefile\",\r\n            \"url\": \"images/filetypes/zip.svg\"\r\n          },{\r\n            \"type\": \"csv\",\r\n            \"url\": \"images/filetypes/csv.svg\"\r\n          },{\r\n            \"type\": \"kml\",\r\n            \"url\": \"images/filetypes/kml.svg\",\r\n          },{\r\n            \"type\": \"geojson\",\r\n            \"url\": \"images/filetypes/geojson.svg\"\r\n          }];\r\n        }\r\n        this.inherited(arguments);\r\n        //console.warn(\"AddFromFilePane.startup .......................\");\r\n\r\n        var self = this, dropNode = this.dropArea;\r\n\r\n        var v, config = this.wabWidget.config;\r\n        if (config.addFromFile) {\r\n          try {\r\n            v = Number(config.addFromFile.maxRecordCount);\r\n            if (typeof v === \"number\" && !isNaN(v)) {\r\n              v = Math.floor(v);\r\n              if (v >= 1 && v <= this.maxRecordThreshold) {\r\n                this.maxRecordCount = v;\r\n              }\r\n            }\r\n          } catch (ex) {\r\n            console.warn(\"Error setting AddFromFile.maxRecordCount:\");\r\n            console.warn(ex);\r\n          }\r\n        }\r\n\r\n        if(i18n.addFromFile.types) {\r\n          try {\r\n            for (var fileTypeName in i18n.addFromFile.types) {\r\n              this._createFileTypeImage(fileTypeName);\r\n            }\r\n          } catch (ex) {\r\n            console.warn(\"Error reading support file types:\");\r\n            console.warn(ex);\r\n          }\r\n        }\r\n\r\n        this.own(on(this.fileNode,\"change\",function(){\r\n          if (!self._getBusy()) {\r\n            self._setBusy(true);\r\n            var fileInfo = self._getFileInfo();\r\n            if (fileInfo.ok) {\r\n              self._execute(fileInfo);\r\n            }\r\n            /*\r\n            [Web AppBuilder for ArcGIS] [Widget][REG]ENU[Safari/Edge/Chrome]:\r\n            Supported file cannot be added again after it has been removed on\r\n            Add Data widget. #18517\r\n            */\r\n            self.fileNode.value = null;\r\n          }\r\n        }));\r\n\r\n        this.own(on(this.uploadLabel,\"click\",function(event){\r\n          if (self._getBusy()) {\r\n            event.preventDefault();\r\n            event.stopPropagation();\r\n          }\r\n        }));\r\n\r\n        this.own(on(dropNode,\"dragenter\",function(event) {\r\n          event.preventDefault();\r\n          if (!self._getBusy()) {\r\n            domClass.add(dropNode,\"hit\");\r\n            self._setStatus(\"\");\r\n          }\r\n        }));\r\n        this.own(on(dropNode,\"dragleave\",function(event) {\r\n          event.preventDefault();\r\n          domClass.remove(dropNode,\"hit\");\r\n        }));\r\n        this.own(on(dropNode,\"dragover\",function(event) {\r\n          event.preventDefault();\r\n        }));\r\n        this.own(on(dropNode,\"drop\",function(event) {\r\n          event.preventDefault();\r\n          event.stopPropagation();\r\n          //console.warn(\"drop\");\r\n          if (!self._getBusy()) {\r\n            self._setBusy(true);\r\n            var fileInfo = self._getFileInfo(event);\r\n            if (fileInfo.ok) {\r\n              self._execute(fileInfo);\r\n            }\r\n          }\r\n        }));\r\n\r\n        // by default, dropping a file on a page will cause\r\n        // the browser to navigate to the file\r\n        var nd = this.wabWidget.domNode;\r\n        this.own(on(nd,\"dragenter\",function(event) {\r\n          event.preventDefault();\r\n        }));\r\n        this.own(on(nd,\"dragleave\",function(event) {\r\n          event.preventDefault();\r\n        }));\r\n        this.own(on(nd,\"dragover\",function(event) {\r\n          event.preventDefault();\r\n        }));\r\n        this.own(on(nd,\"drop\",function(event) {\r\n          event.preventDefault();\r\n        }));\r\n\r\n        this.own(on(this.hintButton,\"click\", lang.hitch(this, function(event) {\r\n          event.preventDefault();\r\n\r\n          var test = '<div class=\"intro\">' +\r\n            '<label>' + i18n.addFromFile.intro + \"</label>\" +\r\n            '<ul>' +\r\n              '<li>' + i18n.addFromFile.types.Shapefile + '</li>' +\r\n              '<li>' + i18n.addFromFile.types.CSV + '</li>' +\r\n              '<li>' + i18n.addFromFile.types.KML + '</li>' +\r\n              '<li>' + i18n.addFromFile.types.GPX + '</li>' +\r\n              '<li>' + i18n.addFromFile.types.GeoJSON + '</li>' +\r\n              '<li><span class=\"note\">' + i18n.addFromFile.maxFeaturesAllowedPattern\r\n                        .replace(\"{count}\", this.maxRecordCount) + '</span></li>' +\r\n            '</ul>' +\r\n          '</div>';\r\n\r\n          if (this.wabWidget.isPortal) {\r\n            test = '<div class=\"intro\">' +\r\n              '<label>' + i18n.addFromFile.intro + \"</label>\" +\r\n              '<ul>' +\r\n                '<li>' + i18n.addFromFile.types.Shapefile + '</li>' +\r\n                '<li>' + i18n.addFromFile.types.CSV + '</li>' +\r\n                '<li>' + i18n.addFromFile.types.KML + '</li>' +\r\n                '<li>' + i18n.addFromFile.types.GeoJSON + '</li>' +\r\n                '<li><span class=\"note\">' + i18n.addFromFile.maxFeaturesAllowedPattern\r\n                          .replace(\"{count}\", this.maxRecordCount) + '</span></li>' +\r\n              '</ul>' +\r\n            '</div>';\r\n          }\r\n\r\n          new Message({message: test});\r\n        })));\r\n      },\r\n\r\n      _addFeatures: function(job,featureCollection) {\r\n        //var triggerError = null; triggerError.length;\r\n        var fullExtent, layers = [], map = job.map, nLayers = 0;\r\n        var loader = new LayerLoader();\r\n        if (featureCollection.layers) {\r\n          nLayers = featureCollection.layers.length;\r\n        }\r\n        array.forEach(featureCollection.layers,function(layer) {\r\n          var featureLayer = new FeatureLayer(layer, {\r\n            id: loader._generateLayerId(),\r\n            outFields: [\"*\"]\r\n          });\r\n          featureLayer.xtnAddData = true;\r\n          if (featureLayer.graphics) {\r\n            job.numFeatures += featureLayer.graphics.length;\r\n          }\r\n          if (nLayers === 0) {\r\n            featureLayer.name = job.baseFileName;\r\n          } else if (typeof featureLayer.name !== \"string\" ||\r\n            featureLayer.name.length === 0) {\r\n            featureLayer.name = job.baseFileName;\r\n          } else if (featureLayer.name.indexOf(job.baseFileName) !== 0) {\r\n            featureLayer.name = i18n.addFromFile.layerNamePattern\r\n              .replace(\"{filename}\",job.baseFileName)\r\n              .replace(\"{name}\",featureLayer.name);\r\n          }\r\n          loader._setFeatureLayerInfoTemplate(featureLayer,null,null);\r\n          if (featureLayer.fullExtent) {\r\n            var extentCenter = featureLayer.fullExtent.getCenter();\r\n            if(extentCenter.x && extentCenter.y) {\r\n              if (!fullExtent) {\r\n                fullExtent = featureLayer.fullExtent;\r\n              } else {\r\n                fullExtent = fullExtent.union(featureLayer.fullExtent);\r\n              }\r\n            }\r\n          }\r\n          layers.push(featureLayer);\r\n        });\r\n        if (layers.length > 0) {\r\n          map.addLayers(layers);\r\n          if (fullExtent) {\r\n            map.setExtent(fullExtent.expand(1.25),true);\r\n          }\r\n        }\r\n      },\r\n\r\n      _analyze: function(job,formData) {\r\n        if (job.fileType.toLowerCase() !== \"csv\") {\r\n          var dfd = new Deferred();\r\n          dfd.resolve(null);\r\n          return dfd;\r\n        }\r\n\r\n        var geocoder = null;\r\n        if (this.wabWidget.batchGeocoderServers &&\r\n            this.wabWidget.batchGeocoderServers.length > 0) {\r\n          geocoder = this.wabWidget.batchGeocoderServers[0];\r\n        }\r\n        var analyzeParams = {\r\n          \"enableGlobalGeocoding\": true,\r\n          \"sourceLocale\": kernel.locale\r\n        };\r\n        if (geocoder) {\r\n          analyzeParams.geocodeServiceUrl = geocoder.url;\r\n          if (geocoder.isWorldGeocodeServer) {\r\n            analyzeParams.sourceCountry = \"world\";\r\n            analyzeParams.sourceCountryHint = \"\";\r\n          }\r\n        }\r\n\r\n        var url = job.sharingUrl + \"/content/features/analyze\";\r\n        var content = {\r\n          f: \"json\",\r\n          filetype: job.fileType.toLowerCase(),\r\n          analyzeParameters: window.JSON.stringify(analyzeParams)\r\n        };\r\n        var req = esriRequest({\r\n          url: url,\r\n          content: content,\r\n          form: formData,\r\n          handleAs: \"json\"\r\n        });\r\n        req.then(function(response){\r\n          //console.warn(\"Analyzed:\",response);\r\n          if (response && response.publishParameters) {\r\n            job.publishParameters = response.publishParameters;\r\n          }\r\n        });\r\n        return req;\r\n      },\r\n\r\n      _createFileTypeImage: function(fileTypeName) {\r\n        var isRTL = window.isRTL;\r\n        array.some(this.SHAPETYPE_ICONS, lang.hitch(this, function(filetypeIcon, index) {\r\n          if(fileTypeName.toLowerCase() === filetypeIcon.type.toLowerCase()) {\r\n            var iconImg = document.createElement(\"IMG\");\r\n            iconImg.src = this.wabWidget.folderUrl + filetypeIcon.url;\r\n            iconImg.alt = fileTypeName;\r\n            if(index === 0) {\r\n              iconImg.className += \" \" + (isRTL ? \"last\" : \"first\") + \"-type-icon\";\r\n            } else if(index === 1) {\r\n              iconImg.className += \" second-\" + (isRTL ? \"last\" : \"first\") + \"-type-icon\";\r\n            } else if(index === (this.SHAPETYPE_ICONS.length - 2)) {\r\n              iconImg.className += \" second-\" + (isRTL ? \"first\" : \"last\") + \"-type-icon\";\r\n            } else if (index === (this.SHAPETYPE_ICONS.length - 1)) {\r\n              iconImg.className += \" \" + (isRTL ? \"first\" : \"last\") + \"-type-icon\";\r\n            }\r\n            this.supportedFileTypes.appendChild(iconImg);\r\n          }\r\n        }));\r\n      },\r\n\r\n      _execute: function(fileInfo) {\r\n        var job = {\r\n          map: this.wabWidget.map,\r\n          sharingUrl: this.wabWidget.getSharingUrl(),\r\n          baseFileName: fileInfo.baseFileName,\r\n          fileName: fileInfo.fileName,\r\n          fileType: fileInfo.fileType,\r\n          generalize: !!this.generalizeCheckBox.getValue(),\r\n          publishParameters: {},\r\n          numFeatures: 0\r\n        };\r\n        this._setBusy(true);\r\n        this._setStatus(i18n.addFromFile.addingPattern\r\n          .replace(\"{filename}\",fileInfo.fileName));\r\n        if (fileInfo.fileType.toLowerCase() === \"kml\") {\r\n          return this._executeKml(fileInfo);\r\n        }\r\n\r\n        var fileName = fileInfo.fileName;\r\n        var self = this, formData = new FormData();\r\n        formData.append(\"file\",fileInfo.file);\r\n        self._analyze(job,formData).then(function(response){\r\n          if(response && response.publishParameters && response.publishParameters.locationType && \r\n            response.publishParameters.locationType === \"unknown\") {\r\n            new Message({\r\n              titleLabel: i18n._widgetLabel,\r\n              message: i18n.addFromFile.featureLocationsCouldNotBeFound\r\n            });\r\n          }\r\n          return self._generateFeatures(job,formData);\r\n        }).then(function(response){\r\n          //console.warn(\"Generated\",response);\r\n          self._addFeatures(job,response.featureCollection);\r\n          self._setBusy(false);\r\n          self._setStatus(i18n.addFromFile.featureCountPattern\r\n            .replace(\"{filename}\",fileName)\r\n            .replace(\"{count}\",job.numFeatures)\r\n          );\r\n        }).otherwise(function(error){\r\n          self._setBusy(false);\r\n          self._setStatus(i18n.addFromFile.addFailedPattern\r\n            .replace(\"{filename}\",fileName));\r\n          console.warn(\"Error generating features.\");\r\n          console.warn(error);\r\n          if (error && typeof error.message === \"string\" && error.message.length > 0) {\r\n            // e.g. The maximum number of records allowed (1000) has been exceeded.\r\n            new Message({\r\n              titleLabel: i18n._widgetLabel,\r\n              message: i18n.addFromFile.generalIssue+\"<br><br>\"+error.message\r\n            });\r\n          }\r\n        });\r\n      },\r\n\r\n      _executeKml: function(fileInfo) {\r\n        var _self = this;\r\n        var reader = new FileReader();\r\n        var map = this.wabWidget.map;\r\n\r\n        var handleError = function(pfx,error) {\r\n          _self._setBusy(false);\r\n          _self._setStatus(i18n.addFromFile.addFailedPattern\r\n            .replace(\"{filename}\",fileInfo.fileName));\r\n          console.warn(pfx);\r\n          console.error(error);\r\n          if (error && typeof error.message === \"string\" && error.message.length > 0) {\r\n            new Message({\r\n              titleLabel: i18n._widgetLabel,\r\n              message: i18n.addFromFile.generalIssue+\"<br><br>\"+error.message\r\n            });\r\n          }\r\n        };\r\n\r\n        reader.onerror = function(err) {\r\n          handleError(\"FileReader::onerror\",err);\r\n        };\r\n\r\n        reader.onload = function(event) {\r\n          if (reader.error) {\r\n            handleError(\"FileReader::error\",reader.error);\r\n            return;\r\n          }\r\n          var v = event.target.result;\r\n          var url = \"\";\r\n          var loader = new LayerLoader();\r\n          var id = loader._generateLayerId();\r\n          var layer = new KMLLayer(url, {\r\n            id: id,\r\n            name: fileInfo.fileName,\r\n            linkInfo: {\r\n              visibility: false\r\n            }\r\n          });\r\n          layer.visible = true;\r\n          delete layer.linkInfo;\r\n\r\n          layer._parseKml = function() {\r\n            var self = this;\r\n            this._fireUpdateStart();\r\n            // Send viewFormat as necessary if this kml layer represents a\r\n            // network link i.e., in the constructor options.linkInfo is\r\n            // available and linkInfo has viewFormat property\r\n            this._io = esriRequest({\r\n              url: this.serviceUrl,\r\n              content: {\r\n                /*url: this._url.path + this._getQueryParameters(map),*/\r\n                kmlString: encodeURIComponent(v),\r\n                model: \"simple\",\r\n                folders: \"\",\r\n                refresh: this.loaded ? true : undefined,\r\n                outSR: dojoJson.toJson(this._outSR.toJson())\r\n              },\r\n              callbackParamName: \"callback\",\r\n              load: function(response) {\r\n                //console.warn(\"response\",response);\r\n                self._io = null;\r\n                self._initLayer(response);\r\n                loader._waitForLayer(layer).then(function(lyr) {\r\n                  var num = 0;\r\n                  lyr.name = fileInfo.fileName;\r\n                  lyr.xtnAddData = true;\r\n                  array.forEach(lyr.getLayers(),function(l) {\r\n                    if (l && l.graphics && l.graphics.length > 0 ) {\r\n                      num += l.graphics.length;\r\n                    }\r\n                  });\r\n                  var mapSR = map.spatialReference, outSR = lyr._outSR;\r\n                  var projOk = (mapSR && outSR) && (mapSR.equals(outSR) ||\r\n                    mapSR.isWebMercator() && outSR.wkid === 4326 ||\r\n                    outSR.isWebMercator() && mapSR.wkid === 4326);\r\n                  if (projOk) {\r\n                    map.addLayer(lyr);\r\n                  } else {\r\n                    new Message({\r\n                      titleLabel: i18n._widgetLabel,\r\n                      message: i18n.addFromFile.kmlProjectionMismatch\r\n                    });\r\n                  }\r\n                  _self._setBusy(false);\r\n                  _self._setStatus(i18n.addFromFile.featureCountPattern\r\n                    .replace(\"{filename}\",fileInfo.fileName)\r\n                    .replace(\"{count}\",num)\r\n                  );\r\n                }).otherwise(function(err) {\r\n                  handleError(\"kml-_waitForLayer.error\",err);\r\n                });\r\n              },\r\n              error: function(err) {\r\n                self._io = null;\r\n                err = lang.mixin(new Error(), err);\r\n                err.message = \"Unable to load KML: \" + (err.message || \"\");\r\n                self._fireUpdateEnd(err);\r\n                self._errorHandler(err);\r\n                handleError(\"Unable to load KML\",err);\r\n              }\r\n            },{usePost:true});\r\n          };\r\n          layer._parseKml();\r\n\r\n        };\r\n\r\n        try {\r\n          reader.readAsText(fileInfo.file);\r\n        } catch(ex) {\r\n          handleError(\"FileReader::readAsText\",ex);\r\n        }\r\n      },\r\n\r\n      _generateFeatures: function(job,formData) {\r\n        var url = job.sharingUrl + \"/content/features/generate\";\r\n        job.publishParameters =  job.publishParameters || {};\r\n        var params = lang.mixin(job.publishParameters,{\r\n          name: job.baseFileName,\r\n          targetSR: job.map.spatialReference,\r\n          maxRecordCount: this.maxRecordCount,\r\n          enforceInputFileSizeLimit: true,\r\n          enforceOutputJsonSizeLimit: true\r\n        });\r\n        if (job.generalize) {\r\n          // 1:40,000\r\n          var extent = scaleUtils.getExtentForScale(job.map,40000);\r\n          var resolution = extent.getWidth() / job.map.width;\r\n          params.generalize = true;\r\n          params.maxAllowableOffset = resolution;\r\n          // 1:4,000\r\n          resolution = resolution / 10;\r\n          var numDecimals = 0;\r\n          while (resolution < 1) {\r\n            resolution = resolution * 10;\r\n            numDecimals++;\r\n          }\r\n          params.reducePrecision = true;\r\n          params.numberOfDigitsAfterDecimal = numDecimals;\r\n        }\r\n        var content = {\r\n          f: \"json\",\r\n          filetype: job.fileType.toLowerCase(),\r\n          publishParameters: window.JSON.stringify(params)\r\n        };\r\n        return esriRequest({\r\n          url: url,\r\n          content: content,\r\n          form: formData,\r\n          handleAs: \"json\"\r\n        });\r\n      },\r\n\r\n      _getBaseFileName: function(fileName) {\r\n        var a, baseFileName = fileName;\r\n        if (sniff(\"ie\")) { //fileName is full path in IE so extract the file name\r\n          a = baseFileName.split(\"\\\\\");\r\n          baseFileName = a[a.length - 1];\r\n        }\r\n        a = baseFileName.split(\".\");\r\n        //Chrome and IE add c:\\fakepath to the value - we need to remove it\r\n        baseFileName = a[0].replace(\"c:\\\\fakepath\\\\\",\"\");\r\n        return baseFileName;\r\n      },\r\n\r\n      _getBusy: function() {\r\n        return domClass.contains(this.uploadLabel,\"disabled\");\r\n      },\r\n\r\n      _getFileInfo: function(dropEvent) {\r\n        var file, files;\r\n        var info = {\r\n          ok: false,\r\n          file: null,\r\n          fileName: null,\r\n          fileType: null\r\n        };\r\n        if (dropEvent) {\r\n          files = dropEvent.dataTransfer.files;\r\n        } else {\r\n          files = this.fileNode.files;\r\n        }\r\n        if (files && files.length === 1) {\r\n          info.file = file = files[0];\r\n          info.fileName = file.name;\r\n          if (util.endsWith(file.name,\".zip\")) {\r\n            info.ok = true;\r\n            info.fileType = \"Shapefile\";\r\n          } else if (util.endsWith(file.name,\".csv\")) {\r\n            info.ok = true;\r\n            info.fileType = \"CSV\";\r\n          } else if (util.endsWith(file.name,\".kml\")) {\r\n            info.ok = true;\r\n            info.fileType = \"KML\";\r\n          } else if (util.endsWith(file.name,\".gpx\")) {\r\n            info.ok = true;\r\n            info.fileType = \"GPX\";\r\n          } else if (util.endsWith(file.name,\".geojson\") ||\r\n            util.endsWith(file.name,\".geo.json\")) {\r\n            info.ok = true;\r\n            info.fileType = \"GeoJSON\";\r\n          }\r\n        }\r\n        if (info.ok) {\r\n          info.ok = array.some(this.SHAPETYPE_ICONS,function(filetypeIcon) {\r\n            return filetypeIcon.type.toLowerCase() === info.fileType.toLowerCase();\r\n          });\r\n        }\r\n        if (info.ok) {\r\n          info.baseFileName = this._getBaseFileName(info.fileName);\r\n        } else {\r\n          var msg = i18n.addFromFile.invalidType, usePopup = true;\r\n          if (typeof info.fileName === \"string\" && info.fileName.length > 0) {\r\n            msg = i18n.addFromFile.invalidTypePattern\r\n              .replace(\"{filename}\",info.fileName);\r\n          }\r\n          this._setBusy(false);\r\n          this._setStatus(msg);\r\n          if (usePopup) {\r\n            var nd = document.createElement(\"div\");\r\n            nd.appendChild(document.createTextNode(msg));\r\n            new Message({\r\n              titleLabel: i18n._widgetLabel,\r\n              message: nd\r\n            });\r\n          }\r\n        }\r\n        return info;\r\n      },\r\n\r\n      resize: function() {\r\n      },\r\n\r\n      _setBusy: function(isBusy) {\r\n        if (isBusy) {\r\n          domClass.add(this.uploadLabel,\"disabled\");\r\n          domClass.add(this.dropArea,[\"hit\",\"disabled\"]);\r\n        } else {\r\n          domClass.remove(this.uploadLabel,\"disabled\");\r\n          domClass.remove(this.dropArea,[\"hit\",\"disabled\"]);\r\n        }\r\n      },\r\n\r\n      _setStatus: function(msg) {\r\n        if(this.wabWidget) {\r\n          this.wabWidget._setStatus(msg);\r\n        }\r\n      }\r\n\r\n    });\r\n\r\n  });\r\n"]}