{"version":3,"sources":["../../../widgets/Scalebar/Widget.js"],"names":["define","declare","lang","html","Deferred","BaseWidget","utils","PortalUtils","Message","Scalebar","on","scaleUtils","domStyle","query","clazz","baseClass","name","scalebar","moveTopOnActive","startup","inherited","arguments","json","clone","config","map","position","top","undefined","left","attachTo","right","bottom","_processConfig","then","hitch","scaleJson","scalebarStyle","show","domNode","appendChild","_hackForhighlight","addClass","removeClass","style","width","mixin","set","getPositionStyle","_isNumberStyle","_createNumberStyleContainer","_showNumberScale","_set508Label","setTimeout","own","onExtentChange","err","message","configJson","def","scalebarUnit","resolve","getUnits","appConfig","portalUrl","units","promise","onClose","destroy","styleList","i","len","length","styleStr","numberStyleContainer","create","_refreshTooltip","_getScaleString","s","getScale","isNaN","localizeNumberByFieldInfo","format","places","decimalPlaces","digitSeparator","addSeparator","window","isRTL","innerHTML","sanitizeHTML","label","str","scale","nls","setAttr","isInNavMode","hasClass","document","activeElement","blur","focus"],"mappings":"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","file":"Widget.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n  'dojo/_base/declare',\r\n  'dojo/_base/lang',\r\n  'dojo/_base/html',\r\n  'dojo/Deferred',\r\n  'jimu/BaseWidget',\r\n  'jimu/utils',\r\n  'jimu/portalUtils',\r\n  'jimu/dijit/Message',\r\n  'esri/dijit/Scalebar',\r\n  'dojo/on',\r\n  \"esri/geometry/scaleUtils\",\r\n  \"dojo/dom-style\",\r\n  'dojo/query',\r\n  'dojo/NodeList-dom'\r\n],\r\n  function (declare, lang, html, Deferred, BaseWidget, utils, PortalUtils, Message,\r\n    Scalebar, on, scaleUtils, domStyle, query) {\r\n    var clazz = declare([BaseWidget], {\r\n      baseClass: \"jimu-widget-scalebar\",\r\n      name: \"Scalebar\",\r\n      scalebar: null,\r\n\r\n      moveTopOnActive: false,\r\n\r\n      startup: function () {\r\n        this.inherited(arguments);\r\n        var json = lang.clone(this.config.scalebar);\r\n        json.map = this.map;\r\n        if (this.position) {\r\n          if (this.position.top !== undefined && this.position.left !== undefined) {\r\n            json.attachTo = \"top-left\";\r\n          } else if (this.position.top !== undefined && this.position.right !== undefined) {\r\n            json.attachTo = \"top-right\";\r\n          } else if (this.position.bottom !== undefined && this.position.left !== undefined) {\r\n            json.attachTo = \"bottom-left\";\r\n          } else if (this.position.bottom !== undefined && this.position.right !== undefined) {\r\n            json.attachTo = \"bottom-right\";\r\n          }\r\n        }\r\n\r\n        this._processConfig(json).then(lang.hitch(this, function (scaleJson) {\r\n          if (!scaleJson.scalebarStyle) {\r\n            scaleJson.scalebarStyle = 'line';\r\n          }\r\n          this.scalebar = new Scalebar(scaleJson);\r\n          this.scalebar.show();\r\n\r\n          this.domNode.appendChild(this.scalebar.domNode);\r\n          this._hackForhighlight();\r\n\r\n          if (scaleJson.scalebarStyle === 'ruler') {\r\n            html.addClass(this.scalebar.domNode, 'ruler-style');\r\n          } else {\r\n            html.removeClass(this.scalebar.domNode, 'ruler-style');\r\n          }\r\n\r\n          var style = {\r\n            left: 'auto',\r\n            right: 'auto',\r\n            top: 'auto',\r\n            bottom: 'auto',\r\n            width: 'auto'\r\n          };\r\n          lang.mixin(style, this.position);\r\n          domStyle.set(this.domNode, utils.getPositionStyle(style));\r\n\r\n          if (this._isNumberStyle()) {\r\n            this._createNumberStyleContainer();\r\n            this._showNumberScale();//init number style\r\n          }\r\n\r\n          this._set508Label();\r\n\r\n          setTimeout(lang.hitch(this, function () {\r\n            if (!this.domNode) {\r\n              return;\r\n            }\r\n            domStyle.set(this.domNode, utils.getPositionStyle(style));\r\n\r\n            this.own(on(this.map, \"extent-change\", lang.hitch(this, this.onExtentChange)));\r\n          }), 1000);\r\n        }), lang.hitch(this, function (err) {\r\n          new Message({\r\n            message: err.message || err\r\n          });\r\n        }));\r\n      },\r\n\r\n      _processConfig: function (configJson) {\r\n        var def = new Deferred();\r\n        if (this._isNumberStyle()) {\r\n          configJson.scalebarStyle = \"line\";//hack style for API\r\n        }\r\n\r\n        if (configJson.scalebarUnit) {\r\n          def.resolve(configJson);\r\n        } else {\r\n          PortalUtils.getUnits(this.appConfig.portalUrl).then(lang.hitch(this, function (units) {\r\n            configJson.scalebarUnit = units === 'english' ? 'english' : 'metric';\r\n            def.resolve(configJson);\r\n          }));\r\n        }\r\n\r\n        return def.promise;\r\n      },\r\n\r\n      _hackForhighlight: function () {\r\n        query('.esriScalebar', this.domNode).removeClass('esriScalebar');\r\n      },\r\n\r\n      onClose: function () {\r\n        this.scalebar.destroy();\r\n      },\r\n\r\n      /* number style */\r\n      _createNumberStyleContainer: function (){\r\n        var styleList = [\"top-right\", \"bottom-right\", \"top-center\",\r\n          \"bottom-center\", \"bottom-left\", \"top-left\"];\r\n        for (var i = 0, len = styleList.length; i < len; i++) {\r\n          var styleStr = \".scalebar_\" + styleList[i];\r\n          query(styleStr, this.domNode).addClass('hide');//hide raw dom for ie11\r\n        }\r\n\r\n        this.numberStyleContainer = html.create('div', {\r\n          'class': \"number-style\"\r\n        }, this.domNode);\r\n      },\r\n      _isNumberStyle: function () {\r\n        return (\"number\" === this.config.scalebar.scalebarStyle);\r\n      },\r\n      onExtentChange: function () {\r\n        this._set508Label();\r\n        this._refreshTooltip();\r\n\r\n        if (this._isNumberStyle()) {\r\n          this._showNumberScale();\r\n        }\r\n      },\r\n\r\n      _getScaleString: function () {\r\n        var s = scaleUtils.getScale(this.map);\r\n        if (isNaN(s)) {\r\n          s = \"\";\r\n        } else {\r\n          s = utils.localizeNumberByFieldInfo(s, {\r\n            format: {\r\n              places: this.config.scalebar.decimalPlaces,\r\n              digitSeparator: this.config.scalebar.addSeparator\r\n            }\r\n          });\r\n\r\n          s = (window.isRTL ? s + \":1\" : \"1:\" + s);\r\n        }\r\n\r\n        return s;\r\n      },\r\n      _showNumberScale: function () {\r\n        this.numberStyleContainer.innerHTML =\r\n          utils.sanitizeHTML(\"<div class='scaleLabelDiv scalebar-line'>\" + this._getScaleString() + \"</div>\");\r\n      },\r\n      _set508Label: function (label) {\r\n        var str,\r\n          scale = this._getScaleString();\r\n        if (label) {\r\n          str = label;\r\n        } else if (scale) {\r\n          str = this.nls.scale + \" \" + scale;\r\n        }\r\n\r\n        html.setAttr(this.domNode, 'aria-label', str);\r\n      },\r\n      _refreshTooltip: function(){\r\n        if( utils.isInNavMode() && html.hasClass(document.activeElement, this.baseClass)){\r\n          this.domNode.blur();\r\n          this.domNode.focus();\r\n        }\r\n      }\r\n    });\r\n\r\n    return clazz;\r\n  });"]}