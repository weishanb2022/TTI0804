{"version":3,"sources":["../../../../widgets/AttributeTable/setting/Setting.js"],"names":["define","declare","_WidgetsInTemplateMixin","BaseWidgetSetting","Table","lang","html","array","on","Deferred","promiseAll","query","registry","Popup","Message","CheckBox","LoadingShelter","utils","baseClass","currentFieldTable","_allLayerFields","_layerInfos","_tableInfos","_delayedLayerInfos","_delayedLayerInfosAfterInit","_unSpportQueryCampsite","startup","inherited","arguments","config","layerInfos","fields","name","title","nls","show","width","type","label","url","hidden","sortField","actions","args","selectable","autoHeight","displayFieldsTable","placeAt","tableLayerInfos","setStyle","domNode","shelter","parentNode","readLayerInfosObj","map","then","hitch","layerInfosObj","own","onLayerInfosChanged","editFieldsClick","_verifiedOnShowClick","tr","_addTooltipToSortOrderNode","syncWithLayersCheck","checked","_toggleTableShowOption","setConfig","tds","data","length","getRowData","popup","message","warning","buttons","ok","onClick","close","rowIndex","parseInt","index","_getLayerFields","openFieldsDialog","err","console","error","always","hide","rowData","idx","layerInfo","_layerNames","layerNames","unSupportQuery","indexOf","unsupportQueryWarning","editRow","getLayerObject","layer","layerFields","f","alias","arcade","appendArcadeExpressionsToFields","merge","d","s","mixin","syncOrderWith","dom","dijit","byNode","updateTooltip","isDescending","sortOrderTooltips","toAscending","toDescending","defaultHasAttachment","layerObject","hasAttachments","objectIdField","content","create","table","_createFieldsTable","place","cbx","showAttachments","style","setValue","maxHeight","fieldsPopup","titleLabel","configureLayerFields","getData","value","getValue","cancel","classNames","onClose","lFields","fieldsTable","fieldVisibility","onChange","atLeastOne","some","field","fieldCheckWarning","fieldName","fieldAlias","editable","fieldActions","i","undefined","addRow","clear","_processTableData","_init","changeType","layerInfoSelf","getSupportTableInfo","supportTableInfo","isSupportedLayer","push","_getLayerInfoById","id","_processDelayedLayerInfosAfterInit","count","sortFieldRequests","_configLayerInfo","getConfigInfoFromLayerInfo","_prepareSortField","results","_addRowToDisplayFieldsTable","_processDelayedLayerInfos","forEach","delayedLayerInfo","def","readConfigLayerInfosFromMap","readSupportTableInfoFromLayerInfos","tableInfos","configInfosFromMap","getConfigInfosFromLayerInfos","mci","cli","getObject","fromConfig","_getUnsupportQueryLayerNames","resolve","configLayerInfos","configLayerInfo","reject","_unSpportQueryLayerNames","_tableInfo","_getSupportTableInfoById","isSupportQuery","unSupportQueryLayerNames","sorting","selectedField","nowUnsupport","unsupportQueryLayers","toString","hideExportButton","exportcsv","uncheck","check","initiallyExpand","expand","_canUseOpenAtStart","openAtStart","status","addClass","filterByMapExtent","allowTextSelection","textSelection","syncWithLayers","layerIndex","_prepareSortFieldOptions","sortingObj","Array","isArray","option","selected","disabled","closeable","isOnScreen","layerId","len","getConfig","tData","lInfo","json","isDisabled","checkNode","checkDijit","setStatus"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEAA,OAAO,CACH,oBADG,EAEH,+BAFG,EAGH,wBAHG,EAIH,wBAJG,EAKH,iBALG,EAMH,iBANG,EAOH,kBAPG,EAQH,SARG,EASH,eATG,EAUH,kBAVG,EAWH,YAXG,EAYH,gBAZG,EAaH,kBAbG,EAcH,oBAdG,EAeH,qBAfG,EAgBH,2BAhBG,EAiBH,UAjBG,CAAP,EAmBE,UACEC,OADF,EAEEC,uBAFF,EAGEC,iBAHF,EAIEC,KAJF,EAKEC,IALF,EAMEC,IANF,EAOEC,KAPF,EAQEC,EARF,EASEC,QATF,EAUEC,UAVF,EAWEC,KAXF,EAYEC,QAZF,EAaEC,KAbF,EAcEC,OAdF,EAeEC,QAfF,EAgBEC,cAhBF,EAiBEC,KAjBF,EAkBE;AACA,SAAOhB,QAAQ,CAACE,iBAAD,EAAoBD,uBAApB,CAAR,EAAsD;AAC3D;AACAgB,eAAW,oCAFgD;AAG3DC,uBAAmB,IAHwC;AAI3DC,qBAAiB,IAJ0C;AAK3D;AACA;AACAC,iBAAa,IAP8C,EAOzC;AAClBC,iBAAa,IAR8C;AAS3DC,wBAAoB,IATuC;AAU3DC,iCAA6B,IAV8B;AAW3DC,4BAAwB,IAXmC;;AAa3DC,aAAS,mBAAW;AAClB,WAAKC,SAAL,CAAeC,SAAf;AACA,UAAI,CAAC,KAAKC,MAAL,CAAYC,UAAjB,EAA6B;AAC3B,aAAKD,MAAL,CAAYC,UAAZ,GAAyB,EAAzB;AACD;AACD,WAAKV,eAAL,GAAuB,EAAvB;AACA;AACA,WAAKC,WAAL,GAAmB,EAAnB;AACA,WAAKC,WAAL,GAAmB,EAAnB;AACA,WAAKC,kBAAL,GAA0B,EAA1B;AACA,WAAKC,2BAAL,GAAmC,EAAnC;AACA,WAAKC,sBAAL,GAA8B,EAA9B;;AAEA,UAAIM,SAAS,CAAC;AACZC,cAAM,MADM;AAEZC,eAAO,KAAKC,GAAL,CAASC,IAFJ;AAGZC,eAAO,MAHK;AAIZC,cAAM,UAJM;AAKZ,iBAAS;AALG,OAAD,EAMV;AACDL,cAAM,OADL;AAEDC,eAAO,KAAKC,GAAL,CAASI,KAFf;AAGDF,eAAO,KAHN;AAIDC,cAAM;AAJL,OANU,EAWV;AACDL,cAAM,KADL;AAEDC,eAAO,KAAKC,GAAL,CAASK,GAFf;AAGDF,cAAM,MAHL;AAIDG,gBAAQ;AAJP,OAXU,EAgBV;AACDR,cAAM,OADL;AAEDC,eAAO,OAFN;AAGDI,cAAM,MAHL;AAIDG,gBAAQ;AAJP,OAhBU,EAqBV;AACDR,cAAM,WADL;AAEDC,eAAO,KAAKC,GAAL,CAASO,SAFf;AAGDJ,cAAM,UAHL;AAIDD,eAAO;AAJN,OArBU,EA0BV;AACDJ,cAAM,cADL;AAEDC,eAAO,EAFN;AAGDG,eAAO,IAHN;AAIDC,cAAM,UAJL;AAKD,iBAAS;AALR,OA1BU,EAgCV;AACDL,cAAM,SADL;AAEDC,eAAO,KAAKC,GAAL,CAASQ,OAFf;AAGDL,cAAM,SAHL;AAIDD,eAAO,KAJN;AAKDM,iBAAS,CAAC,MAAD,CALR;AAMD,iBAAS;AANR,OAhCU,EAuCV;AACDV,cAAM,iBADL;AAEDC,eAAO,EAFN;AAGDI,cAAM,UAHL;AAIDG,gBAAQ;AAJP,OAvCU,CAAb;;AA8CA,UAAIG,OAAO;AACTZ,gBAAQA,MADC;AAETa,oBAAY,IAFH;AAGTC,oBAAY;AAHH,OAAX;AAKA,WAAKC,kBAAL,GAA0B,IAAI1C,KAAJ,CAAUuC,IAAV,CAA1B;AACA,WAAKG,kBAAL,CAAwBC,OAAxB,CAAgC,KAAKC,eAArC;AACA1C,WAAK2C,QAAL,CAAc,KAAKH,kBAAL,CAAwBI,OAAtC,EAA+C;AAC7C,kBAAU;AADmC,OAA/C;;AAIA,WAAKC,OAAL,GAAe,IAAInC,cAAJ,CAAmB;AAChCwB,gBAAQ;AADwB,OAAnB,CAAf;AAGA,WAAKW,OAAL,CAAaJ,OAAb,CAAqB,KAAKG,OAAL,CAAaE,UAAb,CAAwBA,UAAxB,IAAsC,KAAKF,OAAhE;AACA,WAAKC,OAAL,CAAazB,OAAb;AACA,WAAKyB,OAAL,CAAahB,IAAb;;AAEAlB,YAAMoC,iBAAN,CAAwB,KAAKC,GAA7B,EAAkCC,IAAlC,CAAuClD,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASC,aAAT,EAAwB;AAC9E,aAAKC,GAAL,CAASD,cAAcjD,EAAd,CACP,mBADO,EAEPH,KAAKmD,KAAL,CAAW,IAAX,EAAiB,KAAKG,mBAAtB,CAFO,CAAT;;AAKA,aAAKD,GAAL,CAASlD,GACP,KAAKsC,kBADE,EAEP,cAFO,EAGPzC,KAAKmD,KAAL,CAAW,IAAX,EAAiB,KAAKI,eAAtB,CAHO,CAAT;AAKA,aAAKF,GAAL,CAASlD,GACP,KAAKsC,kBADE,EAEP,WAFO,EAGPzC,KAAKmD,KAAL,CAAW,IAAX,EAAiB,KAAKK,oBAAtB,CAHO,CAAT;AAKA,aAAKH,GAAL,CAASlD,GACP,KAAKsC,kBADE,EAEP,SAFO,EAGPzC,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASM,EAAT,EAAa;AAC5B,eAAKC,0BAAL,CAAgCD,EAAhC;AACD,SAFD,CAHO,CAAT;;AAQA,aAAKJ,GAAL,CAASlD,GACP,KAAKwD,mBADE,EAEP,QAFO,EAGP3D,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASS,OAAT,EAAkB;AACjC,eAAKC,sBAAL,CAA4BD,OAA5B;AACD,SAFD,CAHO,CAAT;;AAQA,aAAKE,SAAL,CAAe,KAAKtC,MAApB;AACD,OAjCsC,CAAvC;AAkCD,KA5H0D;;AA8H3D+B,qBAAiB,yBAASE,EAAT,EAAa;AAC5B,UAAIM,MAAMzD,MAAM,qBAAN,EAA6BmD,EAA7B,CAAV;AACA,UAAIO,IAAJ;AACA,UAAID,OAAOA,IAAIE,MAAf,EAAuB;AACrBD,eAAO,KAAKvB,kBAAL,CAAwByB,UAAxB,CAAmCT,EAAnC,CAAP;AACA,YAAI,CAACO,KAAKlC,IAAV,EAAgB;AACd,cAAIqC,QAAQ,IAAI1D,OAAJ,CAAY;AACtB2D,qBAAS,KAAKvC,GAAL,CAASwC,OADI;AAEtBC,qBAAS,CAAC;AACRrC,qBAAO,KAAKJ,GAAL,CAAS0C,EADR;AAERC,uBAASxE,KAAKmD,KAAL,CAAW,IAAX,EAAiB,YAAW;AACnCgB,sBAAMM,KAAN;AACD,eAFQ;AAFD,aAAD;AAFa,WAAZ,CAAZ;AASD,SAVD,MAUO;AACL,cAAIC,WAAWC,SAASX,KAAKY,KAAd,EAAqB,EAArB,CAAf;AACA,eAAK9B,OAAL,CAAahB,IAAb;AACA,eAAK+C,eAAL,CAAqBH,QAArB,EAA+BxB,IAA/B,CAAoClD,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASzB,MAAT,EAAiB;AACpE,iBAAKoD,gBAAL,CAAsBrB,EAAtB,EAA0B/B,MAA1B,EAAkCgD,QAAlC;AACD,WAFmC,CAApC,EAEI1E,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS4B,GAAT,EAAc;AACjCC,oBAAQC,KAAR,CAAcF,GAAd;AACD,WAFG,CAFJ,EAIIG,MAJJ,CAIWlF,KAAKmD,KAAL,CAAW,IAAX,EAAiB,YAAW;AACrC,iBAAKL,OAAL,CAAaqC,IAAb;AACD,WAFU,CAJX;AAOD;AACF;AACF,KAzJ0D;;AA2J3D3B,0BAAsB,8BAASC,EAAT,EAAa;AACjC,UAAI2B,UAAU,KAAK3C,kBAAL,CAAwByB,UAAxB,CAAmCT,EAAnC,CAAd;AACA,UAAI4B,MAAMV,SAASS,QAAQR,KAAjB,EAAwB,EAAxB,CAAV;AACA,UAAIU,YAAY,IAAhB;AACA,UAAI,KAAK9D,MAAL,IAAe,KAAKA,MAAL,CAAYC,UAA3B,IAAyC,KAAKD,MAAL,CAAYC,UAAZ,CAAuBwC,MAAvB,GAAgC,CAA7E,EAAgF;AAC9EqB,oBAAY,KAAK9D,MAAL,CAAYC,UAAZ,CAAuB4D,GAAvB,CAAZ;AACD,OAFD,MAEO;AACLC,oBAAY,KAAKtE,WAAL,CAAiBqE,GAAjB,CAAZ;AACD;;AAED,UAAIE,cAAc,KAAKnE,sBAAL,CAA4BoE,UAA9C;AACA,UAAIC,iBAAiBF,YAAYG,OAAZ,CAAoBJ,UAAU3D,IAAV,IAAkB2D,UAAU1D,KAAhD,IAAyD,CAAC,CAA/E;;AAEA,UAAIwD,QAAQtD,IAAR,IAAgB2D,cAApB,EAAoC;AAClC,YAAIhF,OAAJ,CAAY;AACV2D,mBAAS,KAAKvC,GAAL,CAAS8D;AADR,SAAZ;;AAIAP,gBAAQtD,IAAR,GAAe,KAAf;AACA,aAAKW,kBAAL,CAAwBmD,OAAxB,CAAgCnC,EAAhC,EAAoC2B,OAApC;AACD;AACF,KAhL0D;;AAkL3DP,qBAAiB,yBAASH,QAAT,EAAmB;AAClC,aAAO,KAAK1D,WAAL,CAAiB0D,QAAjB,EACNmB,cADM,GAEN3C,IAFM,CAEDlD,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS2C,KAAT,EAAgB;AACrC,YAAIpE,SAAS,KAAKX,eAAL,CAAqB2D,QAArB,CAAb;AACA,YAAIqB,cAAc7F,MAAM+C,GAAN,CAAU6C,MAAMpE,MAAhB,EAAwB,UAASsE,CAAT,EAAY;AACpD,iBAAO;AACLrE,kBAAMqE,EAAErE,IADH;AAELsE,mBAAOD,EAAEC,KAFJ;AAGLnE,kBAAM;AAHD,WAAP;AAKD,SANiB,CAAlB;AAOAiE,sBAAcnF,MAAMsF,MAAN,CAAaC,+BAAb,CACZJ,WADY,EAEZ,KAAK/E,WAAL,CAAiB0D,QAAjB,CAFY,CAAd;AAIA9D,cAAMwF,KAAN,CAAYL,WAAZ,EAAyBrE,MAAzB,EAAiC,MAAjC,EAAyC,UAAS2E,CAAT,EAAYC,CAAZ,EAAe;AACtDtG,eAAKuG,KAAL,CAAWF,CAAX,EAAcC,CAAd;AACD,SAFD;AAGAP,sBAAcnF,MAAM4F,aAAN,CAAoBT,WAApB,EAAiCrE,MAAjC,EAAyC,MAAzC,CAAd;AACA,eAAOqE,WAAP;AACD,OAlBK,CAFC,CAAP;AAqBD,KAxM0D;;AA0M3DrC,gCAA4B,oCAASD,EAAT,EAAa;AACvC,UAAIgD,MAAMnG,MAAM,4BAAN,EAAoCmD,EAApC,EAAwC,CAAxC,CAAV;AACA,UAAIiD,QAAQnG,SAASoG,MAAT,CAAgBF,GAAhB,CAAZ;AACA,UAAI5E,MAAM,KAAKA,GAAf;AACA,UAAI+E,gBAAgB,SAAhBA,aAAgB,CAASC,YAAT,EAAuB;AACzC,YAAGA,YAAH,EAAiB;AACfJ,cAAI7E,KAAJ,GAAYC,IAAIiF,iBAAJ,CAAsBC,WAAlC;AACD,SAFD,MAEO;AACLN,cAAI7E,KAAJ,GAAYC,IAAIiF,iBAAJ,CAAsBE,YAAlC;AACD;AACF,OAND;AAOA,UAAGN,KAAH,EAAU;AACR,aAAKrD,GAAL,CAASlD,GAAGuG,KAAH,EAAU,QAAV,EAAoBE,aAApB,CAAT;AACAA,sBAAcF,MAAM9C,OAApB;AACD;AACF,KAzN0D;;AA2N3DkB,sBAAkB,0BAASrB,EAAT,EAAa/B,MAAb,EAAqB2D,GAArB,EAA0B;AAC1C;AACA,UAAI4B,uBAAuB,KAA3B;AACA,UAAI3B,YAAY,KAAKtE,WAAL,CAAiBqE,GAAjB,CAAhB;AACA,UAAI6B,cAAc5B,aAAaA,UAAU4B,WAAzC;AACA,UAAGA,WAAH,EAAe;AACbD,+BAAuBC,YAAYC,cAAZ,IAA8BD,YAAYE,aAAjE;AACD;;AAED,UAAIC,UAAUpH,KAAKqH,MAAL,CAAY,KAAZ,CAAd;AACA,UAAIC,QAAQ,KAAKC,kBAAL,CAAwB9F,MAAxB,EAAgC2D,GAAhC,CAAZ;AACApF,WAAKwH,KAAL,CAAWF,MAAM1E,OAAjB,EAA0BwE,OAA1B;;AAEA,UAAIK,MAAM,IAAV;AACA,UAAGT,oBAAH,EAAwB;AACtBS,cAAM,IAAIhH,QAAJ,CAAa;AACjBuB,iBAAO,KAAKJ,GAAL,CAAS8F,eADC;AAEjBC,iBAAO;AAFU,SAAb,CAAN;AAIA,YAAIxC,UAAU,KAAK3C,kBAAL,CAAwByB,UAAxB,CAAmCT,EAAnC,CAAd;AACAiE,YAAIG,QAAJ,CAAazC,QAAQuC,eAArB;AACA;AACAD,YAAIhF,OAAJ,CAAY2E,OAAZ;AACD;;AAED,WAAKvG,iBAAL,GAAyByG,KAAzB;AACA,UAAIO,YAAY,GAAhB;AACA,UAAGJ,GAAH,EAAO;AACLI,oBAAY,GAAZ;AACD;;AAED,UAAIC,cAAc,IAAIvH,KAAJ,CAAU;AAC1BwH,oBAAY,KAAKnG,GAAL,CAASoG,oBADK;AAE1BlG,eAAO,GAFmB;AAG1B+F,mBAAWA,SAHe;AAI1BtF,oBAAY,IAJc;AAK1B6E,iBAASA,OALiB;AAM1B/C,iBAAS,CAAC;AACRrC,iBAAO,KAAKJ,GAAL,CAAS0C,EADR;AAERC,mBAASxE,KAAKmD,KAAL,CAAW,IAAX,EAAiB,YAAW;AACnC,iBAAKpC,eAAL,CAAqBsE,GAArB,IAA4BkC,MAAMW,OAAN,EAA5B;AACA,gBAAIC,QAAQT,MAAMA,IAAIU,QAAJ,EAAN,GAAuB,KAAnC;AACA,iBAAK3F,kBAAL,CAAwBmD,OAAxB,CAAgCnC,EAAhC,EAAoC;AAClCkE,+BAAiBQ;AADiB,aAApC;;AAIAJ,wBAAYtD,KAAZ;AACAsD,0BAAc,IAAd;AACD,WATQ;AAFD,SAAD,EAYN;AACD9F,iBAAO,KAAKJ,GAAL,CAASwG,MADf;AAEDC,sBAAY,CAAC,mBAAD,CAFX;AAGD9D,mBAASxE,KAAKmD,KAAL,CAAW,IAAX,EAAiB,YAAW;AACnC4E,wBAAYtD,KAAZ;AACAsD,0BAAc,IAAd;AACD,WAHQ;AAHR,SAZM,CANiB;AA0B1BQ,iBAAS,mBAAW;AAClBR,wBAAc,IAAd;AACD;AA5ByB,OAAV,CAAlB;;AA+BAR,YAAMlG,OAAN;AACD,KA1R0D;;AA4R3DmG,wBAAoB,4BAASgB,OAAT,EAAkB;AACpC,UAAIC,cAAc,IAAlB;AACA,UAAI/G,SAAS,CAAC;AACZC,cAAM,MADM;AAEZC,eAAO,KAAKC,GAAL,CAAS6G,eAFJ;AAGZ1G,cAAM,UAHM;AAIZ,iBAAS,MAJG;AAKZ2G,kBAAU3I,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASM,EAAT,EAAa;AACtC,cAAI/B,SAAS+G,YAAYP,OAAZ,EAAb;AACA,cAAIU,aAAa1I,MAAM2I,IAAN,CAAWnH,MAAX,EAAmB1B,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS2F,KAAT,EAAgB;AACnE,mBAAOA,MAAMhH,IAAb;AACD,WAFmC,CAAnB,CAAjB;AAGA,cAAI,CAAC8G,UAAL,EAAiB;AACf,gBAAInI,OAAJ,CAAY;AACV2D,uBAAS,KAAKvC,GAAL,CAASkH;AADR,aAAZ;AAGA,gBAAI3D,UAAUqD,YAAYvE,UAAZ,CAAuBT,EAAvB,CAAd;AACA,gBAAI2B,OAAJ,EAAa;AACXA,sBAAQtD,IAAR,GAAe,IAAf;AACA2G,0BAAY7C,OAAZ,CAAoBnC,EAApB,EAAwB2B,OAAxB;AACD;AACF;AACF,SAfS;AALE,OAAD,EAqBV;AACDzD,cAAM,MADL;AAEDC,eAAO,KAAKC,GAAL,CAASmH,SAFf;AAGDhH,cAAM;AAHL,OArBU,EAyBV;AACDL,cAAM,OADL;AAEDC,eAAO,KAAKC,GAAL,CAASoH,UAFf;AAGDC,kBAAU,IAHT;AAIDlH,cAAM;AAJL,OAzBU,EA8BV;AACDL,cAAM,SADL;AAEDC,eAAO,KAAKC,GAAL,CAASsH,YAFf;AAGDnH,cAAM,SAHL;AAIDK,iBAAS,CAAC,IAAD,EAAO,MAAP,CAJR;AAKD,iBAAS;AALR,OA9BU,CAAb;;AAsCA,UAAIC,OAAO;AACTZ,gBAAQA,MADC;AAETa,oBAAY,IAFH;AAGTC,oBAAY,KAHH;AAIToF,eAAO;AACL,oBAAU,OADL;AAEL,uBAAa;AAFR;AAJE,OAAX;AASAa,oBAAc,IAAI1I,KAAJ,CAAUuC,IAAV,CAAd;;AAEA,WAAK,IAAI8G,IAAI,CAAb,EAAgBA,IAAIZ,QAAQvE,MAA5B,EAAoCmF,GAApC,EAAyC;AACvC,YAAIZ,QAAQY,CAAR,EAAWtH,IAAX,KAAoBuH,SAAxB,EAAmC;AACjCb,kBAAQY,CAAR,EAAWtH,IAAX,GAAkB,IAAlB;AACD,SAFD,MAEO;AACL0G,kBAAQY,CAAR,EAAWtH,IAAX,GAAkB,CAAC,CAAC0G,QAAQY,CAAR,EAAWtH,IAA/B;AACD;;AAED2G,oBAAYa,MAAZ,CAAmBd,QAAQY,CAAR,CAAnB;AACD;;AAED,aAAOX,WAAP;AACD,KA1V0D;;AA4V3D3E,eAAW,mBAAStC,MAAT,EAAiB;AAC1B,WAAKA,MAAL,GAAcA,MAAd;AACA,WAAKiB,kBAAL,CAAwB8G,KAAxB;AACA,WAAKxI,eAAL,GAAuB,EAAvB;;AAEA,WAAKyI,iBAAL,GAAyBtG,IAAzB,CAA8BlD,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS1B,UAAT,EAAqB;AAClE,aAAKgI,KAAL,CAAWhI,UAAX;AACA,aAAKqB,OAAL,CAAaqC,IAAb;AACD,OAH6B,CAA9B,EAGInF,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS4B,GAAT,EAAc;AACjC,YAAItE,OAAJ,CAAY;AACV2D,mBAASW,IAAIX,OAAJ,IAAeW;AADd,SAAZ;AAGD,OAJG,CAHJ;AAQD,KAzW0D;;AA2W3DzB,yBAAqB,6BAASgC,SAAT,EAAoBoE,UAApB,EAAgCC,aAAhC,EAA+C;AAClE,UAAI,YAAYD,UAAZ,IAA0B,CAACC,aAA3B,IAA4C,CAACrE,SAAjD,EAA4D;AAC1D;AACD;AACD;AACAqE,oBAAcC,mBAAd,GAAoC1G,IAApC,CAAyClD,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS0G,gBAAT,EAA2B;AACnF,YAAIA,iBAAiBC,gBAArB,EAAuC;AACrC,cAAI,KAAK9I,WAAL,IAAoB,KAAKA,WAAL,CAAiBiD,MAAjB,KAA4B,CAApD,EAAuD;AACrD,iBAAK/C,kBAAL,CAAwB6I,IAAxB,CAA6BJ,aAA7B;AACD,WAFD,MAEO,IAAI,KAAK3I,WAAL,IAAoB,KAAKA,WAAL,CAAiBiD,MAAjB,GAA0B,CAA9C,IACT,CAAC,KAAK+F,iBAAL,CAAuBL,cAAcM,EAArC,CADI,EACsC;AAAE;AAC7C,iBAAK9I,2BAAL,CAAiC4I,IAAjC,CAAsCJ,aAAtC;AACA,iBAAKO,kCAAL,CAAwC,KAAK/I,2BAA7C;AACD;AACF;AACF,OAVwC,CAAzC;AAWD,KA3X0D;;AA6X3D;AACA+I,wCAAoC,4CAASzI,UAAT,EAAqB;AACvD,UAAI0I,QAAQ,KAAKnJ,WAAL,CAAiBiD,MAA7B;AACA,UAAImG,oBAAoB,EAAxB;;AAEA,WAAK,IAAIhB,IAAI,CAAb,EAAgBA,IAAI3H,WAAWwC,MAA/B,EAAuCmF,GAAvC,EAA4C;AAC1C,YAAIiB,mBAAmBzJ,MAAM0J,0BAAN,CAAiC7I,WAAW2H,CAAX,CAAjC,CAAvB;AACA,YAAItH,OAAOuI,iBAAiBvI,IAA5B;AAAA,YACIM,YAAYiI,iBAAiBjI,SADjC;AAEA,YAAIgD,UAAU;AACZnD,iBAAOoI,iBAAiB1I,IAAjB,IAAyB0I,iBAAiBzI,KADrC;AAEZM,eAAKmI,iBAAiBvE,KAAjB,CAAuB5D,GAFhB;AAGZ0C,iBAAO,MAAMuF,QAAQf,CAAd,CAHK;AAIZvC,wBAAc,IAJF;AAKZ/E,gBAAMA;AALM,SAAd;AAOA,aAAKf,eAAL,CAAqBgJ,IAArB,CAA0BM,iBAAiBvE,KAAjB,CAAuBpE,MAAjD;AACA,aAAKV,WAAL,CAAiB+I,IAAjB,CAAsBtI,WAAW2H,CAAX,CAAtB;AACAgB,0BAAkBL,IAAlB,CAAuB,KAAKQ,iBAAL,CAAuBnF,OAAvB,EAAgCgE,CAAhC,CAAvB;AACD;AACD/I,iBAAW+J,iBAAX,EAA8BlH,IAA9B,CAAmClD,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASqH,OAAT,EAAkB;AACpE,aAAI,IAAIpB,IAAI,CAAZ,EAAeA,IAAIoB,QAAQvG,MAA3B,EAAmCmF,GAAnC,EAAwC;AACtC,eAAKqB,2BAAL,CAAiCD,QAAQpB,CAAR,CAAjC;AACD;AACF,OAJkC,CAAnC,EAIIpJ,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS4B,GAAT,EAAc;AACjCC,gBAAQC,KAAR,CAAcF,GAAd;AACD,OAFG,CAJJ;AAOD,KAxZ0D;;AA0Z3D2F,+BAA2B,qCAAW;AAAE;AACtC,UAAI,KAAKxJ,kBAAL,CAAwB+C,MAAxB,GAAiC,CAArC,EAAwC;AACtC/D,cAAMyK,OAAN,CAAc,KAAKzJ,kBAAnB,EAAuClB,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASyH,gBAAT,EAA2B;AACjF,cAAI,CAAC,KAAKZ,iBAAL,CAAuBY,iBAAiBX,EAAxC,CAAL,EAAkD;AAChD,iBAAKjJ,WAAL,CAAiB+I,IAAjB,CAAsBa,gBAAtB;AACD;AACF,SAJsC,CAAvC;;AAMA,aAAK1J,kBAAL,GAA0B,EAA1B;AACD;AACF,KApa0D;;AAsa3DsI,uBAAmB,6BAAW;AAC5B,UAAIqB,MAAM,IAAIzK,QAAJ,EAAV;;AAEAQ,YAAMkK,2BAAN,CAAkC,KAAK7H,GAAvC,EAA4C,IAA5C,EAAkD,IAAlD,EACCC,IADD,CACMlD,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS1B,UAAT,EAAqB;AAC1C,aAAKT,WAAL,GAAmBS,UAAnB;AACA,aAAKiJ,yBAAL;;AAEA9J,cAAMmK,kCAAN,CAAyC,KAAK/J,WAA9C,EACGkC,IADH,CACQlD,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS6H,UAAT,EAAqB;AAC1C,eAAK/J,WAAL,GAAmB+J,UAAnB;;AAEA,cAAI,KAAKxJ,MAAL,IAAe,KAAKA,MAAL,CAAYC,UAA3B,IAAyC,KAAKD,MAAL,CAAYC,UAAZ,CAAuBwC,MAAvB,GAAgC,CAA7E,EAAgF;AAC9E;AACA;;AAEA,gBAAIgH,qBAAqBrK,MAAMsK,4BAAN,CAAmC,KAAKlK,WAAxC,CAAzB;AACA;AACA;AACAJ,kBAAMwF,KAAN,CAAY6E,kBAAZ,EAAgC,KAAKzJ,MAAL,CAAYC,UAA5C,EAAwD,IAAxD,EACEzB,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASgI,GAAT,EAAcC,GAAd,EAAmB;AAClC;AACA;;AAEA;AACA,kBAAI9F,YAAY,KAAK0E,iBAAL,CAAuBmB,IAAIlB,EAA3B,CAAhB;AACAkB,kBAAIrF,KAAJ,CAAUpE,MAAV,GAAmBd,MAAMsF,MAAN,CAAaC,+BAAb,CACjBgF,IAAIrF,KAAJ,CAAUpE,MADO,EAEjB4D,SAFiB,CAAnB;AAIA;AACA6F,kBAAIrJ,IAAJ,GAAWsJ,IAAItJ,IAAf;AACAqJ,kBAAIxD,eAAJ,GAAsByD,IAAIzD,eAA1B;AACAwD,kBAAI/I,SAAJ,GAAgBgJ,IAAIhJ,SAApB;AACA+I,kBAAItE,YAAJ,GAAmBuE,IAAIvE,YAAvB;AACAsE,kBAAIrF,KAAJ,CAAU5D,GAAV,GAAgBkJ,IAAItF,KAAJ,CAAU5D,GAA1B;AACA,kBAAIlC,KAAKqL,SAAL,CAAe,qBAAf,EAAsC,KAAtC,EAA6CF,GAA7C,KACFnL,KAAKqL,SAAL,CAAe,qBAAf,EAAsC,KAAtC,EAA6CD,GAA7C,CADF,EACqD;AACnDxK,sBAAMwF,KAAN,CAAY+E,IAAIrF,KAAJ,CAAUpE,MAAtB,EAA8B0J,IAAItF,KAAJ,CAAUpE,MAAxC,EAAgD,MAAhD,EAAwD,UAAS2E,CAAT,EAAYC,CAAZ,EAAe;AACrEtG,uBAAKuG,KAAL,CAAWF,CAAX,EAAcC,CAAd;AACD,iBAFD;AAGA6E,oBAAIrF,KAAJ,CAAUpE,MAAV,GAAmBd,MAAM4F,aAAN,CACjB2E,IAAIrF,KAAJ,CAAUpE,MADO,EACC0J,IAAItF,KAAJ,CAAUpE,MADX,EACmB,MADnB,CAAnB;AAED,eAPD,MAOO;AACLyJ,oBAAIrF,KAAJ,CAAUpE,MAAV,GAAmB0J,IAAItF,KAAJ,CAAUpE,MAA7B;AACD;AACF,aA1BD,CADF;;AA6BA,iBAAKF,MAAL,CAAYC,UAAZ,GAAyBwJ,kBAAzB;;AAEA,iBAAK7J,sBAAL,CAA4BkK,UAA5B,GAAyC,IAAzC;AACA,iBAAKlK,sBAAL,CAA4BoE,UAA5B,GAAyC,KAAK+F,4BAAL,CACvC,KAAK/J,MAAL,CAAYC,UAD2B,CAAzC;;AAIAoJ,gBAAIW,OAAJ,CAAYP,kBAAZ;AACD,WA5CD,MA4CO;AACL;AACA;AACA,iBAAK7J,sBAAL,CAA4BkK,UAA5B,GAAyC,KAAzC;AACA,iBAAKlK,sBAAL,CAA4BoE,UAA5B,GAAyC,KAAK+F,4BAAL,CACvC,KAAKvK,WADkC,CAAzC;;AAIA,gBAAIyK,mBAAmB7K,MAAMsK,4BAAN,CAAmCzJ,UAAnC,CAAvB;AACA;AACA;AACAgK,+BAAmBvL,MAAM+C,GAAN,CAAUwI,gBAAV,EACjBzL,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASuI,eAAT,EAA0B;AACzC,kBAAI3F,cAAc/F,KAAKqL,SAAL,CAAe,cAAf,EAA+B,KAA/B,EAAsCK,eAAtC,CAAlB;AACA,kBAAIpG,YAAY,KAAK0E,iBAAL,CAAuB0B,gBAAgBzB,EAAvC,CAAhB;AACA,kBAAGlE,WAAH,EAAgB;AACdA,8BAAcnF,MAAMsF,MAAN,CAAaC,+BAAb,CACZuF,gBAAgB5F,KAAhB,CAAsBpE,MADV,EAEZ4D,SAFY,CAAd;AAIAoG,gCAAgB5F,KAAhB,CAAsBpE,MAAtB,GAA+BqE,WAA/B;AACD;AACD,qBAAO2F,eAAP;AACH,aAXC,CADiB,CAAnB;AAaAb,gBAAIW,OAAJ,CAAYC,gBAAZ;AACD;AACF,SAzEK,CADR,EA0EM,UAAS1G,GAAT,EAAc;AAChBC,kBAAQC,KAAR,CAAcF,GAAd;AACA8F,cAAIc,MAAJ,CAAW5G,GAAX;AACD,SA7EH;AA8ED,OAlFK,CADN,EAmFI/E,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS4B,GAAT,EAAc;AACjCC,gBAAQC,KAAR,CAAcF,GAAd;AACA8F,YAAIc,MAAJ,CAAW5G,GAAX;AACD,OAHG,CAnFJ;AAuFA,aAAO8F,GAAP;AACD,KAjgB0D;;AAmgB3DU,kCAA8B,sCAAS9J,UAAT,EAAqB;AACjD,UAAImK,2BAA2B,EAA/B;AACA1L,YAAMyK,OAAN,CAAclJ,UAAd,EAA0BzB,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASmC,SAAT,EAAoB;AAC7D,YAAIuG,aAAa,KAAKC,wBAAL,CAA8BxG,UAAU2E,EAAxC,CAAjB;AACA;AACA,YAAI4B,cAAc,CAACA,WAAWE,cAA9B,EAA8C;AAC5CH,mCAAyB7B,IAAzB,CAA8BzE,UAAU3D,IAAV,IAAkB2D,UAAU1D,KAA1D;AACD;AACF,OANyB,CAA1B;AAOA,aAAOgK,wBAAP;AACD,KA7gB0D;;AA+gB3DnC,WAAO,eAAShI,UAAT,EAAqB;AAC1B,UAAIuK,2BAA2B,EAA/B;AACA,UAAI5B,oBAAoB,EAAxB;;AAEA,WAAK,IAAIhB,IAAI,CAAb,EAAgBA,IAAI3H,WAAWwC,MAA/B,EAAuCmF,GAAvC,EAA4C;AAC1C,YAAItH,OAAOL,WAAW2H,CAAX,EAActH,IAAd,IAAsB,KAAKgK,wBAAL,CAA8BrK,WAAW2H,CAAX,EAAca,EAA5C,EAAgD8B,cAAjF;AACA,YAAI3G,UAAU;AACZnD,iBAAOR,WAAW2H,CAAX,EAAczH,IAAd,IAAsBF,WAAW2H,CAAX,EAAcxH,KAD/B;AAEZM,eAAKT,WAAW2H,CAAX,EAActD,KAAd,CAAoB5D,GAFb;AAGZ0C,iBAAO,KAAKwE,CAHA;AAIZtH,gBAAMA,IAJM;AAKZmK,mBAAS;AACPvK,oBAAQD,WAAW2H,CAAX,EAActD,KAAd,CAAoBpE,MADrB;AAEPwK,2BAAezK,WAAW2H,CAAX,EAAchH;AAFtB,WALG;AASZyE,wBAAcpF,WAAW2H,CAAX,EAAcvC,YAThB;AAUZc,2BAAiB,CAAC,CAAClG,WAAW2H,CAAX,EAAczB;AAVrB,SAAd;AAYA,aAAK5G,eAAL,CAAqBgJ,IAArB,CAA0BtI,WAAW2H,CAAX,EAActD,KAAd,CAAoBpE,MAA9C;AACA0I,0BAAkBL,IAAlB,CAAuB,KAAKQ,iBAAL,CAAuBnF,OAAvB,EAAgCgE,CAAhC,CAAvB;;AAEA,YAAI,KAAKhI,sBAAL,CAA4BkK,UAAhC,EAA4C;AAC1C,cAAI/F,cAAc,KAAKnE,sBAAL,CAA4BoE,UAA9C;AACA,cAAI2G,eAAe5G,eAChBA,YAAYG,OAAZ,CAAoBjE,WAAW2H,CAAX,EAAczH,IAAd,IAAsBF,WAAW2H,CAAX,EAAcxH,KAAxD,IAAiE,CAAC,CADrE;AAEA,cAAIH,WAAW2H,CAAX,EAActH,IAAd,IAAsBqK,YAA1B,EAAwC;AACtCH,qCAAyBjC,IAAzB,CAA8BtI,WAAW2H,CAAX,EAAczH,IAAd,IAAsBF,WAAW2H,CAAX,EAAcxH,KAAlE;AACD;AACF;AACF;AACDvB,iBAAW+J,iBAAX,EAA8BlH,IAA9B,CAAmClD,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASqH,OAAT,EAAkB;AACpE,aAAI,IAAIpB,IAAI,CAAZ,EAAeA,IAAIoB,QAAQvG,MAA3B,EAAmCmF,GAAnC,EAAwC;AACtC,eAAKqB,2BAAL,CAAiCD,QAAQpB,CAAR,CAAjC;AACD;AACF,OAJkC,CAAnC,EAIIpJ,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS4B,GAAT,EAAc;AACjCC,gBAAQC,KAAR,CAAcF,GAAd;AACD,OAFG,CAJJ;;AAQA,UAAI,KAAK3D,sBAAL,CAA4BkK,UAA5B,IAA0CU,yBAAyB/H,MAAzB,GAAkC,CAAhF,EAAmF;AACjF,YAAIxD,OAAJ,CAAY;AACV2D,mBAAS,KAAKvC,GAAL,CAASuK,oBAAT,GAAgC,UAAhC,GACPJ,yBAAyBK,QAAzB;AAFQ,SAAZ;AAID;;AAED,UAAI,KAAK7K,MAAL,CAAY8K,gBAAhB,EAAkC;AAChC,aAAKC,SAAL,CAAeC,OAAf;AACD,OAFD,MAEO;AACL,aAAKD,SAAL,CAAeE,KAAf;AACD;;AAED,UAAI,KAAKjL,MAAL,CAAYkL,eAAhB,EAAiC;AAC/B,aAAKC,MAAL,CAAYF,KAAZ;AACD,OAFD,MAEO;AACL,aAAKE,MAAL,CAAYH,OAAZ;AACD;;AAED;AACA;AACA,UAAI,KAAKI,kBAAL,EAAJ,EAA+B;AAC7B,YAAI,KAAKC,WAAT,EAAsB;AACpB,eAAKF,MAAL,CAAYF,KAAZ;AACD,SAFD,MAEO;AACL,eAAKE,MAAL,CAAYH,OAAZ;AACD;;AAED,aAAKG,MAAL,CAAYG,MAAZ,GAAqB,KAArB;AACA7M,aAAK8M,QAAL,CAAc,KAAKJ,MAAL,CAAY9J,OAA1B,EAAmC,kBAAnC;AACD;;AAED,UAAI,KAAKrB,MAAL,CAAYwL,iBAAhB,EAAmC;AACjC,aAAKA,iBAAL,CAAuBP,KAAvB;AACD,OAFD,MAEO;AACL,aAAKO,iBAAL,CAAuBR,OAAvB;AACD;;AAED,UAAI,KAAKhL,MAAL,CAAYyL,kBAAhB,EAAoC;AAClC,aAAKC,aAAL,CAAmBT,KAAnB;AACD,OAFD,MAEO;AACL,aAAKS,aAAL,CAAmBV,OAAnB;AACD;;AAED,UAAI,KAAKhL,MAAL,CAAY2L,cAAhB,EAAgC;AAC9B,aAAKxJ,mBAAL,CAAyB8I,KAAzB;AACD,OAFD,MAEO;AACL,aAAK9I,mBAAL,CAAyB6I,OAAzB;AACD;AACF,KAtmB0D;;AAwmB3D/B,iCAA6B,qCAASrF,OAAT,EAAkB;AAC7C,WAAK3C,kBAAL,CAAwB6G,MAAxB,CAA+BlE,OAA/B;AACD,KA1mB0D;;AA4mB3DmF,uBAAmB,2BAASnF,OAAT,EAAkBgI,UAAlB,EAA8B;AAC/C,UAAIvC,MAAK,IAAIzK,QAAJ,EAAT;;AAEA,UAAGgF,QAAQ6G,OAAR,IAAmB7G,QAAQ6G,OAAR,CAAgBvK,MAAtC,EAA8C;AAC5C0D,gBAAQhD,SAAR,GAAoB,KAAKiL,wBAAL,CAA8BjI,QAAQ6G,OAAtC,CAApB;AACApB,YAAIW,OAAJ,CAAYpG,OAAZ;AACD,OAHD,MAGO;AACL,aAAKP,eAAL,CAAqBuI,UAArB,EAAiClK,IAAjC,CAAsClD,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAASzB,MAAT,EAAiB;AACtE,cAAG0D,QAAQ6G,OAAX,EAAoB;AAClB7G,oBAAQ6G,OAAR,CAAgBvK,MAAhB,GAAyBA,MAAzB;AACD,WAFD,MAEO;AACL0D,oBAAQ6G,OAAR,GAAkB,EAAE,UAAUvK,MAAZ,EAAlB;AACD;AACD0D,kBAAQhD,SAAR,GAAoB,KAAKiL,wBAAL,CAA8BjI,QAAQ6G,OAAtC,CAApB;AACApB,cAAIW,OAAJ,CAAYpG,OAAZ;AACD,SARqC,CAAtC,EAQIpF,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS4B,GAAT,EAAc;AACjCC,kBAAQC,KAAR,CAAcF,GAAd;AACA8F,cAAIc,MAAJ,CAAW5G,GAAX;AACD,SAHG,CARJ;AAYD;;AAED,aAAO8F,GAAP;AACD,KAloB0D;;AAooB3DwC,8BAA0B,kCAASC,UAAT,EAAqB;AAC7C,UAAG,EAAEA,cAAcA,WAAW5L,MAAzB,IAAmC6L,MAAMC,OAAN,CAAcF,WAAW5L,MAAzB,CAArC,CAAH,EAA2E;;AAE3E,aAAOxB,MAAM+C,GAAN,CAAUqK,WAAW5L,MAArB,EAA6B,UAASsE,CAAT,EAAY;AAC9C,YAAIyH,SAAS;AACXtF,iBAAOnC,EAAErE,IADE;AAEXM,iBAAO+D,EAAEC;AAFE,SAAb;AAIA,YAAGqH,WAAWpB,aAAX,KAA6BlG,EAAErE,IAAlC,EAAwC;AACtC8L,iBAAOC,QAAP,GAAkB,IAAlB;AACD;AACD,YAAG1H,EAAErE,IAAF,CAAO+D,OAAP,CAAe,aAAf,MAAkC,CAArC,EAAwC;AACtC+H,iBAAOE,QAAP,GAAkB,IAAlB;AACD;AACD,eAAOF,MAAP;AACD,OAZM,CAAP;AAaD,KAppB0D;;AAspB3Db,wBAAoB,8BAAW;AAC7B,aAAO,KAAKgB,SAAL,IAAkB,CAAC,KAAKC,UAA/B;AACD,KAxpB0D;;AA0pB3D7D,uBAAmB,2BAAS8D,OAAT,EAAkB;AACnC,WAAK,IAAI1E,IAAI,CAAR,EAAW2E,MAAM,KAAK/M,WAAL,CAAiBiD,MAAvC,EAA+CmF,IAAI2E,GAAnD,EAAwD3E,GAAxD,EAA6D;AAC3D,YAAI,KAAKpI,WAAL,CAAiBoI,CAAjB,EAAoBa,EAApB,KAA2B6D,OAA/B,EAAwC;AACtC,iBAAO,KAAK9M,WAAL,CAAiBoI,CAAjB,CAAP;AACD;AACF;AACF,KAhqB0D;;AAkqB3D0C,8BAA0B,kCAASgC,OAAT,EAAkB;AAC1C,WAAK,IAAI1E,IAAI,CAAR,EAAW2E,MAAM,KAAK9M,WAAL,CAAiBgD,MAAvC,EAA+CmF,IAAI2E,GAAnD,EAAwD3E,GAAxD,EAA6D;AAC3D,YAAI,KAAKnI,WAAL,CAAiBmI,CAAjB,EAAoBa,EAApB,KAA2B6D,OAA/B,EAAwC;AACtC,iBAAO,KAAK7M,WAAL,CAAiBmI,CAAjB,CAAP;AACD;AACF;AACF,KAxqB0D;;AA0qB3D4E,eAAW,qBAAW;AACpB,UAAIhK,OAAO,KAAKvB,kBAAL,CAAwByF,OAAxB,EAAX;AACA,UAAIX,QAAQ,EAAZ;AACA,UAAIwG,MAAM/J,KAAKC,MAAf;AACA,UAAI,KAAKzC,MAAL,IAAe,KAAKA,MAAL,CAAYC,UAA3B,IAAyC,KAAKD,MAAL,CAAYC,UAAZ,CAAuBwC,MAAvB,GAAgC,CAA7E,EAAgF;AAC9E/D,cAAMyK,OAAN,CAAc3G,IAAd,EAAoBhE,KAAKmD,KAAL,CAAW,IAAX,EAAiB,UAAS8K,KAAT,EAAgB5I,GAAhB,EAAqB;AACxD4I,kBAAQA,KAAR,CADwD,CACzC;AACf,cAAIC,QAAQ,KAAK1M,MAAL,CAAYC,UAAZ,CAAuB4D,GAAvB,CAAZ;AACA,cAAI8I,OAAO,EAAX;;AAEAA,eAAKxM,IAAL,GAAYuM,MAAMvM,IAAN,IAAcuM,MAAMtM,KAAhC,CALwD,CAKjB;AACvCuM,eAAKlE,EAAL,GAAUiE,MAAMjE,EAAhB;AACAkE,eAAKrI,KAAL,GAAa,EAAb;AACAqI,eAAKrI,KAAL,CAAW5D,GAAX,GAAiB8B,KAAKqB,GAAL,EAAUnD,GAA3B;AACAiM,eAAKrI,KAAL,CAAWpE,MAAX,GAAoB,KAAKX,eAAL,CAAqBsE,GAArB,CAApB;AACA8I,eAAKrM,IAAL,GAAYkC,KAAKqB,GAAL,EAAUvD,IAAtB;AACAqM,eAAKxG,eAAL,GAAuB3D,KAAKqB,GAAL,EAAUsC,eAAjC;AACAwG,eAAK/L,SAAL,GAAiB4B,KAAKqB,GAAL,EAAUjD,SAA3B;AACA+L,eAAKtH,YAAL,GAAoB7C,KAAKqB,GAAL,EAAUwB,YAA9B;AACAU,gBAAMwC,IAAN,CAAWoE,IAAX;AACD,SAfmB,CAApB;AAgBD,OAjBD,MAiBO;AACL,aAAK,IAAI/E,IAAI,CAAb,EAAgBA,IAAI2E,GAApB,EAAyB3E,GAAzB,EAA8B;AAC5B,cAAI+E,OAAO,EAAX;AACAA,eAAKxM,IAAL,GAAY,KAAKX,WAAL,CAAiBoI,CAAjB,EAAoBzH,IAApB,IAA4B,KAAKX,WAAL,CAAiBoI,CAAjB,EAAoBxH,KAA5D,CAF4B,CAEuC;AACnEuM,eAAKlE,EAAL,GAAU,KAAKjJ,WAAL,CAAiBoI,CAAjB,EAAoBa,EAA9B;AACAkE,eAAKrI,KAAL,GAAa,EAAb;AACAqI,eAAKrI,KAAL,CAAW5D,GAAX,GAAiB8B,KAAKoF,CAAL,EAAQlH,GAAzB;AACAiM,eAAKrI,KAAL,CAAWpE,MAAX,GAAoB,KAAKX,eAAL,CAAqBqI,CAArB,CAApB;AACA+E,eAAKrM,IAAL,GAAYkC,KAAKoF,CAAL,EAAQtH,IAApB;AACAqM,eAAKxG,eAAL,GAAuB3D,KAAKoF,CAAL,EAAQzB,eAA/B;AACAwG,eAAK/L,SAAL,GAAiB4B,KAAKoF,CAAL,EAAQhH,SAAzB;AACA+L,eAAKtH,YAAL,GAAoB7C,KAAKoF,CAAL,EAAQvC,YAA5B;AACAU,gBAAMwC,IAAN,CAAWoE,IAAX;AACD;AACF;;AAGD,WAAK3M,MAAL,CAAYC,UAAZ,GAAyB8F,KAAzB;AACA,WAAK/F,MAAL,CAAY8K,gBAAZ,GAA+B,CAAC,KAAKC,SAAL,CAAenE,QAAf,EAAhC;AACA,WAAK5G,MAAL,CAAYwL,iBAAZ,GAAgC,KAAKA,iBAAL,CAAuB5E,QAAvB,EAAhC;AACA,WAAK5G,MAAL,CAAYyL,kBAAZ,GAAiC,KAAKC,aAAL,CAAmB9E,QAAnB,EAAjC;AACA,WAAK5G,MAAL,CAAY2L,cAAZ,GAA6B,KAAKxJ,mBAAL,CAAyByE,QAAzB,EAA7B;;AAEA,UAAI,CAAC,KAAKwE,kBAAL,EAAL,EAAgC;AAC9B,aAAKpL,MAAL,CAAYkL,eAAZ,GAA8B,KAAKC,MAAL,CAAYvE,QAAZ,EAA9B;AACD,OA9CmB,CA8CnB;;AAED,aAAO,KAAK5G,MAAZ;AACD,KA3tB0D;;AA6tB3DqC,4BAAwB,gCAASuK,UAAT,EAAqB;AAC3C,UAAG,CAAC,KAAK3L,kBAAT,EAA6B;;AAE7BnC,YAAM,sBAAN,EAA8BqK,OAA9B,CAAsC,UAAS0D,SAAT,EAAoB;AACxD,YAAIC,aAAa/N,SAASoG,MAAT,CAAgB0H,SAAhB,CAAjB;AACAC,mBAAWC,SAAX,CAAqB,CAACH,UAAtB;AACD,OAHD;AAID;AApuB0D,GAAtD,CAAP;AAsuBD,CA5wBH","file":"Setting.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright © Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n    'dojo/_base/declare',\r\n    'dijit/_WidgetsInTemplateMixin',\r\n    'jimu/BaseWidgetSetting',\r\n    'jimu/dijit/SimpleTable',\r\n    'dojo/_base/lang',\r\n    'dojo/_base/html',\r\n    'dojo/_base/array',\r\n    'dojo/on',\r\n    'dojo/Deferred',\r\n    'dojo/promise/all',\r\n    \"dojo/query\",\r\n    \"dijit/registry\",\r\n    \"jimu/dijit/Popup\",\r\n    \"jimu/dijit/Message\",\r\n    \"jimu/dijit/CheckBox\",\r\n    \"jimu/dijit/LoadingShelter\",\r\n    \"../utils\"\r\n  ],\r\n  function(\r\n    declare,\r\n    _WidgetsInTemplateMixin,\r\n    BaseWidgetSetting,\r\n    Table,\r\n    lang,\r\n    html,\r\n    array,\r\n    on,\r\n    Deferred,\r\n    promiseAll,\r\n    query,\r\n    registry,\r\n    Popup,\r\n    Message,\r\n    CheckBox,\r\n    LoadingShelter,\r\n    utils\r\n  ) {\r\n    return declare([BaseWidgetSetting, _WidgetsInTemplateMixin], {\r\n      //these two properties is defined in the BaseWidget\r\n      baseClass: 'jimu-widget-attributetable-setting',\r\n      currentFieldTable: null,\r\n      _allLayerFields: null,\r\n      // _allLayerHasAttachments: null,\r\n      //this.config.layerInfos is [configInfo], not [layerInfo]\r\n      _layerInfos: null,//[layerInfo]\r\n      _tableInfos: null,\r\n      _delayedLayerInfos: null,\r\n      _delayedLayerInfosAfterInit: null,\r\n      _unSpportQueryCampsite: null,\r\n\r\n      startup: function() {\r\n        this.inherited(arguments);\r\n        if (!this.config.layerInfos) {\r\n          this.config.layerInfos = [];\r\n        }\r\n        this._allLayerFields = [];\r\n        // this._allLayerHasAttachments = [];\r\n        this._layerInfos = [];\r\n        this._tableInfos = [];\r\n        this._delayedLayerInfos = [];\r\n        this._delayedLayerInfosAfterInit = [];\r\n        this._unSpportQueryCampsite = {};\r\n\r\n        var fields = [{\r\n          name: 'show',\r\n          title: this.nls.show,\r\n          width: 'auto',\r\n          type: 'checkbox',\r\n          'class': 'show'\r\n        }, {\r\n          name: 'label',\r\n          title: this.nls.label,\r\n          width: '60%',\r\n          type: 'text'\r\n        }, {\r\n          name: 'url',\r\n          title: this.nls.url,\r\n          type: 'text',\r\n          hidden: true\r\n        }, {\r\n          name: 'index',\r\n          title: 'index',\r\n          type: 'text',\r\n          hidden: true\r\n        }, {\r\n          name: 'sortField',\r\n          title: this.nls.sortField,\r\n          type: 'dropdown',\r\n          width: '130'          \r\n        }, {\r\n          name: 'isDescending',\r\n          title: '',\r\n          width: '40',\r\n          type: 'checkbox',\r\n          'class': 'sort-order'\r\n        }, {\r\n          name: 'actions',\r\n          title: this.nls.actions,\r\n          type: 'actions',\r\n          width: '20%',\r\n          actions: ['edit'],\r\n          'class': 'symbol'\r\n        }, {\r\n          name: 'showAttachments',\r\n          title: '',\r\n          type: 'checkbox',\r\n          hidden: true\r\n        }];\r\n\r\n        var args = {\r\n          fields: fields,\r\n          selectable: true,\r\n          autoHeight: false\r\n        };\r\n        this.displayFieldsTable = new Table(args);\r\n        this.displayFieldsTable.placeAt(this.tableLayerInfos);\r\n        html.setStyle(this.displayFieldsTable.domNode, {\r\n          'height': '100%'\r\n        });\r\n\r\n        this.shelter = new LoadingShelter({\r\n          hidden: true\r\n        });\r\n        this.shelter.placeAt(this.domNode.parentNode.parentNode || this.domNode);\r\n        this.shelter.startup();\r\n        this.shelter.show();\r\n\r\n        utils.readLayerInfosObj(this.map).then(lang.hitch(this, function(layerInfosObj) {\r\n          this.own(layerInfosObj.on(\r\n            'layerInfosChanged',\r\n            lang.hitch(this, this.onLayerInfosChanged)\r\n          ));\r\n\r\n          this.own(on(\r\n            this.displayFieldsTable,\r\n            'actions-edit',\r\n            lang.hitch(this, this.editFieldsClick)\r\n          ));\r\n          this.own(on(\r\n            this.displayFieldsTable,\r\n            'row-click',\r\n            lang.hitch(this, this._verifiedOnShowClick)\r\n          ));\r\n          this.own(on(\r\n            this.displayFieldsTable,\r\n            'row-add',\r\n            lang.hitch(this, function(tr) {\r\n              this._addTooltipToSortOrderNode(tr);\r\n            })\r\n          ));\r\n\r\n          this.own(on(\r\n            this.syncWithLayersCheck,\r\n            'change',\r\n            lang.hitch(this, function(checked) {\r\n              this._toggleTableShowOption(checked);\r\n            })\r\n          ));\r\n\r\n          this.setConfig(this.config);\r\n        }));\r\n      },\r\n\r\n      editFieldsClick: function(tr) {\r\n        var tds = query(\".action-item-parent\", tr);\r\n        var data;\r\n        if (tds && tds.length) {\r\n          data = this.displayFieldsTable.getRowData(tr);\r\n          if (!data.show) {\r\n            var popup = new Message({\r\n              message: this.nls.warning,\r\n              buttons: [{\r\n                label: this.nls.ok,\r\n                onClick: lang.hitch(this, function() {\r\n                  popup.close();\r\n                })\r\n              }]\r\n            });\r\n          } else {\r\n            var rowIndex = parseInt(data.index, 10);\r\n            this.shelter.show();\r\n            this._getLayerFields(rowIndex).then(lang.hitch(this, function(fields) {\r\n              this.openFieldsDialog(tr, fields, rowIndex);\r\n            }), lang.hitch(this, function(err) {\r\n              console.error(err);\r\n            })).always(lang.hitch(this, function() {\r\n              this.shelter.hide();\r\n            }));\r\n          }\r\n        }\r\n      },\r\n\r\n      _verifiedOnShowClick: function(tr) {\r\n        var rowData = this.displayFieldsTable.getRowData(tr);\r\n        var idx = parseInt(rowData.index, 10);\r\n        var layerInfo = null;\r\n        if (this.config && this.config.layerInfos && this.config.layerInfos.length > 0) {\r\n          layerInfo = this.config.layerInfos[idx];\r\n        } else {\r\n          layerInfo = this._layerInfos[idx];\r\n        }\r\n\r\n        var _layerNames = this._unSpportQueryCampsite.layerNames;\r\n        var unSupportQuery = _layerNames.indexOf(layerInfo.name || layerInfo.title) > -1;\r\n\r\n        if (rowData.show && unSupportQuery) {\r\n          new Message({\r\n            message: this.nls.unsupportQueryWarning\r\n          });\r\n\r\n          rowData.show = false;\r\n          this.displayFieldsTable.editRow(tr, rowData);\r\n        }\r\n      },\r\n\r\n      _getLayerFields: function(rowIndex) {\r\n        return this._layerInfos[rowIndex]\r\n        .getLayerObject()\r\n        .then(lang.hitch(this, function(layer) {\r\n          var fields = this._allLayerFields[rowIndex];\r\n          var layerFields = array.map(layer.fields, function(f) {\r\n            return {\r\n              name: f.name,\r\n              alias: f.alias,\r\n              show: true\r\n            };\r\n          });\r\n          layerFields = utils.arcade.appendArcadeExpressionsToFields(\r\n            layerFields, \r\n            this._layerInfos[rowIndex]\r\n          );\r\n          utils.merge(layerFields, fields, 'name', function(d, s) {\r\n            lang.mixin(d, s);\r\n          });\r\n          layerFields = utils.syncOrderWith(layerFields, fields, 'name');\r\n          return layerFields;\r\n        }));\r\n      },\r\n\r\n      _addTooltipToSortOrderNode: function(tr) {\r\n        var dom = query('.sort-order .jimu-checkbox', tr)[0];\r\n        var dijit = registry.byNode(dom);\r\n        var nls = this.nls;\r\n        var updateTooltip = function(isDescending) {\r\n          if(isDescending) {\r\n            dom.title = nls.sortOrderTooltips.toAscending;\r\n          } else {\r\n            dom.title = nls.sortOrderTooltips.toDescending;\r\n          }\r\n        };\r\n        if(dijit) {\r\n          this.own(on(dijit, 'change', updateTooltip));\r\n          updateTooltip(dijit.checked);\r\n        }\r\n      },     \r\n\r\n      openFieldsDialog: function(tr, fields, idx) {\r\n        /*jshint unused:false*/\r\n        var defaultHasAttachment = false;\r\n        var layerInfo = this._layerInfos[idx];\r\n        var layerObject = layerInfo && layerInfo.layerObject;\r\n        if(layerObject){\r\n          defaultHasAttachment = layerObject.hasAttachments && layerObject.objectIdField;\r\n        }\r\n\r\n        var content = html.create(\"div\");\r\n        var table = this._createFieldsTable(fields, idx);\r\n        html.place(table.domNode, content);\r\n\r\n        var cbx = null;\r\n        if(defaultHasAttachment){\r\n          cbx = new CheckBox({\r\n            label: this.nls.showAttachments,\r\n            style: 'margin-top:10px;'\r\n          });\r\n          var rowData = this.displayFieldsTable.getRowData(tr);\r\n          cbx.setValue(rowData.showAttachments);\r\n          //cbx.setValue(this._allLayerHasAttachments[idx]);\r\n          cbx.placeAt(content);\r\n        }\r\n\r\n        this.currentFieldTable = table;\r\n        var maxHeight = 600;\r\n        if(cbx){\r\n          maxHeight = 640;\r\n        }\r\n\r\n        var fieldsPopup = new Popup({\r\n          titleLabel: this.nls.configureLayerFields,\r\n          width: 640,\r\n          maxHeight: maxHeight,\r\n          autoHeight: true,\r\n          content: content,\r\n          buttons: [{\r\n            label: this.nls.ok,\r\n            onClick: lang.hitch(this, function() {\r\n              this._allLayerFields[idx] = table.getData();\r\n              var value = cbx ? cbx.getValue() : false;\r\n              this.displayFieldsTable.editRow(tr, {\r\n                showAttachments: value\r\n              });\r\n\r\n              fieldsPopup.close();\r\n              fieldsPopup = null;\r\n            })\r\n          }, {\r\n            label: this.nls.cancel,\r\n            classNames: ['jimu-btn-vacation'],\r\n            onClick: lang.hitch(this, function() {\r\n              fieldsPopup.close();\r\n              fieldsPopup = null;\r\n            })\r\n          }],\r\n          onClose: function() {\r\n            fieldsPopup = null;\r\n          }\r\n        });\r\n\r\n        table.startup();\r\n      },\r\n\r\n      _createFieldsTable: function(lFields) {\r\n        var fieldsTable = null;\r\n        var fields = [{\r\n          name: 'show',\r\n          title: this.nls.fieldVisibility,\r\n          type: 'checkbox',\r\n          'class': 'show',\r\n          onChange: lang.hitch(this, function(tr) {\r\n            var fields = fieldsTable.getData();\r\n            var atLeastOne = array.some(fields, lang.hitch(this, function(field) {\r\n              return field.show;\r\n            }));\r\n            if (!atLeastOne) {\r\n              new Message({\r\n                message: this.nls.fieldCheckWarning\r\n              });\r\n              var rowData = fieldsTable.getRowData(tr);\r\n              if (rowData) {\r\n                rowData.show = true;\r\n                fieldsTable.editRow(tr, rowData);\r\n              }\r\n            }\r\n          })\r\n        }, {\r\n          name: 'name',\r\n          title: this.nls.fieldName,\r\n          type: 'text'\r\n        }, {\r\n          name: 'alias',\r\n          title: this.nls.fieldAlias,\r\n          editable: true,\r\n          type: 'text'\r\n        }, {\r\n          name: 'actions',\r\n          title: this.nls.fieldActions,\r\n          type: 'actions',\r\n          actions: ['up', 'down'],\r\n          'class': 'symbol'\r\n        }];\r\n\r\n        var args = {\r\n          fields: fields,\r\n          selectable: true,\r\n          autoHeight: false,\r\n          style: {\r\n            'height': '300px',\r\n            'maxHeight': '300px'\r\n          }\r\n        };\r\n        fieldsTable = new Table(args);\r\n\r\n        for (var i = 0; i < lFields.length; i++) {\r\n          if (lFields[i].show === undefined) {\r\n            lFields[i].show = true;\r\n          } else {\r\n            lFields[i].show = !!lFields[i].show;\r\n          }\r\n\r\n          fieldsTable.addRow(lFields[i]);\r\n        }\r\n\r\n        return fieldsTable;\r\n      },\r\n\r\n      setConfig: function(config) {\r\n        this.config = config;\r\n        this.displayFieldsTable.clear();\r\n        this._allLayerFields = [];\r\n\r\n        this._processTableData().then(lang.hitch(this, function(layerInfos) {\r\n          this._init(layerInfos);\r\n          this.shelter.hide();\r\n        }), lang.hitch(this, function(err) {\r\n          new Message({\r\n            message: err.message || err\r\n          });\r\n        }));\r\n      },\r\n\r\n      onLayerInfosChanged: function(layerInfo, changeType, layerInfoSelf) {\r\n        if ('added' !== changeType || !layerInfoSelf || !layerInfo) {\r\n          return;\r\n        }\r\n        //GeoRss, kml,etc...\r\n        layerInfoSelf.getSupportTableInfo().then(lang.hitch(this, function(supportTableInfo) {\r\n          if (supportTableInfo.isSupportedLayer) {\r\n            if (this._layerInfos && this._layerInfos.length === 0) {\r\n              this._delayedLayerInfos.push(layerInfoSelf);\r\n            } else if (this._layerInfos && this._layerInfos.length > 0 &&\r\n              !this._getLayerInfoById(layerInfoSelf.id)) { // setting table complete\r\n              this._delayedLayerInfosAfterInit.push(layerInfoSelf);\r\n              this._processDelayedLayerInfosAfterInit(this._delayedLayerInfosAfterInit);\r\n            }\r\n          }\r\n        }));\r\n      },\r\n\r\n      // must be invoke after initialize this._layerInfos\r\n      _processDelayedLayerInfosAfterInit: function(layerInfos) {\r\n        var count = this._layerInfos.length;\r\n        var sortFieldRequests = [];\r\n\r\n        for (var i = 0; i < layerInfos.length; i++) {\r\n          var _configLayerInfo = utils.getConfigInfoFromLayerInfo(layerInfos[i]);\r\n          var show = _configLayerInfo.show,\r\n              sortField = _configLayerInfo.sortField;\r\n          var rowData = {\r\n            label: _configLayerInfo.name || _configLayerInfo.title,\r\n            url: _configLayerInfo.layer.url,\r\n            index: \"\" + (count + i),\r\n            isDescending: true,\r\n            show: show\r\n          };\r\n          this._allLayerFields.push(_configLayerInfo.layer.fields);\r\n          this._layerInfos.push(layerInfos[i]);\r\n          sortFieldRequests.push(this._prepareSortField(rowData, i));\r\n        }\r\n        promiseAll(sortFieldRequests).then(lang.hitch(this, function(results) {\r\n          for(var i = 0; i < results.length; i++) {\r\n            this._addRowToDisplayFieldsTable(results[i]);\r\n          }\r\n        }), lang.hitch(this, function(err) {\r\n          console.error(err);\r\n        }));\r\n      },\r\n\r\n      _processDelayedLayerInfos: function() { // must be invoke after initialize this._layerInfos\r\n        if (this._delayedLayerInfos.length > 0) {\r\n          array.forEach(this._delayedLayerInfos, lang.hitch(this, function(delayedLayerInfo) {\r\n            if (!this._getLayerInfoById(delayedLayerInfo.id)) {\r\n              this._layerInfos.push(delayedLayerInfo);\r\n            }\r\n          }));\r\n\r\n          this._delayedLayerInfos = [];\r\n        }\r\n      },\r\n\r\n      _processTableData: function() {\r\n        var def = new Deferred();\r\n\r\n        utils.readConfigLayerInfosFromMap(this.map, true, true)\r\n        .then(lang.hitch(this, function(layerInfos) {\r\n          this._layerInfos = layerInfos;\r\n          this._processDelayedLayerInfos();\r\n\r\n          utils.readSupportTableInfoFromLayerInfos(this._layerInfos)\r\n            .then(lang.hitch(this, function(tableInfos) {\r\n              this._tableInfos = tableInfos;\r\n\r\n              if (this.config && this.config.layerInfos && this.config.layerInfos.length > 0) {\r\n                // user has configured AT config before.\r\n                // settting page should sync with webmap\r\n\r\n                var configInfosFromMap = utils.getConfigInfosFromLayerInfos(this._layerInfos);\r\n                // we want to use configInfosFromMap as the new this.config.layerInfos\r\n                // but we need to use this.config.layerInfos to mixin into configInfosFromMap\r\n                utils.merge(configInfosFromMap, this.config.layerInfos, 'id',\r\n                  lang.hitch(this, function(mci, cli) {\r\n                    //mci short for map config layerInfo: layerInfo\r\n                    //cli short for config layer info: layerInfo\r\n\r\n                    // append arcade expression fields\r\n                    var layerInfo = this._getLayerInfoById(mci.id);\r\n                    mci.layer.fields = utils.arcade.appendArcadeExpressionsToFields(\r\n                      mci.layer.fields,\r\n                      layerInfo\r\n                    );\r\n                    // mci.name = cli.name;\r\n                    mci.show = cli.show;\r\n                    mci.showAttachments = cli.showAttachments;\r\n                    mci.sortField = cli.sortField;\r\n                    mci.isDescending = cli.isDescending;\r\n                    mci.layer.url = cli.layer.url;\r\n                    if (lang.getObject('layer.fields.length', false, mci) &&\r\n                      lang.getObject('layer.fields.length', false, cli)) {\r\n                      utils.merge(mci.layer.fields, cli.layer.fields, 'name', function(d, s) {\r\n                        lang.mixin(d, s);\r\n                      });\r\n                      mci.layer.fields = utils.syncOrderWith(\r\n                        mci.layer.fields, cli.layer.fields, 'name');\r\n                    } else {\r\n                      mci.layer.fields = cli.layer.fields;\r\n                    }\r\n                  }));\r\n\r\n                this.config.layerInfos = configInfosFromMap;\r\n\r\n                this._unSpportQueryCampsite.fromConfig = true;\r\n                this._unSpportQueryCampsite.layerNames = this._getUnsupportQueryLayerNames(\r\n                  this.config.layerInfos\r\n                );\r\n\r\n                def.resolve(configInfosFromMap);\r\n              } else {\r\n                // user has not configured AT config before.\r\n                // this.config.layerInfos is null.\r\n                this._unSpportQueryCampsite.fromConfig = false;\r\n                this._unSpportQueryCampsite.layerNames = this._getUnsupportQueryLayerNames(\r\n                  this._layerInfos\r\n                );\r\n\r\n                var configLayerInfos = utils.getConfigInfosFromLayerInfos(layerInfos);\r\n                // append arcade expression fields\r\n                // to each layerInfo object if it has any\r\n                configLayerInfos = array.map(configLayerInfos, \r\n                  lang.hitch(this, function(configLayerInfo) {\r\n                    var layerFields = lang.getObject('layer.fields', false, configLayerInfo);\r\n                    var layerInfo = this._getLayerInfoById(configLayerInfo.id);\r\n                    if(layerFields) {\r\n                      layerFields = utils.arcade.appendArcadeExpressionsToFields(\r\n                        configLayerInfo.layer.fields,\r\n                        layerInfo\r\n                      );\r\n                      configLayerInfo.layer.fields = layerFields;\r\n                    }\r\n                    return configLayerInfo;\r\n                }));\r\n                def.resolve(configLayerInfos);\r\n              }\r\n            }), function(err) {\r\n              console.error(err);\r\n              def.reject(err);\r\n            });\r\n        }), lang.hitch(this, function(err) {\r\n          console.error(err);\r\n          def.reject(err);\r\n        }));\r\n        return def;\r\n      },\r\n\r\n      _getUnsupportQueryLayerNames: function(layerInfos) {\r\n        var _unSpportQueryLayerNames = [];\r\n        array.forEach(layerInfos, lang.hitch(this, function(layerInfo) {\r\n          var _tableInfo = this._getSupportTableInfoById(layerInfo.id);\r\n          // TODO: need to get _tableInfo if layerInfo come from _processDelayedLayerInfosAfterInit\r\n          if (_tableInfo && !_tableInfo.isSupportQuery) {\r\n            _unSpportQueryLayerNames.push(layerInfo.name || layerInfo.title);\r\n          }\r\n        }));\r\n        return _unSpportQueryLayerNames;\r\n      },\r\n\r\n      _init: function(layerInfos) {\r\n        var unSupportQueryLayerNames = [];\r\n        var sortFieldRequests = [];\r\n\r\n        for (var i = 0; i < layerInfos.length; i++) {\r\n          var show = layerInfos[i].show && this._getSupportTableInfoById(layerInfos[i].id).isSupportQuery;\r\n          var rowData = {\r\n            label: layerInfos[i].name || layerInfos[i].title,\r\n            url: layerInfos[i].layer.url,\r\n            index: \"\" + i,\r\n            show: show,\r\n            sorting: {\r\n              fields: layerInfos[i].layer.fields,\r\n              selectedField: layerInfos[i].sortField\r\n            },\r\n            isDescending: layerInfos[i].isDescending,\r\n            showAttachments: !!layerInfos[i].showAttachments\r\n          };\r\n          this._allLayerFields.push(layerInfos[i].layer.fields);\r\n          sortFieldRequests.push(this._prepareSortField(rowData, i));\r\n\r\n          if (this._unSpportQueryCampsite.fromConfig) {\r\n            var _layerNames = this._unSpportQueryCampsite.layerNames;\r\n            var nowUnsupport = _layerNames &&\r\n              (_layerNames.indexOf(layerInfos[i].name || layerInfos[i].title) > -1);\r\n            if (layerInfos[i].show && nowUnsupport) {\r\n              unSupportQueryLayerNames.push(layerInfos[i].name || layerInfos[i].title);\r\n            }\r\n          }\r\n        }\r\n        promiseAll(sortFieldRequests).then(lang.hitch(this, function(results) {\r\n          for(var i = 0; i < results.length; i++) {\r\n            this._addRowToDisplayFieldsTable(results[i]);\r\n          }\r\n        }), lang.hitch(this, function(err) {\r\n          console.error(err);\r\n        }));\r\n\r\n        if (this._unSpportQueryCampsite.fromConfig && unSupportQueryLayerNames.length > 0) {\r\n          new Message({\r\n            message: this.nls.unsupportQueryLayers + \"<br><br>\" +\r\n              unSupportQueryLayerNames.toString()\r\n          });\r\n        }\r\n\r\n        if (this.config.hideExportButton) {\r\n          this.exportcsv.uncheck();\r\n        } else {\r\n          this.exportcsv.check();\r\n        }\r\n\r\n        if (this.config.initiallyExpand) {\r\n          this.expand.check();\r\n        } else {\r\n          this.expand.uncheck();\r\n        }\r\n\r\n        // if attribute table can use openAtStart,\r\n        // keep initiallyExpand same with openAtStart and keep checkbox read only.\r\n        if (this._canUseOpenAtStart()) {\r\n          if (this.openAtStart) {\r\n            this.expand.check();\r\n          } else {\r\n            this.expand.uncheck();\r\n          }\r\n\r\n          this.expand.status = false;\r\n          html.addClass(this.expand.domNode, 'disable-checkbox');\r\n        }\r\n\r\n        if (this.config.filterByMapExtent) {\r\n          this.filterByMapExtent.check();\r\n        } else {\r\n          this.filterByMapExtent.uncheck();\r\n        }\r\n\r\n        if (this.config.allowTextSelection) {\r\n          this.textSelection.check();\r\n        } else {\r\n          this.textSelection.uncheck();\r\n        }\r\n\r\n        if (this.config.syncWithLayers) {\r\n          this.syncWithLayersCheck.check();\r\n        } else {\r\n          this.syncWithLayersCheck.uncheck();\r\n        }\r\n      },\r\n\r\n      _addRowToDisplayFieldsTable: function(rowData) {\r\n        this.displayFieldsTable.addRow(rowData);\r\n      },\r\n\r\n      _prepareSortField: function(rowData, layerIndex) {\r\n        var def= new Deferred();\r\n\r\n        if(rowData.sorting && rowData.sorting.fields) {\r\n          rowData.sortField = this._prepareSortFieldOptions(rowData.sorting);\r\n          def.resolve(rowData);\r\n        } else {\r\n          this._getLayerFields(layerIndex).then(lang.hitch(this, function(fields) {\r\n            if(rowData.sorting) {\r\n              rowData.sorting.fields = fields;\r\n            } else {\r\n              rowData.sorting = { 'fields': fields };\r\n            }\r\n            rowData.sortField = this._prepareSortFieldOptions(rowData.sorting);\r\n            def.resolve(rowData);\r\n          }), lang.hitch(this, function(err) {\r\n            console.error(err);\r\n            def.reject(err);\r\n          }));\r\n        }  \r\n\r\n        return def;\r\n      },\r\n\r\n      _prepareSortFieldOptions: function(sortingObj) {\r\n        if(!(sortingObj && sortingObj.fields && Array.isArray(sortingObj.fields))) return;\r\n\r\n        return array.map(sortingObj.fields, function(f) {\r\n          var option = {\r\n            value: f.name,\r\n            label: f.alias\r\n          };\r\n          if(sortingObj.selectedField === f.name) {\r\n            option.selected = true;\r\n          }\r\n          if(f.name.indexOf('expression/') === 0) {\r\n            option.disabled = true;\r\n          }\r\n          return option;\r\n        });\r\n      },\r\n\r\n      _canUseOpenAtStart: function() {\r\n        return this.closeable || !this.isOnScreen;\r\n      },\r\n\r\n      _getLayerInfoById: function(layerId) {\r\n        for (var i = 0, len = this._layerInfos.length; i < len; i++) {\r\n          if (this._layerInfos[i].id === layerId) {\r\n            return this._layerInfos[i];\r\n          }\r\n        }\r\n      },\r\n\r\n      _getSupportTableInfoById: function(layerId) {\r\n        for (var i = 0, len = this._tableInfos.length; i < len; i++) {\r\n          if (this._tableInfos[i].id === layerId) {\r\n            return this._tableInfos[i];\r\n          }\r\n        }\r\n      },\r\n\r\n      getConfig: function() {\r\n        var data = this.displayFieldsTable.getData();\r\n        var table = [];\r\n        var len = data.length;\r\n        if (this.config && this.config.layerInfos && this.config.layerInfos.length > 0) {\r\n          array.forEach(data, lang.hitch(this, function(tData, idx) {\r\n            tData = tData; // do nothing\r\n            var lInfo = this.config.layerInfos[idx];\r\n            var json = {};\r\n\r\n            json.name = lInfo.name || lInfo.title; // prevent mess code\r\n            json.id = lInfo.id;\r\n            json.layer = {};\r\n            json.layer.url = data[idx].url;\r\n            json.layer.fields = this._allLayerFields[idx];\r\n            json.show = data[idx].show;\r\n            json.showAttachments = data[idx].showAttachments;\r\n            json.sortField = data[idx].sortField;\r\n            json.isDescending = data[idx].isDescending;\r\n            table.push(json);\r\n          }));\r\n        } else {\r\n          for (var i = 0; i < len; i++) {\r\n            var json = {};\r\n            json.name = this._layerInfos[i].name || this._layerInfos[i].title; // prevent mess code\r\n            json.id = this._layerInfos[i].id;\r\n            json.layer = {};\r\n            json.layer.url = data[i].url;\r\n            json.layer.fields = this._allLayerFields[i];\r\n            json.show = data[i].show;\r\n            json.showAttachments = data[i].showAttachments;\r\n            json.sortField = data[i].sortField;\r\n            json.isDescending = data[i].isDescending;\r\n            table.push(json);\r\n          }\r\n        }\r\n\r\n\r\n        this.config.layerInfos = table;\r\n        this.config.hideExportButton = !this.exportcsv.getValue();\r\n        this.config.filterByMapExtent = this.filterByMapExtent.getValue();\r\n        this.config.allowTextSelection = this.textSelection.getValue();\r\n        this.config.syncWithLayers = this.syncWithLayersCheck.getValue();\r\n\r\n        if (!this._canUseOpenAtStart()) {\r\n          this.config.initiallyExpand = this.expand.getValue();\r\n        }// else never change the property.\r\n\r\n        return this.config;\r\n      },\r\n\r\n      _toggleTableShowOption: function(isDisabled) {\r\n        if(!this.displayFieldsTable) return;\r\n\r\n        query('.show .jimu-checkbox').forEach(function(checkNode) {\r\n          var checkDijit = registry.byNode(checkNode);\r\n          checkDijit.setStatus(!isDisabled);\r\n        });\r\n      }\r\n    });\r\n  });"]}