{"version":3,"sources":["../../../../widgets/AttributeTable/table/_FeatureTable.js"],"names":["define","declare","html","_WidgetBase","Message","Filter","OnDemandGrid","Selection","ColumnHider","ColumnResizer","ColumnReorder","Keyboard","Menu","MenuItem","PopupMenuItem","Toolbar","Button","DropDownMenu","ToggleButton","DropDownButton","Deferred","when","Evented","touch","Memory","esriConfig","esriLang","esriRequest","RelationParameters","RelationshipQuery","FeatureLayer","QueryTask","Query","ProjectParameters","Multipoint","geometryEngine","normalizeUtils","esriId","lang","on","aspect","array","LoadingIndicator","FieldStatistics","Popup","CheckBox","SelectionManager","CSVUtils","jimuUtils","ArcadeUtils","tableUtils","query","string","topic","keys","has","baseClass","_defaultFeatureCount","_defaultBatchCount","_batchCount","_filterObj","_currentDef","_requestStatus","parent","map","matchingMap","layerInfo","configedInfo","footerHeight","layer","loading","grid","footer","selectedRowsLabel","selectionRows","nls","_dblClickResult","actived","showSelected","tableCreated","_relatedQuery","_relatedQueryIds","_selectionHandles","_selectionResults","_normalizedExtent","GRID_FAR_OFF_REMOVAL","DEFAULT","RESELECTION","Infinity","INFINITY","constructor","options","set","relatedOriginalInfo","relationship","syncSelection","postCreate","inherited","arguments","createToolbar","placeAt","domNode","selectionManager","getInstance","setAttr","getObject","get","own","root","release","hitch","_clickMap","window","_resize","_handleFilterChange","startup","toolbarHeight","parseInt","getStyle","toolbar","setLayerDefinition","definition","_layerDefinition","getLayerDefinition","_getLayerDifinition","getFilterableFields","cloned","clone","_getFilterableFields","fields","getFilterObj","setFilterObj","fObj","showRefreshing","isshow","_toggleLoading","active","deactive","cancelThread","cancel","canceledBySelf","isCanceled","create","menus","showSelectedRecordsMenuItem","label","showSelectedRecords","iconClass","onClick","toggleSelectedRecords","addChild","relationships","layerObject","subMenu","showRelatedRecordsMenuItem","showRelatedRecords","popup","length","relationshipInfos","r","getRelationShipInfo","forEach","relationshipInfo","duplicateTableCount","some","rInfo","name","onShowRelatedRecordsClick","filterMenuItem","filter","onFilterMenuItemClick","toggleColumnsMenuItem","columns","onToggleColumnsClick","hideExportButton","exportCSVMenuItem","exportFiles","showLabel","onExportCSVClick","selectionMenu","dropDown","matchingCheckBox","checked","filterByExtent","onChange","status","_onMatchingCheckBoxChange","zoomButton","zoomto","zoomTo","clearSelectionButton","clearSelection","refreshButton","refresh","place","publish","id","context","startQuery","queryByStoreObjectIds","_getLayerObject","then","extent","isTable","spatialReference","isWebMercator","normalizeDef","normalizeCentralMeridian","normalizedGeo","_extent","_doQuery","err","message","console","error","changeToolbarStatus","queryRecordsByRelationship","params","selectedIds","ship","prevShip","prevRelationship","isEqual","ofs","response","f","isDefined","show","type","objectIdField","arcade","isArcadeExpressionField","push","relatedQuery","objectIds","outFields","relationshipId","returnGeometry","geometryType","relatedDef","queryRelatedFeatures","relatedFeatures","results","displayFieldName","features","fieldAliases","featureIds","unique","rf","rfId","attributes","p","_set","destroy","tipNode","_removeTable","oFields","_getOutFieldsFromLayerInfos","queryExecute","toDom","noRelatedRecords","emit","getSelectedRows","_zoomToSelected","layerInfoId","showAllSelectedRecords","showAllRecords","selectedRows","relationshipObj","_getFeatureIds","log","fFields","widgetId","noFilterTip","style","featureLayerId","runtime","size","_getFilterPopupSize","_filterPopup","titleLabel","width","w","height","h","content","autoHeight","buttons","ok","partsObj","toJson","expr","close","setFilterTip","addClass","filterObj","filterOptions","url","layerDefinition","build","always","appInfo","isRunInMobile","innerWidth","innerHeight","resize","toggleColumns","richTextFields","_getRichTextFields","_getExportCSVPopupMessage","check","_check","className","exportToCSV","messageWrapper","document","createElement","appendChild","createTextNode","exportMessage","richTextInputWrapper","keepRichTextLabel","hintButton","href","role","whatsThis","evt","preventDefault","_getRichTextMessage","hasOwnProperty","_EXAMPLE","preview","withHTMLTags","withoutHTMLTags","messageHTML","richTextFieldsHTML","i","len","fieldName","substitute","richTextMessage","explanatoryText","line1","layerName","line2","line3","example","scenarios","first","second","innerHTML","pInfos","getPopupInfo","lFields","fieldInfos","rFields","lField","stringFieldOption","onSelectionComplete","getSelectedFeatures","_selectBySelf","_updateSelectRowsByFeatures","onSelectionClear","_setFarOffRemoval","isSupportQueryToServer","_relatedDef","isFulfilled","resDef","getRelatedTableInfoArray","tableInfos","exportSelected","exportAll","isShowInMap","oid","ids","store","item","indexOf","_updateSelectRowsByIds","requery","clearSelectionSet","_closePopup","setSelectedNumber","fileName","richTextFieldsToClear","def","reject","getSelectedRowsData","datas","_exportData","isSameProjection","fullExtent","equals","hasArcadeExpressionFields","_hasArcadeExpressionFields","orderByFields","getSortbyFields","rows","_getTableSelectedIds","_selectedData","isSelectionMode","_queryOptions","Array","sort","field","optionArray","split","attribute","descending","_appendXY","viewInTableFlag","tabContainer","selectedChildWidget","viewInTableData","exportViewInTableData","data","_outFields","getOutFields","fromClient","withGeometry","formatNumber","formatDate","formatCodedValue","popupInfo","_getExportObjectIds","outSpatialReference","arcadeExpressions","expressionInfos","getFeatureLayerDefinition","geometry","_currentExtent","start","num","maxRecordCount","filterExpression","getFilter","exportCSVFromFeatureLayer","_toggleColumnHiderMenu","changeHeight","setStyle","hasLayerUrl","isCSVLayer","declaredClass","isStreamLayer","isSupportQueryOnClient","_destroyed","sh","remove","oidField","every","sr","select","sg","infoWindow","getSelectedFeature","hasSG","sameLayer","_layer","hide","objectDef","getLayerObject","bindSelectionEvents","flayer","resolve","handleAs","callbackParamName","cFields","lf","cf","mixin","exportIds","object","normalizedExtent","pk","_queryToServer","_queryOnClient","json","getLatestObservations","graphics","feature","wabIsTemp","liFields","_pk","geometries","defaults","geometryService","sr1","sr2","g","intersects","geometries1","geometries2","relation","SPATIAL_REL_INTERSECTION","relationDef","pairs","n","gs","m","geometry1Index","_getFeatureCount","recordCounts","_queryFeatureLayer","currentLayer","maxCount","Math","min","_recordCounts","supportsPagination","advancedQueryCapabilities","_objectIds","qt","where","_getLayerFilterExpression","join","countDef","executeForCount","count","exceededLimit","hasArcadeExpressionWithGeometry","_hasArcadeExpressionWithGeometry","oNames","spatialRelationship","SPATIAL_REL_INTERSECTS","taskDef","execute","returnIdsOnly","_orderByFields","idsDef","executeForIds","nExtent","_processExecuteFields","generateCacheStore","c","generateMemoryStore","_typeIdFild","typeIdField","_types","types","supportOrder","supportPage","supportStatistics","getExpressionInfosFromLayerInfo","expressionCache","compileExpressions","generateColumnsFromFields","hasAttachments","showAttachments","attachmentsColumn","formatAttachmentsColumn","autoWidth","getMarginBox","createTable","selectionHandleOnHeader","querySelectorAll","setAttribute","selectedFeatures","column","attachments","hidden","unhidable","sortable","_cache","statistics","renderCell","obj","v","node","queryAttachmentInfos","infos","liTemplates","ainfo","isImage","test","fileType","credential","findCredential","attachmentUrl","token","filesNls","files","template","templateDom","showAttachmentsDiv","target","valid","hasClass","oldVisibleAttachmentPopup","_visibleAttachmentPopup","attachmentPopup","toggleClass","autoWidthMode","gridLoadingIndicator","keepScrollPosition","farOffRemoval","pagingDelay","allowTextSelection","deselectOnRefresh","loadingMessage","outerHTML","minRowsPerPage","maxRowsPerPage","selectionMode","demands","ownerDocument","shiftKey","_setAllowTextSelection","keyCode","SHIFT","META","CTRL","once","_onHeaderClick","_onColumnStateChange","_onSelectionHandleClick","e","ENTER","SPACE","_onDblclickRow","inMap","getLayer","_onFeaturelayerClick","sortField","isDescending","getParent","scroller","header","scrollerStyle","getComputedStyle","headerBox","smt","marginTop","isFinite","removeClass","empty","tabindex","_footer","countLabel","records","selected","display","_export_count","_entityData","d","_x","x","_y","y","isSelectedData","_getVisibleFields","alias","format","_ids","currentViewCount","oids","_setSelection","result","setSelection","_zoomToExtentByFeatures","getExtent","gExtent","numLevels","getNumLevels","currentLevel","getLevel","last","getMaxZoom","factor","targetLevel","centerAndZoom","pow","setExtent","expand","_showMapInfoWindowByFeatures","layerInfoTemplate","isPopupEnabled","getInfoTemplate","setFeatures","setInfoTemplate","location","getCenter","closetFirst","syncWithMapInfowindow","selectFeatures","method","graphicsExtent","featureSet","toFeatureSet","onMapZoomOrPan","zoomToFeatureSet","onFeatureSelectionChange","_popupMessage","dataNotAvailable","monitor","isArray","after","selectedSg","index","getGraphicsFromLocalFeatureLayer","idsi","objectid","points","Error","addPoint","union","parameter","outSR","project","fromPopup","graphic","_getIndexOfIdInGrid","dataIndex","scrollTo","rowHeight","compare","attr","des","a","b","queryCount","_goToFeatures","localGraphics","_queryFeaturesByIds","row","mode","queryTask","fset","_errorSelectFeatures","SELECTION_NEW","cell","cellBoundingRect","element","getBoundingClientRect","coords","pageX","pageY","_showColumnMenu","info","cm","that","labelArray","sortAsc","sortDes","iconArray","idx","menuItem","statInfo","fieldNames","_getSelectedIds","fieldStatistics","showContentAsPopup","childCount","getChildren","_openMyself","delegatedTarget","iframe","menu","destroyRecursive","table","_onExtentChange","really","levelChange","abs","layerFilter","visible","j","hiddenFields","columnField","oField","selection","parsedExpressions","parseArcadeExpressions","Object","usesGeometry","undefined","isHidden","number","isNaN","selectionIds","queryParams","filterIds","_isLayerNeedDisplayLayer","_updateDisplayLayer"],"mappings":"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","file":"_FeatureTable.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright © Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\ndefine([\r\n  'dojo/_base/declare',\r\n  'dojo/_base/html',\r\n  'dijit/_WidgetBase',\r\n  'jimu/dijit/Message',\r\n  'jimu/dijit/Filter',\r\n  \"dgrid/OnDemandGrid\",\r\n  \"../dgrid/Selection\", // use custom Selection\r\n  \"dgrid/extensions/ColumnHider\",\r\n  \"dgrid/extensions/ColumnResizer\",\r\n  \"dgrid/extensions/ColumnReorder\",\r\n  'dgrid/Keyboard',\r\n  \"dijit/Menu\",\r\n  \"dijit/MenuItem\",\r\n  \"dijit/PopupMenuItem\",\r\n  'dijit/Toolbar',\r\n  'dijit/form/Button',\r\n  'dijit/DropDownMenu',\r\n  'dijit/form/ToggleButton',\r\n  'dijit/form/DropDownButton',\r\n  \"dojo/Deferred\",\r\n  \"dojo/when\",\r\n  'dojo/Evented',\r\n  'dojo/touch',\r\n  \"dojo/store/Memory\",\r\n  \"esri/config\",\r\n  \"esri/lang\",\r\n  \"esri/request\",\r\n  \"esri/tasks/RelationParameters\",\r\n  \"esri/tasks/RelationshipQuery\",\r\n  // \"esri/layers/GraphicsLayer\",\r\n  \"esri/layers/FeatureLayer\",\r\n  \"esri/tasks/QueryTask\",\r\n  \"esri/tasks/query\",\r\n  \"esri/tasks/ProjectParameters\",\r\n  // \"esri/graphic\",\r\n  // \"esri/geometry/Point\",\r\n  \"esri/geometry/Multipoint\",\r\n  \"esri/geometry/geometryEngine\",\r\n  // \"esri/geometry/Polyline\",\r\n  // \"esri/geometry/Polygon\",\r\n  // \"esri/symbols/SimpleLineSymbol\",\r\n  // \"esri/symbols/SimpleFillSymbol\",\r\n  // \"esri/Color\",\r\n  \"esri/geometry/normalizeUtils\",\r\n  \"esri/IdentityManager\",\r\n  'dojo/_base/lang',\r\n  \"dojo/on\",\r\n  \"dojo/aspect\",\r\n  \"dojo/_base/array\",\r\n  'jimu/dijit/LoadingIndicator',\r\n  'jimu/dijit/FieldStatistics',\r\n  'jimu/dijit/Popup',\r\n  \"jimu/dijit/CheckBox\",\r\n  'jimu/SelectionManager',\r\n  'jimu/CSVUtils',\r\n  'jimu/utils',\r\n  \"jimu/ArcadeUtils\",\r\n  '../utils',\r\n  'dojo/query',\r\n  'dojo/string',\r\n  'dojo/topic',\r\n\t'dojo/keys',\r\n\t'dojo/has'\r\n], function(\r\n  declare,\r\n  html,\r\n  _WidgetBase,\r\n  Message,\r\n  Filter,\r\n  OnDemandGrid,\r\n  Selection,\r\n  ColumnHider,\r\n  ColumnResizer,\r\n  ColumnReorder,\r\n  Keyboard,\r\n  Menu,\r\n  MenuItem,\r\n  PopupMenuItem,\r\n  Toolbar,\r\n  Button,\r\n  DropDownMenu,\r\n  ToggleButton,\r\n  DropDownButton,\r\n  Deferred,\r\n  when,\r\n  Evented,\r\n  touch,\r\n  Memory,\r\n  esriConfig,\r\n  esriLang,\r\n  esriRequest,\r\n  RelationParameters,\r\n  RelationshipQuery,\r\n  // GraphicsLayer,\r\n  FeatureLayer,\r\n  QueryTask,\r\n  Query,\r\n  ProjectParameters,\r\n  // Graphic,\r\n  // Point,\r\n  Multipoint,\r\n  geometryEngine,\r\n  // Polyline,\r\n  // Polygon,\r\n  // SimpleLineSymbol,\r\n  // SimpleFillSymbol,\r\n  // Color,\r\n  normalizeUtils,\r\n  esriId,\r\n  lang,\r\n  on,\r\n  aspect,\r\n  array,\r\n  LoadingIndicator,\r\n  FieldStatistics,\r\n  Popup,\r\n  CheckBox,\r\n  SelectionManager,\r\n  CSVUtils,\r\n  jimuUtils,\r\n  ArcadeUtils,\r\n  tableUtils,\r\n  query,\r\n  string,\r\n  topic,\r\n  keys,\r\n  has\r\n) {\r\n  return declare([_WidgetBase, Evented], {\r\n    baseClass: 'jimu-widget-attributetable-feature-table',\r\n    _defaultFeatureCount: 2000, //default max records by one request\r\n    _defaultBatchCount: 25, //default records per page\r\n    _batchCount: 0,//records per page\r\n\r\n    _filterObj: null, // come from filter popup\r\n    _currentDef: null,\r\n    //initial: initial state\r\n    //processing: querying data\r\n    //canceled: stop querying data to save network brandwidth\r\n    //fullfilled: get the data\r\n    _requestStatus: 'initial', // initial, processing, canceled, fulfilled\r\n\r\n    parent: null,\r\n    map: null,\r\n    matchingMap: false,\r\n    layerInfo: null,\r\n    configedInfo: null,\r\n    // tableDisplayer: null,\r\n    // parentWidget: null,\r\n    footerHeight: 25,\r\n\r\n    layer: null, // layerInfo.layerObject\r\n    loading: null, // LoadingIndicator\r\n    grid: null, // dgrid\r\n    footer: null, // footer div\r\n    selectedRowsLabel: null, // selected div on footer\r\n    selectionRows: null, // id of rows was selected,[id]\r\n    // griaphicLayer: null,\r\n    nls: null,\r\n\r\n    //_layerDefinition: null,\r\n    // _filterObj: null,\r\n    _dblClickResult: null,// a feature which be zoom to and show pupup by double click row\r\n\r\n    actived: false, // tabcontent is selected\r\n    showSelected: false, // if true only show selected rows\r\n    tableCreated: false, // if true dgrid is created\r\n\r\n    // for queryRelatedIds\r\n    // it is set to true when click \"Show Related Records\" from another _FeatureTable\r\n    // If true, when click \"Show All Records\", it will be set to false and layerType will be changed\r\n    _relatedQuery: false,\r\n    _relatedQueryIds: null,//[originalFeatureLayerObjectId]\r\n\r\n    _selectionHandles: null,//save handles for selecion-complete event of FeatureLayer\r\n    _selectionResults: null,//[Feature], used for SelectionManager.selectFeatures()\r\n\r\n    _normalizedExtent: null,//normalized extent of the current layer's extent\r\n    //events:\r\n    //data-loaded//emit after one query requst is done, but maybe not get real features\r\n    //row-click\r\n    //clear-selection\r\n    //sort\r\n\r\n    //show-all-records\r\n    //show-selected-records\r\n    //show-related-records\r\n    //show-filter\r\n    //apply-filter\r\n    //toggle-columns\r\n    //export-csv\r\n    //zoom-to\r\n    //refresh\r\n\r\n    // CONSTS:\r\n    GRID_FAR_OFF_REMOVAL: {\r\n      DEFAULT: 2000,\r\n      RESELECTION: Infinity,\r\n      INFINITY: Infinity\r\n    },\r\n\r\n    constructor: function(options) {\r\n      options = options || {};\r\n      this.set('parent', options.parent || null);\r\n      this.set('map', options.map || null);\r\n      this.set('matchingMap', !!options.matchingMap);\r\n      this.set('layerInfo', options.layerInfo || null);\r\n      this.set('layer', options.layer || null);\r\n      this.set('configedInfo', options.configedInfo || null);\r\n\r\n      this.set('relatedOriginalInfo', options.relatedOriginalInfo || null);\r\n      this.set('relationship', options.relationship || null);\r\n      this.set('prevRelationship', null);\r\n\r\n      // syncSelection if true scroll record to view after click feature in map\r\n      this.set('syncSelection', !!options.syncSelection || true);\r\n    },\r\n\r\n    postCreate: function() {\r\n      this.inherited(arguments);\r\n      this._relatedQueryIds = [];\r\n      this.createToolbar();\r\n      this.loading = new LoadingIndicator();\r\n      this.loading.placeAt(this.domNode);\r\n\r\n      this.selectionManager = SelectionManager.getInstance();\r\n      this._selectionResults = [];\r\n      this.selectionRows = [];\r\n      this._normalizedExtent = null;\r\n\r\n      html.setAttr(this.domNode, 'data-layerinfoid', lang.getObject('layerInfo.id', false, this));\r\n\r\n      if (this.get('map')) {\r\n        this.own(on(this.map.root, touch.release, lang.hitch(this, function() {\r\n          this._clickMap = true;\r\n        })));\r\n        this.own(on(this.map, 'extent-change', lang.hitch(this, '_onExtentChange')));\r\n      }\r\n\r\n      this.own(on(window, 'resize', lang.hitch(this, this._resize)));\r\n\r\n      if (this.layerInfo) {\r\n        this.own(on(this.layerInfo, 'filterChanged', lang.hitch(this, this._handleFilterChange)));\r\n      }\r\n    },\r\n\r\n    startup: function() {\r\n      this.inherited(arguments);\r\n      this.toolbarHeight = parseInt(html.getStyle(this.toolbar.domNode, 'height'), 10) || 0;\r\n    },\r\n\r\n    setLayerDefinition: function(definition) {\r\n      this._layerDefinition = definition;\r\n    },\r\n\r\n    getLayerDefinition: function() {\r\n      return this._getLayerDifinition();\r\n    },\r\n\r\n    getFilterableFields: function() {\r\n      if (this._layerDefinition && this.configedInfo) {\r\n        var cloned = lang.clone(this._layerDefinition);\r\n        return this._getFilterableFields(cloned.fields, this.configedInfo.layer.fields);\r\n      } else {\r\n        return [];\r\n      }\r\n    },\r\n\r\n    getFilterObj: function() {\r\n      return this._filterObj;\r\n    },\r\n\r\n    setFilterObj: function(fObj) {\r\n      this._filterObj = fObj;\r\n    },\r\n\r\n    showRefreshing: function(isshow) {\r\n      if (isshow) {\r\n        this._toggleLoading(true);\r\n      } else {\r\n        this._toggleLoading(false);\r\n      }\r\n    },\r\n\r\n    active: function() {\r\n      this.actived = true;\r\n    },\r\n\r\n    deactive: function() {\r\n      this.actived = false;\r\n    },\r\n\r\n    cancelThread: function() {\r\n      if (this._requestStatus !== 'fulfilled' && this._currentDef) {\r\n        this._currentDef.cancel({\r\n          canceledBySelf: true\r\n        });\r\n        this._requestStatus = 'canceled';\r\n      }\r\n    },\r\n\r\n    isCanceled: function() {\r\n      return this._requestStatus === 'canceled';\r\n    },\r\n\r\n    createToolbar: function() {\r\n      var toolbar = new Toolbar({}, html.create(\"div\"));\r\n\r\n      var menus = new DropDownMenu();\r\n\r\n      this.showSelectedRecordsMenuItem = new MenuItem({\r\n        label: this.nls.showSelectedRecords,\r\n        iconClass: \"esriAttributeTableSelectPageImage\",\r\n        onClick: lang.hitch(this, this.toggleSelectedRecords)\r\n      });\r\n      menus.addChild(this.showSelectedRecordsMenuItem);\r\n\r\n      // related records:\r\n      var relationships = this.layerInfo &&\r\n        this.layerInfo.layerObject &&\r\n        this.layerInfo.layerObject.relationships;\r\n\r\n      // create related table submenu:\r\n\r\n      var subMenu = new Menu();\r\n\r\n      this.showRelatedRecordsMenuItem = new PopupMenuItem({\r\n        label: this.nls.showRelatedRecords,\r\n        iconClass: \"esriAttributeTableSelectAllImage\",\r\n        popup: subMenu\r\n      });\r\n\r\n      if(relationships && relationships.length > 0) {\r\n        // get all relationship info\r\n        var relationshipInfos = array.map(relationships, lang.hitch(this, function(r) {\r\n          return this.parent && this.parent.getRelationShipInfo(r);\r\n        }));\r\n\r\n        array.forEach(relationships, lang.hitch(this, function(r) {\r\n          var relationshipInfo = this.parent && this.parent.getRelationShipInfo(r);\r\n          var duplicateTableCount = 0;\r\n\r\n          if(relationshipInfo) {\r\n            array.some(relationshipInfos, function(rInfo) {\r\n              if(rInfo && rInfo.name === relationshipInfo.name) {\r\n                duplicateTableCount++;\r\n              }\r\n              if(duplicateTableCount > 1) {\r\n                return false;\r\n              }\r\n            });\r\n            subMenu.addChild(new MenuItem({\r\n              label: relationshipInfo.name + (\r\n                duplicateTableCount > 1 ? r && '<br><span style=\"opacity: 0.4\">&lpar;' + r.name + '&rpar;</span>' : ''\r\n              ),\r\n              onClick: lang.hitch(this, this.onShowRelatedRecordsClick, r)\r\n            }));\r\n          }\r\n        }));\r\n      }\r\n\r\n      menus.addChild(this.showRelatedRecordsMenuItem);\r\n\r\n      this.filterMenuItem = new MenuItem({\r\n        label: this.nls.filter,\r\n        iconClass: \"esriAttributeTableFilterImage\",\r\n        onClick: lang.hitch(this, this.onFilterMenuItemClick)\r\n      });\r\n      menus.addChild(this.filterMenuItem);\r\n\r\n      this.toggleColumnsMenuItem = new MenuItem({\r\n        label: this.nls.columns,\r\n        iconClass: \"esriAttributeTableColumnsImage\",\r\n        onClick: lang.hitch(this, this.onToggleColumnsClick)\r\n      });\r\n      menus.addChild(this.toggleColumnsMenuItem);\r\n\r\n      if (!this.hideExportButton) {\r\n        // always set exportButton to true\r\n        this.exportCSVMenuItem = new MenuItem({\r\n          label: this.nls.exportFiles,\r\n          showLabel: true,\r\n          iconClass: \"esriAttributeTableExportImage\",\r\n          onClick: lang.hitch(this, this.onExportCSVClick)\r\n        });\r\n        menus.addChild(this.exportCSVMenuItem);\r\n      }\r\n\r\n      this.selectionMenu = new DropDownButton({\r\n        label: this.nls.options,\r\n        iconClass: \"esriAttributeTableOptionsImage\",\r\n        dropDown: menus\r\n      });\r\n      toolbar.addChild(this.selectionMenu);\r\n\r\n      this.matchingCheckBox = new ToggleButton({\r\n        checked: this.matchingMap ? true : false,\r\n        showLabel: true,\r\n        label: this.nls.filterByExtent,\r\n        onChange: lang.hitch(this, function(status) {\r\n          this.set('matchingMap', status);\r\n          this._onMatchingCheckBoxChange(status);\r\n        })\r\n      });\r\n      toolbar.addChild(this.matchingCheckBox);\r\n\r\n      this.zoomButton = new Button({\r\n        label: this.nls.zoomto,\r\n        iconClass: \"esriAttributeTableZoomImage\",\r\n        onClick: lang.hitch(this, this.zoomTo)\r\n      });\r\n      toolbar.addChild(this.zoomButton);\r\n\r\n      this.clearSelectionButton = new Button({\r\n        label: this.nls.clearSelection,\r\n        iconClass: \"esriAttributeTableClearImage\",\r\n        onClick: lang.hitch(this, this.clearSelection, true, true)\r\n      });\r\n      toolbar.addChild(this.clearSelectionButton);\r\n\r\n      this.refreshButton = new Button({\r\n        label: this.nls.refresh,\r\n        showLabel: true,\r\n        iconClass: \"esriAttributeTableRefreshImage\",\r\n        onClick: lang.hitch(this, this.refresh)\r\n      });\r\n      toolbar.addChild(this.refreshButton);\r\n\r\n      // this.closeButton = new Button({\r\n      //   title: this.nls.closeMessage,\r\n      //   iconClass: \"esriAttributeTableCloseImage\",\r\n      //   onClick: lang.hitch(this, this._onCloseBtnClicked)\r\n      // });\r\n      // html.addClass(this.closeButton.domNode, 'close-button');\r\n      // toolbar.addChild(this.closeButton);\r\n\r\n      html.place(toolbar.domNode, this.domNode);\r\n      this.toolbar = toolbar;\r\n\r\n      this.own(\r\n        on(this, 'data-loaded,row-click,clear-selection', lang.hitch(this, 'changeToolbarStatus'))\r\n      );\r\n\r\n      // add a11y support to the toolbar\r\n      if(this.parent) {\r\n        topic.publish(this.parent.id + '_toolbar_created', {\r\n          toolbar: this.toolbar,\r\n          context: this\r\n        });\r\n      }\r\n    },\r\n\r\n    //queryByStoreObjectIds: [objectId]\r\n    //queryByStoreObjectIds exists when layerType is RELATIONSHIPTABLE and matchingMapExtent is true\r\n    startQuery: function(/*optional*/ queryByStoreObjectIds) {\r\n      this.cancelThread();\r\n      // if (this.tableCreated && this.layerInfo &&\r\n      //   this.layerInfo.isTable && !this._relatedQuery) {\r\n      //   return;\r\n      // }\r\n\r\n      this._requestStatus = 'processing';\r\n      this._toggleLoading();\r\n      if (!queryByStoreObjectIds || !queryByStoreObjectIds.length) {\r\n        this._relatedQuery = false;\r\n        this._relatedQueryIds = [];\r\n        this.queryByStoreObjectIds = null;\r\n      } else {// this case means filter by map extent in related mode\r\n        //or view in table about featureSet\r\n        this.queryByStoreObjectIds = queryByStoreObjectIds;\r\n      }\r\n      this._currentDef = this._getLayerObject();\r\n      this._currentDef.then(lang.hitch(this, function(layerObject) {\r\n        if (!this.domNode) {\r\n          return;\r\n        }\r\n\r\n        this.layer = layerObject;\r\n        var extent = (!this.layerInfo.isTable && this.matchingMap && this.map.extent) || null;\r\n        if (extent && extent.spatialReference && extent.spatialReference.isWebMercator()) {\r\n          //normalizeUtils.normalizeCentralMeridian is called because the extent maybe cross 180\r\n          var normalizeDef = this._currentDef = normalizeUtils.normalizeCentralMeridian(\r\n            [extent], null, lang.hitch(this, function(normalizedGeo) {\r\n              return normalizedGeo[0];\r\n            }));\r\n          normalizeDef.then(lang.hitch(this, function(_extent) {\r\n            this._doQuery(_extent, queryByStoreObjectIds);\r\n            this._normalizedExtent = _extent;\r\n          }), lang.hitch(this, function(err) {\r\n            if (err && err.message !== 'Request canceled') {\r\n              console.error(err);\r\n            }\r\n            this.changeToolbarStatus();\r\n            this._toggleLoading(false);\r\n          }));\r\n        } else {\r\n          this._doQuery(extent, queryByStoreObjectIds);\r\n        }\r\n      }), lang.hitch(this, function(err) {\r\n        console.error(err);\r\n        this.changeToolbarStatus();\r\n        this._toggleLoading(false);\r\n      }));\r\n    },\r\n\r\n    //this method is called when click \"Show Related Records\" option.\r\n    queryRecordsByRelationship: function(params) {\r\n      var layer = params && params.layer;\r\n      var selectedIds = params && params.selectedIds; // original feautrelayer ids\r\n      if (params && params.relationship) {\r\n        this.set('prevRelationship', this.relationship);\r\n        this.set('relationship', params.relationship);\r\n      }\r\n      if (params && params.relatedOriginalInfo) {\r\n        this.set('relatedOriginalInfo', params.relatedOriginalInfo);\r\n      }\r\n      var ship = this.relationship, prevShip = this.prevRelationship;\r\n\r\n      //this._relatedQueryIds is previous selectedIds\r\n      //selectedIds is new ids\r\n      if (layer && ship && selectedIds && selectedIds.length > 0 &&\r\n        (!jimuUtils.isEqual(this._relatedQueryIds, selectedIds) ||\r\n        !jimuUtils.isEqual(ship, prevShip)) &&\r\n        lang.getObject('relatedOriginalInfo.layerObject.url', false, this)) {\r\n        this._toggleLoading(true);\r\n        this._requestStatus = 'processing';\r\n        this._relatedQuery = true;\r\n\r\n        // unchecked filter by map extent if query related records\r\n        this.matchingCheckBox.set('checked', false);\r\n\r\n        this.cancelThread();\r\n\r\n        this._currentDef = this._getLayerObject();\r\n        this._currentDef.then(lang.hitch(this, function(layerObject) {\r\n          if (!this.domNode) {\r\n            return;\r\n          }\r\n\r\n          this.layer = layerObject;\r\n\r\n          var ofs = [];\r\n          var response = this.layer;//point to related layer\r\n          array.forEach(response.fields, function(f) {\r\n            if ((!esriLang.isDefined(f.show) || f.show === true ||\r\n              (f.type === 'esriFieldTypeOID' ||\r\n                (esriLang.isDefined(response.objectIdField) &&\r\n                  f.name === response.objectIdField))) &&\r\n              !tableUtils.arcade.isArcadeExpressionField(f)) {\r\n              ofs.push(f.name);\r\n            }\r\n          });\r\n          var relatedQuery = new RelationshipQuery();\r\n          relatedQuery.objectIds = selectedIds;\r\n          relatedQuery.outFields = ofs.length ? ofs : ['*'];\r\n          relatedQuery.relationshipId = ship.id;\r\n          relatedQuery.returnGeometry = this.layer.geometryType === 'esriGeometryPoint';//false;\r\n\r\n          var relatedDef = this._currentDef = layer.queryRelatedFeatures(relatedQuery,\r\n            function(relatedFeatures) {\r\n              return relatedFeatures;\r\n            });\r\n          relatedDef.then(lang.hitch(this, function(relatedFeatures) {\r\n            if (!this.domNode) {\r\n              return;\r\n            }\r\n            var results = {\r\n              displayFieldName: ship.objectIdField,\r\n              fields: response.fields,\r\n              features: [],\r\n              fieldAliases: null\r\n            };\r\n            var featureIds = {};\r\n            //start to reduce duplicate features\r\n            var unique = function(rf) {\r\n              var rfId = rf.attributes[this.layer.objectIdField];\r\n              if (!featureIds[rfId]) {\r\n                featureIds[rfId] = true;\r\n                results.features.push(rf);\r\n              }\r\n            };\r\n\r\n            for (var p in relatedFeatures) {\r\n              var _set = relatedFeatures[p];\r\n              array.forEach(_set && _set.features, unique, this);\r\n            }\r\n            //end\r\n\r\n            html.destroy(this.tipNode);\r\n            if (results.features.length > 0) {\r\n              if (!this.grid) {\r\n                this._removeTable();\r\n                html.place(this.loading.domNode, this.domNode);\r\n              }\r\n              var oFields = this._getOutFieldsFromLayerInfos(this.layer.objectIdField);\r\n              this.queryExecute(oFields, results.features.length, false, results);\r\n            } else {\r\n              this.tipNode = html.toDom('<div>' + this.nls.noRelatedRecords + '</div>');\r\n              this._removeTable();\r\n              html.place(this.tipNode, this.domNode);\r\n              html.place(this.loading.domNode, this.domNode);\r\n            }\r\n            this._relatedQueryIds = selectedIds;\r\n            this.emit('data-loaded');\r\n\r\n            this._toggleLoading(false);\r\n          }), lang.hitch(this, function(err) {\r\n            if (err && err.message !== 'Request canceled') {\r\n              console.error(err);\r\n            }\r\n            html.destroy(this.tipNode);\r\n            this.tipNode = html.toDom('<div>' + this.nls.noRelatedRecords + '</div>');\r\n            this._removeTable();\r\n            html.place(this.tipNode, this.domNode);\r\n            html.place(this.loading.domNode, this.domNode);\r\n            this._toggleLoading(false);\r\n            this.changeToolbarStatus();\r\n          }));\r\n        }), lang.hitch(this, function(err) {\r\n          console.error(err);\r\n          this._toggleLoading(false);\r\n          this.changeToolbarStatus();\r\n        }));\r\n      } else {\r\n        this._toggleLoading(false);\r\n      }\r\n    },\r\n\r\n    getSelectedRows: function() {\r\n      if (!this.tableCreated) {\r\n        return [];\r\n      }\r\n      return this.selectionRows;\r\n    },\r\n\r\n    zoomTo: function() {\r\n      this._zoomToSelected();\r\n    },\r\n\r\n    toggleSelectedRecords: function() {\r\n      if (this._relatedQuery && !this.showSelected && this.getSelectedRows().length === 0) {\r\n        //from RELATIONSHIPTABLE to FEATURELAYER and need to send request to get all data\r\n        this._relatedQuery = false;\r\n        this._relatedQueryIds = [];\r\n        if (this.layerInfo && !this.layerInfo.isTable) {\r\n          this.matchingCheckBox.set('checked', true);\r\n        }\r\n        this.startQuery();\r\n        this.showSelectedRecordsMenuItem.set('label', this.nls.showSelectedRecords);\r\n        this.showSelected = false;\r\n        this.emit('show-all-records', {\r\n          layerInfoId: this.layerInfo.id\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (!this.tableCreated) {\r\n        return;\r\n      }\r\n      if (this.showSelected) {\r\n        //both for FEATURELAYER and RELATIONSHIP\r\n        //from selected mode to all mode, don't need to request data\r\n        this.showAllSelectedRecords();\r\n        this.showSelectedRecordsMenuItem.set('label', this.nls.showSelectedRecords);\r\n        this.showSelected = false;\r\n        this.emit('show-all-records', {\r\n          layerInfoId: this.layerInfo.id\r\n        });\r\n      } else {\r\n        //both for FEATURELAYER and RELATIONSHIP\r\n        //from all mode to selected mode, don't need to request data\r\n        this.showSelectedRecords();\r\n        this.showSelectedRecordsMenuItem.set('label', this.nls.showAllRecords);\r\n        this.showSelected = true;\r\n        this.emit('show-selected-records', {\r\n          layerInfoId: this.layerInfo.id\r\n        });\r\n      }\r\n      // this.showSelected = !this.showSelected;\r\n    },\r\n\r\n    onShowRelatedRecordsClick: function(relationship) {\r\n      var selectedRows = this.getSelectedRows();\r\n      if(selectedRows.length > 0) {\r\n        this.emit('show-related-records', {\r\n          layerInfoId: this.layerInfo.id,\r\n          objectIds: selectedRows,\r\n          relationshipObj: relationship\r\n        });\r\n      } else {\r\n        this._getFeatureIds(\r\n          this.layer && this.layer.objectIdField,\r\n          this.matchingMap && this._normalizedExtent\r\n        ).then(lang.hitch(this, function(objectIds) {\r\n          console.log(objectIds);\r\n          this.emit('show-related-records', {\r\n            layerInfoId: this.layerInfo.id,\r\n            objectIds: objectIds,\r\n            relationshipObj: relationship\r\n          });\r\n        }));\r\n      }\r\n    },\r\n\r\n    onFilterMenuItemClick: function() {\r\n      this.showRefreshing(true);\r\n      this.getLayerDefinition()\r\n        .then(lang.hitch(this, function(definition) {\r\n          if (!this.domNode) {\r\n            return;\r\n          }\r\n          definition = lang.clone(definition);\r\n\r\n          var fFields = this.getFilterableFields();\r\n          definition.fields = fFields;\r\n\r\n          var filter = new Filter({\r\n            widgetId: this.widgetId,\r\n            noFilterTip: this.nls.noFilterTip,\r\n            style: \"width:100%;\",\r\n            featureLayerId: this.layerInfo.id,\r\n            runtime: true\r\n          });\r\n\r\n          var size = this._getFilterPopupSize();\r\n\r\n          this._filterPopup = new Popup({\r\n            titleLabel: this.nls.filter,\r\n            width: size.w,\r\n            height: size.h,\r\n            content: filter,\r\n            autoHeight: true,\r\n            buttons: [{\r\n              label: this.nls.ok,\r\n              onClick: lang.hitch(this, function() {\r\n                var partsObj = filter.toJson();\r\n                if (partsObj && partsObj.expr) {\r\n                  this.setFilterObj(partsObj);\r\n                  this.clearSelection(false);\r\n                  this.startQuery();\r\n                  this._filterPopup.close();\r\n                  this._filterPopup = null;\r\n\r\n                  this.emit('apply-filter', {\r\n                    layerInfoId: this.layerInfo.id,\r\n                    expr: partsObj.expr\r\n                  });\r\n                } else {\r\n                  new Message({\r\n                    message: this.nls.setFilterTip\r\n                  });\r\n                }\r\n              })\r\n            }, {\r\n              label: this.nls.cancel\r\n            }]\r\n          });\r\n          filter.startup();\r\n          html.addClass(this._filterPopup.domNode, 'widget-at-filter-popup');\r\n          var filterObj = this.getFilterObj();\r\n          var filterOptions = {\r\n            url: this.layer.url,\r\n            partsObj: filterObj,\r\n            layerDefinition: this.layer || definition,\r\n            featureLayerId: this.layer.id\r\n          };\r\n          filter.build(filterOptions);\r\n        }), lang.hitch(this, function(err) {\r\n          if (!this.domNode) {\r\n            return;\r\n          }\r\n          console.error(err);\r\n        })).always(lang.hitch(this, function() {\r\n          this.showRefreshing(false);\r\n        }));\r\n      this.emit('show-filter', {\r\n        layerInfoId: this.layerInfo.id\r\n      });\r\n    },\r\n\r\n    _getFilterPopupSize: function(){\r\n      var size = {\r\n        w: 720,\r\n        h: 485\r\n      };\r\n\r\n      if(window.appInfo.isRunInMobile){\r\n        size = {\r\n          w: window.innerWidth,\r\n          h: window.innerHeight\r\n        };\r\n      }\r\n\r\n      return size;\r\n    },\r\n\r\n    _resize: function(){\r\n      if(this._filterPopup){\r\n        var size = this._getFilterPopupSize();\r\n        this._filterPopup.resize(size);\r\n      }\r\n    },\r\n\r\n    onToggleColumnsClick: function() {\r\n      this.toggleColumns();\r\n      this.emit('toggle-columns', {\r\n        layerInfoId: this.layerInfo.id\r\n      });\r\n    },\r\n\r\n    onExportCSVClick: function() {\r\n      var richTextFields = this._getRichTextFields();\r\n      var message = this._getExportCSVPopupMessage(richTextFields);\r\n      var popup = new Message({\r\n        'class': this.baseClass + '-popup',\r\n        message: message,\r\n        titleLabel: this.nls.exportFiles,\r\n        autoHeight: true,\r\n        buttons: [{\r\n          label: this.nls.ok,\r\n          onClick: lang.hitch(this, function() {\r\n            var check = message._check;\r\n            if(popup.domNode) {\r\n              popup.domNode.className += ' is-loading';\r\n              var loading = new LoadingIndicator();\r\n              loading.placeAt(popup.domNode);\r\n            }\r\n            this.exportToCSV(\r\n              null,\r\n              typeof check !== 'undefined' && !check.checked ? richTextFields : null)\r\n              .then(function() {\r\n                popup.close();\r\n              }, function(err) {\r\n                console.error('Error exporting CSV for Attribute Table');\r\n                popup.close();\r\n              });\r\n          })\r\n        }, {\r\n          label: this.nls.cancel\r\n        }]\r\n      });\r\n      this.emit('export-csv', {\r\n        layerInfoId: this.layerInfo.id\r\n      });\r\n    },\r\n\r\n    _getExportCSVPopupMessage: function(richTextFields) {\r\n      var messageWrapper = document.createElement('div');\r\n      messageWrapper.className = 'message-wrapper';\r\n      messageWrapper.appendChild(document.createTextNode(this.nls.exportMessage));\r\n\r\n      // create extra UI elements if rich text field(s) exist(s)\r\n      if(richTextFields.length) {\r\n        var richTextInputWrapper = document.createElement('div');\r\n        richTextInputWrapper.className = 'input-row';\r\n        // checkbox\r\n        var check = new CheckBox({\r\n          label: this.nls.keepRichTextLabel,\r\n          checked: true // set default to keeping rich text format\r\n        });\r\n        // hint button\r\n        var hintButton = document.createElement('a');\r\n        hintButton.className = 'hint-button';\r\n        hintButton.href = '#';\r\n        hintButton.role = 'button';\r\n        hintButton.appendChild(document.createTextNode(this.nls.whatsThis));\r\n        richTextInputWrapper.appendChild(check.domNode);\r\n        richTextInputWrapper.appendChild(hintButton);\r\n        messageWrapper.appendChild(richTextInputWrapper);\r\n        messageWrapper._check = check;\r\n\r\n        this.own(on(hintButton, 'click', lang.hitch(this, function(evt) {\r\n          evt.preventDefault();\r\n          var options = {\r\n            'class': this.baseClass + '-popup',\r\n            message: this._getRichTextMessage(richTextFields)\r\n          };\r\n          if(!window.appInfo.isRunInMobile) {\r\n            options.width = 500;\r\n          }\r\n          new Message(options);\r\n        })));\r\n      }\r\n      return messageWrapper;\r\n    },\r\n\r\n    _getRichTextMessage: function(richTextFields) {\r\n      if(!richTextFields || richTextFields.hasOwnProperty(\"length\") && !richTextFields.length) return \"\";\r\n\r\n      var _EXAMPLE = {\r\n        preview: '<u>ArcGIS</u> <font color=\"#31aacd\">Web AppBuilder</font>',\r\n        withHTMLTags: '&ltu&gtArcGIS&lt/u&gt &ltfont color=\\\"#31aacd\\\"&gtWeb AppBuilder&lt/font&gt',\r\n        withoutHTMLTags: 'ArcGIS Web AppBuilder'\r\n      };\r\n      var messageWrapper = document.createElement('div');\r\n      var messageHTML = '', richTextFieldsHTML = '';\r\n      for(var i = 0, len = richTextFields.length; i < len; i++) {\r\n        richTextFieldsHTML += '<mark>' + richTextFields[i].fieldName + '</mark>';\r\n      }\r\n      messageHTML += '<p>' + string.substitute(this.nls.richTextMessage.explanatoryText.line1, {\r\n        layerName: '<strong>' + this.layer.name + '</strong>'\r\n      }) + '</p>';\r\n      messageHTML += '<div class=\"tags\">' + richTextFieldsHTML + '</div>';\r\n      messageHTML += '<p>' + this.nls.richTextMessage.explanatoryText.line2 + '</p>' +\r\n                    '<p>' + this.nls.richTextMessage.explanatoryText.line3 + '</p>'+\r\n                    '<h3>' + this.nls.richTextMessage.example.label + '</h3>' +\r\n                    '<div class=\"example-block\"><pre>' + _EXAMPLE.preview + '</pre>' +\r\n                    this.nls.richTextMessage.example.scenarios.first +\r\n                    '<pre>' + _EXAMPLE.withHTMLTags + '</pre>' +\r\n                    this.nls.richTextMessage.example.scenarios.second +\r\n                    '<pre>' + _EXAMPLE.withoutHTMLTags + '</pre></div>';\r\n      messageWrapper.innerHTML = messageHTML;\r\n      return messageWrapper;\r\n    },\r\n\r\n    // get fields that display as rich text fields\r\n    _getRichTextFields: function() {\r\n      var pInfos = this.layerInfo && this.layerInfo.getPopupInfo && this.layerInfo.getPopupInfo(),\r\n          lFields = pInfos && pInfos.fieldInfos,\r\n          rFields = [];\r\n      if(lFields) {\r\n        for(var i = 0, len = lFields.length; i < len; i++) {\r\n          var lField = lFields[i];\r\n          if(lField.stringFieldOption && lField.stringFieldOption === \"richtext\") {\r\n            rFields.push(lField);\r\n          }\r\n        }\r\n      }\r\n      return rFields;\r\n    },\r\n\r\n\r\n    onSelectionComplete: function() {\r\n      var features = this.layer && this.layer.getSelectedFeatures();\r\n      if (!features) {\r\n        return;\r\n      }\r\n      if (features.length === 0) {\r\n          this.clearSelection(false, this._selectionResults.length > 0);\r\n      } else if (!this._selectBySelf(features)) {\r\n        this.clearSelection(false);\r\n        this._updateSelectRowsByFeatures(features);\r\n      }\r\n    },\r\n\r\n    onSelectionClear: function() {\r\n      this.clearSelection(false, true);\r\n      this._setFarOffRemoval(this.GRID_FAR_OFF_REMOVAL.DEFAULT); // set to default\r\n    },\r\n\r\n    changeToolbarStatus: function() {\r\n      //selected/all option\r\n\r\n      if (!this.tableCreated) {\r\n        //dgrid not created, set initial state\r\n        if (this._relatedQuery) {\r\n          //if RELATIONSHIPTABLE mode, show \"Show All Records\"\r\n          this.showSelectedRecordsMenuItem.set('disabled', false);\r\n          this.showSelectedRecordsMenuItem.set('label', this.nls.showAllRecords);\r\n        } else {\r\n          this.showSelectedRecordsMenuItem.set('disabled', true);\r\n        }\r\n\r\n        this.showRelatedRecordsMenuItem.set('disabled', true);\r\n        this.matchingCheckBox.set('disabled', true);\r\n        this.filterMenuItem.set('disabled', true);\r\n        this.toggleColumnsMenuItem.set('disabled', true);\r\n        if (!this.hideExportButton) {\r\n          this.exportCSVMenuItem.set('disabled', true);\r\n        }\r\n        this.zoomButton.set('disabled', true);\r\n        return;\r\n      }\r\n\r\n      //now dgid is created\r\n      var selectionRows = this.getSelectedRows();\r\n      if (this.showSelected) {\r\n        //if this.showSelected is true, means we are in selected mode\r\n        //now we need to show \"Show All Records\"\r\n        this.showSelectedRecordsMenuItem.set('label', this.nls.showAllRecords);\r\n      } else {\r\n        this.showSelectedRecordsMenuItem.set('label', this.nls.showSelectedRecords);\r\n      }\r\n      if (this.tableCreated && selectionRows && selectionRows.length > 0 &&\r\n        this.layer && this.layer.objectIdField) {\r\n        this.showSelectedRecordsMenuItem.set('disabled', false);\r\n        this.clearSelectionButton.set('disabled', false);\r\n      } else {\r\n        this.showSelectedRecordsMenuItem.set('disabled', true);\r\n        this.clearSelectionButton.set('disabled', true);\r\n      }\r\n\r\n      if (this._relatedQuery) {\r\n        this.showSelectedRecordsMenuItem.set('disabled', false);\r\n        if (this.tableCreated && selectionRows && selectionRows.length === 0) {\r\n          this.showSelectedRecordsMenuItem.set('label', this.nls.showAllRecords);\r\n        }\r\n      }\r\n\r\n      //related records option\r\n\r\n      this.showRelatedRecordsMenuItem.set('disabled', true);\r\n      if (this.layerInfo && this.isSupportQueryToServer() &&\r\n        this.layer && this.layer.objectIdField) {\r\n        if (this._relatedDef && !this._relatedDef.isFulfilled()) {\r\n          this._relatedDef.cancel();\r\n        }\r\n\r\n        var resDef = this.layerInfo.getRelatedTableInfoArray();\r\n        this._relatedDef = resDef;\r\n        resDef.then(lang.hitch(this, function(tableInfos) {\r\n          if (!this.domNode) {\r\n            return;\r\n          }\r\n          if (this.tableCreated && tableInfos && tableInfos.length > 0) {\r\n            this.showRelatedRecordsMenuItem.set('disabled', false);\r\n          }\r\n        }));\r\n      }\r\n\r\n      //filter option\r\n      if (this.tableCreated && this.isSupportQueryToServer() && !this._relatedQuery) {\r\n        this.filterMenuItem.set('disabled', false);\r\n      } else {\r\n        this.filterMenuItem.set('disabled', true);\r\n      }\r\n\r\n      //map extent option\r\n      this.matchingCheckBox.set('disabled', false);\r\n\r\n      //Show/Hide Columns option\r\n      if (this.tableCreated) {\r\n        this.toggleColumnsMenuItem.set('disabled', false);\r\n      } else {\r\n        this.toggleColumnsMenuItem.set('disabled', true);\r\n      }\r\n\r\n      //export option\r\n      if (!this.hideExportButton) {\r\n        if (selectionRows && selectionRows.length > 0) {\r\n          this.exportCSVMenuItem.set('label', this.nls.exportSelected);\r\n        } else {\r\n          this.exportCSVMenuItem.set('label', this.nls.exportAll);\r\n        }\r\n        if (this.tableCreated) {\r\n          this.exportCSVMenuItem.set('disabled', false);\r\n        } else {\r\n          this.exportCSVMenuItem.set('disabled', true);\r\n        }\r\n      }\r\n\r\n      //zoom to option\r\n      if (this.layerInfo.isShowInMap()) {\r\n        // this.showGraphic();\r\n        if (this.tableCreated && selectionRows && selectionRows.length > 0) {\r\n          this.zoomButton.set('disabled', false);\r\n        } else {\r\n          this.zoomButton.set('disabled', true);\r\n        }\r\n      } else {\r\n        // if (this.tableCreated) {\r\n        //   this.hideGraphic();\r\n        // }\r\n        this.zoomButton.set('disabled', true);\r\n      }\r\n      if (this.layerInfo.isTable) {\r\n        this.matchingCheckBox.set('disabled', true);\r\n        this.zoomButton.set('disabled', true);\r\n      }\r\n    },\r\n\r\n    showSelectedRecords: function() {\r\n      if (!this.tableCreated) {\r\n        return;\r\n      }\r\n      var oid = this.layer.objectIdField;\r\n      // this.grid._clickShowSelectedRecords = true;\r\n      var ids = this.getSelectedRows();\r\n\r\n      if (ids.length > 0 && this.grid) {\r\n        // when refresh completed select these rows..\r\n        if (this.grid.store instanceof Memory) {\r\n          this.grid.set('query', lang.hitch(this, function(item) {\r\n            if (typeof item === 'number' && ids.indexOf(item) > -1) {\r\n              return true;\r\n            } else if (ids.indexOf(item[oid]) > -1) {\r\n              return true;\r\n            }\r\n            return false;\r\n          }));\r\n        } else {\r\n          this.grid.set('query', function() {\r\n            return ids;\r\n          });\r\n        }\r\n      }\r\n    },\r\n\r\n    showAllSelectedRecords: function() {\r\n      if (!this.tableCreated) {\r\n        return;\r\n      }\r\n      if (this.showSelected) {\r\n        this.grid.set('query', {});\r\n        var selectedIds = this.getSelectedRows();\r\n        this._updateSelectRowsByIds(selectedIds);\r\n      }\r\n    },\r\n\r\n    clearSelection: function(requery, clearSelectionSet) {\r\n      if (!this.tableCreated) {\r\n        return;\r\n      }\r\n      this.grid.clearSelection();\r\n      this.selectionRows = [];\r\n      if (requery) {\r\n        //from selected mode to all mode\r\n        this.grid.set('query', {});\r\n      }\r\n      if (clearSelectionSet) {\r\n        this._selectionResults = [];\r\n        if(this.layer && this.layer.getSelectedFeatures().length > 0) {\r\n          this.selectionManager.clearSelection(this.layer);\r\n        }\r\n      }\r\n      this._closePopup();\r\n      // this.graphicsLayer.clear();\r\n\r\n      this.setSelectedNumber();\r\n      this.showSelected = false;\r\n\r\n      this.emit('clear-selection');\r\n    },\r\n\r\n    refresh: function() {\r\n      if (this.grid) {\r\n        this.grid.clearSelection();\r\n        // this.clearSelection(false);\r\n      }\r\n\r\n      if (!this._relatedQuery) {\r\n        this.startQuery();\r\n      }\r\n\r\n      this.emit('refresh', {\r\n        layerInfoId: this.layerInfo.id\r\n      });\r\n    },\r\n\r\n    exportToCSV: function(fileName, richTextFieldsToClear) {\r\n      if (!this.layerInfo || !this.layer || !this.tableCreated) {\r\n        var def = new Deferred();\r\n        def.reject();\r\n        return def;\r\n      }\r\n      // var types = this.layer.types;\r\n      return this.getSelectedRowsData().then(lang.hitch(\r\n          this,\r\n          function(datas) {\r\n            // seleted data process.\r\n            var oid = this.layer.objectIdField;\r\n            var _exportData = [];\r\n            var isSameProjection = this.layer.fullExtent.spatialReference.equals(\r\n              this.map.extent.spatialReference);\r\n\r\n            var hasArcadeExpressionFields = this._hasArcadeExpressionFields();\r\n            var orderByFields = tableUtils.getSortbyFields(this.grid, this.layer);\r\n\r\n            // if the output layer's spatial reference is the same as map's, which means\r\n            // a spatial reference conversion to make output data (X, Y fields) consistent with\r\n            // layer's original projection system is NOT needed. then we can use data from client side.\r\n            // if they are different, then it needs to send a query request to\r\n            // server side (handle by \"_getExportDataFromServer\" method in jimu/CSVUtils.js)\r\n            // to get the data with correct spatial reference\r\n            // or the layer is a layer without a url that cannot be queried from the server side, e.g.: graphics layer then\r\n            // try to get the data from the client side\r\n            if(isSameProjection || !this.layer.url) {\r\n              var rows = array.map(\r\n                this._getTableSelectedIds(),\r\n                lang.hitch(this, function(id) {\r\n                  for (var i = 0, len = datas.length; i < len; i++) {\r\n                    if (datas[i] && datas[i][oid] === id) {\r\n                      return datas[i];\r\n                    }\r\n                  }\r\n                  return {};\r\n                })\r\n              );\r\n              var _selectedData = rows || [];// get selected data\r\n              // if table were in selection mode and no records were selected, we push an\r\n              // empty object to _selectedData, for the following logic compatible.\r\n              if(_selectedData.length === 0 && this.isSelectionMode()){\r\n                _selectedData.push({});\r\n              }\r\n\r\n              _exportData = _selectedData;\r\n\r\n              if(_selectedData.length === 0 &&  this.grid.store instanceof Memory){\r\n                var _queryOptions = {};\r\n                if(orderByFields && orderByFields instanceof Array) {\r\n                  _queryOptions.sort = array.map(orderByFields, function(field) {\r\n                    var optionArray = field.split(/\\ +/);\r\n                    return {attribute: optionArray[0], descending: optionArray[1] === 'DESC'};\r\n                  });\r\n                }\r\n                _exportData = lang.clone(this.grid.store.query({}, _queryOptions));\r\n              }\r\n\r\n              if(_exportData.length){\r\n                this._appendXY(_exportData);\r\n              }\r\n            }\r\n\r\n            // Indicates whether it is 'view in table'\r\n            var selectedIds = this._getTableSelectedIds()\r\n            var viewInTableFlag = this.parent && this.parent.tabContainer.selectedChildWidget.params.viewInTableFlag\r\n            var viewInTableData = []\r\n            var exportViewInTableData = !_exportData.length && viewInTableFlag && !selectedIds.length\r\n            if(exportViewInTableData) {\r\n              viewInTableData = lang.clone(this.grid.store.data);\r\n              if((isSameProjection || !this.layer.url) && viewInTableData.length){\r\n                this._appendXY(viewInTableData);\r\n              }\r\n            }\r\n            var options = {};\r\n            var _outFields = this.getOutFields(!!_exportData.length);\r\n            // 'view in table' export all in related table need export the data filtered\r\n            options.datas = exportViewInTableData ? viewInTableData : _exportData;\r\n            options.fromClient = false;\r\n            options.withGeometry = this.layer.geometryType === 'esriGeometryPoint';\r\n            options.outFields = _outFields;\r\n            options.formatNumber = false;\r\n            options.formatDate = true;\r\n            options.formatCodedValue = true;\r\n            options.popupInfo = this.layerInfo.getPopupInfo();\r\n            //if spatial reference needs to be converted and there are rows selected:\r\n            // 1. query data using object ids\r\n            options.objectIds = !isSameProjection && this.getSelectedRows().length > 0 &&\r\n            this._getExportObjectIds();\r\n            // 2. use layer's default spatial reference as the output to do\r\n            // the conversion on the server side\r\n            options.outSpatialReference = !isSameProjection &&\r\n              lang.clone(this.layer.fullExtent.spatialReference);\r\n            // pass in rich text fields to be cleared:\r\n            options.richTextFieldsToClear = richTextFieldsToClear;\r\n            // if the output layer has arcade expressions configured, the computed values\r\n            // need to be added to each data to be exported\r\n            if(hasArcadeExpressionFields) {\r\n              options.arcadeExpressions = {\r\n                expressionInfos: this.layerInfo.getPopupInfo().expressionInfos,\r\n                layerDefinition: jimuUtils.getFeatureLayerDefinition(this.layer)\r\n              };\r\n            }\r\n            // get \"order by\" fields\r\n            options.orderByFields = orderByFields;\r\n            // add additional options if cannot query by ids\r\n            if(!options.objectIds ||\r\n                options.objectIds instanceof Array && options.objectIds.length === 0) {\r\n              // if \"filter by map extent\" is on:\r\n              if(this.matchingMap && (this.layerInfo && !this.layerInfo.isTable)) {\r\n                options.geometry = this._currentExtent;\r\n              }\r\n              // query offset start from index 0\r\n              options.start = 0;\r\n              // query count defaults to the maximum record count or 1000\r\n              options.num = this.layer.maxRecordCount || 1000;\r\n              // get definition expression from the layer info\r\n              options.filterExpression = this.layerInfo.getFilter && this.layerInfo.getFilter();\r\n            }\r\n            return CSVUtils.exportCSVFromFeatureLayer(\r\n              fileName || this.configedInfo.name,\r\n              this.layer, options);\r\n          }\r\n        ));\r\n    },\r\n\r\n    toggleColumns: function() {\r\n      if (this.tableCreated) {\r\n        this.grid._toggleColumnHiderMenu();\r\n      }\r\n    },\r\n\r\n    changeHeight: function(h) {\r\n      if (this.grid && (h - this.toolbarHeight - this.footerHeight >= 0)) {\r\n        html.setStyle(\r\n          this.grid.domNode,\r\n          \"height\", (h - this.toolbarHeight - this.footerHeight) + \"px\"\r\n        );\r\n      }\r\n    },\r\n\r\n    // showGraphic: function() {\r\n    //   // if (this.graphicsLayer) {\r\n    //   //   this.graphicsLayer.show();\r\n    //   // }\r\n    // },\r\n\r\n    // hideGraphic: function() {\r\n    //   // if (this.graphicsLayer) {\r\n    //   //   this.graphicsLayer.hide();\r\n    //   // }\r\n    // },\r\n\r\n    isSupportQueryToServer: function() {\r\n      var hasLayerUrl = this.layer && this.layer.url && this.configedInfo.layer.url;\r\n      var isCSVLayer = this.layer && this.layer.declaredClass === \"esri.layers.CSVLayer\";\r\n      var isStreamLayer = this.layer && this.layer.declaredClass === \"esri.layers.StreamLayer\";\r\n\r\n      return hasLayerUrl && !isCSVLayer && !isStreamLayer;\r\n    },\r\n\r\n    isSupportQueryOnClient: function() {\r\n      var hasLayerUrl = this.layer && this.layer.url && this.configedInfo.layer.url;\r\n      var isCSVLayer = this.layer && this.layer.declaredClass === \"esri.layers.CSVLayer\";\r\n      var isStreamLayer = this.layer && this.layer.declaredClass === \"esri.layers.StreamLayer\";\r\n\r\n      return !hasLayerUrl || isCSVLayer || isStreamLayer;\r\n    },\r\n\r\n    destroy: function() {\r\n      if (!this._destroyed) {\r\n        this.layerInfo = null;\r\n        this.configedInfo = null;\r\n        this.layer = null;\r\n\r\n        if (this._selectionHandles) {\r\n          array.forEach(this._selectionHandles, function(sh) {\r\n            if (sh && sh.remove) {\r\n              sh.remove();\r\n            }\r\n          });\r\n        }\r\n\r\n        this._closePopup();\r\n        if (this._filterPopup && this._filterPopup.domNode) {\r\n          this._filterPopup.close();\r\n          this._filterPopup = null;\r\n        }\r\n\r\n        // if (this.graphicsLayer && this.graphicsLayer.clear) {\r\n        //   this.graphicsLayer.clear();\r\n        //   this.map.removeLayer(this.graphicsLayer);\r\n        // }\r\n        this._dblClickResult = null;\r\n        if (this.grid) {\r\n          this.grid.destroy();\r\n        }\r\n        this.map = null;\r\n        this.nls = null;\r\n        this.relationship = null;\r\n        this.prevRelationship = null;\r\n        if (this._currentDef && !this._currentDef.isFulfilled()) {\r\n          this._currentDef.cancel({\r\n            canceledBySelf: true\r\n          });\r\n        }\r\n        if (this._relatedDef && !this._relatedDef.isFulfilled()) {\r\n          this._relatedDef.cancel({\r\n            canceledBySelf: true\r\n          });\r\n        }\r\n\r\n        this.inherited(arguments);\r\n      }\r\n    },\r\n\r\n    _selectBySelf: function(features) {\r\n      features = features || [];\r\n      if (features.length !== this._selectionResults.length) {\r\n        return false;\r\n      } else {\r\n        var oidField = this.layer.objectIdField;\r\n        return array.every(this._selectionResults, function (sr) {\r\n          //was: return features.indexOf(sr) > -1;\r\n\r\n          // use the native Array.prototype.some() method for better performance\r\n          return features.some(function(f) {\r\n            // use object id to do a more strict comparison\r\n            return sr.attributes[oidField] === f.attributes[oidField];\r\n          })\r\n        });\r\n      }\r\n    },\r\n\r\n    _updateSelectRowsByFeatures: function(features) {\r\n      var selectedIds = array.map(features, lang.hitch(this, function(f) {\r\n        return f.attributes[this.layer.objectIdField];\r\n      }));\r\n      this._updateSelectRowsByIds(selectedIds);\r\n\r\n      this._selectionResults = features;\r\n    },\r\n\r\n    _updateSelectRowsByIds: function(selectedIds) {\r\n      if (this.grid && this.tableCreated) {\r\n        this.selectionRows = selectedIds;\r\n        array.forEach(selectedIds, lang.hitch(this, function(id) {\r\n          this.grid.select(id);\r\n        }));\r\n        this.setSelectedNumber();\r\n\r\n        this.changeToolbarStatus();\r\n      }\r\n    },\r\n\r\n    _removeTable: function() {\r\n      if (this.grid && this.grid.domNode) {\r\n        this.grid.destroy();\r\n        this.grid = null;\r\n      }\r\n      if (this.footer) {\r\n        html.destroy(this.footer);\r\n        this.footer = null;\r\n        this.selectedRowsLabel = null;\r\n      }\r\n      this.tableCreated = false;\r\n    },\r\n\r\n    _onMatchingCheckBoxChange: function(status) {\r\n      if (this.tableCreated && !this._relatedQuery) {\r\n        this.cancelThread();\r\n        this.queryByStoreObjectIds = null;\r\n        this.startQuery();\r\n      }\r\n      if (this._requestStatus === 'fulfilled' && this.tableCreated && this._relatedQuery) {\r\n        // this.startQuery(this.grid.store.data.);\r\n        if (status) {\r\n          this.queryByStoreObjectIds = array.map(this.grid.store.data,\r\n          lang.hitch(this, function(item) {\r\n            return item[this.layer.objectIdField];\r\n          }));\r\n          this.startQuery(this.queryByStoreObjectIds);\r\n        } else {\r\n          var selectedIds = this._relatedQueryIds;\r\n          this._relatedQueryIds = []; // empty _relatedQueryIds for query related\r\n          this.queryRecordsByRelationship({\r\n            'layer': this.relatedOriginalInfo.layerObject,\r\n            'selectedIds': selectedIds\r\n          });\r\n        }\r\n      }\r\n      if (!status) {\r\n        this._currentExtent = null;\r\n      }\r\n    },\r\n\r\n    _closePopup: function() {\r\n      var sg = this.map.infoWindow.getSelectedFeature();\r\n      var hasSG = sg && this._dblClickResult && sg === this._dblClickResult;\r\n      var sameLayer = sg && sg._layer === this.layer;\r\n      if (this.domNode && (hasSG || sameLayer)) {\r\n        this.map.infoWindow.hide();\r\n        this._dblClickResult = null;\r\n      }\r\n    },\r\n\r\n    _getLayerObject: function() {\r\n      var objectDef = this._currentDef = this.layerInfo.getLayerObject();\r\n      function bindSelectionEvents(layer) {\r\n        if (this._selectionHandles) {\r\n          array.forEach(this._selectionHandles, function(sh) {\r\n            if (sh && sh.remove) {\r\n              sh.remove();\r\n            }\r\n          });\r\n        }\r\n        this._selectionHandles = [];\r\n\r\n        this._selectionHandles.push(\r\n          on(layer, 'selection-complete', lang.hitch(this, 'onSelectionComplete')));\r\n        this._selectionHandles.push(\r\n          on(layer, 'selection-clear', lang.hitch(this, 'onSelectionClear')));\r\n      }\r\n      return objectDef.then(lang.hitch(this, function(layerObject) {\r\n        var def = new Deferred();\r\n        if (layerObject.declaredClass === \"esri.layers.ArcGISImageServiceLayer\" ||\r\n          layerObject.declaredClass === \"esri.layers.ArcGISImageServiceVectorLayer\") {\r\n          var flayer = new FeatureLayer(layerObject.url);\r\n          this.own(on(flayer, \"load\", lang.hitch(this, function(params) {\r\n            lang.hitch(this, bindSelectionEvents)(params.layer);\r\n            def.resolve(params.layer);\r\n          })));\r\n        } else {\r\n          lang.hitch(this, bindSelectionEvents)(layerObject);\r\n          def.resolve(layerObject);\r\n        }\r\n\r\n        return def;\r\n      }));\r\n    },\r\n\r\n    _getLayerDifinition: function() {\r\n      if (this._layerDefinition) {\r\n        return when(lang.clone(this._layerDefinition));\r\n      } else {\r\n        return esriRequest({\r\n          url: this.layer.url,\r\n          content: {\r\n            f: 'json'\r\n          },\r\n          handleAs: 'json',\r\n          callbackParamName: 'callback'\r\n        }).then(lang.hitch(this, function(definition) {\r\n          this.setLayerDefinition(definition);\r\n          return this.getLayerDefinition();\r\n        }));\r\n      }\r\n    },\r\n\r\n    _getFilterableFields: function(lFields, cFields) {\r\n      return array.filter(lFields, function(lf) {\r\n        return array.some(cFields, function(cf) {\r\n          return lf.name === cf.name &&\r\n            (cf.show || !esriLang.isDefined(cf.show)) &&\r\n            lang.mixin(lf, cf);\r\n        });\r\n      });\r\n    },\r\n\r\n    _getExportObjectIds: function() {\r\n      var exportIds = this._getTableSelectedIds() || []; // try to get selected ids first\r\n      if(exportIds.length === 0 && this.grid.store instanceof Memory) {\r\n        var oid = this.layer.objectIdField;\r\n        this.grid.store.query(function(object) {\r\n          exportIds.push(object[oid]);\r\n        });\r\n      } // if nothing is selected, get ids from current dgrid's store object\r\n      return exportIds;\r\n    },\r\n\r\n    _doQuery: function(normalizedExtent, queryByStoreObjectIds) {\r\n      if (!this.layer) {\r\n        return;\r\n      }\r\n      var pk = this.layer.objectIdField; // primary key always be display\r\n\r\n      if (this.isSupportQueryToServer()) {\r\n        this._queryToServer(normalizedExtent, pk, queryByStoreObjectIds);\r\n      } else if (this.isSupportQueryOnClient()) {\r\n        this._queryOnClient(normalizedExtent, pk, queryByStoreObjectIds);\r\n      }\r\n    },\r\n\r\n    _queryOnClient: function(normalizedExtent, pk, queryByStoreObjectIds) {\r\n      var json = {};//json has the similay structure with FeatureSet.\r\n      if (this.layer.declaredClass === \"esri.layers.StreamLayer\") {\r\n        json.features = this.layer.getLatestObservations();\r\n      } else {\r\n        json.features = array.filter(this.layer.graphics, lang.hitch(this, function(feature){\r\n          return !feature.wabIsTemp;\r\n        }));\r\n      }\r\n\r\n      if (queryByStoreObjectIds && queryByStoreObjectIds.length > 0) {\r\n        json.features = array.filter(json.features, function(f) {\r\n          return queryByStoreObjectIds.indexOf(f.attributes[this.layer.objectIdField]) > -1;\r\n        }, this);\r\n      }\r\n\r\n      var lFields = this.layer.fields;\r\n      var liFields = this.configedInfo.layer.fields;\r\n\r\n      if (liFields) {\r\n        //user has open AT setting page and we get this.configedInfo.layer.fields\r\n        json.fields = array.filter(liFields, lang.hitch(this, function(field) {\r\n          if (!esriLang.isDefined(field.show)) { // first open\r\n            field.show = true;\r\n          }\r\n          if (field.name === pk &&\r\n            (field.type === 'esriFieldTypeOID' || field.type === 'esriFieldTypeInteger')) {\r\n            field._pk = true;\r\n          }\r\n\r\n          //add esri field type to liField\r\n          for (var i = 0, len = lFields.length; i < len; i++) {\r\n            if (lFields[i].name === field.name && !field.type) {\r\n              field.type = lFields[i].type;\r\n            }\r\n          }\r\n          return field.show || field._pk;\r\n        }));\r\n      } else {\r\n        //user doesn't open AT setting page\r\n        json.fields = array.filter(lFields, lang.hitch(this, function(field) {\r\n          if (!esriLang.isDefined(field.show)) { // first open\r\n            field.show = true;\r\n          }\r\n          if (field.name === pk &&\r\n            (field.type === 'esriFieldTypeOID' || field.type === 'esriFieldTypeInteger')) {\r\n            field._pk = true;\r\n          }\r\n          return field.show || field._pk;\r\n        }));\r\n      }\r\n\r\n      var geometries = [];\r\n      var len = json.features.length;\r\n      for (var i = 0; i < len; i++) {\r\n        if (json && json.features && json.features[i] && json.features[i].geometry) {\r\n          geometries.push(json.features[i].geometry);\r\n        }\r\n      }\r\n      if (normalizedExtent && esriConfig.defaults.geometryService && geometries.length > 0) {\r\n        var sr1 = normalizedExtent.spatialReference;\r\n        var sr2 = geometries[0].spatialReference;\r\n        if(sr1.equals(sr2)){\r\n          json.features = array.filter(json.features, lang.hitch(this, function(g) {\r\n            if(g && g.geometry){\r\n              return geometryEngine.intersects(normalizedExtent, g.geometry);\r\n            }\r\n          }));\r\n          this.queryExecute(\r\n            json.fields, json.features.length, false, json, normalizedExtent\r\n          );\r\n        }else{\r\n          var params = new RelationParameters();\r\n          params.geometries1 = geometries;\r\n          params.geometries2 = [normalizedExtent];\r\n          params.relation = RelationParameters.SPATIAL_REL_INTERSECTION;\r\n\r\n          var relationDef = this._currentDef = esriConfig.defaults.geometryService.relation(\r\n            params, lang.hitch(this, function(pairs) {\r\n              return pairs;\r\n            }));\r\n          relationDef.then(lang.hitch(this, function(json, pairs) {\r\n            var n = pairs.length;\r\n            //the filtered features\r\n            var gs = [];\r\n            for (var m = 0; m < n; m++) {\r\n              gs.push(json.features[pairs[m].geometry1Index]);\r\n            }\r\n            json.features = gs;\r\n            this.queryExecute(\r\n              json.fields, json.features.length, false, json, normalizedExtent\r\n            );\r\n          }, json), lang.hitch(this, function(err) {\r\n            if (err && err.message !== 'Request canceled') {\r\n              console.error(err);\r\n            }\r\n            this.changeToolbarStatus();\r\n            this._toggleLoading(false);\r\n          }));\r\n        }\r\n      } else {\r\n        //don't filter features\r\n        this.queryExecute(\r\n          json.fields, json.features.length, false, json, normalizedExtent\r\n        );\r\n      }\r\n    },\r\n\r\n    /*\r\n    pk: objectIdField\r\n     */\r\n    _queryToServer: function(normalizedExtent, pk, queryByStoreObjectIds) {\r\n      this._getFeatureCount(normalizedExtent, queryByStoreObjectIds)\r\n        .then(lang.hitch(this, function(recordCounts) {\r\n          if (!this.domNode) {\r\n            return;\r\n          }\r\n          if (queryByStoreObjectIds) {// RELATIONSHIPTABLE doesn't care pagination\r\n            this._queryFeatureLayer(\r\n              normalizedExtent, pk, recordCounts, false, queryByStoreObjectIds\r\n            );\r\n          } else {\r\n            var currentLayer = this.layer;\r\n            var maxCount = esriLang.isDefined(currentLayer.maxRecordCount) ?\r\n              currentLayer.maxRecordCount : 1000;\r\n            this._batchCount = Math.min(maxCount, this._defaultBatchCount);\r\n\r\n            // some table isn't GIS based, so it have no objectIdField\r\n            // issue#7122\r\n            if (recordCounts <= maxCount || !this.layer.objectIdField) {\r\n              //one request can cover all features, don't need to pages\r\n              this._queryFeatureLayer(\r\n                normalizedExtent, pk, recordCounts, false\r\n              );\r\n            } else {\r\n              var oFields = this._getOutFieldsFromLayerInfos(pk);\r\n              var results = {\r\n                fields: this.layer.fields\r\n              };\r\n              this.layer._recordCounts = recordCounts;\r\n              var supportsPagination = currentLayer.advancedQueryCapabilities &&\r\n                currentLayer.advancedQueryCapabilities.supportsPagination;\r\n              if (supportsPagination) {\r\n                this.queryExecute(oFields, recordCounts, true, results, normalizedExtent\r\n                );\r\n              } else {\r\n                this._getFeatureIds(pk, normalizedExtent)\r\n                  .then(lang.hitch(this, function(objectIds) {\r\n                    if (!this.domNode) {\r\n                      return;\r\n                    }\r\n                    this.layer._objectIds = objectIds;\r\n\r\n                    this.queryExecute(oFields, recordCounts, true, results, normalizedExtent);\r\n                  }), lang.hitch(this, function(err) {\r\n                    console.error(err);\r\n                    this.changeToolbarStatus();\r\n                  }));\r\n              }\r\n            }\r\n          }\r\n        }), lang.hitch(this, function(err) {\r\n          console.error(err);\r\n          this.changeToolbarStatus();\r\n        }));\r\n    },\r\n\r\n    _getFeatureCount: function(normalizedExtent, queryByStoreObjectIds) {\r\n      var def = new Deferred();\r\n      var qt = new QueryTask(this.configedInfo.layer.url);\r\n      var query = new Query();\r\n      query.returnGeometry = false;\r\n      query.where = this._getLayerFilterExpression();\r\n      if (queryByStoreObjectIds) {\r\n        query.where += ' AND ' + this.layer.objectIdField +\r\n        ' IN (' + queryByStoreObjectIds.join() + ')';\r\n      }\r\n\r\n      if (normalizedExtent) {\r\n        query.geometry = normalizedExtent;\r\n      }\r\n\r\n      // Because _getAttributeFilter of FeatureLayer will merge definitionExpression\r\n      // to where property of Query,\r\n      // we change to QueryTask to executeForCount.\r\n      // var countDef = this._currentDef = this.layer.queryCount(query);\r\n\r\n      var countDef = this._currentDef = qt.executeForCount(\r\n        query,\r\n        lang.hitch(this, function(results) {\r\n          return results;\r\n        })\r\n      );\r\n      countDef.then(lang.hitch(this, function(count) {\r\n        def.resolve(count);\r\n      }), lang.hitch(this, function(err) {\r\n        if (err && err.message !== 'Request canceled') {\r\n          console.error(err);\r\n          console.log(\"Could not get feature count.\");\r\n        }\r\n        this._toggleLoading(false);\r\n        def.reject(err);\r\n      }));\r\n\r\n      return def;\r\n    },\r\n\r\n    // get all records from server by only one request without pagination\r\n    _queryFeatureLayer: function(normalizedExtent, pk,\r\n      recordCounts, exceededLimit, queryByStoreObjectIds) {\r\n      // function body\r\n      var qt = new QueryTask(this.configedInfo.layer.url);\r\n      var query = new Query();\r\n      query.where = this._getLayerFilterExpression();\r\n      if (queryByStoreObjectIds && pk) {\r\n        query.where += ' AND ' + pk + ' IN (' + queryByStoreObjectIds.join() + ')';\r\n      }\r\n      var oFields = this._getOutFieldsFromLayerInfos(pk);\r\n      var hasArcadeExpressionFields = this._hasArcadeExpressionFields();\r\n      var hasArcadeExpressionWithGeometry = hasArcadeExpressionFields &&\r\n                                            this._hasArcadeExpressionWithGeometry();\r\n      if (oFields.length > 0 && !hasArcadeExpressionFields) {\r\n        var oNames = [];\r\n        array.forEach(oFields, function(field) {\r\n          oNames.push(field.name);\r\n        });\r\n        query.outFields = oNames;\r\n      } else {\r\n        query.outFields = [\"*\"];\r\n      }\r\n      if (normalizedExtent) {\r\n        query.geometry = normalizedExtent;\r\n        query.spatialRelationship = Query.SPATIAL_REL_INTERSECTS;\r\n      }\r\n      query.outSpatialReference = lang.clone(this.map.spatialReference);\r\n\r\n      query.returnGeometry = this.layer.geometryType === 'esriGeometryPoint' ||\r\n                             hasArcadeExpressionWithGeometry;\r\n      if (pk) {\r\n        query.orderByFields = [pk + ' ASC'];\r\n      }\r\n\r\n      var taskDef = this._currentDef = qt.execute(\r\n        query,\r\n        lang.hitch(this, function(results) {\r\n          return results;\r\n        })\r\n      );\r\n\r\n      taskDef.then(lang.hitch(this, function(results) {\r\n        this.queryExecute(oFields, recordCounts, exceededLimit, results, normalizedExtent);\r\n      }), lang.hitch(this, function(err) {\r\n        if (err && err.message !== 'Request canceled') {\r\n          console.error(err);\r\n        }\r\n        this.changeToolbarStatus();\r\n        this._toggleLoading(false);\r\n      }));\r\n    },\r\n\r\n    _getFeatureIds: function(pk, normalizedExtent) {\r\n      var def = new Deferred();\r\n      var qt = new QueryTask(this.configedInfo.layer.url);\r\n      var query = new Query();\r\n      query.returnGeometry = false;\r\n      query.returnIdsOnly = true;\r\n      query.where = this._getLayerFilterExpression();\r\n      if (this.layer._orderByFields || pk) {\r\n        query.orderByFields = this.layer._orderByFields || [pk + \" ASC\"];\r\n      }\r\n\r\n      if (normalizedExtent) {\r\n        query.geometry = normalizedExtent;\r\n      }\r\n\r\n      // Because _getAttributeFilter of FeatureLayer will merge definitionExpression\r\n      // to where property of Query,\r\n      // we change to QueryTask to executeForCount.\r\n      // var idsDef = this._currentDef = this.layer.queryIds(query);\r\n\r\n      var idsDef = this._currentDef = qt.executeForIds(query, lang.hitch(this, function(results) {\r\n        return results;\r\n      }));\r\n      idsDef.then(lang.hitch(this, function(objectIds) {\r\n        def.resolve(objectIds);\r\n      }), lang.hitch(this, function(err) {\r\n        if (err && err.message !== 'Request canceled') {\r\n          console.error(err);\r\n          console.log(\"Could not get feature Ids\");\r\n        }\r\n        def.resolve([]);\r\n      }));\r\n\r\n      return def;\r\n    },\r\n\r\n    /*\r\n    oFields: out fields\r\n    recordCounts: all records count\r\n    exceededLimit: if true means pagination\r\n    results: FeatureSet like structure\r\n    nExtent: normalize map extent\r\n     */\r\n    queryExecute: function(oFields, recordCounts, exceededLimit, results, nExtent) {\r\n      var data = [];\r\n      var store = null;\r\n      var columns = {};\r\n      if (!this.domNode) {\r\n        return;\r\n      }\r\n      // mixin porperty of field to result.fields\r\n      results.fields = this._processExecuteFields(this.layer.fields, oFields);\r\n      if (exceededLimit) {\r\n        //if exceededLimit, means need pagination. In this case, we create cache store.\r\n        //With cache store, dgrid get data dynamically.\r\n        store = tableUtils.generateCacheStore(\r\n          this.layer,\r\n          recordCounts,\r\n          this._batchCount,\r\n          this._getLayerFilterExpression(),\r\n          nExtent\r\n        );\r\n      } else {\r\n        //If don't need pagination, we create memory store.\r\n        data = array.map(results.features, lang.hitch(this, function(feature) {\r\n          // return lang.clone(feature.attributes);\r\n          var c = lang.clone(feature.attributes);\r\n          return lang.mixin(c, {\r\n            geometry: feature.geometry\r\n          });\r\n        }));\r\n\r\n        store = tableUtils.generateMemoryStore(data, this.layer.objectIdField);\r\n      }\r\n\r\n      var _typeIdFild = this.layer.typeIdField;\r\n      var _types = this.layer.types;\r\n      var supportOrder = lang.getObject('advancedQueryCapabilities.supportsOrderBy',\r\n        false, this.layer);\r\n      var supportPage = lang.getObject('advancedQueryCapabilities.supportsPagination',\r\n        false, this.layer);\r\n      var supportStatistics = lang.getObject('advancedQueryCapabilities.supportsStatistics',\r\n        false, this.layer);\r\n\r\n      // AttributeTable does not work\r\n      // when column name contains special character such as \".\" and \"()\"\r\n      var expressionInfos = tableUtils.arcade.getExpressionInfosFromLayerInfo(this.layerInfo);\r\n      var expressionCache = ArcadeUtils.compileExpressions(expressionInfos);\r\n      columns = tableUtils.generateColumnsFromFields(\r\n        this.grid && this.grid.columns,\r\n        this.map,\r\n        this.layerInfo,\r\n        expressionCache,\r\n        results.fields, _typeIdFild, _types, (supportOrder && supportPage) || !exceededLimit,\r\n        supportStatistics, this.layer\r\n      );\r\n\r\n      // remove attachments temporary\r\n      if (this.layer.hasAttachments && this.layer.objectIdField && this.configedInfo.showAttachments) {\r\n        // columns.selectionHandle = {\r\n        //   label: \"\",\r\n        //   className: \"selection-handle-column\",\r\n        //   hidden: false,\r\n        //   unhidable: true,\r\n        //   filed: \"selection-handle-column\",\r\n        //   sortable: false,\r\n        //   _cache: {\r\n        //     sortable: false,\r\n        //     statistics: false\r\n        //   }\r\n        // };\r\n        columns.attachmentsColumn = this.formatAttachmentsColumn(); // add attachments column\r\n      }\r\n      //if autoWidth is ture, means no horizontal bar\r\n      //if autoWidth is false, means we have too many fields and maybe need horizontal bar\r\n      var autoWidth = (20 * 1 + 100 * results.fields.length) < html.getMarginBox(this.domNode).w;\r\n      //create dgrid, only one time\r\n      this.createTable(columns, store, recordCounts, autoWidth);\r\n      //Use 'presentation' instead of default 'columnheader' for selectionHandler on header\r\n      var selectionHandleOnHeader = this.grid.domNode.querySelectorAll('.dgrid-header .dgrid-column-selectionHandle');\r\n      selectionHandleOnHeader.length > 0 && selectionHandleOnHeader[0].setAttribute('role', 'presentation');\r\n\r\n      this._currentExtent = nExtent;\r\n\r\n      var selectedFeatures = this.layer.getSelectedFeatures();\r\n      // it seems that grid.select(id) is not always emitting dgrid-select,\r\n      // so persist the selection ids.\r\n      if (this.selectionRows && this.selectionRows.length > 0) {\r\n        this._updateSelectRowsByIds(this.selectionRows);\r\n      } else if (selectedFeatures && selectedFeatures.length > 0) {\r\n        this._updateSelectRowsByFeatures(selectedFeatures);\r\n      } else {\r\n        this.grid.clearSelection();\r\n      }\r\n      this.changeToolbarStatus();\r\n\r\n      this.emit('data-loaded');\r\n    },\r\n\r\n    formatAttachmentsColumn: function() {\r\n      var column = {\r\n        label: this.nls.attachments,\r\n        className: 'attachments-column',\r\n        hidden: false,\r\n        unhidable: true,\r\n        field: 'at-show-attachments',\r\n        sortable: false,\r\n        _cache: {\r\n          sortable: false,\r\n          statistics: false\r\n        }\r\n      };\r\n      // jshint unused: true\r\n      column.renderCell = lang.hitch(this, function(obj, v, node) {\r\n        /*jshint unused: false*/\r\n        var oid = obj[this.layer.objectIdField];\r\n        this.layer.queryAttachmentInfos(oid, lang.hitch(this, function(infos) {\r\n          var liTemplates = array.map(infos, lang.hitch(this, function(ainfo) {\r\n            var isImage = ainfo.name && (/\\.(png|jpg|jpeg|gif)$/gi).test(ainfo.name);\r\n            var fileType = isImage ? 'image-type' : 'file-type';\r\n            var credential = esriId.findCredential(this.layer.url);\r\n            var attachmentUrl = this.layer.url + '/' + oid + '/attachments/' + ainfo.id +\r\n            (credential ? '?token=' + credential.token : \"\");\r\n            return '<li class=\"' + fileType + '\">' +\r\n            '<a class=\"jimu-ellipsis\" target=\"_blank\" href=\"' + attachmentUrl + '\">' + ainfo.name + '</a>' +\r\n            '</li>';\r\n          }));\r\n          var filesNls = '';\r\n          if(infos.length > 0){\r\n            filesNls = ' ' + this.nls.files;\r\n          }\r\n          var template = '<div class=\"attachment-infos\">' +\r\n              '<div class=\"show-attachments-div\">' +\r\n                '<span class=\"show-attachments\">' + infos.length + filesNls + '</span>' +\r\n              '</div>' +\r\n              '<div class=\"attachment-popup\">' +\r\n                '<div class=\"attachment-popup-header\">' +\r\n                  '<span>' + liTemplates.length + '&nbsp;' + this.nls.files + '</span>' +\r\n                  '<span class=\"close jimu-float-trailing\"></span>' +\r\n                '</div>' +\r\n                '<ul class=\"attachment-popup-content\">' +\r\n                  liTemplates.join('') +\r\n                '</ul>' +\r\n              '</div>' +\r\n            '</div>';\r\n\r\n          var templateDom = html.toDom(template);\r\n\r\n          if(infos.length > 0){\r\n            var showAttachmentsDiv = query('.show-attachments-div', templateDom)[0];\r\n            html.addClass(showAttachmentsDiv, 'has-attachments');\r\n          }\r\n\r\n          node.appendChild(templateDom);\r\n          this.own(on(node, 'click', lang.hitch(this, function(evt) {\r\n            var target = evt && evt.target;\r\n            var valid = html.hasClass(target, 'show-attachments-div') ||\r\n                        html.hasClass(target, 'show-attachments') ||\r\n                        html.hasClass(target, 'close');\r\n            if (!valid) {\r\n              return;\r\n            }\r\n            var oldVisibleAttachmentPopup = this._visibleAttachmentPopup;\r\n            var attachmentPopup = query('.attachment-popup', node)[0];\r\n            if (attachmentPopup && liTemplates.length > 0) {\r\n              html.toggleClass(attachmentPopup, 'show');\r\n            }\r\n            if (html.hasClass(attachmentPopup, 'show')) {\r\n              this._visibleAttachmentPopup = attachmentPopup;\r\n            } else {\r\n              this._visibleAttachmentPopup = null;\r\n            }\r\n            if(oldVisibleAttachmentPopup && oldVisibleAttachmentPopup !== attachmentPopup){\r\n              html.toggleClass(oldVisibleAttachmentPopup, 'show');\r\n            }\r\n          })));\r\n        }), lang.hitch(this, function(err) {\r\n          console.error(err);\r\n\r\n        }));\r\n      });\r\n\r\n      return column;\r\n    },\r\n\r\n    createTable: function(columns, store, recordCounts, autoWidthMode) {\r\n      if (this.grid) {\r\n        this.grid.set(\"store\", store);\r\n        this.grid.set('columns', columns);\r\n        this.grid.refresh();\r\n      } else {\r\n        var json = {};\r\n        var gridLoadingIndicator = new LoadingIndicator();\r\n        html.setStyle(\r\n          gridLoadingIndicator.domNode,\r\n          \"max-width\",  \"100vw\"\r\n        );\r\n        json.columns = columns;\r\n        json.store = store;\r\n        json.keepScrollPosition = true;\r\n        json.farOffRemoval = this.GRID_FAR_OFF_REMOVAL.DEFAULT;\r\n        // a better handling for lazy loading data when scrolling on Chrome.\r\n        // original issue from dgrid: https://github.com/SitePen/dgrid/issues/1351\r\n        if(!has('chrome')) {\r\n          json.pagingDelay = 1000;//like search delay\r\n        }\r\n        json.allowTextSelection = this.allowTextSelection;\r\n        json.deselectOnRefresh = false;\r\n        json.loadingMessage = gridLoadingIndicator.domNode &&\r\n        gridLoadingIndicator.domNode.outerHTML;\r\n\r\n        if (!this.layer.objectIdField) {\r\n          json.minRowsPerPage = this.layer.maxRecordCount || 1000;\r\n          json.maxRowsPerPage = this.layer.maxRecordCount || 1000;\r\n          json.selectionMode = 'none';\r\n        }\r\n\r\n        var demands = [OnDemandGrid, Selection, ColumnHider, ColumnResizer, ColumnReorder, Keyboard];\r\n        this.grid = new(declare(demands))(json, html.create(\"div\"));\r\n        html.place(this.grid.domNode, this.domNode);\r\n        this.grid.startup();\r\n\r\n        // //\r\n        // html.create('p', {\r\n        //  id: 'gridSelectionHandleDescription',\r\n        //  innerHTML: this.parent.nls.selectionHandleDescription\r\n        // }, this.parent.domNode);\r\n\r\n        // this.grid.hiderToggleNode\r\n\r\n        if (this.tipNode) {\r\n          html.destroy(this.tipNode);\r\n        }\r\n        // // private preperty in grid\r\n        // // _clickShowSelectedRecords\r\n        // // when these value is true selected rows after refresh complete.\r\n        // this.grid._clickShowSelectedRecords = false;\r\n\r\n        // prevent select when press shift key to do multiple selection.\r\n        this.own(on(this.ownerDocument, 'keydown', lang.hitch(this, function(evt) {\r\n          if (this.allowTextSelection && this.grid && this.grid.allowTextSelection && evt.shiftKey) {\r\n            this.grid._setAllowTextSelection(false);\r\n          }\r\n        })));\r\n        this.own(on(this.ownerDocument, 'keyup', lang.hitch(this, function() {\r\n          if (this.allowTextSelection && this.grid && !this.grid.allowTextSelection) {\r\n            this.grid._setAllowTextSelection(true);\r\n          }\r\n        })));\r\n        this.own(on(this.ownerDocument, 'keydown', lang.hitch(this, function(evt) {\r\n          if(this.tableCreated &&\r\n            (evt.keyCode === keys.SHIFT ||\r\n            (has('mac') ? evt.keyCode === keys.META : evt.keyCode === keys.CTRL) &&\r\n            this.isSelectionMode())) {\r\n            this._setFarOffRemoval(this.GRID_FAR_OFF_REMOVAL.INFINITY);\r\n            on.once(this.ownerDocument, 'keyup', lang.hitch(this, function(evt) {\r\n              if(this.tableCreated &&\r\n                (evt.keyCode === keys.SHIFT ||\r\n                (has('mac') ? evt.keyCode === keys.META : evt.keyCode === keys.CTRL))) {\r\n                if(this.isSelectionMode()) {\r\n                  this._setFarOffRemoval(this.GRID_FAR_OFF_REMOVAL.RESELECTION);\r\n                } else {\r\n                  this._setFarOffRemoval(this.GRID_FAR_OFF_REMOVAL.DEFAULT);\r\n                }\r\n              }\r\n            }));\r\n          }\r\n        })));\r\n\r\n        if(this.layer.objectIdField) {\r\n          // bind grid evnt\r\n\r\n          //show header menu: ASC,DSC,Statistics\r\n          this.own(on(\r\n            this.grid,\r\n            \".dgrid-header .dgrid-cell:click\",\r\n            lang.hitch(this, this._onHeaderClick)\r\n          ));\r\n\r\n          // toogle visibility of field in columns menu\r\n          this.own(on(\r\n            this.grid,\r\n            'dgrid-columnstatechange',\r\n            lang.hitch(this, this._onColumnStateChange)\r\n          ));\r\n\r\n          //select rows\r\n          this.own(\r\n            on(\r\n              this.grid,\r\n              \".selection-handle-column:click\",\r\n              lang.hitch(this, this._onSelectionHandleClick)\r\n            ),on(\r\n              this.grid,\r\n              \".selection-handle-column:keydown\",\r\n              lang.hitch(this, function(e) {\r\n                if(e.keyCode === keys.ENTER ||\r\n                   e.keyCode === keys.SPACE) {\r\n                  this._onSelectionHandleClick();\r\n                }\r\n              })\r\n            )\r\n          );\r\n\r\n          // attach event handlers\r\n          this.own(\r\n            //dblclick to select one row and show popup on the feature, but not put into selection\r\n            on(\r\n              this.grid,\r\n              \".dgrid-row:dblclick\",\r\n              lang.hitch(this, this._onDblclickRow)\r\n            ),\r\n            //dgrid sort\r\n            on(this.grid, 'dgrid-sort', lang.hitch(this, function(evt) {\r\n              this.emit('sort', evt);\r\n            })),\r\n            // add a11y support to the table (grid)\r\n            on(this.grid, 'dgrid-refresh-complete', lang.hitch(this, function(evt) {\r\n              if(this.parent) {\r\n                topic.publish(this.parent.id + '_table_created', {\r\n                  grid: evt.grid,\r\n                  context: this\r\n                });\r\n              }\r\n            }))\r\n          );\r\n          var inMap = this.map.getLayer(this.layer.id);\r\n          if (this.syncSelection && inMap) {\r\n            this.own(on(inMap, 'click', lang.hitch(this, this._onFeaturelayerClick)));\r\n          }\r\n        }\r\n      }\r\n\r\n      // apply sort option if no one has been applied\r\n      if(!this.grid.get('sort')[0]) {\r\n        if(this.configedInfo && this.configedInfo.sortField) {\r\n          this.grid.set('sort', this.configedInfo.sortField, this.configedInfo.isDescending);\r\n        } else if (this.layer.objectIdField) {\r\n          this.grid.set('sort', this.layer.objectIdField, false);\r\n        }\r\n      }\r\n\r\n      // fix dgrid bug\r\n      // sometimes dgrid-scroller will overload dgrid-header\r\n      if (this.getParent()) {\r\n        var scroller = query('.dgrid-scroller', this.grid.domNode)[0];\r\n        var header = query('.dgrid-header', this.grid.domNode)[0];\r\n        var scrollerStyle = html.getComputedStyle(scroller);\r\n        var headerBox = html.getMarginBox(header);\r\n        var smt = parseInt(scrollerStyle.marginTop, 10);\r\n        if (isFinite(smt) && headerBox && smt < headerBox.h) {\r\n          html.setStyle(scroller, 'marginTop', headerBox.h + 'px');\r\n        }\r\n      }\r\n\r\n      if (autoWidthMode) {\r\n        html.addClass(this.domNode, 'auto-width');\r\n      } else {\r\n        html.removeClass(this.domNode, 'auto-width');\r\n      }\r\n\r\n      if (this.footer) {\r\n        html.empty(this.footer);\r\n      } else {\r\n        this.footer = html.create('div', {\r\n          'id': this.parent.id + '_' + this.id + '_footer',\r\n          'class': this.parent.baseClass + '-feature-table-footer',\r\n          tabindex: '-1'\r\n        }, this.domNode);\r\n      }\r\n      var _footer = this.footer;\r\n      var countLabel = html.create('div', {\r\n        'class': 'dgrid-status self-footer',\r\n        'innerHTML': recordCounts + '&nbsp;' +\r\n          (this.layerInfo.isTable ? this.nls.records : this.nls.features) + '&nbsp;'\r\n      }, _footer);\r\n      this.selectedRowsLabel = html.create('div', {\r\n        'class': 'dgrid-status self-footer',\r\n        'id': this.id + '_Selected_Rows_Label',\r\n        'innerHTML': 0 + '&nbsp;' + this.nls.selected + '&nbsp;',\r\n        'style': {\r\n          display: this.layer.objectIdField ? '' : 'none'\r\n        }\r\n      }, countLabel, 'after');\r\n\r\n      var height = html.getStyle(this.domNode, \"height\");\r\n      this.changeHeight(height);\r\n\r\n      this._requestStatus = 'fulfilled';\r\n      this.tableCreated = true;\r\n      html.place(this.loading.domNode, this.grid.domNode);\r\n      this._toggleLoading(false);\r\n    },\r\n\r\n    getSelectedRowsData: function() {\r\n      var def = new Deferred();\r\n      var selectedIds = this._getTableSelectedIds() || [];\r\n      if (!this.grid || !selectedIds.length) {\r\n        def.resolve(null);\r\n        return def;\r\n      }\r\n\r\n      if(this.grid.store instanceof Memory){\r\n        var results = lang.clone(this.grid.store.data);\r\n        def.resolve(results);\r\n      }else{\r\n        this.grid.store\r\n        .query(selectedIds, {_export_count: selectedIds.length})// count specific counts to fetch.\r\n        .then(lang.hitch(this, function(data) {\r\n          var results = data && lang.clone(this.grid.store._entityData || this.grid.store.data);\r\n          def.resolve(results);\r\n        }));\r\n      }\r\n      return def;\r\n    },\r\n\r\n    _appendXY: function(datas){\r\n      //export geometry if shape type of layer is point\r\n      if (datas && this.layer.geometryType === \"esriGeometryPoint\") {\r\n        array.forEach(datas, function(d) {\r\n          var geometry = d.geometry;\r\n          if (geometry && geometry.type === \"point\") {\r\n            if (\"x\" in d) {\r\n              d._x = geometry.x;\r\n            } else {\r\n              d.x = geometry.x;\r\n            }\r\n\r\n            if (\"y\" in d) {\r\n              d._y = geometry.y;\r\n            } else {\r\n              d.y = geometry.y;\r\n            }\r\n          }\r\n\r\n          delete d.geometry;\r\n        });\r\n      }\r\n    },\r\n\r\n    // get out fields for export.\r\n    // isSelectedData equals true means export selected data,\r\n    // we should append x,y fields to _outFields.\r\n    getOutFields: function(isSelectedData){\r\n      var _outFields = null;\r\n      var pk = this.layer.objectIdField;\r\n      _outFields = this._getOutFieldsFromLayerInfos(pk);\r\n      _outFields = this._processExecuteFields(this.layer.fields, _outFields);\r\n      _outFields = this._getVisibleFields(_outFields);\r\n      _outFields = lang.clone(_outFields);\r\n      if(isSelectedData){\r\n        var name = \"\";\r\n        if (_outFields.indexOf('x') !== -1) {\r\n          name = '_x';\r\n        } else {\r\n          name = 'x';\r\n        }\r\n        _outFields.push({\r\n          'name': name,\r\n          alias: name,\r\n          format: {\r\n            'digitSeparator': false,\r\n            'places': 6\r\n          },\r\n          show: true,\r\n          type: \"esriFieldTypeDouble\"\r\n        });\r\n        if (_outFields.indexOf('y') !== -1) {\r\n          name = '_y';\r\n        } else {\r\n          name = 'y';\r\n        }\r\n        _outFields.push({\r\n          'name': name,\r\n          alias: name,\r\n          format: {\r\n            'digitSeparator': false,\r\n            'places': 6\r\n          },\r\n          show: true,\r\n          type: \"esriFieldTypeDouble\"\r\n        });\r\n      }\r\n      return _outFields;\r\n    },\r\n\r\n    setSelectedNumber: function() {\r\n      if (this.selectedRowsLabel && this.grid) {\r\n        var _ids = this.getSelectedRows();\r\n        var currentViewCount = 0;\r\n        // selected number should change with current records in table.\r\n        if (this.grid.store instanceof Memory) {\r\n          var oids = array.map(this.grid.store.data, function(d) {\r\n            return d[this.layer.objectIdField];\r\n          }, this);\r\n          array.forEach(_ids, function(id) {\r\n            if (oids.indexOf(id) > -1) {\r\n              currentViewCount++;\r\n            }\r\n          });\r\n        } else {// query store\r\n          currentViewCount = _ids.length;\r\n        }\r\n        this.selectedRowsLabel.innerHTML = \"&nbsp;&nbsp;\" +\r\n          currentViewCount + \" \" + this.nls.selected + \"&nbsp;&nbsp;\";\r\n      }\r\n    },\r\n\r\n    _setSelection: function(result) {\r\n      result = result || [];\r\n      this._selectionResults = result;\r\n      this.selectionManager.setSelection(this.layer, result);\r\n    },\r\n\r\n    _zoomToExtentByFeatures: function(result) {\r\n      return this.getExtent(result).then(lang.hitch(this, function(gExtent) {\r\n        if (gExtent && this.domNode) {\r\n          var def = null;\r\n          if (gExtent.type === \"point\") {\r\n            // var levelOrFactor = 15;\r\n            // levelOrFactor = this.map.getMaxZoom() > -1 ? this.map.getMaxZoom() : 0.1;\r\n            // // def = this.map.centerAndZoom(gExtent, levelOrFactor);\r\n\r\n            var numLevels = this.map.getNumLevels(),\r\n              currentLevel = this.map.getLevel(),\r\n              last = this.map.getMaxZoom(),\r\n              factor = 4;\r\n\r\n            if (numLevels > 0) { // tiled base layer\r\n              var targetLevel;\r\n              if (currentLevel === last) {// if currentLevel is maxZoomLevel\r\n                targetLevel = currentLevel;\r\n              }else{\r\n                targetLevel = currentLevel + factor;\r\n                if (targetLevel > last) {\r\n                  targetLevel = last;\r\n                }\r\n              }\r\n              def = this.map.centerAndZoom(gExtent, targetLevel);\r\n            } else { // dynamic base layer\r\n              def = this.map.centerAndZoom(gExtent, (1 / Math.pow(2, factor)) * 2);\r\n            }\r\n          } else {\r\n            def = this.map.setExtent(gExtent.expand(2));\r\n          }\r\n\r\n          return def.then((function() {\r\n            return gExtent;\r\n          }));\r\n        }\r\n      }));\r\n    },\r\n\r\n    _showMapInfoWindowByFeatures: function(gExtent, result) {\r\n      if (!result || result.length === 0 || !this.domNode) {\r\n        return;\r\n      }\r\n      var popup = this.map.infoWindow;\r\n      var layerInfoTemplate = this.layerInfo.isPopupEnabled() &&\r\n        this.layerInfo.getInfoTemplate();\r\n      if (popup && popup.setFeatures && result.length === 1 && layerInfoTemplate) {\r\n        array.forEach(result, lang.hitch(this, function(item) {\r\n          // sometimes result come from querytask not local feature\r\n          // so we need to bind the _layer and infoTemplate to the result\r\n          item._layer = this.layerInfo.layerObject;\r\n          item.setInfoTemplate(layerInfoTemplate);\r\n        }));\r\n        popup.setFeatures(result);\r\n\r\n        var location = null;\r\n        if (gExtent.type === \"point\") {\r\n          location = result[0].geometry;\r\n        } else {\r\n          location = gExtent.getCenter();\r\n        }\r\n        popup.show(location, {\r\n          closetFirst: true\r\n        });\r\n\r\n        this._dblClickResult = result[0];\r\n        this.syncWithMapInfowindow(this._dblClickResult);\r\n      }\r\n    },\r\n\r\n    // differect with layer.selectFeatures\r\n    selectFeatures: function(method, result) {\r\n      if (result && result.length > 0) {\r\n        if (method === \"rowclick\" || method === \"selectall\") {// ignore selectall\r\n          this._setSelection(result); // call selectionManager\r\n        } else if (method === \"zoom\" || method === \"row-dblclick\") {\r\n          var gExtent = jimuUtils.graphicsExtent(result);\r\n          var featureSet = jimuUtils.toFeatureSet(result);\r\n          // use \"zoom-end\" and \"pan-end\" to catch zooming animation complete callback\r\n          // more precisely than the callback from \"jimuUtils.zoomToFeatureSet\"\r\n          var onMapZoomOrPan = on(this.map, 'zoom-end, pan-end', lang.hitch(this, function() {\r\n            onMapZoomOrPan.remove();\r\n            if (method !== \"row-dblclick\" || !this.domNode) {\r\n              return;\r\n            }\r\n            this._showMapInfoWindowByFeatures(gExtent, result);\r\n          }));\r\n          // use \"zoomToFeatureSet\" method in jimu/utils to zoom to feature(s)\r\n          jimuUtils.zoomToFeatureSet(this.map, featureSet).then(null, function(err) {\r\n            if (err) {\r\n              console.error(err.message);\r\n              if(onMapZoomOrPan) {\r\n                onMapZoomOrPan.remove();\r\n              }\r\n            }\r\n          });\r\n        }\r\n        this.setSelectedNumber();\r\n        //emit the feature selected event\r\n        this.onFeatureSelectionChange();\r\n      } else {\r\n        //emit the feature selected event\r\n        this.onFeatureSelectionChange();\r\n        this._popupMessage(this.nls.dataNotAvailable);\r\n      }\r\n    },\r\n\r\n    // monitor: feature or [feature]\r\n    syncWithMapInfowindow: function(monitor) {\r\n      var popup = this.map.infoWindow;\r\n      var result = lang.isArray(monitor) ? monitor : [monitor];\r\n      // var sg = monitor;\r\n      on.once(popup, 'hide', lang.hitch(this, function() {\r\n        if (h && h.remove) {\r\n          h.remove();\r\n          h = null;\r\n        }\r\n      }));\r\n      var h = aspect.after(popup, 'show', lang.hitch(this, function() {\r\n        var sg = popup.getSelectedFeature();\r\n        var selectedSg = sg && result[0] === sg;\r\n        var index = -1;\r\n        if(popup.features){\r\n          index = popup.features.indexOf(result[0]);\r\n        }\r\n        if (!selectedSg && index > -1) {\r\n          popup.select(index);\r\n        } else if (this.domNode && !selectedSg) {\r\n          if (h && h.remove) {\r\n            h.remove();\r\n            h = null;\r\n          }\r\n        }\r\n      }));\r\n    },\r\n\r\n    getGraphicsFromLocalFeatureLayer: function(ids) {\r\n      var gs = [],\r\n        id,\r\n        idsi;\r\n      var len = ids.length;\r\n      var n = this.layer.graphics.length;\r\n      var objectid = this.layer.objectIdField;\r\n      for (var i = 0; i < len; i++) {\r\n        for (var m = 0; m < n; m++) {\r\n          id = this.layer.graphics[m].attributes[objectid] + \"\";\r\n          idsi = ids[i] + \"\";\r\n          if (id === idsi) {\r\n            gs.push(this.layer.graphics[m]);\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      return gs;\r\n    },\r\n\r\n    // addGraphics: function(result) {\r\n    //   var symbol, graphic;\r\n    //   var len = result.length;\r\n    //   var outlineSymbol = new SimpleLineSymbol(\r\n    //     SimpleLineSymbol.STYLE_SOLID,\r\n    //     new Color([0, 255, 255]),\r\n    //     2\r\n    //   );\r\n    //   // this.graphicsLayer.clear();\r\n\r\n    //   for (var i = 0; i < len; i++) {\r\n    //     var geometry = null;\r\n    //     if (!result[i].geometry) {\r\n    //       console.error('unable to get geometry of the reocord: ', result[i]);\r\n    //       continue;\r\n    //     } else if (!result[i].geometry.spatialReference.equals(this.map.spatialReference)) {\r\n    //       console.warn('unable to draw graphic result in different wkid from map');\r\n    //     }\r\n    //     if (result[i].geometry.type === \"point\") {\r\n    //       geometry = new Point(result[i].geometry.toJson());\r\n    //       symbol = lang.clone(this.map.infoWindow.markerSymbol);\r\n    //     } else if (result[i].geometry.type === \"multipoint\") {\r\n    //       geometry = new Multipoint(result[i].geometry.toJson());\r\n    //       symbol = lang.clone(this.map.infoWindow.markerSymbol);\r\n    //     } else if (result[i].geometry.type === \"polyline\") {\r\n    //       geometry = new Polyline(result[i].geometry.toJson());\r\n    //       symbol = outlineSymbol;\r\n    //     } else if (result[i].geometry.type === \"polygon\") {\r\n    //       geometry = new Polygon(result[i].geometry.toJson());\r\n    //       symbol = new SimpleFillSymbol(\r\n    //         SimpleFillSymbol.STYLE_SOLID,\r\n    //         outlineSymbol,\r\n    //         new Color([255, 255, 255, 0.25])\r\n    //       );\r\n    //     }\r\n    //     graphic = new Graphic(geometry, symbol, result[i].attributes, result[i].infoTemplate);\r\n    //     // this.graphicsLayer.add(graphic);\r\n    //   }\r\n    // },\r\n\r\n    getExtent: function(result) {\r\n      var def = new Deferred();\r\n\r\n      var extent, points;\r\n      var len = result.length;\r\n      if (len === 1 && result[0].geometry && result[0].geometry.type === \"point\") {\r\n        extent = result[0].geometry;\r\n      } else if (len === 1 && !result[0].geometry) {\r\n        def.reject(new Error('AttributeTable.getExtent:: extent was not projected.'));\r\n        return def;\r\n      } else {\r\n        for (var i = 0; i < len; i++) {\r\n          if (!result[i].geometry) {\r\n            console.error('unable to get geometry of the reocord: ', result[i]);\r\n            continue;\r\n          }\r\n          if (result[i].geometry.type === \"point\") {\r\n            if (!points) {\r\n              points = new Multipoint(result[i].geometry.spatialReference);\r\n              points.addPoint(result[i].geometry);\r\n            } else {\r\n              points.addPoint(result[i].geometry);\r\n            }\r\n            if (i === (len - 1)) {\r\n              extent = points.getExtent();\r\n            }\r\n          } else {\r\n            if (!extent) {\r\n              extent = result[i].geometry.getExtent();\r\n            } else {\r\n              extent = extent.union(result[i].geometry.getExtent());\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!extent || !extent.spatialReference) {\r\n        def.reject(new Error(\"AttributeTable.getExtent:: extent was not projected.\"));\r\n        return def;\r\n      }\r\n\r\n      // convert to map sr\r\n      var sr = this.map.spatialReference;\r\n      if (extent.spatialReference.equals(sr)) {\r\n        def.resolve(extent);\r\n      } else {\r\n        var parameter = new ProjectParameters();\r\n        parameter.geometries = [extent];\r\n        parameter.outSR = sr;\r\n\r\n        esriConfig.defaults.geometryService.project(\r\n          parameter,\r\n          lang.hitch(this, function(geometries) {\r\n            if (!this.domNode) {\r\n              return;\r\n            }\r\n            if (geometries && geometries.length) {\r\n              def.resolve(geometries[0]);\r\n            } else {\r\n              def.reject(new Error(\"AttributeTable.getExtent:: extent was not projected.\"));\r\n            }\r\n          }), lang.hitch(this, function(err) {\r\n            // projection error\r\n            if (!err) {\r\n              err = new Error(\"AttributeTable.getExtent:: extent was not projected.\");\r\n            }\r\n            def.reject(err);\r\n          }));\r\n      }\r\n      return def;\r\n    },\r\n\r\n    // scroll records to view when click feature in map if possible\r\n    // 1. get selected feature objectId\r\n    // 2. calculate row position based on objectId if sorted by objectId ASC:_getIndexOfIdInGrid\r\n    // 3. scroll to the position\r\n    _onFeaturelayerClick: function(evt, fromPopup) {\r\n      if (!this.actived) {\r\n        return;\r\n      }\r\n      var graphic = lang.getObject('graphic', false, evt);\r\n      var attributes = lang.getObject('graphic.attributes', false, evt);\r\n      if (!attributes || !graphic || graphic._layer !== this.layer) {\r\n        return;\r\n      }\r\n      var sg = this.map.infoWindow.getSelectedFeature();\r\n      if (sg && sg._layer === this.layer && !fromPopup) {\r\n        this.map.infoWindow.hide();\r\n      }\r\n\r\n      var id = attributes[this.layer.objectIdField];\r\n      if (this.showSelected) {\r\n        this.toggleSelectedRecords();\r\n      }\r\n      // this.clearSelection(false);\r\n      // for now doesn't get index correctly if other fields be sorted\r\n      this._getIndexOfIdInGrid(id).then(lang.hitch(this, function(dataIndex) {\r\n        if (dataIndex === -1) {\r\n          return;\r\n        }\r\n\r\n        this.grid.scrollTo({\r\n          x: 0,\r\n          y: this.grid.rowHeight * dataIndex\r\n        });\r\n\r\n        if (this.map.infoWindow.features) {\r\n          var index = this.map.infoWindow.features.indexOf(evt.graphic);\r\n          this.map.infoWindow.select(index);\r\n        }\r\n\r\n        on.once(this.map.infoWindow, 'selection-change', lang.hitch(this, function() {\r\n          var graphic = this.map.infoWindow.getSelectedFeature();\r\n          var _layer = lang.getObject('_layer', false, graphic);\r\n          if (graphic === evt.graphic || _layer !== this.layer) {\r\n            return;\r\n          }\r\n          this._onFeaturelayerClick({\r\n            graphic: graphic\r\n          }, true);\r\n        }));\r\n        this.syncWithMapInfowindow(evt.graphic);\r\n      }));\r\n    },\r\n\r\n    _getIndexOfIdInGrid: function(id) {\r\n      var def = new Deferred();\r\n      var dataIndex = -1;\r\n      var objectIds = lang.getObject('store.objectIds', false, this.grid);\r\n\r\n      var compare = null;\r\n      var sort = this.grid.get('sort')[0];\r\n\r\n      if (this._relatedQuery) {\r\n        def.resolve(-1);\r\n        return def;\r\n      }\r\n\r\n      if (this.grid.store instanceof Memory) {\r\n        var obj = this.grid.store.get(id);\r\n        var data = this.grid.store.data;\r\n        if (!obj) {\r\n          dataIndex = -1;\r\n        }else if (sort && sort.attribute && esriLang.isDefined(sort.descending)) {\r\n          data = lang.clone(data);\r\n          compare = (function(attr, des) {\r\n            return function(a, b) {\r\n              if (a[attr] === b[attr]) {\r\n                return 0;\r\n              }\r\n\r\n              return a[attr] < b[attr] ? (des ? 1 : -1) : (des ? -1 : 1);\r\n            };\r\n          })(sort.attribute, sort.descending);\r\n          data.sort(compare);\r\n          data = array.map(data, function(d) {\r\n            return d[this.layer.objectIdField];\r\n          }, this);\r\n          dataIndex = data.indexOf(obj[this.layer.objectIdField]);\r\n        } else {\r\n          dataIndex = data.indexOf(obj);\r\n        }\r\n        def.resolve(dataIndex);\r\n      } else if (objectIds && objectIds.length > 0) {// in this case does't support sort\r\n        dataIndex = objectIds.indexOf(id);\r\n        def.resolve(dataIndex);\r\n      } else {\r\n        var query = new Query();\r\n        query.returnGeometry = false;\r\n        query.where = this._getLayerFilterExpression() + \" AND \" +\r\n          this.layer.objectIdField + \" < \" + id;\r\n        // query count cann't get right postion if users ordered by other fields\r\n        if (sort && !(sort.attribute === this.layer.objectIdField && !sort.descending)) {\r\n          def.resolve(-1);\r\n          return def;\r\n        }\r\n        // if (sort && sort.attribute && esriLang.isDefined(sort.descending)) {\r\n        //   query.orderByFields = [sort.attribute + (sort.descending ? \" DESC\" : \" ASC\")];\r\n        // }\r\n\r\n        // query.outFields = [this.layer.objectIdField, sort.attribute];\r\n\r\n        if (this.matchingMap && !this._relatedQuery && this._currentExtent) {\r\n          query.geometry = this._currentExtent;\r\n        }\r\n\r\n        var countDef = this._currentDef = this.layer.queryCount(query);\r\n        // var countDef = this._currentDef = this.layer.queryFeatures(query);\r\n        countDef.then(lang.hitch(this, function(count) {\r\n          def.resolve(count);\r\n        }), lang.hitch(this, function(err) {\r\n          def.reject(err);\r\n        }));\r\n      }\r\n\r\n      return def;\r\n    },\r\n\r\n    // _onRefreshComplete: function(evt) {\r\n    //   if (evt.grid._clickShowSelectedRecords) {\r\n    //     var selectedIds = this.getSelectedRows();\r\n    //     array.forEach(selectedIds, lang.hitch(this, function(id) {\r\n    //       evt.grid.select(id);\r\n    //     }));\r\n\r\n    //     evt.grid._clickShowSelectedRecords = false;\r\n    //   }\r\n    // },\r\n\r\n    _zoomToSelected: function() {\r\n      if (!this.configedInfo || !this.tableCreated) {\r\n        return;\r\n      }\r\n      var ids = this.getSelectedRows();\r\n      this._goToFeatures(ids, 'zoom');\r\n    },\r\n\r\n    _goToFeatures: function(ids, method) {\r\n      if (ids.length === 0) {\r\n        return;\r\n      } else {\r\n        var localGraphics = this.getGraphicsFromLocalFeatureLayer(ids);\r\n        if (this.isSupportQueryToServer() && ids.length !== localGraphics.length) {\r\n          this._queryFeaturesByIds(ids, method);\r\n          return;\r\n        } else {\r\n          //this.isSupportQueryOnClient()\r\n          // or supportQueryToServer but can get graphics in client directly\r\n          this.selectFeatures(\r\n            method,\r\n            localGraphics\r\n          );\r\n        }\r\n      }\r\n    },\r\n\r\n    _onDblclickRow: function(evt) {\r\n      if (this.layerInfo &&\r\n        this.layerInfo.isShowInMap()) {\r\n        // this._zoomToSelected();\r\n        var row = this.grid.row(evt);\r\n        var ids = [row.id];\r\n        this._goToFeatures(ids, 'row-dblclick');\r\n      }\r\n    },\r\n\r\n    _queryFeaturesByIds: function(ids, mode) {\r\n      var query = new Query();\r\n      query.objectIds = ids;\r\n      query.returnGeometry = true;\r\n      query.outSpatialReference = lang.clone(this.map.spatialReference);\r\n      query.outFields = ['*'];\r\n      var _layer = this.layer;\r\n      var isCSVLayer = _layer.declaredClass === \"esri.layers.CSVLayer\";\r\n      if (_layer.url && !isCSVLayer) {\r\n        //we always select feature from server if layer has url\r\n        var queryTask = new QueryTask(_layer.url);\r\n        queryTask.execute(\r\n          query,\r\n          lang.hitch(this, function(fset) {\r\n            this.selectFeatures(mode, fset.features);\r\n          }),\r\n          lang.hitch(this, this._errorSelectFeatures)\r\n        );\r\n      } else { // FeatureCollection do query on client\r\n        _layer.selectFeatures(\r\n          query,\r\n          FeatureLayer.SELECTION_NEW,\r\n          lang.hitch(this, this.selectFeatures, mode),\r\n          lang.hitch(this, this._errorSelectFeatures)\r\n        );\r\n      }\r\n    },\r\n\r\n    _onHeaderClick: function(evt) {\r\n      var cell = this.grid.cell(evt);\r\n      var column = cell.column;\r\n      var cellBoundingRect = cell.element.getBoundingClientRect();\r\n      var coords = {\r\n        x: evt.pageX || cellBoundingRect.x + cellBoundingRect.width * 0.5,\r\n        y: evt.pageY || cellBoundingRect.y + cellBoundingRect.height\r\n      };\r\n      this._showColumnMenu(column, cell, evt.target, coords);\r\n    },\r\n\r\n    _showColumnMenu: function(column, cell, target, coords) {\r\n      var info = lang.getObject(\"_cache\", false, column);\r\n      if (!info || !info.sortable && !info.statistics) {\r\n        return;\r\n      }\r\n      var cm = new Menu({});\r\n      html.addClass(cm.domNode, 'jimu-widget-attributetable-feature-menu');\r\n      var that = this;\r\n      if (info.sortable) {\r\n        var labelArray = [\r\n          this.nls.sortAsc,\r\n          this.nls.sortDes\r\n        ];\r\n        var iconArray = [\r\n          \"iconSortAscending\",\r\n          \"iconSortDescending\"\r\n        ];\r\n\r\n        array.forEach(labelArray, function(label, idx) {\r\n          var menuItem = new MenuItem({\r\n            \"label\": label,\r\n            \"iconClass\": iconArray[idx],\r\n            \"baseClass\": \"menuItemClass\",\r\n            onClick: function() {\r\n              if (0 === idx) {\r\n                that.grid.set('sort', column.field, false);\r\n              } else if (1 === idx) {\r\n                that.grid.set('sort', column.field, true);\r\n              }\r\n            }\r\n          });\r\n          cm.addChild(menuItem);\r\n        });\r\n      }\r\n      if (info.statistics) {\r\n        var menuItem = new MenuItem({\r\n          label: this.nls.statistics,\r\n          iconClass: \"iconTableStatistics\",\r\n          baseClass: \"menuItemClass\",\r\n          onClick: lang.hitch(this, function() {\r\n            var statInfo = {\r\n              layer: this.layer,\r\n              filterExpression: this._getLayerFilterExpression(),\r\n              fieldNames: [column.field]\r\n            };\r\n\r\n            if (this.matchingMap) {// map extent\r\n              statInfo.geometry = this._currentExtent;\r\n            }\r\n\r\n            if (this.showSelected) { // only show Selected records\r\n              var selectedIds = this._getSelectedIds();\r\n              statInfo.filterExpression += ' AND ' + this.layer.objectIdField +\r\n              ' IN (' + selectedIds.join() + ')';\r\n            } else {\r\n              //related mode or featureSet(View In Table Action)\r\n              if (this.queryByStoreObjectIds && this.queryByStoreObjectIds.length > 0) {\r\n                statInfo.filterExpression += ' AND ' + this.layer.objectIdField +\r\n                ' IN (' + this.queryByStoreObjectIds.join() + ')';\r\n              }\r\n            }\r\n\r\n            this.fieldStatistics = new FieldStatistics();\r\n            this.fieldStatistics.showContentAsPopup(statInfo);\r\n            // on.once(this.FieldStatistics, 'statistics', lang.hitch(this, function(evt) {\r\n            //   this.emit('show-statistics', evt);\r\n            // }));\r\n          })\r\n        });\r\n        cm.addChild(menuItem);\r\n      }\r\n\r\n      var childCount = cm.getChildren();\r\n\r\n      cm.startup();\r\n      cm._openMyself({\r\n        \"target\": target,\r\n        delegatedTarget: cell,\r\n        iframe: null,\r\n        \"coords\": coords\r\n      });\r\n\r\n      this.own(on(cm, 'Close', lang.hitch(this, function() {\r\n        var menu = this.get('columnMenu');\r\n        if (menu) {\r\n          menu.destroyRecursive();\r\n          this.set('columnMenu', null);\r\n        }\r\n      })));\r\n      this.set('columnMenu', cm);\r\n\r\n      if (childCount.length < 1) {\r\n        on.emit(cm, 'Close');\r\n      }\r\n    },\r\n\r\n    _onColumnStateChange: function(evt) {\r\n      if (evt && evt.grid && evt.grid.columns){\r\n        // var visibleFields = array.filter(evt.grid.columns, lang.hitch(this, function(c) {\r\n        //   return !c.hidden;\r\n        // }));\r\n        // var len = visibleFields.length;\r\n        var len = 0;\r\n        for (var p in evt.grid.columns) {\r\n          if (!evt.grid.columns[p].hidden) {\r\n            len++;\r\n          }\r\n        }\r\n\r\n        if ((20 * 1 + 100 * len - 1) < html.getMarginBox(this.domNode).w) {\r\n          html.addClass(this.domNode, 'auto-width');\r\n        } else {\r\n          html.removeClass(this.domNode, 'auto-width');\r\n        }\r\n      }\r\n    },\r\n\r\n    _onSelectionHandleClick: function() {\r\n      var ids = this._getSelectedIds();\r\n      this.selectionRows = ids;\r\n\r\n      this._closePopup();\r\n      if (!this.layerInfo.isTable) {\r\n        if (ids.length > 0) {\r\n          this._goToFeatures(ids, 'rowclick');\r\n        } else {\r\n          //emit the feature selected event\r\n          this.onFeatureSelectionChange();\r\n          this._setSelection([]);\r\n        }\r\n      }\r\n\r\n      this.setSelectedNumber();\r\n\r\n      if(this.getSelectedRows().length === 1) {\r\n        this._setFarOffRemoval(this.GRID_FAR_OFF_REMOVAL.RESELECTION);\r\n      }\r\n\r\n      this.emit('row-click', {\r\n        table: this,\r\n        selectedIds: ids\r\n      });\r\n    },\r\n\r\n    _onExtentChange: function(params) {\r\n      var x = lang.getObject('delta.x', false, params);\r\n      var y = lang.getObject('delta.y', false, params);\r\n      // sometimes click map will emit extent change,\r\n      //so we need to judge whether delta really changed\r\n      var really = (this._clickMap && !params.levelChange) ?\r\n        isFinite(x) && isFinite(y) && (Math.abs(x) > 0 || Math.abs(y) > 0) : true;\r\n      this._clickMap = false;\r\n      if (!really) {\r\n        return;\r\n      }\r\n      if (this.matchingMap && this.actived && (this.layerInfo && !this.layerInfo.isTable)) {\r\n        this.startQuery(this.queryByStoreObjectIds);\r\n      }\r\n    },\r\n\r\n    _getLayerFilterExpression: function() {\r\n      // var expr = (this._filterObj && this._filterObj.expr) || \"\";\r\n\r\n      // var mapFilter = this.layerInfo.getFilterOfWebmap();\r\n\r\n      // if (expr) {\r\n      //   if (mapFilter) {\r\n      //     return expr + \" AND \" + mapFilter;\r\n      //   } else {\r\n      //     return expr;\r\n      //   }\r\n      // } else if (mapFilter) {\r\n      //   return mapFilter;\r\n      // }\r\n\r\n      var layerFilter = this.layerInfo.getFilter();\r\n      if (layerFilter) {\r\n        return layerFilter;\r\n      }\r\n\r\n      return \"1=1\";\r\n    },\r\n\r\n    _getOutFieldsFromLayerInfos: function(pk) {\r\n      var fields = this.configedInfo.layer.fields;\r\n      var pInfos = this.layerInfo.getPopupInfo();\r\n      var lFields = pInfos && pInfos.fieldInfos;\r\n      var oFields = [];\r\n      if (fields) {\r\n        array.forEach(fields, lang.hitch(this, function(field) {\r\n          if (!esriLang.isDefined(field.show)) {\r\n            field.show = true;\r\n            // check if the field is defined via configuration of map popup\r\n            if(lFields) {\r\n              for (var i = 0, len = lFields.length; i < len; i++) {\r\n                var f = lFields[i];\r\n                if (f.fieldName === field.name) {\r\n                  field.show = f.visible;\r\n                }\r\n              }\r\n            }\r\n          }\r\n          if (field.name === pk &&\r\n            // Fields come from layer.fields\r\n            ((field.type === 'esriFieldTypeOID' || field.type === 'esriFieldTypeInteger') ||\r\n              // Fields come from config.layer.fileds\r\n              !field.type)\r\n          ) {\r\n            field._pk = true;\r\n          }\r\n          if (field.show || field._pk) {\r\n            oFields.push(field);\r\n          }\r\n        }));\r\n      }\r\n      return oFields;\r\n    },\r\n\r\n    _processExecuteFields: function(rFields, oFields) {\r\n      if (rFields && rFields.length > 0) {\r\n        var outFields = [];\r\n        if (!oFields.length) {\r\n          return rFields;\r\n        }\r\n        for (var i = 0, len = oFields.length; i < len; i++) {\r\n          for (var j = 0; j < rFields.length; j++) {\r\n            if (oFields[i].name === rFields[j].name &&\r\n              (oFields[i].type === rFields[j].type || // oFields come from layer.fields\r\n                !oFields[i].type) // oFields come from config.layer.fileds\r\n            ) {\r\n              rFields[j] = lang.mixin(rFields[j], oFields[i]);\r\n              outFields.push(rFields[j]);\r\n            }\r\n          }\r\n        }\r\n        return outFields;\r\n      } else {\r\n        return oFields;\r\n      }\r\n\r\n      return rFields;\r\n    },\r\n\r\n    _getVisibleFields: function(oFields) {\r\n      var hiddenFields = [];\r\n      if(this.grid && this.grid.columns) {\r\n        for(var field in this.grid.columns) {\r\n          var columnField = this.grid.columns[field];\r\n          if(columnField && columnField.hidden) {\r\n            hiddenFields.push(columnField.field);\r\n          }\r\n        }\r\n        return array.filter(oFields, function(oField) {\r\n          if(hiddenFields.indexOf(oField.name) < 0) {\r\n            return oField;\r\n          }\r\n        });\r\n      }\r\n      return oFields;\r\n    },\r\n\r\n    _getSelectedIds: function() {\r\n      var ids = [];\r\n      var selection = this.grid.selection;\r\n      for (var id in selection) {\r\n        if (selection[id]) {\r\n          if (isFinite(id)) {\r\n            ids.push(parseInt(id, 10));\r\n          } else {\r\n            ids.push(id);\r\n          }\r\n        }\r\n      }\r\n\r\n      return ids;\r\n    },\r\n\r\n    // different from fun:_getSelectedIds,table selected counts may differ\r\n    // from layer selected if filtered by extent.\r\n    _getTableSelectedIds: function(){\r\n      var ids = [];\r\n      var _ids = this.getSelectedRows();\r\n      if (this.grid) {\r\n        // selected number should change with current records in table.\r\n        if (this.grid.store instanceof Memory) {\r\n          var oids = array.map(this.grid.store.data, function(d) {\r\n            return d[this.layer.objectIdField];\r\n          }, this);\r\n          array.forEach(_ids, function(id) {\r\n            if (oids.indexOf(id) > -1) {\r\n              ids.push(parseInt(id, 10));\r\n            }\r\n          });\r\n        }else{\r\n          ids = _ids;// as default.\r\n        }\r\n      }\r\n      return ids;\r\n    },\r\n\r\n    // check table mode is selection mode.\r\n    isSelectionMode: function(){\r\n      //now dgid is created\r\n      var selectionRows = this.getSelectedRows();\r\n      if (this.tableCreated && selectionRows && selectionRows.length > 0 &&\r\n        this.layer && this.layer.objectIdField) {\r\n        return true;\r\n      } else {\r\n        return false;\r\n      }\r\n    },\r\n\r\n    _errorSelectFeatures: function(params) {\r\n      console.error(params);\r\n    },\r\n\r\n    _popupMessage: function(message) {\r\n      var popup = new Message({\r\n        message: message,\r\n        buttons: [{\r\n          label: this.nls.ok,\r\n          onClick: lang.hitch(this, function() {\r\n            popup.close();\r\n          })\r\n        }]\r\n      });\r\n\r\n      this._toggleLoading(false);\r\n    },\r\n\r\n    _hasArcadeExpressionFields: function() {\r\n      return this.layerInfo.getPopupInfo() &&\r\n        this.layerInfo.getPopupInfo().expressionInfos &&\r\n        array.some(this.configedInfo.layer.fields, function(field) {\r\n          return tableUtils.arcade.isArcadeExpressionField(field);\r\n        });\r\n    },\r\n\r\n    _hasArcadeExpressionWithGeometry: function() {\r\n      var expressionInfos = this.layerInfo.getPopupInfo() &&\r\n        this.layerInfo.getPopupInfo().expressionInfos;\r\n      var parsedExpressions = tableUtils.arcade.parseArcadeExpressions(expressionInfos);\r\n      if(parsedExpressions) {\r\n        return array.some(Object.keys(parsedExpressions), function(expr) {\r\n          return parsedExpressions[expr].usesGeometry;\r\n        });\r\n      }\r\n      return false;\r\n    },\r\n\r\n    _toggleLoading: function(show) {\r\n      if(show === undefined) {\r\n        var isHidden = this.loading.hidden;\r\n        if(isHidden) {\r\n          this.loading.show();\r\n        } else {\r\n          this.loading.hide();\r\n        }\r\n      } else {\r\n        if(show) {\r\n          this.loading.show();\r\n        } else {\r\n          this.loading.hide();\r\n        }\r\n      }\r\n    },\r\n\r\n    _setFarOffRemoval: function(number) {\r\n      if(this.tableCreated && !isNaN(number)) {\r\n        this.grid.set('farOffRemoval', number);\r\n      }\r\n    },\r\n\r\n    // same logic taken from \"jimu.js/dijit/_FeatureSetChooserCore.js\"\r\n    _handleFilterChange: function() {\r\n      var selectedFeatures = this.layer.getSelectedFeatures();\r\n      var objectIdField = this.layer.objectIdField;\r\n      if (selectedFeatures && selectedFeatures.length > 0) {\r\n        var selectionIds = array.map(selectedFeatures, function(feature) {\r\n          return feature.attributes[objectIdField];\r\n        });\r\n        var queryParams = new Query();\r\n        queryParams.where = objectIdField + ' in (' + selectionIds.join(',') + ') AND ' +\r\n        this.layerInfo.getFilter();\r\n        var queryTask = new QueryTask(this.layer.url);\r\n        queryTask.executeForIds(queryParams).then(lang.hitch(this, function(filterIds){\r\n          array.forEach(selectedFeatures, function(feature) {\r\n            if (filterIds && filterIds.indexOf(feature.attributes[objectIdField]) >= 0) {\r\n              feature.show();\r\n            } else {\r\n              feature.hide();\r\n            }\r\n          });\r\n          if (this.selectionManager._isLayerNeedDisplayLayer(this.layer)) {\r\n            this.selectionManager._updateDisplayLayer(this.layer, selectedFeatures, FeatureLayer.SELECTION_NEW);\r\n          }\r\n        }), lang.hitch(this, function(err){\r\n          console.error(err);\r\n        }));\r\n      }\r\n    }\r\n  });\r\n});\r\n"]}