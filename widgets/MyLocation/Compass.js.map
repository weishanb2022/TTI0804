{"version":3,"sources":["../../../widgets/MyLocation/Compass.js"],"names":["define","declare","lang","Deferred","BaseWidget","on","PictureMarkerSymbol","SimpleFillSymbol","SimpleLineSymbol","Graphic","Color","Circle","instance","clazz","constructor","folderUrl","map","config","id","Date","getTime","_debug","inherited","arguments","show","parameters","geoLocate","spatialReference","isWebMercator","useCompass","_showDirection","useAccCircle","_showAccCircle","useTracking","_destroyDirectionHandler","directionEvent","window","DeviceOrientationEvent","_directionHandler","hitch","_watchMobileLocation","event","alpha","webkitCompassHeading","Math","abs","displayOrientation","orientation","angle","symbolOption","url","width","height","highlightGraphic","setSymbol","_destroyAccCircle","_graphicsLayer","centerPt","geometry","accuracy","position","coords","accCircleR","getResolution","circle","center","radius","g","STYLE_SOLID","add","_accCircle","_accCircleGraphicsLayer","clean","destroy","remove","getInstance","needCompass","locateButton","highlightLocation","checkPermission","def","requestPermission","then","response","resolve","catch","error"],"mappings":"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","file":"Compass.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n  'dojo/_base/declare',\r\n  'dojo/_base/lang',\r\n  'dojo/Deferred',\r\n  //'dojo/_base/html',\r\n  'jimu/BaseWidget',\r\n  'dojo/on',\r\n  //'dojo/query',\r\n  //'jimu/utils',\r\n  'esri/symbols/PictureMarkerSymbol',\r\n  \"esri/symbols/SimpleFillSymbol\",\r\n  \"esri/symbols/SimpleLineSymbol\",\r\n  \"esri/graphic\",\r\n  \"esri/Color\",\r\n  \"esri/geometry/Circle\"\r\n],\r\n  function (declare, lang, Deferred,/*html,*/ BaseWidget, on,/*query, utils,*/\r\n    PictureMarkerSymbol, SimpleFillSymbol, SimpleLineSymbol, Graphic, Color, Circle) {\r\n\r\n    var instance = null, clazz;\r\n    clazz = declare([BaseWidget], {\r\n      //show compass on mobile\r\n      constructor: function (folderUrl, map, config) {\r\n        this.id = \"widget-myLocation-compass-\" + new Date().getTime();\r\n        this.map = map;\r\n        this.folderUrl = folderUrl;\r\n        this.config = config;\r\n\r\n        this._debug = 0;\r\n\r\n        this.inherited(arguments);\r\n      },\r\n\r\n      show: function (parameters, geoLocate) {\r\n        if (!(this.map.spatialReference.isWebMercator() || this.map.spatialReference === 4326)) {\r\n          return; //support WebMercator only\r\n        }\r\n        // if(!jimuUtils.isMobileUa()){\r\n        //   return;\r\n        // }\r\n        if (true === this.config.useCompass) {\r\n          this._showDirection(geoLocate);\r\n        }\r\n        if (true === this.config.useAccCircle) {\r\n          this._showAccCircle(parameters, geoLocate);\r\n        }\r\n      },\r\n\r\n      //1. Direction\r\n      _showDirection: function (geoLocate) {\r\n        if (geoLocate.useTracking) {\r\n          this._destroyDirectionHandler();\r\n          var directionEvent;\r\n\r\n          //var _flag1;\r\n          if ('ondeviceorientationabsolute' in window) {\r\n            directionEvent = \"deviceorientationabsolute\";// Chrome 50+ specific, \"deviceorientationabsolute\"\r\n          //  _flag1 = \"1\";\r\n          } else if ('ondeviceorientation' in window) {\r\n            directionEvent = \"deviceorientation\";//Safari/iOS\r\n          //  _flag1 = \"2\";\r\n          } else if (DeviceOrientationEvent) {\r\n            directionEvent = \"deviceorientation\";//FF\r\n          //  _flag1 = \"3\";\r\n          }\r\n          //document.querySelector(\".jimu-subtitle\").innerText = this._flag1;\r\n\r\n          this._directionHandler = on(window, directionEvent, lang.hitch(this, this._watchMobileLocation, geoLocate));\r\n        }\r\n      },\r\n\r\n      _watchMobileLocation: function (geoLocate, event) {\r\n        if (!event) {\r\n          return;\r\n        }\r\n\r\n        var alpha;\r\n        if (event.webkitCompassHeading || event.alpha) {\r\n          alpha = event.webkitCompassHeading || Math.abs(event.alpha - 360);\r\n        }\r\n        var displayOrientation = window.orientation || 0;//Landscape: 90(head to left)/-90, Portrait: 0/180(head to bottom)\r\n        //if (this._debug) {\r\n        //  document.querySelector(\".jimu-title\").innerText = \"==>\"+this._flag1 +parseInt(alpha)+\"==>\"+displayOrientation;\r\n        //}\r\n\r\n        if (\"undefined\" !== typeof alpha) {\r\n          var angle = -alpha - displayOrientation;\r\n          var symbolOption = {\r\n            url: this.folderUrl + \"/images/compass.png\",\r\n            width: 36,\r\n            height: 36,\r\n            angle: angle\r\n          };\r\n          var highlightGraphic = geoLocate.highlightGraphic;\r\n\r\n          highlightGraphic.setSymbol(new PictureMarkerSymbol(symbolOption));\r\n        }\r\n      },\r\n\r\n      //2. accuracy circle\r\n      _showAccCircle: function (parameters, geoLocate) {\r\n        this._destroyAccCircle();\r\n        var highlightGraphic = geoLocate.highlightGraphic;\r\n        if (highlightGraphic && highlightGraphic._graphicsLayer) {\r\n          var centerPt = highlightGraphic.geometry;\r\n\r\n          var accuracy = parameters.position.coords.accuracy;\r\n          var accCircleR = accuracy / this.map.getResolution();//px\r\n          var circle = new Circle({\r\n            center: centerPt,\r\n            radius: accCircleR\r\n          });\r\n\r\n          var g = new Graphic(circle, new SimpleFillSymbol(\r\n            SimpleFillSymbol.STYLE_SOLID,\r\n            new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([94, 164, 255, 0.2]), 1),//outline\r\n            new Color([16, 119, 255, 0.2])\r\n          ));\r\n          highlightGraphic._graphicsLayer.add(g);\r\n\r\n          //cache\r\n          this._accCircle = g;\r\n          this._accCircleGraphicsLayer = highlightGraphic._graphicsLayer;\r\n        }\r\n      },\r\n\r\n      clean: function () {\r\n        this._destroyDirectionHandler();\r\n        this._destroyAccCircle();\r\n      },\r\n      //destroy\r\n      destroy: function () {\r\n        this.clean();\r\n        this.inherited(arguments);\r\n      },\r\n      _destroyDirectionHandler: function () {\r\n        if (this._directionHandler) {\r\n          if (this._directionHandler.remove) {\r\n            this._directionHandler.remove();\r\n          }\r\n          this._directionHandler = null;\r\n        }\r\n      },\r\n      _destroyAccCircle: function () {\r\n        if (this._accCircleGraphicsLayer && this._accCircleGraphicsLayer.remove && this._accCircle) {\r\n          this._accCircleGraphicsLayer.remove(this._accCircle);\r\n          this._accCircle = null;\r\n        }\r\n      }\r\n    });\r\n\r\n    clazz.getInstance = function (folderUrl, map, config) {\r\n      if (instance === null) {\r\n        instance = new clazz(folderUrl, map, config);\r\n      }\r\n      return instance;\r\n    };\r\n    clazz.needCompass = function (config) {\r\n      if (true !== config.locateButton.highlightLocation || true !== config.locateButton.useTracking) {\r\n        return false;//1 or all false\r\n      }\r\n      if (true !== config.useCompass && true !== config.useAccCircle) {\r\n        return false;//all false\r\n      }\r\n\r\n      return true;\r\n    };\r\n    //https://developer.apple.com/documentation/safari-release-notes/safari-13-release-notes#3314664\r\n    clazz.checkPermission = function () {\r\n      var def = new Deferred();\r\n      //var ua = utils.detectUserAgent();\r\n      //var isIos = utils.isIosUa(),\r\n      //    isSafari = ua.browser.safari;\r\n      //alert(\"isSafari==> \" + isSafari)\r\n\r\n      //ios don't support def in requestPermission, so request directly\r\n      if (/*isIos && isSafari &&*/DeviceOrientationEvent && DeviceOrientationEvent.requestPermission) {\r\n        DeviceOrientationEvent.requestPermission()\r\n          .then(lang.hitch(this, function (response) {\r\n            if (response == \"granted\") {\r\n              def.resolve(true);\r\n            } else {\r\n              def.resolve(false);\r\n            }\r\n          }))\r\n          .catch(function (error) {\r\n            def.resolve(false);\r\n          });\r\n      } else {\r\n        def.resolve(false);\r\n      }\r\n      return def;\r\n    };\r\n    return clazz;\r\n  });"]}