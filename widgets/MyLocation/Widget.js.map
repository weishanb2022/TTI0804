{"version":3,"sources":["../../../widgets/MyLocation/Widget.js"],"names":["define","declare","Deferred","GraphicsLayer","BaseWidget","LocateButton","html","on","lang","jimuUtils","Compass","a11y","clazz","name","baseClass","moveTopOnActive","_DEBUG","_graphicsLayer","_locateAction","locator","cacheLatestTracking","startup","inherited","arguments","placehoder","create","title","label","domNode","a11y_updateLabel","nls","_widgetLabel","isNeedHttpsButNot","console","log","addClass","setAttr","httpNotSupportError","a11y_disable","window","navigator","geolocation","own","hitch","onLocationClickWapper","map","_scaleChangeHandler","a11y_initEvents","a11y_enable","_createHiddenLocator","browserError","evt","stopPropagation","needCompass","config","checkPermission","then","onLocationClick","hasClass","geoLocate","_canDestroy","_destroyGeoLocate","_tryToCleanCompass","_createGeoLocateAndLocate","getGeoLocateInstance","locate","def","resolve","json","locateButton","useTracking","centerAt","setScale","geoOptions","maximumAge","timeout","enableHighAccuracy","geolocationOptions","mixin","has","addLayer","graphicsLayer","onLocateOrError","_publishLocationAction","setTimeout","error","onLocateError","onLocate","parameters","removeClass","neverLocate","_tryToShowCompass","scale","getScale","compass","getInstance","folderUrl","show","clean","_tryToDestroyCompass","destroy","clear","removeLayer","_destroyHiddenLocator","_isWidgetLocatorLoaded","loaded","_isWidgetLocatorTracking","tracking","_isWidgetLocatorLocating","onReceiveData","widgetId","data","historyData","type","_triggerHiddenLocatorLocate","isWidgetLocatorTracking","isWidgetLocatorLocating","publishData","highlightLocation","once","_onHiddenLocatorLocate","inPanel","hasUIFile","extend"],"mappings":"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","file":"Widget.js","sourcesContent":["///////////////////////////////////////////////////////////////////////////\r\n// Copyright Â© Esri. All Rights Reserved.\r\n//\r\n// Licensed under the Apache License Version 2.0 (the \"License\");\r\n// you may not use this file except in compliance with the License.\r\n// You may obtain a copy of the License at\r\n//\r\n//    http://www.apache.org/licenses/LICENSE-2.0\r\n//\r\n// Unless required by applicable law or agreed to in writing, software\r\n// distributed under the License is distributed on an \"AS IS\" BASIS,\r\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n// See the License for the specific language governing permissions and\r\n// limitations under the License.\r\n///////////////////////////////////////////////////////////////////////////\r\n\r\ndefine([\r\n  'dojo/_base/declare',\r\n  'dojo/Deferred',\r\n  \"esri/layers/GraphicsLayer\",\r\n  'jimu/BaseWidget',\r\n  \"esri/dijit/LocateButton\",\r\n  'dojo/_base/html',\r\n  'dojo/on',\r\n  'dojo/_base/lang',\r\n  'jimu/utils',\r\n  \"./Compass\",\r\n  \"./a11y/Widget\",\r\n  'jimu/dijit/Message',\r\n  'dojo/touch'\r\n],\r\n  function (declare, Deferred, GraphicsLayer, BaseWidget, LocateButton, html, on, lang, jimuUtils, Compass, a11y) {\r\n    var clazz = declare([BaseWidget], {\r\n      name: 'MyLocation',\r\n      baseClass: 'jimu-widget-mylocation',\r\n\r\n      moveTopOnActive: false,\r\n      _DEBUG: false,\r\n\r\n      _graphicsLayer: null,\r\n\r\n      //locateAction msg\r\n      _locateAction: {\r\n        locator: null,\r\n        cacheLatestTracking: null\r\n      },\r\n\r\n      startup: function () {\r\n        this.inherited(arguments);\r\n        this.placehoder = html.create('div', {\r\n          'class': 'place-holder',\r\n          title: this.label\r\n        }, this.domNode);\r\n        this.a11y_updateLabel(this.nls._widgetLabel);\r\n\r\n        this.isNeedHttpsButNot = jimuUtils.isNeedHttpsButNot();\r\n\r\n        if (true === this.isNeedHttpsButNot) {\r\n          console.log('LocateButton::navigator.geolocation requires a secure origin.');\r\n          html.addClass(this.placehoder, \"nohttps\");\r\n\r\n          html.setAttr(this.placehoder, 'title', this.nls.httpNotSupportError);\r\n          this.a11y_updateLabel(this.nls.httpNotSupportError);\r\n          this.a11y_disable();\r\n        } else if (window.navigator.geolocation) {\r\n          this.own(on(this.placehoder, 'click', lang.hitch(this, this.onLocationClickWapper)));\r\n          this.own(on(this.map, 'zoom-end', lang.hitch(this, this._scaleChangeHandler)));\r\n\r\n          this.a11y_initEvents();\r\n          this.a11y_enable();\r\n\r\n          this._createHiddenLocator();\r\n        } else {\r\n          html.setAttr(this.placehoder, 'title', this.nls.browserError);\r\n          this.a11y_updateLabel(this.nls.browserError);\r\n          this.a11y_disable();\r\n        }\r\n      },\r\n\r\n      //for IOS 13+ added a permission API ,#18638\r\n      onLocationClickWapper: function (evt) {\r\n        if (evt && evt.stopPropagation) {\r\n          evt.stopPropagation();\r\n        }\r\n\r\n        if (true === Compass.needCompass(this.config)) {//compass for ios 13+\r\n          Compass.checkPermission().then(\r\n            lang.hitch(this, function () {\r\n              this.onLocationClick(evt);\r\n            }),\r\n            lang.hitch(this, function () {\r\n              this.onLocationClick(evt);\r\n            })\r\n          )\r\n        } else {\r\n          this.onLocationClick(evt);\r\n        }\r\n      },\r\n\r\n      onLocationClick: function (evt) {\r\n        if (html.hasClass(this.domNode, \"onCenter\") ||\r\n          html.hasClass(this.domNode, \"locating\")) {\r\n\r\n          if (!(this.geoLocate && true === this.geoLocate._canDestroy)) {\r\n            if (this._DEBUG) {\r\n              console.log(\"==>block click1\");\r\n            }\r\n            return;\r\n          }\r\n\r\n          this._destroyGeoLocate();//this._clearGeoLocate();\r\n          this._tryToCleanCompass();\r\n        } else {\r\n          if (!(!this.geoLocate || (this.geoLocate && true === this.geoLocate._canDestroy))) {\r\n            if (this._DEBUG) {\r\n              console.log(\"==>block click2\");\r\n            }\r\n            return;\r\n          }\r\n\r\n          this._destroyGeoLocate();//this._clearGeoLocate();\r\n          this._createGeoLocateAndLocate();\r\n        }\r\n      },\r\n\r\n\r\n      //create & async-locate\r\n      _createGeoLocateAndLocate: function () {\r\n        if (this._DEBUG) {\r\n          console.log(\"==>_createGeoLocateAndLocate\");\r\n        }\r\n        this.getGeoLocateInstance().then(lang.hitch(this, function () {\r\n          this.geoLocate.locate();\r\n          html.addClass(this.placehoder, \"locating\");\r\n        }));\r\n      },\r\n      getGeoLocateInstance: function () {\r\n        var def = new Deferred();\r\n        //1 get\r\n        if (this.geoLocate) {\r\n          def.resolve(this.geoLocate);\r\n        }\r\n        //2 create\r\n        var json = this.config.locateButton;\r\n        json.map = this.map;\r\n        if (typeof (this.config.locateButton.useTracking) === \"undefined\") {\r\n          json.useTracking = true;\r\n        }\r\n        json.centerAt = true;\r\n        json.setScale = true;\r\n        var geoOptions = {\r\n          maximumAge: 0,\r\n          timeout: 15000,\r\n          enableHighAccuracy: true\r\n        };\r\n        if (json.geolocationOptions) {\r\n          json.geolocationOptions = lang.mixin(geoOptions, json.geolocationOptions);\r\n        }\r\n        if (jimuUtils.has('ie') === 11) {//hack for issue,#11199\r\n          json.geolocationOptions.maximumAge = 300;\r\n          json.geolocationOptions.enableHighAccuracy = false;\r\n        }\r\n\r\n        if (!this._graphicsLayer) {\r\n          this._graphicsLayer = new GraphicsLayer();\r\n          this.map.addLayer(this._graphicsLayer);\r\n        }\r\n        json.graphicsLayer = this._graphicsLayer;\r\n\r\n        this.geoLocate = new LocateButton(json);\r\n        this.geoLocate.own(on(this.geoLocate, 'load', lang.hitch(this, function () {\r\n          def.resolve(this.geoLocate);\r\n        })));\r\n        //only 3d-api have error event\r\n        this.geoLocate.own(on(this.geoLocate, \"locate\", lang.hitch(this, this.onLocateOrError)));\r\n        this.geoLocate.startup();\r\n\r\n        return def;\r\n      },\r\n\r\n\r\n      //events handler\r\n      //there is no \"locate-error\" event in 2d-api\r\n      onLocateOrError: function (evt) {\r\n        this._publishLocationAction(evt);\r\n\r\n        if (this.geoLocate) {\r\n          setTimeout(lang.hitch(this, function () {\r\n            this.geoLocate._canDestroy = true;\r\n\r\n            if (evt.error) {\r\n              this.onLocateError(evt);\r\n            } else {\r\n              this.onLocate(evt);\r\n            }\r\n          }), 300);\r\n        }\r\n      },\r\n      onLocate: function (parameters) {\r\n        html.removeClass(this.placehoder, \"locating\");\r\n        if (this.geoLocate.useTracking) {\r\n          html.addClass(this.placehoder, \"tracking\");\r\n          this._locateAction.cacheLatestTracking = parameters;\r\n        }\r\n\r\n        html.addClass(this.domNode, \"onCenter\");\r\n        this.neverLocate = false;\r\n        this._tryToShowCompass(parameters);\r\n      },\r\n      onLocateError: function (evt) {\r\n        console.error(evt.error);\r\n        //this._destroyAPIBugLocate();\r\n        this._tryToCleanCompass();\r\n        html.removeClass(this.placehoder, \"locating\");\r\n        html.removeClass(this.domNode, \"onCenter\");\r\n        html.removeClass(this.placehoder, \"tracking\");\r\n      },\r\n      //use current scale in Tracking\r\n      _scaleChangeHandler: function () {\r\n        var scale = this.map.getScale();\r\n        if (scale && this.geoLocate && this.geoLocate.useTracking) {\r\n          this.geoLocate.scale = scale;\r\n        }\r\n      },\r\n\r\n\r\n      //compass\r\n      _tryToShowCompass: function (parameters) {\r\n        if (false === Compass.needCompass(this.config)) {\r\n          return;\r\n        }\r\n\r\n        this.compass = Compass.getInstance({ folderUrl: this.folderUrl, map: this.map, config: this.config });\r\n        this.compass.show(parameters, this.geoLocate);\r\n      },\r\n      _tryToCleanCompass: function () {\r\n        if (this.compass && this.compass.clean) {\r\n          this.compass.clean();\r\n        }\r\n      },\r\n      _tryToDestroyCompass: function () {\r\n        if (this.compass && this.compass.destroy) {\r\n          this.compass.destroy();\r\n        }\r\n      },\r\n      // _clearGeoLocate: function () {\r\n      //   if (this.geoLocate){\r\n      //     this.geoLocate.clear();\r\n      //     html.removeClass(this.domNode, \"onCenter\");\r\n      //     html.removeClass(this.placehoder, \"tracking\");\r\n      //     this._destroyAPIBugLocate();\r\n      //   }\r\n      // },\r\n      // _isGeoLocateLocating: function () {\r\n      //   return html.hasClass(this.geoLocate._locateNode, this.geoLocate._css.loading);\r\n      // },\r\n      _destroyGeoLocate: function () {\r\n        if (this._DEBUG) {\r\n          console.log(\"==>_destroyGeoLocate\");\r\n        }\r\n\r\n        if (this._graphicsLayer) {\r\n          this._graphicsLayer.clear();\r\n        }\r\n\r\n        if (this.geoLocate && this.geoLocate._canDestroy) {\r\n          if (this.geoLocate) {\r\n            //console.log(\"==> !!! _destroyGeoLocate\");\r\n            this.geoLocate.clear();\r\n            this.geoLocate.destroy();\r\n            this.geoLocate = null;\r\n\r\n            this._locateAction.cacheLatestTracking = null;\r\n          }\r\n          //this._destroyAPIBugLocate();\r\n          html.removeClass(this.domNode, \"onCenter\");\r\n          html.removeClass(this.placehoder, \"tracking\");\r\n        }\r\n      },\r\n      //hack api bug, when destroy before locating finish\r\n      // _destroyAPIBugLocate: function () {\r\n      //   var graphics = this.map.graphics.graphics;\r\n      //   for (var i = 0, len = graphics.length; i < len; i++) {\r\n      //     var g = graphics[i];\r\n      //     if (g.symbol && this._endsWithStr(g.symbol.url, \"/dijit/images/sdk_gps_location.png\")) {\r\n      //       this.map.graphics.remove(g);\r\n      //       i = 0;\r\n      //       len = graphics.length;\r\n      //     }\r\n      //   }\r\n      // },\r\n      /*jshint esnext: true */\r\n      /* jscs:disable */\r\n      // _endsWithStr(string, suf) {\r\n      //   var reg = new RegExp(suf + \"$\");\r\n      //   return reg.test(string);\r\n      // },\r\n      /* jscs:enable */\r\n      destroy: function () {\r\n        this._tryToCleanCompass();\r\n        this._tryToDestroyCompass();\r\n\r\n        this._destroyGeoLocate();\r\n\r\n        if (this._graphicsLayer) {\r\n          this.map.removeLayer(this._graphicsLayer);\r\n          this._graphicsLayer = null;\r\n        }\r\n\r\n        this._destroyHiddenLocator();\r\n\r\n        this.inherited(arguments);\r\n      },\r\n\r\n\r\n      //message\r\n      _isWidgetLocatorLoaded: function () {\r\n        return !!(this.geoLocate && this.geoLocate.loaded);\r\n      },\r\n      _isWidgetLocatorTracking: function () {\r\n        return !!(this._isWidgetLocatorLoaded() && this.geoLocate.tracking);\r\n      },\r\n      _isWidgetLocatorLocating: function () {\r\n        return !!(!this._isWidgetLocatorTracking() && html.hasClass(this.placehoder, \"locating\"));\r\n      },\r\n      onReceiveData: function (name, widgetId, data, historyData) {\r\n        if (!(data && \"getCurrentLocation\" === data.type)) {\r\n          return;\r\n        }\r\n\r\n        //this._TESTCASE_FLAG = 0;\r\n        if (!this._isWidgetLocatorLoaded()) {\r\n          //this._TESTCASE_FLAG = 1;\r\n          //1. WidgetLocator in MyLocationWidget can't do locate (e.g. unloaded, inactive)\r\n          //_actionLocator do a locate, then _actionLocator publish location msg\r\n          this._triggerHiddenLocatorLocate();\r\n        } else {\r\n          //2. WidgetLocator can locate\r\n          var isWidgetLocatorTracking = this._isWidgetLocatorTracking();\r\n          if (!isWidgetLocatorTracking) {\r\n            //2.1. when MyLocationWidget not in Tracking(watching)\r\n            var isWidgetLocatorLocating = this._isWidgetLocatorLocating();\r\n            if (!isWidgetLocatorLocating) {\r\n              //this._TESTCASE_FLAG = \"2.1.1\";\r\n              //2.1.1. widget is not locating: _actionLocator do a locate, then _actionLocator publish location msg (case 1)\r\n              this._triggerHiddenLocatorLocate();\r\n            } else {\r\n              //2.1.2. widget is locating: waiting for MyLocationWidget finish location, then WidgetLocator publish location msg\r\n              //this._TESTCASE_FLAG = \"2.1.2\";\r\n            }\r\n          } else {\r\n            //2.2. MyLocationWidget is in Tracking(watching), cache latest location in widget(before Tracking update it)\r\n            if (this._locateAction.cacheLatestTracking) {\r\n              //this._TESTCASE_FLAG = \"2.2.1\";\r\n              //2.2.1. there is cachedTrackingLocation: widget publish the cached location msg\r\n              this._publishLocationAction(this._locateAction.cacheLatestTracking);\r\n            } else {\r\n              //2.2.2. there is no cachedTrackingLocation: waiting for MyLocationWidget finish location, then WidgetLocator publish location msg (case 2.1.2)\r\n              //this._TESTCASE_FLAG = \"2.2.2\";\r\n            }\r\n          }\r\n        }\r\n      },\r\n      _publishLocationAction: function (evt) {\r\n        this.publishData({ 'type': 'publishCurrentLocation', 'geoLocationResult': evt });\r\n\r\n        // if (this._TESTCASE_FLAG) {\r\n        //   alert(\"==>_TESTCASE_FLAG_\" + this._TESTCASE_FLAG);\r\n        // }\r\n      },\r\n\r\n      _createHiddenLocator: function () {\r\n        this._locateAction = {\r\n          locator: null,\r\n          cacheLatestTracking: null//for case 2.2.1 of _publishLocationAction\r\n        };\r\n\r\n        this._locateAction.locator = new LocateButton({\r\n          map: this.map,\r\n          highlightLocation: false,\r\n          setScale: false,\r\n          centerAt: false,\r\n          geolocationOptions: { enableHighAccuracy: true }\r\n        });\r\n        this._locateAction.locator.startup();\r\n      },\r\n      _destroyHiddenLocator: function () {\r\n        this._locateAction.locator.clear();\r\n        this._locateAction.locator.destroy();\r\n        this._locateAction.locator = null;\r\n\r\n        this._locateAction = {\r\n          locator: null,\r\n          cacheLatestTracking: null\r\n        };\r\n      },\r\n\r\n      _triggerHiddenLocatorLocate: function () {\r\n        this.own(on.once(this._locateAction.locator, \"locate\", lang.hitch(this, this._onHiddenLocatorLocate)));\r\n        this._locateAction.locator.locate();\r\n      },\r\n      _onHiddenLocatorLocate: function (evt) {\r\n        this._publishLocationAction(evt);\r\n      }\r\n    });\r\n    clazz.inPanel = false;\r\n    clazz.hasUIFile = false;\r\n\r\n    clazz.extend(a11y);//for a11y\r\n    return clazz;\r\n  });"]}